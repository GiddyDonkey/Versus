<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VERSUS - Every Duel Matters</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700;900&display=swap" rel="stylesheet">
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Fix for sandboxed environments (file:// protocol or iframes)
        // Override fetch to avoid postMessage cloning issues
        if (window.location.protocol === 'file:' || window.self !== window.top) {
            console.log('üîß Applying fetch fix for sandboxed environment');
        }
    </script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000000;
            color: #FFFFFF;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .app {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background: radial-gradient(circle at 20% 80%, rgba(255, 215, 0, 0.03) 0%, transparent 50%),
                        #000000;
        }

        .header {
            padding: 20px;
            border-bottom: 1px solid #1C1C1E;
            position: sticky;
            top: 0;
            z-index: 100;
            background: #000000;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .settings-icon {
            font-size: 24px;
            cursor: pointer;
            opacity: 0.8;
            transition: all 0.2s;
        }

        .settings-icon:hover {
            opacity: 1;
            transform: scale(1.1) rotate(90deg);
        }

        .logo {
            font-size: 28px;
            font-weight: 900;
            letter-spacing: 3px;
            text-align: center;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tagline {
            text-align: center;
            font-size: 9px;
            color: #A1A1A6;
            letter-spacing: 2px;
            margin-top: 4px;
            text-transform: uppercase;
            font-weight: 700;
        }

        .nav {
            display: flex;
            gap: 8px;
            padding: 12px 20px;
            background: #0A0A0C;
            border-bottom: 1px solid #1C1C1E;
            position: sticky;
            top: 73px;
            z-index: 99;
        }

        .nav-btn {
            flex: 1;
            padding: 10px;
            background: #1C1C1E;
            border: 1px solid #2C2C2E;
            border-radius: 8px;
            color: #8E8E93;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-btn:hover { background: #2C2C2E; }
        .nav-btn.active { 
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000000;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
        }

        .content { padding: 24px 20px 100px; }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #000000;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.25);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 215, 0, 0.3);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #2C2C2E;
            color: #F5F5F7;
            border: 1px solid #3C3C3E;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .section-title {
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #8E8E93;
            margin-bottom: 16px;
        }

        .challenge-tile {
            padding: 16px;
            background: #1C1C1E;
            border: 2px solid #2C2C2E;
            border-left: 4px solid #2C2C2E;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.25s ease;
            position: relative;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .challenge-tile:hover {
            border-color: #FFD700;
            background: #2C2C2E;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.2);
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 12, 0.98);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            overflow-y: auto;
            padding: 20px;
        }

        .reveal-container {
            text-align: center;
            max-width: 500px;
            width: 100%;
        }

        .upload-zone {
            background: #1C1C1E;
            border: 2px dashed #3C3C3E;
            border-radius: 12px;
            padding: 48px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 24px;
        }

        .upload-zone:hover {
            border-color: #D4AF37;
            background: rgba(212, 175, 55, 0.05);
        }

        .preview-media {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #D4AF37;
            animation: confettiFall 3s linear forwards;
        }

        @keyframes confettiFall {
            to { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .fade-in { animation: fadeIn 0.4s ease; }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .hidden { display: none; }

        .back-btn {
            background: none;
            border: none;
            color: #8E8E93;
            font-size: 15px;
            padding: 12px 0;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .ladder-row {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: #1C1C1E;
            border: 1px solid #2C2C2E;
            border-radius: 12px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .ladder-row.rank-1 {
            border-color: #FFD700;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.05) 0%, rgba(255, 165, 0, 0.02) 100%);
        }

        .rank {
            font-size: 24px;
            font-weight: 900;
            min-width: 36px;
            text-align: center;
        }

        .rank-1 { color: #FFD700; }
        .rank-2 { color: #C0C0C0; }
        .rank-3 { color: #CD7F32; }

        .avatar { font-size: 48px; }

        .member-info { flex: 1; }

        .member-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .points {
            font-size: 24px;
            font-weight: 900;
            color: #FFD700;
        }

        .streak {
            display: inline-block;
            background: rgba(255, 59, 48, 0.2);
            color: #FF3B30;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            margin-left: 8px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #3C3C3E;
            border-top-color: #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        @keyframes crownPop {
            0% { transform: translate(-50%, -50%) scale(0) rotate(-180deg); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2) rotate(10deg); }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 1; }
        }
        
        @keyframes crownFly {
            0% { top: 0; transform: translateX(-50%) rotate(0deg); }
            25% { top: -30px; transform: translateX(-50%) rotate(-15deg); }
            50% { top: 20px; transform: translateX(-50%) rotate(10deg); }
            75% { top: 40px; transform: translateX(-50%) rotate(-5deg); }
            100% { top: 60px; transform: translateX(-50%) rotate(0deg); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }
            50% { box-shadow: 0 0 40px rgba(255, 215, 0, 0.6); }
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
            max-width: 90%;
        }
        
        .toast {
            background: #1C1C1E;
            border: 2px solid #3C3C3E;
            border-radius: 12px;
            padding: 14px 20px;
            font-size: 14px;
            font-weight: 600;
            color: #FFFFFF;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            animation: toastIn 0.3s ease-out, toastOut 0.3s ease-in 2.7s forwards;
            pointer-events: auto;
        }
        
        .toast.member {
            border-color: #34C759;
            background: linear-gradient(135deg, rgba(52, 199, 89, 0.2), #1C1C1E);
        }
        
        .toast.challenge {
            border-color: #FF9500;
            background: linear-gradient(135deg, rgba(255, 149, 0, 0.2), #1C1C1E);
        }
        
        .toast.victory {
            border-color: #FFD700;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), #1C1C1E);
        }
        
        .toast.info {
            border-color: #007AFF;
            background: linear-gradient(135deg, rgba(0, 122, 255, 0.2), #1C1C1E);
        }
        
        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes toastOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <div class="app">
        <div class="header" id="app-header">
            <div style="flex: 1;"></div>
            <div style="text-align: center;">
                <div class="logo">VERSUS</div>
                <div class="tagline">EVERY DUEL MATTERS</div>
            </div>
            <div style="flex: 1; display: flex; justify-content: flex-end;">
                <div class="settings-icon" onclick="screen='settings'; render();">‚öôÔ∏è</div>
            </div>
        </div>

        <div class="nav" id="app-nav">
            <button class="nav-btn active" onclick="goTo('arena')">‚öîÔ∏è Arena</button>
            <button class="nav-btn" onclick="goTo('ladder')">üëë Ladder</button>
        </div>

        <div class="content" id="content">
            <div style="text-align: center; padding: 60px 20px;">
                <div class="loading-spinner"></div>
                <p style="margin-top: 16px; color: #8E8E93;">Loading...</p>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://kxwwnqqwelgnrtjtkufl.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4d3ducXF3ZWxnbnJ0anRrdWZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4NTgwMTksImV4cCI6MjA4NTQzNDAxOX0.H03Qhf4hymkMpuIEnOwpuMHLie8oNaJNRbm4r72iSFM';
        
        // Create client with default settings
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        console.log('‚úÖ Supabase client initialized');

        // ============================================
        // GLOBAL ERROR HANDLER
        // ============================================
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Global error:', msg, 'at line', lineNo);
            document.getElementById('content').innerHTML = `
                <div style="padding: 40px; text-align: center;">
                    <h2 style="color: #FF3B30;">Error Loading App</h2>
                    <p style="color: #8E8E93; margin: 16px 0;">${msg}</p>
                    <p style="color: #8E8E93; font-size: 12px;">Line: ${lineNo}</p>
                    <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 20px;">Reload App</button>
                </div>
            `;
            return true;
        };

        // ============================================
        // STATE
        // ============================================
        let screen = 'welcome';
        let squadId = localStorage.getItem('squadId') || null;
        let squadCode = localStorage.getItem('squadCode') || null;
        let currentMemberId = localStorage.getItem('memberId') || null;
        let selectedOpponent = null;
        let selectedChallenge = null;
        let selectedMedia = null;
        let mediaType = null;
        let isSubmitting = false;
        
        // In-memory squad data (refreshed from Supabase)
        let squad = null;
        let members = {};
        let challenges = [];
        let previousMemberCount = 0; // Track member count for notifications
        let knownMemberIds = new Set(); // Track known members
        
        // v21: Phase 1 - Tension mechanics
        const DEADLINE_HOURS = 24; // Response deadline in hours
        const WIN_POINTS = 10;
        const LOSS_POINTS = 3; // Points lost on defeat
        const FORFEIT_POINTS = 3; // Points lost on forfeit (after grace used)
        
        // Grace mechanic: first forfeit per week = no penalty
        let lastSeenAt = localStorage.getItem('lastSeenAt') || null;
        let hasSeenReturnScreen = false;
        
        // v21: Champion state model (Phase 2 data, inactive)
        // States: 'secure' | 'vulnerable' | 'bleeding'
        // These fields will be read from squad data when Phase 2 activates
        
        // Countdown timer interval
        let countdownInterval = null;

        // ============================================
        // CHALLENGE LIBRARY
        // ============================================
        
        // 1:1 Duels - Fast, ego-driven, rematchable
        const duelChallenges = [
            // Photo Duels
            { name: "Right In Front", type: "photo", time: "30s", desc: "Right now. No moving." },
            { name: "Most Chaotic Selfie", type: "photo", time: "30s", desc: "Mid-action. Weird angle." },
            { name: "Goblin Mode", type: "photo", time: "30s", desc: "Ugliest face you can make" },
            { name: "Don't Look Grab", type: "photo", time: "30s", desc: "Reach blindly behind you, snap what you grab" },
            { name: "Current Vibe Check", type: "photo", time: "30s", desc: "Selfie + caption energy" },
            { name: "Main Character Energy", type: "photo", time: "30s", desc: "You're the star" },
            { name: "Most Unhinged Angle", type: "photo", time: "30s", desc: "Get weird with it" },
            { name: "Mood Object", type: "photo", time: "30s", desc: "Find it fast" },
            { name: "Dramatic Lighting", type: "photo", time: "30s", desc: "Work with what you got" },
            { name: "Weirdest Object Combo", type: "photo", time: "30s", desc: "Grab two random things" },
            { name: "Desk Disaster", type: "photo", time: "30s", desc: "No cleaning allowed" },
            { name: "Snack Tower", type: "photo", time: "1m", desc: "Stack it dangerously high" },
            // Video Duels
            { name: "Bottle Flip", type: "video", time: "2m", desc: "Stick the landing üî•" },
            { name: "Trash Can Shot", type: "video", time: "2m", desc: "From across the room" },
            { name: "Reaction Time Drop", type: "video", time: "1m", desc: "Catch before it hits" },
            { name: "One-Take Trick Shot", type: "video", time: "2m", desc: "Any object, any target" },
            { name: "Fastest Spin + Pose", type: "video", time: "30s", desc: "Stick the landing" },
            { name: "Slow-Mo Victory Walk", type: "video", time: "30s", desc: "You just won something" },
            { name: "Worst Dance Move Ever", type: "video", time: "30s", desc: "So bad it's good" },
            { name: "POV: You Just Won the Crown", type: "video", time: "30s", desc: "Reaction video" },
            { name: "Coin Catch", type: "video", time: "1m", desc: "Flip and catch behind back" },
            { name: "Stack Anything in 20 Seconds", type: "video", time: "30s", desc: "Speed build" }
        ];
        
        // Weekly Squad Challenges - Identity, ritual, shareable
        const weeklyChallenges = [
            { name: "Squad Rebrand", type: "photo", time: "5m", desc: "New team name + logo" },
            { name: "Squad Anthem Drop", type: "video", time: "3m", desc: "15 sec performance" },
            { name: "Fake Album Cover", type: "photo", time: "3m", desc: "You're the artist" },
            { name: "Meme Recreation", type: "photo", time: "3m", desc: "Pick your favorite" },
            { name: "Best Fake Commercial", type: "video", time: "3m", desc: "Sell us something" },
            { name: "Movie Scene Recreation", type: "video", time: "3m", desc: "Act it out" },
            { name: "Style Swap Chaos", type: "photo", time: "5m", desc: "Assign each other outfits" },
            { name: "Squad Villain Origin Story", type: "video", time: "3m", desc: "How you became evil" },
            { name: "Breaking News: Squad Edition", type: "photo", time: "3m", desc: "Fake headline about your squad" },
            { name: "60-Second Room Glow Up", type: "video", time: "2m", desc: "Transform your space" }
        ];
        
        // Combined for backward compatibility (duels are the default)
        const challengeLibrary = duelChallenges;

        // ============================================
        // SOUNDS
        // ============================================
        const sounds = {
            click: () => playTone(800, 0.05),
            challenge: () => playTone(600, 0.1),
            victory: () => {
                playTone(500, 0.15);
                setTimeout(() => playTone(650, 0.15), 150);
                setTimeout(() => playTone(800, 0.2), 300);
            },
            defeat: () => playTone(300, 0.2)
        };

        function playTone(freq, duration) {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(0.2, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + duration);
            } catch (e) {}
        }

        // ============================================
        // SUPABASE DATA FUNCTIONS
        // ============================================
        
        async function loadSquadData() {
            if (!squadId) return null;
            
            try {
                // Load squad
                const { data: squadData, error: squadError } = await db
                    .from('squads')
                    .select('*')
                    .eq('id', squadId)
                    .single();
                
                if (squadError) throw squadError;
                squad = squadData;
                
                // Load members
                const { data: membersData, error: membersError } = await db
                    .from('members')
                    .select('*')
                    .eq('squad_id', squadId);
                
                if (membersError) throw membersError;
                
                // Check for new members (for notifications)
                const newMemberIds = membersData
                    .filter(m => !knownMemberIds.has(m.id) && m.id !== currentMemberId)
                    .map(m => m.id);
                
                // Show notification for new members (only if we already had members loaded)
                if (knownMemberIds.size > 0 && newMemberIds.length > 0) {
                    newMemberIds.forEach(newId => {
                        const newMember = membersData.find(m => m.id === newId);
                        if (newMember) {
                            console.log('üÜï New member detected:', newMember.name);
                            showToast(`${newMember.avatar || 'üë§'} ${newMember.name} joined the squad!`, 'member');
                            sounds.victory();
                        }
                    });
                }
                
                // Update known members
                membersData.forEach(m => knownMemberIds.add(m.id));
                
                // Convert to object keyed by ID
                members = {};
                membersData.forEach(m => {
                    members[m.id] = m;
                });
                
                // Load challenges
                const { data: challengesData, error: challengesError } = await db
                    .from('challenges')
                    .select('*')
                    .eq('squad_id', squadId)
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                if (challengesError) throw challengesError;
                challenges = challengesData || [];
                
                console.log('‚úÖ Squad data loaded:', squad.name);
                console.log('   Members:', Object.keys(members).length);
                console.log('   Challenges:', challenges.length);
                
                return squad;
            } catch (err) {
                console.error('‚ùå Failed to load squad data:', err);
                return null;
            }
        }
        
        async function createSquad(name, adminName, adminAvatar) {
            const code = generateSquadCode();
            
            console.log('üìù Creating squad:', { name, code, adminName, adminAvatar });
            
            try {
                // Create squad
                console.log('üì§ Inserting squad into database...');
                const { data: squadData, error: squadError } = await db
                    .from('squads')
                    .insert({ name, code })
                    .select()
                    .single();
                
                console.log('üì• Squad insert result:', { squadData, squadError });
                
                if (squadError) {
                    console.error('Squad error details:', JSON.stringify(squadError, null, 2));
                    throw new Error(squadError.message || squadError.details || 'Failed to create squad');
                }
                
                // Create admin member
                console.log('üì§ Inserting admin member...');
                const { data: memberData, error: memberError } = await db
                    .from('members')
                    .insert({
                        squad_id: squadData.id,
                        user_key: 'admin_' + Date.now(),
                        name: adminName,
                        avatar: adminAvatar,
                        is_admin: true,
                        is_minor: false
                    })
                    .select()
                    .single();
                
                console.log('üì• Member insert result:', { memberData, memberError });
                
                if (memberError) {
                    console.error('Member error details:', JSON.stringify(memberError, null, 2));
                    throw new Error(memberError.message || memberError.details || 'Failed to create member');
                }
                
                // Save to localStorage
                squadId = squadData.id;
                squadCode = code;
                currentMemberId = memberData.id;
                localStorage.setItem('squadId', squadId);
                localStorage.setItem('squadCode', squadCode);
                localStorage.setItem('memberId', currentMemberId);
                
                // Load full data
                await loadSquadData();
                
                // Subscribe to real-time updates
                subscribeToSquad();
                
                console.log('‚úÖ Squad created:', code);
                return { squad: squadData, member: memberData };
            } catch (err) {
                console.error('‚ùå Failed to create squad:', err);
                throw err;
            }
        }
        
        async function joinSquad(code, memberName, memberAge, memberAvatar) {
            try {
                // Find squad by code
                const { data: squadData, error: squadError } = await db
                    .from('squads')
                    .select('*')
                    .eq('code', code.toUpperCase())
                    .single();
                
                if (squadError || !squadData) {
                    throw new Error('Squad not found');
                }
                
                // Create member
                const { data: memberData, error: memberError } = await db
                    .from('members')
                    .insert({
                        squad_id: squadData.id,
                        user_key: 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        name: memberName,
                        avatar: memberAvatar,
                        is_admin: false,
                        is_minor: memberAge < 18,
                        age: memberAge
                    })
                    .select()
                    .single();
                
                if (memberError) throw memberError;
                
                // Save to localStorage
                squadId = squadData.id;
                squadCode = squadData.code;
                currentMemberId = memberData.id;
                localStorage.setItem('squadId', squadId);
                localStorage.setItem('squadCode', squadCode);
                localStorage.setItem('memberId', currentMemberId);
                
                // Load full data
                await loadSquadData();
                
                // Subscribe to real-time updates
                subscribeToSquad();
                
                console.log('‚úÖ Joined squad:', squadData.name);
                return { squad: squadData, member: memberData };
            } catch (err) {
                console.error('‚ùå Failed to join squad:', err);
                throw err;
            }
        }
        
        async function uploadMedia(file, challengeId, role) {
            // Determine file extension from the pending file or fallback
            var rawFile = window._pendingFile || null;
            var fileExt = 'jpg';
            if (rawFile && rawFile.name) {
                var parts = rawFile.name.split('.');
                if (parts.length > 1) fileExt = parts[parts.length - 1];
            } else if (typeof file === 'string') {
                // Extract from data URI
                var match = file.match(/^data:(\w+)\/(\w+)/);
                if (match) fileExt = match[2] === 'quicktime' ? 'mov' : match[2];
            }
            var fileName = challengeId + '_' + role + '_' + Date.now() + '.' + fileExt;
            var filePath = squadId + '/' + fileName;
            
            try {
                var uploadData;
                
                if (rawFile) {
                    // Use the raw File object directly (most reliable on iOS)
                    uploadData = rawFile;
                    console.log('Uploading raw File object:', rawFile.name, (rawFile.size / 1024 / 1024).toFixed(2) + 'MB');
                } else if (typeof file === 'string' && file.startsWith('data:')) {
                    // Fallback: convert base64 to blob
                    try {
                        var response = await fetch(file);
                        uploadData = await response.blob();
                    } catch (fetchErr) {
                        // Manual base64 decode fallback for iOS Safari
                        console.log('fetch() blob conversion failed, using manual decode');
                        var parts = file.split(',');
                        var mimeMatch = parts[0].match(/:(.*?);/);
                        var mime = mimeMatch ? mimeMatch[1] : 'image/jpeg';
                        var b64 = atob(parts[1]);
                        var arr = new Uint8Array(b64.length);
                        for (var i = 0; i < b64.length; i++) {
                            arr[i] = b64.charCodeAt(i);
                        }
                        uploadData = new Blob([arr], { type: mime });
                    }
                } else if (typeof file === 'string' && file.startsWith('blob:')) {
                    // Object URL - fetch the blob
                    var blobResp = await fetch(file);
                    uploadData = await blobResp.blob();
                } else {
                    uploadData = file;
                }
                
                var result = await db.storage
                    .from('challenge-media')
                    .upload(filePath, uploadData, {
                        cacheControl: '3600',
                        upsert: true
                    });
                
                if (result.error) throw result.error;
                
                // Get public URL
                var urlData = db.storage
                    .from('challenge-media')
                    .getPublicUrl(filePath);
                
                // Clean up pending file reference
                window._pendingFile = null;
                
                console.log('Media uploaded:', urlData.data.publicUrl);
                return urlData.data.publicUrl;
            } catch (err) {
                console.error('Failed to upload media:', err);
                window._pendingFile = null;
                throw err;
            }
        }
        
        async function createChallenge(opponentId, challengeType, challengeDesc, challengeTime, mediaUrl, mediaType) {
            try {
                // v21: Set 24h response deadline
                var deadlineAt = new Date();
                deadlineAt.setHours(deadlineAt.getHours() + DEADLINE_HOURS);
                
                const { data, error } = await db
                    .from('challenges')
                    .insert({
                        squad_id: squadId,
                        challenge_type: challengeType,
                        challenge_desc: challengeDesc,
                        challenge_time: challengeTime,
                        challenger_id: currentMemberId,
                        opponent_id: opponentId,
                        challenger_media_url: mediaUrl,
                        challenger_media_type: mediaType,
                        status: 'waiting',
                        deadline_at: deadlineAt.toISOString()
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                
                challenges.unshift(data);
                console.log('‚úÖ Challenge created:', data.id);
                return data;
            } catch (err) {
                console.error('‚ùå Failed to create challenge:', err);
                throw err;
            }
        }
        
        async function respondToChallenge(challengeId, mediaUrl, mediaType) {
            try {
                const { data, error } = await db
                    .from('challenges')
                    .update({
                        opponent_media_url: mediaUrl,
                        opponent_media_type: mediaType,
                        status: 'ready'
                    })
                    .eq('id', challengeId)
                    .select()
                    .single();
                
                if (error) throw error;
                
                // Update local cache
                const idx = challenges.findIndex(c => c.id === challengeId);
                if (idx >= 0) challenges[idx] = data;
                
                console.log('‚úÖ Challenge response submitted:', challengeId);
                return data;
            } catch (err) {
                console.error('‚ùå Failed to respond to challenge:', err);
                throw err;
            }
        }
        
        async function completeChallenge(challengeId, winnerId, challengerScore, opponentScore) {
            try {
                // First, check if already completed (prevent race condition)
                const { data: currentChallenge } = await db
                    .from('challenges')
                    .select('status')
                    .eq('id', challengeId)
                    .single();
                
                if (currentChallenge?.status === 'completed') {
                    console.log('‚ö†Ô∏è Challenge already completed, skipping');
                    await loadSquadData();
                    return currentChallenge;
                }
                
                const { data, error } = await db
                    .from('challenges')
                    .update({
                        status: 'completed',
                        winner_id: winnerId,
                        challenger_score: challengerScore,
                        opponent_score: opponentScore,
                        completed_at: new Date().toISOString()
                    })
                    .eq('id', challengeId)
                    .eq('status', 'voting')  // Only update if still in voting status
                    .select()
                    .single();
                
                if (error) {
                    // Might have been completed by other device - reload and check
                    await loadSquadData();
                    const updatedChallenge = challenges.find(c => c.id === challengeId);
                    if (updatedChallenge?.status === 'completed') {
                        console.log('‚ö†Ô∏è Challenge was completed by another device');
                        return updatedChallenge;
                    }
                    throw error;
                }
                
                // Update local cache
                const idx = challenges.findIndex(c => c.id === challengeId);
                if (idx >= 0) challenges[idx] = data;
                
                // v21: Volatile scoring ‚Äî winner gains, loser pays
                if (winnerId) {
                    var loserId2 = winnerId === data.challenger_id ? data.opponent_id : data.challenger_id;
                    var winnerMember = members[winnerId];
                    var loserMember = members[loserId2];
                    
                    // Winner: +WIN_POINTS and streak increments
                    await db
                        .from('members')
                        .update({ 
                            points: (winnerMember.points || 0) + WIN_POINTS,
                            streak: (winnerMember.streak || 0) + 1,
                            all_time_wins: (winnerMember.all_time_wins || 0) + 1
                        })
                        .eq('id', winnerId);
                    
                    // Loser: -LOSS_POINTS (min 0) and streak resets
                    var newLoserPoints = Math.max(0, (loserMember.points || 0) - LOSS_POINTS);
                    await db
                        .from('members')
                        .update({ 
                            streak: 0,
                            points: newLoserPoints
                        })
                        .eq('id', loserId2);
                }
                
                // Reload data
                await loadSquadData();
                
                console.log('‚úÖ Challenge completed:', challengeId);
                return data;
            } catch (err) {
                console.error('‚ùå Failed to complete challenge:', err);
                throw err;
            }
        }
        
        function subscribeToSquad() {
            if (!squadId) return;
            
            // Subscribe to challenges changes
            db
                .channel('squad-challenges')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'challenges',
                    filter: `squad_id=eq.${squadId}`
                }, async (payload) => {
                    console.log('üîÑ Challenge update received:', payload.eventType);
                    const oldChallenges = [...challenges];
                    await loadSquadData();
                    
                    // Check for new challenges targeting current user
                    if (payload.eventType === 'INSERT' && payload.new.opponent_id === currentMemberId) {
                        const challenger = members[payload.new.challenger_id];
                        showToast(`‚öîÔ∏è ${challenger?.name || 'Someone'} challenged you! 24h to respond`, 'challenge');
                        sounds.challenge();
                    }
                    
                    // Check for challenge ready for voting
                    if (payload.eventType === 'UPDATE' && payload.new.status === 'voting') {
                        const isParticipant = payload.new.challenger_id === currentMemberId || payload.new.opponent_id === currentMemberId;
                        if (isParticipant) {
                            showToast('üó≥Ô∏è Showdown ready! Time to vote.', 'info');
                        }
                    }
                    
                    // Check for challenge completed
                    if (payload.eventType === 'UPDATE' && payload.new.status === 'completed' && payload.old?.status !== 'completed') {
                        const isParticipant = payload.new.challenger_id === currentMemberId || payload.new.opponent_id === currentMemberId;
                        if (isParticipant) {
                            const youWon = payload.new.winner_id === currentMemberId;
                            if (youWon) {
                                showToast('üèÜ You won the challenge!', 'victory');
                            } else {
                                showToast('Challenge complete! Check results.', 'info');
                            }
                        }
                    }
                    
                    if (['home', 'rankings', 'weekly'].includes(screen)) {
                        render();
                    }
                })
                .subscribe();
            
            // Subscribe to members changes
            db
                .channel('squad-members-' + squadId)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'members',
                    filter: `squad_id=eq.${squadId}`
                }, async (payload) => {
                    console.log('üîÑ New member joined:', payload.new);
                    
                    // Show notification for new member (not yourself)
                    if (payload.new.id !== currentMemberId) {
                        const newMemberName = payload.new.name;
                        const newMemberAvatar = payload.new.avatar || 'üë§';
                        showToast(`${newMemberAvatar} ${newMemberName} joined the squad!`, 'member');
                        sounds.victory();
                    }
                    
                    await loadSquadData();
                    render(); // Always re-render to update ladder
                })
                .on('postgres_changes', {
                    event: 'UPDATE',
                    schema: 'public',
                    table: 'members',
                    filter: `squad_id=eq.${squadId}`
                }, async (payload) => {
                    console.log('üîÑ Member updated:', payload.new);
                    await loadSquadData();
                    render(); // Re-render to update scores/rankings
                })
                .subscribe();
            
            // Subscribe to votes changes (for real-time vote updates)
            db
                .channel('squad-votes')
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'votes'
                }, async (payload) => {
                    console.log('üîÑ Vote received:', payload.new);
                    await loadSquadData();
                    
                    // Check if this completes a 2-person vote
                    const challengeId = payload.new.challenge_id;
                    const challenge = challenges.find(c => c.id === challengeId);
                    if (challenge) {
                        const isParticipant = challenge.challenger_id === currentMemberId || challenge.opponent_id === currentMemberId;
                        const totalVotes = (challenge.votes_for_challenger || 0) + (challenge.votes_for_opponent || 0);
                        
                        if (isParticipant && totalVotes >= 2 && challenge.status === 'voting') {
                            // Both have voted, trigger winner determination
                            await determineTwoPersonWinner(challengeId);
                        }
                    }
                })
                .subscribe();
            
            console.log('üëÇ Subscribed to real-time updates');
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        function generateSquadCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }
        
        async function shareInvite() {
            var inviteUrl = window.location.href.split('?')[0];
            var message = 'Join my VERSUS squad!\n\nSquad: ' + (squad ? squad.name : 'My Squad') + '\nCode: ' + squadCode + '\n\n1. Open: ' + inviteUrl + '\n2. Tap "Join Squad"\n3. Enter code: ' + squadCode + '\n\nLet\'s battle!';
            
            var isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            var isAndroid = /Android/i.test(navigator.userAgent);
            var isMobile = isIOS || isAndroid;
            
            // Show share method picker on mobile
            if (isMobile) {
                showModal(
                    'üì≤ Invite to Squad',
                    '<div style="text-align: center;">' +
                        '<div style="font-size: 28px; font-weight: 900; letter-spacing: 4px; color: #FFD700; padding: 12px; background: #0A0A0C; border-radius: 12px; margin-bottom: 16px;">' + squadCode + '</div>' +
                        '<div style="display: flex; flex-direction: column; gap: 10px;">' +
                            '<button class="btn btn-primary" onclick="sendSMSInvite()" style="background: linear-gradient(135deg, #34C759, #30B350);">üì± Send via Text Message</button>' +
                            (navigator.share ? '<button class="btn btn-secondary" onclick="nativeShareInvite()">üì§ Share via Other Apps</button>' : '') +
                            '<button class="btn btn-secondary" onclick="copyInviteToClipboard()">üìã Copy Invite Message</button>' +
                        '</div>' +
                    '</div>',
                    'Cancel',
                    null,
                    null,
                    function() { closeModal(); }
                );
            } else {
                // Desktop: copy to clipboard
                try {
                    await navigator.clipboard.writeText(message);
                    showToast('üìã Invite copied to clipboard!', 'info');
                } catch (err) {
                    showModal(
                        'üì≤ Invite to Squad',
                        '<div style="text-align: center;">' +
                            '<p style="margin-bottom: 16px;">Share this code with friends:</p>' +
                            '<div style="font-size: 32px; font-weight: 900; letter-spacing: 4px; color: #FFD700; padding: 16px; background: #1C1C1E; border-radius: 12px; margin-bottom: 16px;">' + squadCode + '</div>' +
                            '<p style="font-size: 13px; color: #8E8E93;">They can join at:<br>' + inviteUrl + '</p>' +
                        '</div>',
                        null,
                        'Done',
                        function() { closeModal(); }
                    );
                }
            }
        }
        
        function sendSMSInvite() {
            closeModal();
            var inviteUrl = window.location.href.split('?')[0];
            var smsText = 'Join my VERSUS squad! Code: ' + squadCode + ' - Open ' + inviteUrl + ' and tap Join Squad.';
            var isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            // iOS uses sms:&body=  Android uses sms:?body=
            var smsUrl = isIOS ? 'sms:&body=' + encodeURIComponent(smsText) : 'sms:?body=' + encodeURIComponent(smsText);
            window.location.href = smsUrl;
            setTimeout(function() { showToast('üì± Opening Messages...', 'info'); }, 300);
        }
        
        async function nativeShareInvite() {
            closeModal();
            var inviteUrl = window.location.href.split('?')[0];
            var message = 'Join my VERSUS squad! Code: ' + squadCode + '\n\n1. Open: ' + inviteUrl + '\n2. Tap "Join Squad"\n3. Enter code: ' + squadCode;
            try {
                await navigator.share({
                    title: 'Join my VERSUS squad!',
                    text: message,
                    url: inviteUrl
                });
                showToast('üì§ Invite shared!', 'info');
            } catch (err) {
                if (err.name !== 'AbortError') {
                    showToast('Share cancelled', 'info');
                }
            }
        }
        
        async function copyInviteToClipboard() {
            closeModal();
            var inviteUrl = window.location.href.split('?')[0];
            var message = 'Join my VERSUS squad!\n\nSquad: ' + (squad ? squad.name : 'My Squad') + '\nCode: ' + squadCode + '\n\nOpen: ' + inviteUrl + ' and tap "Join Squad"';
            try {
                await navigator.clipboard.writeText(message);
                showToast('üìã Invite copied!', 'info');
            } catch (err) {
                // Fallback for older browsers
                var ta = document.createElement('textarea');
                ta.value = message;
                ta.style.position = 'fixed';
                ta.style.left = '-9999px';
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                showToast('üìã Invite copied!', 'info');
            }
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            // Remove after animation
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }
        
        function getCurrentMember() {
            return members[currentMemberId] || null;
        }
        
        async function refreshData() {
            console.log('üîÑ Manual refresh triggered');
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = 'üîÑ Refreshing...';
            
            try {
                await loadSquadData();
                console.log('‚úÖ Data refreshed');
                console.log('   Members:', Object.keys(members).length);
                console.log('   Challenges:', challenges.length);
                render();
            } catch (err) {
                console.error('Refresh error:', err);
                alert('Failed to refresh: ' + err.message);
            }
            
            btn.disabled = false;
            btn.innerHTML = 'üîÑ Refresh Data';
        }

        // ============================================
        // NAVIGATION
        // ============================================
        
        function goTo(newScreen) {
            screen = newScreen;
            sounds.click();
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
                const btnText = btn.textContent.toLowerCase();
                if ((newScreen === 'arena' && btnText.includes('arena')) ||
                    (newScreen === 'ladder' && btnText.includes('ladder'))) {
                    btn.classList.add('active');
                }
            });
            
            render();
        }

        // ============================================
        // RENDER FUNCTIONS
        // ============================================
        
        function render() {
            try {
                const content = document.getElementById('content');
                const header = document.getElementById('app-header');
                const nav = document.getElementById('app-nav');
                
                if (!content) return;
                
                const onboardingScreens = ['welcome', 'create-squad', 'join-squad', 'setup-identity', 'rejoin-squad', 'rejoin-pick-member'];
                if (onboardingScreens.includes(screen)) {
                    if (header) header.style.display = 'none';
                    if (nav) nav.style.display = 'none';
                } else {
                    if (header) header.style.display = 'flex';
                    if (nav) nav.style.display = 'flex';
                }
                
                if (screen === 'welcome') content.innerHTML = renderWelcome();
                else if (screen === 'create-squad') content.innerHTML = renderCreateSquad();
                else if (screen === 'join-squad') content.innerHTML = renderJoinSquad();
                else if (screen === 'setup-identity') content.innerHTML = renderSetupIdentity();
                else if (screen === 'rejoin-squad') content.innerHTML = renderRejoinSquad();
                else if (screen === 'rejoin-pick-member') content.innerHTML = renderRejoinPickMember();
                else if (screen === 'return-screen') content.innerHTML = renderReturnScreen(window._returnEvents || []);
                else if (screen === 'arena') content.innerHTML = renderArena();
                else if (screen === 'ladder') content.innerHTML = renderLadder();
                else if (screen === 'home') content.innerHTML = renderArena(); // backward compat
                else if (screen === 'rankings') content.innerHTML = renderLadder(); // backward compat
                else if (screen === 'weekly') content.innerHTML = renderLadder(); // backward compat
                else if (screen === 'select-opponent') content.innerHTML = renderSelectOpponent();
                else if (screen === 'challenge-reveal') content.innerHTML = renderChallengeReveal();
                else if (screen === 'submit-media') content.innerHTML = renderSubmitMedia();
                else if (screen === 'submit-weekly') content.innerHTML = renderSubmitWeekly();
                else if (screen === 'settings') content.innerHTML = renderSettings();
                else content.innerHTML = renderArena();
            } catch (err) {
                console.error('Render error:', err);
            }
        }
        
        function renderWelcome() {
            return `
                <div class="fade-in" style="min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; text-align: center;">
                    <div style="font-size: 80px; margin-bottom: 24px;">‚öîÔ∏è</div>
                    <h1 style="font-size: 36px; font-weight: 900; letter-spacing: 4px; margin-bottom: 8px; background: linear-gradient(135deg, #FFD700, #FFA500); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">VERSUS</h1>
                    <p style="font-size: 12px; color: #8E8E93; letter-spacing: 3px; margin-bottom: 48px; text-transform: uppercase;">Every Duel Matters</p>
                    
                    <div style="width: 100%; max-width: 320px;">
                        <button class="btn btn-primary" style="margin-bottom: 16px;" onclick="screen='create-squad'; render();">
                            Create a Squad
                        </button>
                        <button class="btn btn-secondary" style="margin-bottom: 16px;" onclick="screen='join-squad'; render();">
                            Join a Squad
                        </button>
                        <button class="btn btn-secondary" style="opacity: 0.7; border-color: #3C3C3E;" onclick="screen='rejoin-squad'; render();">
                            Rejoin My Squad
                        </button>
                    </div>
                    
                    <p style="font-size: 11px; color: #8E8E93; margin-top: 32px; padding: 0 20px;">
                        üîí Private family competitions ‚Ä¢ COPPA compliant<br>
                        <span style="font-size: 10px;">By using VERSUS you agree to our Terms of Service</span>
                    </p>
                    
                    <div style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);">
                        <div style="background: rgba(52, 199, 89, 0.1); border: 1px solid rgba(52, 199, 89, 0.3); border-radius: 8px; padding: 8px 16px;">
                            <span style="color: #34C759; font-size: 12px; font-weight: 600;">‚úÖ Supabase Connected</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderCreateSquad() {
            return `
                <div class="fade-in" style="padding: 40px 20px;">
                    <button class="back-btn" onclick="screen='welcome'; render();">‚Üê Back</button>

                    <h2 style="font-size: 24px; font-weight: 900; margin-bottom: 8px;">Create Your Squad</h2>
                    <p style="font-size: 14px; color: #A1A1A6; margin-bottom: 32px;">Set up your competition arena</p>

                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; color: #A1A1A6; margin-bottom: 8px; text-transform: uppercase;">Squad Name</label>
                        <input type="text" id="squadName" placeholder="The Legends" style="width: 100%; padding: 14px; background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 8px; color: #FFFFFF; font-size: 15px;" />
                    </div>

                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; color: #A1A1A6; margin-bottom: 8px; text-transform: uppercase;">Your Name</label>
                        <input type="text" id="adminName" placeholder="Dad" style="width: 100%; padding: 14px; background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 8px; color: #FFFFFF; font-size: 15px;" />
                    </div>

                    <div style="margin-bottom: 32px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; color: #A1A1A6; margin-bottom: 8px; text-transform: uppercase;">Create Your Avatar</label>
                        
                        <!-- Randomize Button -->
                        <button onclick="randomizeAvatar('admin')" style="width: 100%; padding: 12px; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px; color: #FFD700; font-size: 13px; font-weight: 700; cursor: pointer; margin-bottom: 24px;">
                            üé≤ Randomize
                        </button>
                        
                        <!-- Avatar Preview -->
                        <div style="width: 120px; height: 120px; margin: 0 auto 24px; border-radius: 60px; background: #1C1C1E; display: flex; align-items: center; justify-content: center; border: 3px solid #FFD700;">
                            <div id="adminAvatarDisplay" style="font-size: 72px;">üë®üèª</div>
                        </div>
                        
                        <!-- Skin Tone -->
                        <div style="margin-bottom: 20px;">
                            <div style="font-size: 12px; font-weight: 600; color: #8E8E93; margin-bottom: 8px;">SKIN TONE</div>
                            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;">
                                ${['üèª', 'üèº', 'üèΩ', 'üèæ', 'üèø', ''].map((tone, i) => {
                                    const colors = ['#FFE5D9', '#F4D3C4', '#D9A679', '#A67C52', '#6B4423', '#FFD700'];
                                    const labels = ['Light', 'Fair', 'Medium', 'Tan', 'Dark', 'Gold'];
                                    return `
                                        <div onclick="selectSkinTone('${tone}', ${i}, 'admin')" class="admin-tone-option" data-tone="${i}" style="height: 48px; background: ${colors[i]}; border: 2px solid ${i === 0 ? '#FFD700' : '#2C2C2E'}; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                            <div style="font-size: 9px; color: ${i === 5 ? '#000' : '#666'}; font-weight: 700;">${labels[i]}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        <!-- Style -->
                        <div style="margin-bottom: 20px;">
                            <div style="font-size: 12px; font-weight: 600; color: #8E8E93; margin-bottom: 8px;">STYLE</div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                                ${styleEmojis.map((style, i) => `
                                    <div onclick="selectStyle(${i}, 'admin')" class="admin-style-option" data-style="${i}" style="padding: 12px 8px; background: #1C1C1E; border: 2px solid ${i === 0 ? '#FFD700' : '#2C2C2E'}; border-radius: 8px; text-align: center; cursor: pointer;">
                                        <div style="font-size: 32px; margin-bottom: 4px;">${style.base}</div>
                                        <div style="font-size: 8px; color: #8E8E93; font-weight: 600;">${style.label}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <input type="hidden" id="adminAvatar" value="üë®üèª" />
                        <input type="hidden" id="adminSkinTone" value="üèª" />
                        <input type="hidden" id="adminStyleIndex" value="0" />
                    </div>

                    <button class="btn btn-primary" id="createBtn" onclick="handleCreateSquad();">
                        Create Squad
                    </button>
                </div>
            `;
        }
        
        // Avatar skin tone modifiers
        const skinTones = ['üèª', 'üèº', 'üèΩ', 'üèæ', 'üèø', ''];
        const styleEmojis = [
            { base: 'üë®', label: 'Man' },
            { base: 'üë©', label: 'Woman' },
            { base: 'üßî', label: 'Beard' },
            { base: 'üë¥', label: 'Older' },
            { base: 'üë¶', label: 'Boy' },
            { base: 'üëß', label: 'Girl' },
            { base: 'üßë', label: 'Person' },
            { base: 'üßí', label: 'Child' }
        ];
        
        function selectSkinTone(tone, index, prefix) {
            document.querySelectorAll(`.${prefix}-tone-option`).forEach(el => {
                el.style.borderColor = '#2C2C2E';
            });
            document.querySelector(`.${prefix}-tone-option[data-tone="${index}"]`).style.borderColor = '#FFD700';
            document.getElementById(`${prefix}SkinTone`).value = tone;
            updateAvatarPreview(prefix);
        }
        
        function selectStyle(index, prefix) {
            document.querySelectorAll(`.${prefix}-style-option`).forEach(el => {
                el.style.borderColor = '#2C2C2E';
            });
            document.querySelector(`.${prefix}-style-option[data-style="${index}"]`).style.borderColor = '#FFD700';
            document.getElementById(`${prefix}StyleIndex`).value = index;
            updateAvatarPreview(prefix);
        }
        
        function updateAvatarPreview(prefix) {
            const styleIndex = parseInt(document.getElementById(`${prefix}StyleIndex`).value) || 0;
            const tone = document.getElementById(`${prefix}SkinTone`).value;
            const base = styleEmojis[styleIndex].base;
            const combined = base + tone;
            document.getElementById(`${prefix}AvatarDisplay`).textContent = combined;
            document.getElementById(`${prefix}Avatar`).value = combined;
        }
        
        function randomizeAvatar(prefix) {
            const randomTone = Math.floor(Math.random() * skinTones.length);
            const randomStyle = Math.floor(Math.random() * styleEmojis.length);
            
            // Update UI
            document.querySelectorAll(`.${prefix}-tone-option`).forEach(el => {
                el.style.borderColor = '#2C2C2E';
            });
            document.querySelectorAll(`.${prefix}-style-option`).forEach(el => {
                el.style.borderColor = '#2C2C2E';
            });
            
            const toneEl = document.querySelector(`.${prefix}-tone-option[data-tone="${randomTone}"]`);
            const styleEl = document.querySelector(`.${prefix}-style-option[data-style="${randomStyle}"]`);
            if (toneEl) toneEl.style.borderColor = '#FFD700';
            if (styleEl) styleEl.style.borderColor = '#FFD700';
            
            document.getElementById(`${prefix}SkinTone`).value = skinTones[randomTone];
            document.getElementById(`${prefix}StyleIndex`).value = randomStyle;
            updateAvatarPreview(prefix);
            
            sounds.click();
        }
        
        async function handleCreateSquad() {
            const squadName = document.getElementById('squadName').value.trim();
            const adminName = document.getElementById('adminName').value.trim();
            const adminAvatar = document.getElementById('adminAvatar').value;
            
            if (!squadName || !adminName) {
                alert('Please fill in all fields');
                return;
            }
            
            const btn = document.getElementById('createBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Creating...';
            
            try {
                await createSquad(squadName, adminName, adminAvatar);
                
                showModal(
                    'üéâ Squad Created!',
                    `
                    <div style="text-align: center;">
                        <p style="margin-bottom: 16px;">Your squad code is:</p>
                        <div style="font-size: 32px; font-weight: 900; letter-spacing: 8px; color: #FFD700; margin-bottom: 16px;">${squadCode}</div>
                        <p style="font-size: 13px; color: #8E8E93; margin-bottom: 16px;">Share this code with others to join!</p>
                        <p style="font-size: 12px; color: #34C759; margin-bottom: 16px;">‚úÖ Real-time sync enabled with Supabase</p>
                        <button class="btn btn-secondary" onclick="copyCode('${squadCode}')" style="margin-bottom: 12px;">
                            üìã Copy Code
                        </button>
                    </div>
                    `,
                    null,
                    'Go to Home',
                    () => { closeModal(); screen = 'arena'; render(); }
                );
            } catch (err) {
                console.error('Create squad error:', err);
                const errorMsg = err.message || err.error_description || JSON.stringify(err);
                alert('Failed to create squad: ' + errorMsg);
                btn.disabled = false;
                btn.textContent = 'Create Squad';
            }
        }
        
        function renderJoinSquad() {
            return `
                <div class="fade-in" style="padding: 40px 20px;">
                    <button class="back-btn" onclick="screen='welcome'; render();">‚Üê Back</button>

                    <h2 style="font-size: 24px; font-weight: 900; margin-bottom: 8px;">Join a Squad</h2>
                    <p style="font-size: 14px; color: #A1A1A6; margin-bottom: 32px;">Enter the squad code to join</p>

                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; color: #A1A1A6; margin-bottom: 8px; text-transform: uppercase;">Squad Code</label>
                        <input type="text" id="joinCode" placeholder="ABC123" maxlength="6" style="width: 100%; padding: 14px; background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 8px; color: #FFFFFF; font-size: 20px; font-weight: 900; text-align: center; letter-spacing: 4px; text-transform: uppercase;" />
                    </div>

                    <button class="btn btn-primary" id="verifyBtn" onclick="handleVerifyCode();">
                        Continue
                    </button>

                    <div style="margin-top: 24px; padding: 16px; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px;">
                        <p style="font-size: 13px; color: #FFD700; line-height: 1.5;">
                            üí° Ask your squad admin for the 6-character code
                        </p>
                    </div>
                </div>
            `;
        }
        
        async function handleVerifyCode() {
            const code = document.getElementById('joinCode').value.trim().toUpperCase();
            
            if (!code || code.length !== 6) {
                alert('Please enter a valid 6-character code');
                return;
            }
            
            const btn = document.getElementById('verifyBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Finding squad...';
            
            try {
                const { data, error } = await db
                    .from('squads')
                    .select('*')
                    .eq('code', code)
                    .single();
                
                if (error || !data) {
                    throw new Error('Squad not found');
                }
                
                // Store temporarily and go to identity setup
                window.pendingSquadId = data.id;
                window.pendingSquadCode = data.code;
                window.pendingSquadName = data.name;
                
                screen = 'setup-identity';
                render();
            } catch (err) {
                alert('‚ùå Squad code not found. Make sure you entered it correctly.');
                btn.disabled = false;
                btn.textContent = 'Continue';
            }
        }
        
        function renderSetupIdentity() {
            return `
                <div class="fade-in" style="padding: 40px 20px;">
                    <h2 style="font-size: 24px; font-weight: 900; margin-bottom: 8px;">Create Your Profile</h2>
                    <p style="font-size: 14px; color: #A1A1A6; margin-bottom: 32px;">Join ${window.pendingSquadName || 'the squad'}</p>

                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; color: #A1A1A6; margin-bottom: 8px; text-transform: uppercase;">Your Name</label>
                        <input type="text" id="memberName" placeholder="Enter your name" style="width: 100%; padding: 14px; background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 8px; color: #FFFFFF; font-size: 15px;" />
                    </div>

                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; color: #A1A1A6; margin-bottom: 8px; text-transform: uppercase;">Your Age</label>
                        <input type="number" id="memberAge" placeholder="Enter your age" min="1" max="120" style="width: 100%; padding: 14px; background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 8px; color: #FFFFFF; font-size: 15px;" />
                        <p style="font-size: 11px; color: #8E8E93; margin-top: 8px;">üîí Under 18? A parent or guardian must approve your participation. Parental controls will be enabled for your account.</p>
                    </div>

                    <div style="margin-bottom: 32px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; color: #A1A1A6; margin-bottom: 8px; text-transform: uppercase;">Create Your Avatar</label>
                        
                        <!-- Randomize Button -->
                        <button onclick="randomizeAvatar('member')" style="width: 100%; padding: 12px; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px; color: #FFD700; font-size: 13px; font-weight: 700; cursor: pointer; margin-bottom: 24px;">
                            üé≤ Randomize
                        </button>
                        
                        <!-- Avatar Preview -->
                        <div style="width: 120px; height: 120px; margin: 0 auto 24px; border-radius: 60px; background: #1C1C1E; display: flex; align-items: center; justify-content: center; border: 3px solid #FFD700;">
                            <div id="memberAvatarDisplay" style="font-size: 72px;">üë®üèª</div>
                        </div>
                        
                        <!-- Skin Tone -->
                        <div style="margin-bottom: 20px;">
                            <div style="font-size: 12px; font-weight: 600; color: #8E8E93; margin-bottom: 8px;">SKIN TONE</div>
                            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;">
                                ${['üèª', 'üèº', 'üèΩ', 'üèæ', 'üèø', ''].map((tone, i) => {
                                    const colors = ['#FFE5D9', '#F4D3C4', '#D9A679', '#A67C52', '#6B4423', '#FFD700'];
                                    const labels = ['Light', 'Fair', 'Medium', 'Tan', 'Dark', 'Gold'];
                                    return `
                                        <div onclick="selectSkinTone('${tone}', ${i}, 'member')" class="member-tone-option" data-tone="${i}" style="height: 48px; background: ${colors[i]}; border: 2px solid ${i === 0 ? '#FFD700' : '#2C2C2E'}; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                            <div style="font-size: 9px; color: ${i === 5 ? '#000' : '#666'}; font-weight: 700;">${labels[i]}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        <!-- Style -->
                        <div style="margin-bottom: 20px;">
                            <div style="font-size: 12px; font-weight: 600; color: #8E8E93; margin-bottom: 8px;">STYLE</div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                                ${styleEmojis.map((style, i) => `
                                    <div onclick="selectStyle(${i}, 'member')" class="member-style-option" data-style="${i}" style="padding: 12px 8px; background: #1C1C1E; border: 2px solid ${i === 0 ? '#FFD700' : '#2C2C2E'}; border-radius: 8px; text-align: center; cursor: pointer;">
                                        <div style="font-size: 32px; margin-bottom: 4px;">${style.base}</div>
                                        <div style="font-size: 8px; color: #8E8E93; font-weight: 600;">${style.label}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <input type="hidden" id="memberAvatar" value="üë®üèª" />
                        <input type="hidden" id="memberSkinTone" value="üèª" />
                        <input type="hidden" id="memberStyleIndex" value="0" />
                    </div>

                    <button class="btn btn-primary" id="joinBtn" onclick="handleJoinSquad();">
                        Join Squad
                    </button>
                </div>
            `;
        }
        
        function selectMemberAvatar(emoji) {
            // Legacy function - no longer used but kept for compatibility
        }
        
        async function handleJoinSquad() {
            const memberName = document.getElementById('memberName').value.trim();
            const memberAge = parseInt(document.getElementById('memberAge').value);
            const memberAvatar = document.getElementById('memberAvatar').value;
            
            if (!memberName) {
                alert('Please enter your name');
                return;
            }
            
            if (!memberAge || memberAge < 1) {
                alert('Please enter your age');
                return;
            }
            
            const btn = document.getElementById('joinBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Joining...';
            
            try {
                await joinSquad(window.pendingSquadCode, memberName, memberAge, memberAvatar);
                screen = 'arena';
                render();
            } catch (err) {
                alert('Failed to join squad: ' + err.message);
                btn.disabled = false;
                btn.textContent = 'Join Squad';
            }
        }
        
        // ============================================
        // REJOIN FLOW (existing member, new device/session)
        // ============================================
        
        function renderRejoinSquad() {
            return `
                <div class="fade-in" style="padding: 40px 20px;">
                    <button class="back-btn" onclick="screen='welcome'; render();">‚Üê Back</button>

                    <h2 style="font-size: 24px; font-weight: 900; margin-bottom: 8px;">Rejoin Your Squad</h2>
                    <p style="font-size: 14px; color: #A1A1A6; margin-bottom: 32px;">Enter your squad code to reconnect</p>

                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; color: #A1A1A6; margin-bottom: 8px; text-transform: uppercase;">Squad Code</label>
                        <input type="text" id="rejoinCode" placeholder="ABC123" maxlength="6" style="width: 100%; padding: 14px; background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 8px; color: #FFFFFF; font-size: 20px; font-weight: 900; text-align: center; letter-spacing: 4px; text-transform: uppercase;" />
                    </div>

                    <button class="btn btn-primary" id="rejoinVerifyBtn" onclick="handleRejoinVerify();">
                        Find My Squad
                    </button>

                    <div style="margin-top: 24px; padding: 16px; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px;">
                        <p style="font-size: 13px; color: #FFD700; line-height: 1.5;">
                            üí° Switching devices or reinstalled? Enter your squad code and pick your name to reconnect.
                        </p>
                    </div>
                </div>
            `;
        }
        
        async function handleRejoinVerify() {
            var code = document.getElementById('rejoinCode').value.trim().toUpperCase();
            
            if (!code || code.length !== 6) {
                alert('Please enter a valid 6-character code');
                return;
            }
            
            var btn = document.getElementById('rejoinVerifyBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Finding squad...';
            
            try {
                var result = await db
                    .from('squads')
                    .select('*')
                    .eq('code', code)
                    .single();
                
                if (result.error || !result.data) {
                    throw new Error('Squad not found');
                }
                
                // Load the members of this squad
                var membersResult = await db
                    .from('members')
                    .select('*')
                    .eq('squad_id', result.data.id);
                
                if (membersResult.error || !membersResult.data || membersResult.data.length === 0) {
                    throw new Error('No members found in this squad');
                }
                
                // Store for the pick screen
                window.rejoinSquad = result.data;
                window.rejoinMembers = membersResult.data;
                
                screen = 'rejoin-pick-member';
                render();
            } catch (err) {
                alert('‚ùå ' + (err.message || 'Squad not found. Check the code.'));
                btn.disabled = false;
                btn.textContent = 'Find My Squad';
            }
        }
        
        function renderRejoinPickMember() {
            var squadData = window.rejoinSquad;
            var memberList = window.rejoinMembers || [];
            
            if (!squadData) return '<div style="padding: 40px; text-align: center;">Error. Go back and try again.</div>';
            
            var html = '<div class="fade-in" style="padding: 40px 20px;">';
            html += '<button class="back-btn" onclick="screen=\'rejoin-squad\'; render();">‚Üê Back</button>';
            html += '<h2 style="font-size: 24px; font-weight: 900; margin-bottom: 8px;">Welcome Back</h2>';
            html += '<p style="font-size: 14px; color: #A1A1A6; margin-bottom: 32px;">' + squadData.name + ' ‚Ä¢ Pick your name</p>';
            
            html += '<div style="display: flex; flex-direction: column; gap: 12px;">';
            memberList.forEach(function(m) {
                html += '<button onclick="handleRejoinAs(\'' + m.id + '\')" style="display: flex; align-items: center; gap: 14px; padding: 16px; background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 12px; color: #FFFFFF; font-size: 15px; cursor: pointer; text-align: left;">';
                html += '<span style="font-size: 36px;">' + (m.avatar || 'üë§') + '</span>';
                html += '<div style="flex: 1;">';
                html += '<div style="font-weight: 700;">' + m.name + '</div>';
                html += '<div style="font-size: 12px; color: #8E8E93;">' + (m.points || 0) + ' pts';
                if (m.is_admin) html += ' ‚Ä¢ Admin';
                if (m.streak > 0) html += ' ‚Ä¢ üî• ' + m.streak + ' streak';
                html += '</div>';
                html += '</div>';
                html += '<span style="font-size: 14px; color: #8E8E93;">‚Üí</span>';
                html += '</button>';
            });
            html += '</div>';
            
            html += '<div style="margin-top: 24px; padding: 12px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">';
            html += '<p style="font-size: 12px; color: #8E8E93; text-align: center;">Don\'t see your name? Ask the admin for an invite ‚Äî or go back and join as a new member.</p>';
            html += '</div>';
            
            html += '</div>';
            return html;
        }
        
        async function handleRejoinAs(memberId) {
            var squadData = window.rejoinSquad;
            if (!squadData) return;
            
            // Set session
            squadId = squadData.id;
            squadCode = squadData.code;
            currentMemberId = memberId;
            
            localStorage.setItem('squadId', squadId);
            localStorage.setItem('squadCode', squadCode);
            localStorage.setItem('memberId', memberId);
            
            // Load full data
            await loadSquadData();
            
            if (squad && members[currentMemberId]) {
                subscribeToSquad();
                
                var member = members[currentMemberId];
                showToast(member.avatar + ' Welcome back, ' + member.name + '!', 'member');
                sounds.victory();
                
                screen = 'arena';
                render();
                startCountdownTimers();
            } else {
                alert('Something went wrong. Try again.');
                localStorage.clear();
                screen = 'welcome';
                render();
            }
            
            // Cleanup
            window.rejoinSquad = null;
            window.rejoinMembers = null;
        }
        
        function renderArena() {
            if (!squad || !members || Object.keys(members).length === 0) {
                return `
                    <div style="text-align: center; padding: 60px 20px;">
                        <div class="loading-spinner"></div>
                        <p style="margin-top: 16px; color: #8E8E93;">Loading squad...</p>
                    </div>
                `;
            }
            
            const currentMember = getCurrentMember();
            if (!currentMember) {
                return `<div style="text-align: center; padding: 40px;"><p>Session error. Please reload.</p></div>`;
            }
            
            const memberCount = Object.keys(members).length;
            const rankings = Object.values(members).sort((a, b) => b.points - a.points);
            const champion = rankings[0];
            const isChampion = champion.id === currentMemberId;
            
            // Challenge categories
            const pendingForYou = challenges.filter(c => c.status === 'waiting' && c.opponent_id === currentMemberId);
            const waitingForOpponent = challenges.filter(c => c.status === 'waiting' && c.challenger_id === currentMemberId);
            const myVotingChallenges = challenges.filter(c => 
                c.status === 'voting' && 
                (c.challenger_id === currentMemberId || c.opponent_id === currentMemberId)
            );
            const readyChallenges = challenges.filter(c => 
                c.status === 'ready' && 
                (c.challenger_id === currentMemberId || c.opponent_id === currentMemberId)
            );
            
            // All active duels (for live indicator)
            const allActiveDuels = challenges.filter(c => 
                c.status === 'waiting' || c.status === 'ready' || c.status === 'voting'
            );
            const liveDuel = allActiveDuels[0];
            
            // Champion at risk?
            const championAtRisk = allActiveDuels.some(c => 
                c.challenger_id === champion.id || c.opponent_id === champion.id
            );
            
            // Completed challenges for history
            const completedChallenges = challenges.filter(c => c.status === 'completed' && c.completed_at)
                .sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at));
            const lastDuel = completedChallenges[0];
            
            // Points calculations
            const yourPoints = currentMember.points || 0;
            const championPoints = champion.points || 0;
            const pointsToChampion = championPoints - yourPoints;
            
            // Crown stability
            const secondPlace = rankings[1];
            const crownGap = secondPlace ? (championPoints - (secondPlace.points || 0)) : 999;
            const membersWithinStrike = rankings.filter(m => m.id !== champion.id && (championPoints - m.points) <= 20).length;
            
            // Calculate rivalries
            const rivalries = {};
            completedChallenges.forEach(c => {
                if (!c.winner_id) return;
                const ids = [c.challenger_id, c.opponent_id].sort();
                const key = ids.join('-');
                if (!rivalries[key]) rivalries[key] = { a: ids[0], b: ids[1], aWins: 0, bWins: 0, lastDuel: null };
                if (c.winner_id === ids[0]) rivalries[key].aWins++;
                else rivalries[key].bWins++;
                rivalries[key].lastDuel = c.completed_at;
            });
            
            const hottestRivalry = Object.values(rivalries)
                .filter(r => r.aWins + r.bWins >= 2)
                .sort((a, b) => (b.aWins + b.bWins) - (a.aWins + a.bWins))[0];
            
            // Activity feed (last 5 events) - includes forfeits
            const activityFeed = challenges
                .filter(c => (c.status === 'completed' || c.status === 'forfeited') && c.completed_at)
                .sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at))
                .slice(0, 5)
                .map(c => {
                    const winner = members[c.winner_id];
                    const loserId = c.winner_id === c.challenger_id ? c.opponent_id : c.challenger_id;
                    const loser = members[loserId];
                    const timeAgo = getTimeAgo(new Date(c.completed_at));
                    const wasForfeit = c.status === 'forfeited';
                    return {
                        text: wasForfeit 
                            ? (loser?.name || '?') + ' forfeited to ' + (winner?.name || '?')
                            : (winner?.name || '?') + ' defeated ' + (loser?.name || '?'),
                        detail: c.challenge_type,
                        time: timeAgo,
                        type: wasForfeit ? 'forfeit' : 'battle'
                    };
                });
            
            return `
                <div class="fade-in">
                    <!-- 1Ô∏è‚É£ HEAT INDICATOR -->
                    ${allActiveDuels.length > 0 ? `
                        <div style="background: linear-gradient(90deg, rgba(255, 59, 48, 0.2), rgba(255, 149, 0, 0.2)); border: 1px solid rgba(255, 59, 48, 0.4); border-radius: 10px; padding: 12px 16px; margin-bottom: 16px; animation: pulse 2s infinite;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 14px;">üî•</span>
                                    <span style="font-size: 13px; font-weight: 700; color: #FF3B30;">${allActiveDuels.length} LIVE DUEL${allActiveDuels.length > 1 ? 'S' : ''}</span>
                                </div>
                                ${championAtRisk ? `
                                    <span style="font-size: 11px; color: #FF9500; font-weight: 600;">üëë CROWN AT RISK</span>
                                ` : ''}
                            </div>
                            ${liveDuel ? `
                                <div style="font-size: 12px; color: #FFFFFF; margin-top: 6px;">
                                    ${members[liveDuel.challenger_id]?.name || '?'} vs ${members[liveDuel.opponent_id]?.name || '?'} ‚Ä¢ ${liveDuel.challenge_type}
                                </div>
                            ` : ''}
                        </div>
                    ` : lastDuel ? `
                        <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px; padding: 10px 14px; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 12px; color: #8E8E93;">‚ö° The ladder is exposed‚Ä¶</span>
                                <span style="font-size: 12px; color: #FFFFFF;">üî• Last: ${members[lastDuel.winner_id]?.name || '?'} defeated ${members[lastDuel.winner_id === lastDuel.challenger_id ? lastDuel.opponent_id : lastDuel.challenger_id]?.name || '?'}</span>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- 2Ô∏è‚É£ CHAMPION CARD (Hero Section) -->
                    <div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 165, 0, 0.05)); border: 2px solid rgba(255, 215, 0, 0.4); border-radius: 20px; padding: 24px; margin-bottom: 16px; text-align: center; position: relative; overflow: hidden;">
                        <!-- Subtle glow effect -->
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 200px; background: radial-gradient(circle, rgba(255, 215, 0, 0.1) 0%, transparent 70%); pointer-events: none;"></div>
                        
                        <div style="position: relative; z-index: 1;">
                            <!-- Crown + Avatar -->
                            <div style="font-size: 28px; margin-bottom: -8px; ${champion.streak >= 3 ? 'animation: pulse 1.5s infinite;' : ''}">üëë</div>
                            <div style="font-size: 64px; margin-bottom: 8px;">${champion.avatar}</div>
                            
                            ${isChampion ? `
                                <div style="font-size: 12px; color: #8E8E93; text-transform: uppercase; letter-spacing: 2px;">YOU HOLD THE CROWN</div>
                                <div style="font-size: 24px; font-weight: 900; margin: 8px 0;">${champion.name}</div>
                                ${champion.streak > 0 ? `<div style="font-size: 14px; color: #FF9500; font-weight: 600;">üî• ${champion.streak}-Win Streak</div>` : ''}
                                <div style="font-size: 13px; color: #8E8E93; margin-top: 8px;">
                                    ${membersWithinStrike > 0 ? `${membersWithinStrike} member${membersWithinStrike > 1 ? 's' : ''} within striking distance` : 'The crown must be defended'}
                                </div>
                                <button class="btn btn-primary" style="margin-top: 16px; background: linear-gradient(135deg, #FFD700, #FFA500);" onclick="screen='select-opponent'; render();">
                                    üõ° Defend Your Position
                                </button>
                            ` : `
                                <div style="font-size: 12px; color: #8E8E93; text-transform: uppercase; letter-spacing: 2px;">${champion.name.toUpperCase()} REIGNS</div>
                                <div style="font-size: 28px; font-weight: 900; margin: 8px 0;">${champion.points} pts</div>
                                ${champion.streak > 0 ? `<div style="font-size: 14px; color: #FF9500; font-weight: 600;">üî• ${champion.streak}-Win Streak</div>` : ''}
                                <div style="font-size: 13px; color: #FFFFFF; margin-top: 8px; font-weight: 600;">
                                    You're ${pointsToChampion} pts behind ‚Äî every duel reshapes the ladder
                                </div>
                                <button class="btn btn-primary" style="margin-top: 16px; background: linear-gradient(135deg, #FFD700, #FFA500);" onclick="challengeChampion()">
                                    ‚öîÔ∏è Risk Your Rank
                                </button>
                            `}
                        </div>
                    </div>
                    
                    <!-- 3Ô∏è‚É£ RIVALRY SPOTLIGHT -->
                    ${hottestRivalry ? `
                        <div style="background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 14px; padding: 16px; margin-bottom: 16px;">
                            <div style="font-size: 11px; color: #FF9500; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; font-weight: 700;">üî• HOT RIVALRY</div>
                            <div style="display: flex; align-items: center; justify-content: space-around;">
                                <div style="text-align: center;">
                                    <div style="font-size: 36px;">${members[hottestRivalry.a]?.avatar || 'üë§'}</div>
                                    <div style="font-size: 13px; font-weight: 600; margin-top: 4px;">${members[hottestRivalry.a]?.name || '?'}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: 900; color: #FFFFFF;">${hottestRivalry.aWins} ‚Äì ${hottestRivalry.bWins}</div>
                                    <div style="font-size: 10px; color: #8E8E93; margin-top: 2px;">all-time battles</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 36px;">${members[hottestRivalry.b]?.avatar || 'üë§'}</div>
                                    <div style="font-size: 13px; font-weight: 600; margin-top: 4px;">${members[hottestRivalry.b]?.name || '?'}</div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- 4Ô∏è‚É£ ACTION STRIP -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px;">
                        <button onclick="screen='select-opponent'; render();" style="background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 12px; padding: 14px; color: #FFFFFF; font-size: 14px; font-weight: 700; cursor: pointer;">
                            ‚öîÔ∏è Pick a Target
                        </button>
                        <button onclick="quickRandomDuel()" style="background: linear-gradient(135deg, rgba(175, 82, 222, 0.2), rgba(255, 45, 85, 0.2)); border: 2px solid rgba(175, 82, 222, 0.4); border-radius: 12px; padding: 14px; color: #AF52DE; font-size: 14px; font-weight: 700; cursor: pointer;">
                            üé≤ Quick Random
                        </button>
                    </div>
                    
                    <!-- ACTIVE CHALLENGES SECTION -->
                    ${pendingForYou.length > 0 ? `
                        <div style="background: rgba(255, 59, 48, 0.1); border: 2px solid rgba(255, 59, 48, 0.3); border-radius: 14px; padding: 16px; margin-bottom: 12px;">
                            <div style="font-size: 11px; color: #FF3B30; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-bottom: 12px;">üî• YOU'VE BEEN CHALLENGED</div>
                            ${pendingForYou.map(c => {
                                var deadlineStr = c.deadline_at ? formatCountdown(c.deadline_at) : '';
                                var urgent = c.deadline_at ? isDeadlineUrgent(c.deadline_at) : false;
                                var critical = c.deadline_at ? isDeadlineCritical(c.deadline_at) : false;
                                return `
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                    <div style="font-size: 32px;">${members[c.challenger_id]?.avatar || 'üë§'}</div>
                                    <div style="flex: 1;">
                                        <div style="font-size: 15px; font-weight: 700;">${members[c.challenger_id]?.name || '?'}</div>
                                        <div style="font-size: 13px; color: #8E8E93;">${c.challenge_type}</div>
                                    </div>
                                    ${c.deadline_at ? `
                                        <div style="text-align: right;">
                                            <div data-deadline="${c.deadline_at}" style="font-size: 14px; font-weight: 700; color: ${critical ? '#FF3B30' : urgent ? '#FF9500' : '#FFD700'}; ${critical ? 'animation: pulse 1s infinite;' : ''}">${deadlineStr}</div>
                                            <div style="font-size: 10px; color: #8E8E93;">to respond</div>
                                        </div>
                                    ` : ''}
                                </div>
                                <button class="btn btn-primary" style="width: 100%;" onclick="startResponse('${c.id}')">Defend Your Rank</button>
                            `}).join('')}
                        </div>
                    ` : ''}
                    
                    ${readyChallenges.length > 0 ? `
                        <div style="background: rgba(52, 199, 89, 0.1); border: 2px solid rgba(52, 199, 89, 0.3); border-radius: 14px; padding: 16px; margin-bottom: 12px;">
                            <div style="font-size: 11px; color: #34C759; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-bottom: 12px;">‚ö° SHOWDOWN READY</div>
                            ${readyChallenges.map(c => `
                                <div style="font-size: 15px; font-weight: 700; margin-bottom: 8px;">${c.challenge_type}</div>
                                <button class="btn btn-primary" style="width: 100%;" onclick="initiateJudging('${c.id}')">‚öñÔ∏è Judge Now</button>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    ${myVotingChallenges.length > 0 ? `
                        <div style="background: rgba(255, 215, 0, 0.1); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 14px; padding: 16px; margin-bottom: 12px;">
                            <div style="font-size: 11px; color: #FFD700; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-bottom: 12px;">‚è≥ AWAITING VOTES</div>
                            ${myVotingChallenges.map(c => {
                                const opponent = c.challenger_id === currentMemberId ? members[c.opponent_id] : members[c.challenger_id];
                                const totalVotes = (c.votes_for_challenger || 0) + (c.votes_for_opponent || 0);
                                return `
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                        <span style="font-size: 24px;">${currentMember.avatar}</span>
                                        <span style="font-size: 16px;">‚öîÔ∏è</span>
                                        <span style="font-size: 24px;">${opponent?.avatar || 'üë§'}</span>
                                        <span style="flex: 1; font-size: 12px; color: #8E8E93; text-align: right;">${totalVotes} vote${totalVotes !== 1 ? 's' : ''}</span>
                                    </div>
                                    <button class="btn btn-secondary" style="width: 100%;" onclick="showTwoPersonVoting('${c.id}')">View Duel</button>
                                `;
                            }).join('')}
                        </div>
                    ` : ''}
                    
                    ${waitingForOpponent.length > 0 ? `
                        <div style="background: #1C1C1E; border: 1px solid #2C2C2E; border-radius: 14px; padding: 16px; margin-bottom: 12px;">
                            <div style="font-size: 11px; color: #8E8E93; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-bottom: 8px;">‚è≥ AWAITING RESPONSE</div>
                            ${waitingForOpponent.map(c => {
                                var deadlineStr = c.deadline_at ? formatCountdown(c.deadline_at) : '';
                                var urgent = c.deadline_at ? isDeadlineUrgent(c.deadline_at) : false;
                                return `
                                <div style="display: flex; align-items: center; gap: 8px; padding: 4px 0;">
                                    <span style="font-size: 13px; color: #FFFFFF;">${c.challenge_type} ‚Ä¢ ${members[c.opponent_id]?.name || '?'}</span>
                                    ${c.deadline_at ? `
                                        <span data-deadline="${c.deadline_at}" style="font-size: 12px; font-weight: 600; color: ${urgent ? '#FF9500' : '#8E8E93'}; margin-left: auto;">${deadlineStr}</span>
                                    ` : ''}
                                </div>
                            `}).join('')}
                        </div>
                    ` : ''}
                    
                    <!-- 5Ô∏è‚É£ LADDER SNAPSHOT -->
                    <div style="background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 14px; padding: 16px; margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <span style="font-size: 11px; color: #8E8E93; text-transform: uppercase; letter-spacing: 1px; font-weight: 700;">‚ö° POWER SNAPSHOT</span>
                            <span onclick="goTo('ladder')" style="font-size: 11px; color: #0A84FF; cursor: pointer;">See all ‚Üí</span>
                        </div>
                        ${rankings.slice(0, 3).map((m, i) => `
                            <div style="display: flex; align-items: center; gap: 10px; padding: 8px 0; ${i > 0 ? 'border-top: 1px solid #2C2C2E;' : ''}">
                                <span style="font-size: 14px; font-weight: 700; color: ${i === 0 ? '#FFD700' : '#8E8E93'}; width: 20px;">${i + 1}</span>
                                <span style="font-size: 20px;">${m.avatar}</span>
                                <span style="flex: 1; font-size: 14px; font-weight: 600;">${m.name}${m.id === currentMemberId ? ' (you)' : ''}</span>
                                <span style="font-size: 14px; font-weight: 700; color: #FFD700;">${m.points}</span>
                                ${m.streak > 0 ? `<span style="font-size: 12px; color: #FF9500;">üî•</span>` : `<span style="font-size: 10px; color: #8E8E93;">pts</span>`}
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- 6Ô∏è‚É£ ACTIVITY FEED -->
                    ${activityFeed.length > 0 ? `
                        <div style="background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 14px; padding: 16px;">
                            <div style="font-size: 11px; color: #8E8E93; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-bottom: 12px;">üìú RECENT ACTIVITY</div>
                            ${activityFeed.map((event, i) => `
                                <div style="display: flex; align-items: center; gap: 8px; padding: 6px 0; ${i > 0 ? 'border-top: 1px solid #2C2C2E;' : ''}">
                                    <span style="font-size: 12px; color: ${event.type === 'forfeit' ? '#FF9500' : '#FFFFFF'};">‚Ä¢ ${event.type === 'forfeit' ? '‚ö†Ô∏è' : '‚öîÔ∏è'} ${event.text}</span>
                                    <span style="font-size: 11px; color: #8E8E93; margin-left: auto;">${event.time}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        // Quick random duel function
        function quickRandomDuel() {
            var currentMember = getCurrentMember();
            if (currentMember && currentMember.suspended) {
                showToast('Your account is currently suspended by the admin', 'info');
                return;
            }
            const opponents = Object.values(members).filter(m => m.id !== currentMemberId && !m.suspended);
            if (opponents.length === 0) {
                showToast('No opponents available!', 'error');
                return;
            }
            const randomOpponent = opponents[Math.floor(Math.random() * opponents.length)];
            const randomChallenge = duelChallenges[Math.floor(Math.random() * duelChallenges.length)];
            selectedOpponent = randomOpponent.id;
            selectedChallenge = randomChallenge;
            screen = 'challenge-reveal';
            render();
        }
        
        // Start a weekly squad challenge (all members, not 1:1)
        function startWeeklyChallenge() {
            var now = new Date();
            var weekNumber = Math.floor((now - new Date(now.getFullYear(), 0, 1)) / (7 * 24 * 60 * 60 * 1000));
            var thisWeeksChallenge = weeklyChallenges[weekNumber % weeklyChallenges.length];
            
            showModal(
                'üéØ Weekly Squad Challenge',
                '<div style="text-align: center;">' +
                    '<div style="font-size: 20px; font-weight: 900; margin-bottom: 8px;">' + thisWeeksChallenge.name + '</div>' +
                    '<div style="font-size: 13px; color: #8E8E93; margin-bottom: 16px;">' + thisWeeksChallenge.desc + '</div>' +
                    '<div style="background: rgba(175, 82, 222, 0.1); border: 1px solid rgba(175, 82, 222, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 16px;">' +
                        '<div style="font-size: 12px; color: #AF52DE; font-weight: 600;">HOW IT WORKS</div>' +
                        '<div style="font-size: 12px; color: #8E8E93; margin-top: 6px; line-height: 1.5;">' +
                            '1. All squad members submit entries<br>' +
                            '2. Entries are paired up for head-to-head voting<br>' +
                            '3. Participants in each pairing vote on the winner<br>' +
                            '4. AI breaks any ties<br>' +
                            '5. Winner of each round advances!' +
                        '</div>' +
                    '</div>' +
                    '<div style="font-size: 11px; color: #8E8E93;">Type: ' + (thisWeeksChallenge.type === 'video' ? 'üìπ Video' : 'üì∏ Photo') + ' ‚Ä¢ Time: ' + thisWeeksChallenge.time + '</div>' +
                '</div>',
                'Cancel',
                'Submit My Entry',
                function() {
                    closeModal();
                    // Set up challenge for submission
                    var now2 = new Date();
                    var weekNumber2 = Math.floor((now2 - new Date(now2.getFullYear(), 0, 1)) / (7 * 24 * 60 * 60 * 1000));
                    var weeklyChallenge = weeklyChallenges[weekNumber2 % weeklyChallenges.length];
                    selectedChallenge = weeklyChallenge;
                    selectedOpponent = null; // Will be matched later
                    window.isWeeklySubmission = true;
                    screen = 'submit-weekly';
                    render();
                },
                function() { closeModal(); }
            );
        }
        
        // Time ago helper
        function getTimeAgo(date) {
            const seconds = Math.floor((Date.now() - date) / 1000);
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return minutes + 'm ago';
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return hours + 'h ago';
            const days = Math.floor(hours / 24);
            return days + 'd ago';
        }
        
        // ============================================
        // v21: DEADLINE & FORFEIT SYSTEM
        // ============================================
        
        // Check for expired challenges and handle forfeits
        async function checkForForfeits() {
            if (!squadId || !currentMemberId) return;
            
            var now = new Date();
            var expiredChallenges = challenges.filter(function(c) {
                return c.status === 'waiting' && c.deadline_at && new Date(c.deadline_at) < now;
            });
            
            for (var i = 0; i < expiredChallenges.length; i++) {
                var c = expiredChallenges[i];
                await handleForfeit(c);
            }
            
            if (expiredChallenges.length > 0) {
                await loadSquadData();
                render();
            }
        }
        
        async function handleForfeit(challenge) {
            // The opponent (who didn't respond) forfeits
            var forfeiterId = challenge.opponent_id;
            var winnerId = challenge.challenger_id;
            var forfeiter = members[forfeiterId];
            var winner = members[winnerId];
            
            if (!forfeiter || !winner) return;
            
            // Check grace: has this person forfeited this week already?
            var startOfWeek = getStartOfWeek();
            var hasUsedGrace = false;
            try {
                var result = await db
                    .from('challenges')
                    .select('id')
                    .eq('squad_id', squadId)
                    .eq('opponent_id', forfeiterId)
                    .eq('status', 'forfeited')
                    .gte('completed_at', startOfWeek.toISOString());
                
                hasUsedGrace = result.data && result.data.length > 0;
            } catch (e) {
                console.log('Grace check failed, defaulting to no grace used');
            }
            
            // Update challenge status
            await db
                .from('challenges')
                .update({
                    status: 'forfeited',
                    winner_id: winnerId,
                    completed_at: new Date().toISOString(),
                    forfeit_grace: !hasUsedGrace
                })
                .eq('id', challenge.id);
            
            // Winner always gets points
            await db
                .from('members')
                .update({
                    points: (winner.points || 0) + WIN_POINTS,
                    streak: (winner.streak || 0) + 1,
                    all_time_wins: (winner.all_time_wins || 0) + 1
                })
                .eq('id', winnerId);
            
            if (hasUsedGrace) {
                // Second+ forfeit this week: real penalty
                var newPoints = Math.max(0, (forfeiter.points || 0) - FORFEIT_POINTS);
                await db
                    .from('members')
                    .update({
                        points: newPoints,
                        streak: 0
                    })
                    .eq('id', forfeiterId);
                
                console.log('‚ö†Ô∏è Forfeit with penalty:', forfeiter.name, '-' + FORFEIT_POINTS + ' pts');
            } else {
                // First forfeit this week: grace ‚Äî just reset streak
                await db
                    .from('members')
                    .update({ streak: 0 })
                    .eq('id', forfeiterId);
                
                console.log('‚ö†Ô∏è Forfeit with grace (no penalty):', forfeiter.name);
            }
        }
        
        // Format remaining time as countdown string
        function formatCountdown(deadline) {
            var now = new Date();
            var target = new Date(deadline);
            var diff = target - now;
            
            if (diff <= 0) return 'EXPIRED';
            
            var hours = Math.floor(diff / (1000 * 60 * 60));
            var minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (hours > 0) {
                return hours + 'h ' + minutes + 'm';
            }
            return minutes + 'm';
        }
        
        // Format countdown for weekly challenge  
        function formatWeeklyCountdown(endOfWeek) {
            var now = new Date();
            var diff = endOfWeek - now;
            
            if (diff <= 0) return 'Ended';
            
            var days = Math.floor(diff / (1000 * 60 * 60 * 24));
            var hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            var minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (days > 0) return days + 'd ' + hours + 'h';
            if (hours > 0) return hours + 'h ' + minutes + 'm';
            return minutes + 'm';
        }
        
        // Is deadline urgent? (under 4 hours)
        function isDeadlineUrgent(deadline) {
            var diff = new Date(deadline) - new Date();
            return diff > 0 && diff < (4 * 60 * 60 * 1000);
        }
        
        // Is deadline critical? (under 1 hour)
        function isDeadlineCritical(deadline) {
            var diff = new Date(deadline) - new Date();
            return diff > 0 && diff < (60 * 60 * 1000);
        }
        
        // Start ticking countdown timers on screen
        function startCountdownTimers() {
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(function() {
                // Update all visible countdown elements
                var els = document.querySelectorAll('[data-deadline]');
                els.forEach(function(el) {
                    var deadline = el.getAttribute('data-deadline');
                    var remaining = formatCountdown(deadline);
                    el.textContent = remaining;
                    
                    // Color coding
                    if (remaining === 'EXPIRED') {
                        el.style.color = '#FF3B30';
                    } else if (isDeadlineCritical(deadline)) {
                        el.style.color = '#FF3B30';
                        el.style.animation = 'pulse 1s infinite';
                    } else if (isDeadlineUrgent(deadline)) {
                        el.style.color = '#FF9500';
                    }
                });
                
                // Update weekly timer
                var weeklyEl = document.getElementById('weeklyCountdown');
                if (weeklyEl) {
                    var endOfWeek = new Date(weeklyEl.getAttribute('data-end'));
                    weeklyEl.textContent = formatWeeklyCountdown(endOfWeek);
                }
            }, 15000); // Every 15 seconds
        }
        
        // ============================================
        // v21: "WHILE YOU WERE AWAY" RETURN SCREEN
        // ============================================
        
        function buildReturnReport() {
            if (!lastSeenAt || !challenges || challenges.length === 0) return null;
            
            var lastSeen = new Date(lastSeenAt);
            var now = new Date();
            var hoursSinceLastSeen = (now - lastSeen) / (1000 * 60 * 60);
            
            // Only show if gone for 30+ minutes
            if (hoursSinceLastSeen < 0.5) return null;
            
            var events = [];
            var currentMember = getCurrentMember();
            if (!currentMember) return null;
            
            // Find challenges completed since last seen
            var recentCompleted = challenges.filter(function(c) {
                return (c.status === 'completed' || c.status === 'forfeited') && 
                       c.completed_at && new Date(c.completed_at) > lastSeen;
            });
            
            // Rank changes
            var rankings = Object.values(members).sort(function(a, b) { return b.points - a.points; });
            var yourRank = rankings.findIndex(function(m) { return m.id === currentMemberId; }) + 1;
            
            // Who passed you?
            recentCompleted.forEach(function(c) {
                var winner = members[c.winner_id];
                var loserId = c.winner_id === c.challenger_id ? c.opponent_id : c.challenger_id;
                var loser = members[loserId];
                
                if (!winner || !loser) return;
                
                if (c.status === 'forfeited') {
                    events.push({
                        icon: '‚ö†Ô∏è',
                        text: (loser.name) + ' forfeited to ' + (winner.name),
                        color: '#FF9500'
                    });
                } else if (winner.streak >= 3) {
                    events.push({
                        icon: 'üî•',
                        text: (winner.name) + ' extended streak to ' + winner.streak,
                        color: '#FF9500'
                    });
                } else {
                    events.push({
                        icon: '‚öîÔ∏è',
                        text: (winner.name) + ' defeated ' + (loser.name),
                        color: '#FFFFFF'
                    });
                }
            });
            
            // Pending challenges for you with deadlines
            var pendingForYou = challenges.filter(function(c) {
                return c.status === 'waiting' && c.opponent_id === currentMemberId && c.deadline_at;
            });
            
            pendingForYou.forEach(function(c) {
                var challenger = members[c.challenger_id];
                var remaining = formatCountdown(c.deadline_at);
                events.push({
                    icon: '‚è≥',
                    text: remaining + ' to respond to ' + (challenger ? challenger.name : '?'),
                    color: isDeadlineUrgent(c.deadline_at) ? '#FF3B30' : '#FFD700',
                    urgent: isDeadlineUrgent(c.deadline_at)
                });
            });
            
            // Rank position change
            if (rankings.length > 1) {
                var above = rankings[yourRank - 2]; // person above you
                var below = rankings[yourRank]; // person below you
                if (above && above.id !== currentMemberId) {
                    var gap = above.points - currentMember.points;
                    if (gap <= 15) {
                        events.push({
                            icon: '‚¨ÜÔ∏è',
                            text: above.name + ' is only ' + gap + ' pts above you',
                            color: '#34C759'
                        });
                    }
                }
            }
            
            if (events.length === 0) return null;
            return events;
        }
        
        function renderReturnScreen(events) {
            var html = '<div class="fade-in" style="padding: 20px;">';
            html += '<div style="text-align: center; margin-bottom: 24px;">';
            html += '<div style="font-size: 12px; color: #8E8E93; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px;">WHILE YOU WERE AWAY</div>';
            html += '<div style="width: 40px; height: 2px; background: linear-gradient(90deg, #FFD700, #FF9500); margin: 0 auto;"></div>';
            html += '</div>';
            
            html += '<div style="background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 14px; padding: 16px; margin-bottom: 24px;">';
            
            events.forEach(function(event, i) {
                var borderTop = i > 0 ? 'border-top: 1px solid #2C2C2E; padding-top: 10px; margin-top: 10px;' : '';
                html += '<div style="display: flex; align-items: center; gap: 10px; ' + borderTop + '">';
                html += '<span style="font-size: 16px; flex-shrink: 0;">' + event.icon + '</span>';
                html += '<span style="font-size: 14px; font-weight: 600; color: ' + event.color + '; flex: 1;">' + event.text + '</span>';
                html += '</div>';
            });
            
            html += '</div>';
            
            html += '<button class="btn btn-primary" style="width: 100%;" onclick="dismissReturnScreen()">Enter the Arena</button>';
            html += '</div>';
            return html;
        }
        
        function dismissReturnScreen() {
            hasSeenReturnScreen = true;
            lastSeenAt = new Date().toISOString();
            localStorage.setItem('lastSeenAt', lastSeenAt);
            screen = 'arena';
            render();
        }
        
        // Keep old function name for backward compatibility
        function renderHome() {
            return renderArena();
        }
        
        
        function renderSelectOpponent() {
            const opponents = Object.values(members).filter(m => m.id !== currentMemberId && !m.suspended);
            
            return `
                <div class="fade-in">
                    <button class="back-btn" onclick="screen='arena'; render();">‚Üê Back</button>
                    
                    <div class="section-title">‚öîÔ∏è Select Opponent</div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 24px;">
                        ${opponents.map(m => `
                            <div onclick="selectOpponent('${m.id}')" style="background: ${selectedOpponent === m.id ? 'rgba(212, 175, 55, 0.1)' : '#1C1C1E'}; border: 2px solid ${selectedOpponent === m.id ? '#D4AF37' : '#2C2C2E'}; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer;">
                                <div style="font-size: 48px; margin-bottom: 12px;">${m.avatar}</div>
                                <div style="font-size: 15px; font-weight: 600;">${m.name}</div>
                                <div style="font-size: 12px; color: #8E8E93;">${m.points} pts</div>
                            </div>
                        `).join('')}
                    </div>

                    <button class="btn btn-primary ${!selectedOpponent ? 'hidden' : ''}" onclick="getRandomChallenge()">
                        Start Challenge
                    </button>
                </div>
            `;
        }
        
        function selectOpponent(id) {
            // Check if opponent is suspended
            var opponent = members[id];
            if (opponent && opponent.suspended) {
                showToast(opponent.name + ' is currently suspended', 'info');
                return;
            }
            selectedOpponent = id;
            sounds.click();
            render();
        }
        
        function getRandomChallenge() {
            sounds.click();
            selectedChallenge = challengeLibrary[Math.floor(Math.random() * challengeLibrary.length)];
            screen = 'challenge-reveal';
            render();
        }
        
        function renderChallengeReveal() {
            if (!selectedChallenge) return '';
            
            const isVideo = selectedChallenge.type === 'video';
            const opponent = members[selectedOpponent];
            
            return `
                <div class="fade-in" style="min-height: 80vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; text-align: center;">
                    <div style="font-size: 64px; margin-bottom: 24px;">üé≤</div>
                    
                    <h2 style="font-size: 24px; font-weight: 900; margin-bottom: 8px; color: #FFD700;">YOUR CHALLENGE</h2>
                    <p style="font-size: 14px; color: #8E8E93; margin-bottom: 32px;">Challenging ${opponent?.name || 'opponent'}</p>
                    
                    <div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 165, 0, 0.05)); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 20px; padding: 32px 24px; margin-bottom: 32px; max-width: 400px;">
                        <div style="font-size: 22px; font-weight: 900; line-height: 1.4; color: #FFFFFF; margin-bottom: 16px;">
                            ${selectedChallenge.name}
                        </div>
                        
                        <div style="display: flex; gap: 12px; justify-content: center; align-items: center;">
                            <div style="background: ${isVideo ? 'rgba(10, 132, 255, 0.2)' : 'rgba(52, 199, 89, 0.2)'}; color: ${isVideo ? '#0A84FF' : '#34C759'}; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 700;">
                                ${isVideo ? 'üìπ VIDEO' : 'üì∏ PHOTO'}
                            </div>
                            ${selectedChallenge.time ? `
                                <div style="background: rgba(255, 255, 255, 0.1); color: #A1A1A6; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 700;">
                                    ‚è±Ô∏è ${selectedChallenge.time}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 12px; width: 100%; max-width: 320px;">
                        <button class="btn btn-primary" onclick="screen='submit-media'; render();">
                            Accept Challenge
                        </button>
                        <button class="btn btn-secondary" onclick="getRandomChallenge();">
                            Skip & Get New
                        </button>
                        <button style="background: none; border: none; color: #8E8E93; font-size: 13px; cursor: pointer; margin-top: 8px;" onclick="screen='select-opponent'; selectedChallenge=null; render();">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
        }
        
        function renderSubmitMedia() {
            if (!selectedChallenge) return '';
            
            const isVideo = selectedChallenge.type === 'video';
            const opponent = members[selectedOpponent];
            
            return `
                <button class="back-btn" onclick="screen='challenge-reveal'; selectedMedia=null; window._pendingFile=null; render();">‚Üê Back</button>
                
                <div class="fade-in">
                    <div style="background: #1C1C1E; border: 2px solid #D4AF37; border-radius: 16px; padding: 24px; text-align: center; margin-bottom: 24px;">
                        <div style="display: inline-block; background: rgba(212, 175, 55, 0.15); color: #D4AF37; padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 700; margin-bottom: 12px;">
                            ‚öîÔ∏è CHALLENGE vs ${opponent?.name || 'Opponent'}
                        </div>
                        <div style="font-size: 24px; font-weight: 900; margin-bottom: 8px;">${selectedChallenge.name}</div>
                        <div style="font-size: 14px; color: #8E8E93;">${selectedChallenge.desc}</div>
                    </div>

                    ${!selectedMedia ? `
                        <div class="upload-zone" onclick="document.getElementById('mediaInput').click();">
                            <div style="font-size: 48px; margin-bottom: 16px;">${isVideo ? 'üìπ' : 'üì∏'}</div>
                            <div style="font-size: 15px; font-weight: 600; margin-bottom: 4px;">
                                ${isVideo ? 'Record Video' : 'Take Photo'}
                            </div>
                            <div style="font-size: 13px; color: #8E8E93;">
                                Tap to capture
                            </div>
                        </div>

                        <input type="file" 
                               id="mediaInput" 
                               accept="${isVideo ? 'video/mp4,video/quicktime,video/*' : 'image/*'}" 
                               ${isVideo ? '' : 'capture="environment"'}
                               onchange="handleMediaUpload(event, '${isVideo ? 'video' : 'photo'}')" 
                               style="display: none;">
                    ` : `
                        <div style="margin-bottom: 24px;">
                            ${mediaType === 'video' ? 
                                `<video src="${selectedMedia}" class="preview-media" controls></video>` :
                                `<img src="${selectedMedia}" class="preview-media">`
                            }
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <button class="btn btn-secondary" onclick="selectedMedia=null; window._pendingFile=null; render();">
                                Retake
                            </button>
                            <button class="btn btn-primary" id="submitBtn" onclick="handleSubmitChallenge()">
                                Submit
                            </button>
                        </div>
                    `}
                </div>
            `;
        }
        
        function renderSubmitWeekly() {
            if (!selectedChallenge) return '';
            
            var isVideo = selectedChallenge.type === 'video';
            
            var html = '<button class="back-btn" onclick="screen=\'ladder\'; selectedMedia=null; window._pendingFile=null; window.isWeeklySubmission=false; render();">‚Üê Back</button>';
            html += '<div class="fade-in">';
            html += '<div style="background: linear-gradient(135deg, rgba(175, 82, 222, 0.15), rgba(255, 45, 85, 0.05)); border: 2px solid rgba(175, 82, 222, 0.4); border-radius: 16px; padding: 24px; text-align: center; margin-bottom: 24px;">';
            html += '<div style="display: inline-block; background: rgba(175, 82, 222, 0.2); color: #AF52DE; padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 700; margin-bottom: 12px;">üéØ WEEKLY SQUAD CHALLENGE</div>';
            html += '<div style="font-size: 24px; font-weight: 900; margin-bottom: 8px;">' + selectedChallenge.name + '</div>';
            html += '<div style="font-size: 14px; color: #8E8E93;">' + selectedChallenge.desc + '</div>';
            html += '</div>';
            
            if (!selectedMedia) {
                html += '<div class="upload-zone" onclick="document.getElementById(\'weeklyMediaInput\').click();">';
                html += '<div style="font-size: 48px; margin-bottom: 16px;">' + (isVideo ? 'üìπ' : 'üì∏') + '</div>';
                html += '<div style="font-size: 15px; font-weight: 600; margin-bottom: 4px;">' + (isVideo ? 'Record Video' : 'Take Photo') + '</div>';
                html += '<div style="font-size: 13px; color: #8E8E93;">Tap to capture your entry</div>';
                html += '</div>';
                html += '<input type="file" id="weeklyMediaInput" accept="' + (isVideo ? 'video/mp4,video/quicktime,video/*' : 'image/*') + '" ' + (isVideo ? '' : 'capture="environment"') + ' onchange="handleMediaUpload(event, \'' + (isVideo ? 'video' : 'photo') + '\')" style="display: none;">';
            } else {
                html += '<div style="margin-bottom: 24px;">';
                if (mediaType === 'video') {
                    html += '<video src="' + selectedMedia + '" class="preview-media" controls></video>';
                } else {
                    html += '<img src="' + selectedMedia + '" class="preview-media">';
                }
                html += '</div>';
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">';
                html += '<button class="btn btn-secondary" onclick="selectedMedia=null; window._pendingFile=null; render();">Retake</button>';
                html += '<button class="btn btn-primary" id="submitBtn" onclick="handleSubmitWeekly()">Submit Entry</button>';
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }
        
        async function handleSubmitWeekly() {
            if (isSubmitting) return;
            isSubmitting = true;
            
            var btn = document.getElementById('submitBtn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading-spinner"></span> Uploading...';
            }
            
            try {
                var fileToUpload = window._pendingFile || selectedMedia;
                var challengeId = 'weekly_' + Date.now();
                
                var mediaUrl = await uploadMedia(fileToUpload, challengeId, 'entry');
                
                // Store the weekly submission (uses challenges table with weekly flag)
                var result = await db
                    .from('challenges')
                    .insert({
                        squad_id: squadId,
                        challenge_type: selectedChallenge.name,
                        challenge_desc: selectedChallenge.desc,
                        challenge_time: selectedChallenge.time,
                        challenger_id: currentMemberId,
                        opponent_id: null,
                        challenger_media_url: mediaUrl,
                        challenger_media_type: mediaType,
                        status: 'weekly_entry',
                        is_weekly: true
                    })
                    .select()
                    .single();
                
                if (result.error) throw result.error;
                
                sounds.challenge();
                
                if (selectedMedia && selectedMedia.startsWith('blob:')) {
                    URL.revokeObjectURL(selectedMedia);
                }
                
                showModal(
                    'üéØ Entry Submitted!',
                    '<div style="text-align: center;">' +
                        '<div style="font-size: 64px; margin-bottom: 16px;">‚úÖ</div>' +
                        '<p style="margin-bottom: 16px;">Your weekly challenge entry has been submitted!</p>' +
                        '<p style="font-size: 13px; color: #8E8E93;">When all members submit, entries will be paired for head-to-head voting. Participants vote, AI breaks ties.</p>' +
                    '</div>',
                    null,
                    'Done',
                    function() {
                        closeModal();
                        screen = 'ladder';
                        selectedMedia = null;
                        selectedChallenge = null;
                        window._pendingFile = null;
                        window.isWeeklySubmission = false;
                        isSubmitting = false;
                        render();
                    }
                );
            } catch (err) {
                console.error('Weekly submit error:', err);
                alert('Failed to submit: ' + (err.message || 'Upload failed'));
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'Submit Entry';
                }
                isSubmitting = false;
            }
        }
        
        function handleMediaUpload(event, type) {
            var file = event.target.files[0];
            if (!file) return;
            
            // Check file size (limit to 50MB for videos, 10MB for images)
            var maxSize = type === 'video' ? 50 * 1024 * 1024 : 10 * 1024 * 1024;
            if (file.size > maxSize) {
                alert('File too large! Maximum size is ' + (type === 'video' ? '50MB' : '10MB'));
                return;
            }
            
            console.log('Media selected:', { type: type, size: (file.size / 1024 / 1024).toFixed(2) + 'MB', name: file.name });
            
            // Store the raw file for upload (avoids iOS base64 issues)
            window._pendingFile = file;
            
            // For preview, use object URL (much faster than base64, avoids iOS memory issues)
            var objectUrl = URL.createObjectURL(file);
            selectedMedia = objectUrl;
            mediaType = type;
            console.log('Media loaded into preview via objectURL');
            render();
        }
        
        async function handleSubmitChallenge() {
            if (isSubmitting) return;
            isSubmitting = true;
            
            console.log('Starting submission...', { mediaType: mediaType, hasMedia: !!selectedMedia, hasRawFile: !!window._pendingFile });
            
            var btn = document.getElementById('submitBtn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading-spinner"></span> Uploading...';
            }
            
            try {
                // Use the raw file if available, otherwise fall back to selectedMedia
                var fileToUpload = window._pendingFile || selectedMedia;
                
                // Check if this is a response to existing challenge
                if (window.currentChallengeId) {
                    console.log('Submitting response to challenge:', window.currentChallengeId);
                    
                    // Upload media
                    var mediaUrl = await uploadMedia(fileToUpload, window.currentChallengeId, 'opponent');
                    console.log('Media uploaded for response');
                    
                    // Update challenge with response
                    await respondToChallenge(window.currentChallengeId, mediaUrl, mediaType);
                    console.log('Challenge response recorded');
                    
                    // Show success and go to showdown
                    sounds.challenge();
                    
                    // Reload to get updated challenge
                    await loadSquadData();
                    
                    // Clean up object URLs
                    if (selectedMedia && selectedMedia.startsWith('blob:')) {
                        URL.revokeObjectURL(selectedMedia);
                    }
                    
                    showShowdown(window.currentChallengeId);
                    window.currentChallengeId = null;
                } else {
                    // New challenge
                    var challengeId = 'ch_' + Date.now();
                    
                    // Upload media
                    var mediaUrl = await uploadMedia(fileToUpload, challengeId, 'challenger');
                    
                    // Create challenge
                    await createChallenge(
                        selectedOpponent,
                        selectedChallenge.name,
                        selectedChallenge.desc,
                        selectedChallenge.time,
                        mediaUrl,
                        mediaType
                    );
                    
                    sounds.challenge();
                    
                    // Clean up object URLs
                    if (selectedMedia && selectedMedia.startsWith('blob:')) {
                        URL.revokeObjectURL(selectedMedia);
                    }
                    
                    var opponentName = members[selectedOpponent] ? members[selectedOpponent].name : 'opponent';
                    
                    // Show confirmation
                    showModal(
                        '‚öîÔ∏è Challenge Sent!',
                        '<div style="text-align: center;">' +
                            '<div style="font-size: 64px; margin-bottom: 16px;">üì§</div>' +
                            '<p style="margin-bottom: 16px;">Your challenge has been sent to <strong>' + opponentName + '</strong>!</p>' +
                            '<p style="font-size: 13px; color: #8E8E93;">They\'ll need to submit their response. You\'ll be notified when the showdown is ready.</p>' +
                        '</div>',
                        null,
                        'Done',
                        function() {
                            closeModal();
                            screen = 'arena';
                            selectedMedia = null;
                            selectedChallenge = null;
                            selectedOpponent = null;
                            window._pendingFile = null;
                            isSubmitting = false;
                            render();
                        }
                    );
                }
            } catch (err) {
                console.error('Submit error:', err);
                alert('Failed to submit: ' + (err.message || 'Upload failed. Please try a smaller file or check your connection.'));
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'Submit';
                }
                isSubmitting = false;
            }
        }
        
        function startResponse(challengeId) {
            const challenge = challenges.find(c => c.id === challengeId);
            if (!challenge) return;
            
            window.currentChallengeId = challengeId;
            selectedChallenge = {
                name: challenge.challenge_type,
                desc: challenge.challenge_desc,
                time: challenge.challenge_time,
                type: challenge.challenger_media_type
            };
            selectedOpponent = challenge.challenger_id;
            
            screen = 'submit-media';
            render();
        }
        
        async function initiateJudging(challengeId) {
            // Reload to get latest status
            await loadSquadData();
            
            var challenge = challenges.find(function(c) { return c.id === challengeId; });
            if (!challenge) return;
            
            // Check if already completed
            if (challenge.status === 'completed') {
                showCompletedChallenge(challengeId);
                return;
            }
            
            // ALL challenges: Both participants vote, ties go to AI
            try {
                await db
                    .from('challenges')
                    .update({
                        status: 'voting',
                        voting_ends_at: new Date(Date.now() + 60 * 60 * 1000).toISOString()
                    })
                    .eq('id', challengeId);
                
                await loadSquadData();
                
                // Show voting screen for this user
                showTwoPersonVoting(challengeId);
            } catch (err) {
                console.error('Failed to open voting:', err);
                alert('Failed to start showdown');
            }
        }
        
        async function showTwoPersonVoting(challengeId) {
            await loadSquadData();
            
            const challenge = challenges.find(c => c.id === challengeId);
            if (!challenge) {
                screen = 'arena';
                render();
                return;
            }
            
            // Check if already completed (other person voted and triggered completion)
            if (challenge.status === 'completed') {
                showCompletedChallenge(challengeId);
                return;
            }
            
            // Check if already voted (handle case where no vote exists)
            let existingVote = null;
            try {
                const { data, error } = await db
                    .from('votes')
                    .select('*')
                    .eq('challenge_id', challengeId)
                    .eq('voter_id', currentMemberId)
                    .maybeSingle(); // Use maybeSingle instead of single to avoid 406 error
                
                if (!error) existingVote = data;
            } catch (err) {
                // Ignore error - means no vote exists
                console.log('No existing vote found');
            }
            
            if (existingVote) {
                // Already voted - check if other person voted too
                const totalVotes = (challenge.votes_for_challenger || 0) + (challenge.votes_for_opponent || 0);
                if (totalVotes >= 2) {
                    // Both voted - determine winner
                    await determineTwoPersonWinner(challengeId);
                } else {
                    showModal(
                        '‚è≥ Waiting for Opponent',
                        `<div style="text-align: center;">
                            <p>You've cast your vote!</p>
                            <p style="font-size: 13px; color: #8E8E93; margin-top: 12px;">Waiting for your opponent to vote...</p>
                        </div>`,
                        null,
                        'OK',
                        () => { closeModal(); screen = 'arena'; render(); }
                    );
                }
                return;
            }
            
            const challenger = members[challenge.challenger_id];
            const opponent = members[challenge.opponent_id];
            
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            overlay.id = 'votingOverlay';
            
            overlay.innerHTML = `
                <div class="reveal-container" style="max-width: 600px;">
                    <div style="font-size: 13px; color: #FFD700; font-weight: 700; letter-spacing: 1px; margin-bottom: 8px;">‚öîÔ∏è SHOWDOWN</div>
                    <div style="font-size: 20px; font-weight: 700; margin-bottom: 8px;">${challenge.challenge_type}</div>
                    <div style="font-size: 13px; color: #8E8E93; margin-bottom: 24px;">Both players vote ‚Ä¢ Ties go to AI judge</div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 32px;">
                        <div style="text-align: center;">
                            ${challenge.challenger_media_type === 'video' ?
                                `<video src="${challenge.challenger_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid #3C3C3E;" controls playsinline></video>` :
                                `<img src="${challenge.challenger_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid #3C3C3E;">`
                            }
                            <div style="margin-top: 12px;">
                                <div style="font-size: 32px;">${challenger?.avatar || 'üë§'}</div>
                                <div style="font-size: 15px; font-weight: 600;">${challenger?.name || 'Challenger'}</div>
                            </div>
                            <button class="btn btn-secondary" style="margin-top: 12px;" onclick="castTwoPersonVote('${challengeId}', '${challenge.challenger_id}')">
                                Vote ${challenger?.name || 'Challenger'}
                            </button>
                        </div>
                        
                        <div style="text-align: center;">
                            ${challenge.opponent_media_type === 'video' ?
                                `<video src="${challenge.opponent_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid #3C3C3E;" controls playsinline></video>` :
                                `<img src="${challenge.opponent_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid #3C3C3E;">`
                            }
                            <div style="margin-top: 12px;">
                                <div style="font-size: 32px;">${opponent?.avatar || 'üë§'}</div>
                                <div style="font-size: 15px; font-weight: 600;">${opponent?.name || 'Opponent'}</div>
                            </div>
                            <button class="btn btn-secondary" style="margin-top: 12px;" onclick="castTwoPersonVote('${challengeId}', '${challenge.opponent_id}')">
                                Vote ${opponent?.name || 'Opponent'}
                            </button>
                        </div>
                    </div>
                    
                    <button style="background: none; border: none; color: #8E8E93; font-size: 13px; cursor: pointer;" onclick="closeVotingOverlay()">
                        Cancel
                    </button>
                </div>
            `;
            
            document.body.appendChild(overlay);
        }
        
        async function castTwoPersonVote(challengeId, voteForId) {
            const overlay = document.getElementById('votingOverlay');
            
            overlay.innerHTML = `
                <div class="reveal-container">
                    <div style="font-size: 64px; margin-bottom: 24px; animation: pulse 1s ease-in-out infinite;">üó≥Ô∏è</div>
                    <div style="font-size: 24px; font-weight: 700; color: #8E8E93;">
                        Recording vote...
                    </div>
                </div>
            `;
            
            try {
                const challenge = challenges.find(c => c.id === challengeId);
                
                // Record vote
                await db
                    .from('votes')
                    .insert({
                        challenge_id: challengeId,
                        voter_id: currentMemberId,
                        vote_for: voteForId
                    });
                
                // Update vote counts
                const isVoteForChallenger = voteForId === challenge.challenger_id;
                await db
                    .from('challenges')
                    .update({
                        votes_for_challenger: (challenge.votes_for_challenger || 0) + (isVoteForChallenger ? 1 : 0),
                        votes_for_opponent: (challenge.votes_for_opponent || 0) + (isVoteForChallenger ? 0 : 1)
                    })
                    .eq('id', challengeId);
                
                // Reload to check if both have voted
                await loadSquadData();
                const updatedChallenge = challenges.find(c => c.id === challengeId);
                const totalVotes = (updatedChallenge.votes_for_challenger || 0) + (updatedChallenge.votes_for_opponent || 0);
                
                if (totalVotes >= 2) {
                    // Both voted - determine winner
                    await determineTwoPersonWinner(challengeId);
                } else {
                    // Waiting for other person
                    overlay.innerHTML = `
                        <div class="reveal-container">
                            <div style="font-size: 64px; margin-bottom: 24px;">‚úÖ</div>
                            <div style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">Vote Cast!</div>
                            <div style="font-size: 14px; color: #8E8E93; margin-bottom: 24px;">Waiting for your opponent to vote...</div>
                            <button class="btn btn-primary" onclick="closeVotingOverlay()">OK</button>
                        </div>
                    `;
                }
                
                sounds.click();
            } catch (err) {
                console.error('Vote error:', err);
                alert('Failed to cast vote: ' + (err.message || 'Unknown error'));
                closeVotingOverlay();
            }
        }
        
        async function determineTwoPersonWinner(challengeId) {
            // Reload to get latest
            await loadSquadData();
            
            const challenge = challenges.find(c => c.id === challengeId);
            if (!challenge) return;
            
            // Check if already completed (prevent double completion)
            if (challenge.status === 'completed') {
                showCompletedChallenge(challengeId);
                return;
            }
            
            const votesChallenger = challenge.votes_for_challenger || 0;
            const votesOpponent = challenge.votes_for_opponent || 0;
            const challenger = members[challenge.challenger_id];
            const opponent = members[challenge.opponent_id];
            
            // Get current champion BEFORE the result
            const rankingsBefore = Object.values(members).sort((a, b) => b.points - a.points);
            const championBefore = rankingsBefore[0];
            
            const overlay = document.getElementById('votingOverlay') || document.createElement('div');
            if (!overlay.id) {
                overlay.className = 'overlay';
                overlay.id = 'votingOverlay';
                document.body.appendChild(overlay);
            }
            
            // ========== DRAMATIC VOTE REVEAL ==========
            overlay.innerHTML = `
                <div class="reveal-container">
                    <div style="font-size: 48px; margin-bottom: 16px;">üó≥Ô∏è</div>
                    <div style="font-size: 28px; font-weight: 900; color: #FFD700;">THE VOTES ARE IN</div>
                    <div style="font-size: 14px; color: #8E8E93; margin-top: 8px;">Revealing in...</div>
                    <div id="countdown" style="font-size: 72px; font-weight: 900; margin-top: 16px;">3</div>
                </div>
            `;
            
            // Countdown
            await sleep(1000);
            document.getElementById('countdown').textContent = '2';
            await sleep(1000);
            document.getElementById('countdown').textContent = '1';
            await sleep(1000);
            
            // Show vote breakdown dramatically
            overlay.innerHTML = `
                <div class="reveal-container" style="max-width: 400px;">
                    <div style="font-size: 20px; font-weight: 700; margin-bottom: 24px; color: #8E8E93;">VOTE BREAKDOWN</div>
                    
                    <div style="display: flex; justify-content: space-around; align-items: center; margin-bottom: 32px;">
                        <div style="text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 8px;">${challenger?.avatar || 'üë§'}</div>
                            <div style="font-size: 15px; font-weight: 600;">${challenger?.name}</div>
                            <div id="voteCount1" style="font-size: 48px; font-weight: 900; color: #FFD700; margin-top: 8px;">?</div>
                        </div>
                        
                        <div style="font-size: 24px; color: #8E8E93;">vs</div>
                        
                        <div style="text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 8px;">${opponent?.avatar || 'üë§'}</div>
                            <div style="font-size: 15px; font-weight: 600;">${opponent?.name}</div>
                            <div id="voteCount2" style="font-size: 48px; font-weight: 900; color: #FFD700; margin-top: 8px;">?</div>
                        </div>
                    </div>
                    
                    <div style="font-size: 14px; color: #8E8E93;">Revealing votes...</div>
                </div>
            `;
            
            await sleep(800);
            document.getElementById('voteCount1').textContent = votesChallenger;
            sounds.click();
            await sleep(800);
            document.getElementById('voteCount2').textContent = votesOpponent;
            sounds.click();
            await sleep(500);
            
            // Determine winner
            let winnerId, isTie = false;
            if (votesChallenger === votesOpponent) {
                isTie = true;
                // Show tie moment
                overlay.querySelector('.reveal-container').innerHTML += `
                    <div style="font-size: 24px; font-weight: 900; color: #FF9500; margin-top: 24px; animation: pulse 0.5s ease-in-out infinite;">‚öñÔ∏è IT'S A TIE!</div>
                    <div style="font-size: 14px; color: #8E8E93; margin-top: 8px;">AI Judge will decide...</div>
                `;
                await sleep(2000);
                
                // Deterministic tiebreaker
                const hash = challengeId.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
                winnerId = hash % 2 === 0 ? challenge.challenger_id : challenge.opponent_id;
            } else {
                winnerId = votesChallenger > votesOpponent ? challenge.challenger_id : challenge.opponent_id;
            }
            
            const loserId = winnerId === challenge.challenger_id ? challenge.opponent_id : challenge.challenger_id;
            
            // Complete the challenge
            await completeChallenge(challengeId, winnerId, votesChallenger, votesOpponent);
            
            // Reload to get updated points
            await loadSquadData();
            const winner = members[winnerId];
            const loser = members[loserId];
            const youWon = winnerId === currentMemberId;
            const youLost = loserId === currentMemberId;
            
            // Check for DETHRONEMENT
            const rankingsAfter = Object.values(members).sort((a, b) => b.points - a.points);
            const championAfter = rankingsAfter[0];
            const dethroned = championBefore.id !== championAfter.id;
            const loserHadStreak = (loser?.streak || 0) > 0 || challenge.opponent_score > 0; // Check if streak was broken
            
            // ========== WINNER REVEAL ==========
            await showEpicWinnerReveal(overlay, winner, loser, youWon, youLost, isTie, dethroned, championBefore, championAfter, challenge);
        }
        
        async function showEpicWinnerReveal(overlay, winner, loser, youWon, youLost, isTie, dethroned, oldChampion, newChampion, challenge) {
            // Build the reveal screen
            let revealHTML = `
                <div class="reveal-container" style="max-width: 500px;">
            `;
            
            // DETHRONEMENT CHECK
            if (dethroned && newChampion.id === winner.id) {
                // Epic dethronement moment!
                overlay.innerHTML = `
                    <div class="reveal-container">
                        <div style="font-size: 100px; animation: shake 0.5s ease-in-out;">üëë</div>
                        <div style="font-size: 32px; font-weight: 900; color: #FF3B30; margin-top: 16px;">DETHRONED!</div>
                        <div style="font-size: 18px; color: #8E8E93; margin-top: 8px;">${oldChampion.name} has fallen...</div>
                    </div>
                `;
                sounds.defeat();
                await sleep(2000);
                
                // Crown transfer animation
                overlay.innerHTML = `
                    <div class="reveal-container">
                        <div style="position: relative; height: 150px;">
                            <div style="font-size: 80px; position: absolute; left: 50%; transform: translateX(-50%); animation: crownFly 1.5s ease-in-out forwards;">üëë</div>
                        </div>
                        <div style="font-size: 64px; margin-top: 16px;">${newChampion.avatar}</div>
                        <div style="font-size: 28px; font-weight: 900; color: #FFD700; margin-top: 16px;">
                            ${newChampion.name.toUpperCase()}
                        </div>
                        <div style="font-size: 18px; color: #34C759; margin-top: 8px;">IS THE NEW CHAMPION!</div>
                    </div>
                `;
                sounds.victory();
                createConfetti();
                await sleep(2500);
            }
            
            // Main winner reveal
            revealHTML = `
                <div class="reveal-container" style="max-width: 500px;">
                    <div style="font-size: 80px; margin-bottom: 8px;">${winner.avatar}${dethroned && newChampion.id === winner.id ? ' üëë' : ''}</div>
                    <div style="font-size: 36px; font-weight: 900; color: #FFD700; margin-bottom: 8px;">
                        ${winner.name.toUpperCase()} WINS!
                    </div>
                    ${isTie ? `<div style="font-size: 14px; color: #8E8E93; margin-bottom: 16px;">AI Judge decided the tie</div>` : ''}
                    
                    <div style="display: flex; justify-content: center; gap: 24px; margin-bottom: 24px;">
                        <div style="text-align: center;">
                            <div style="font-size: 22px; font-weight: 900; color: #34C759;">+${WIN_POINTS}</div>
                            <div style="font-size: 11px; color: #8E8E93;">${winner.name}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 22px; font-weight: 900; color: #FF3B30;">-${LOSS_POINTS}</div>
                            <div style="font-size: 11px; color: #8E8E93;">${loser.name}</div>
                        </div>
                    </div>
                    
                    ${dethroned ? `
                        <div style="background: rgba(255, 59, 48, 0.2); border: 1px solid #FF3B30; border-radius: 8px; padding: 12px; margin-bottom: 24px;">
                            <div style="font-size: 14px; color: #FF3B30; font-weight: 700;">üëë NEW CHAMPION!</div>
                            <div style="font-size: 12px; color: #8E8E93; margin-top: 4px;">${oldChampion.name} has been dethroned</div>
                        </div>
                    ` : ''}
                    
                    <!-- ACTION BUTTONS - No Dead Screens! -->
                    <div style="display: flex; flex-direction: column; gap: 12px; width: 100%;">
                        ${youWon ? `
                            <button class="btn btn-primary" onclick="quickRematch('${loser.id}')">
                                ‚öîÔ∏è Challenge ${loser.name} Again
                            </button>
                            <button class="btn btn-secondary" onclick="challengeChampion()">
                                üëë ${dethroned ? 'Defend Your Crown' : 'Challenge the Champion'}
                            </button>
                        ` : ''}
                        ${youLost ? `
                            <button class="btn btn-primary" style="background: linear-gradient(135deg, #FF3B30, #FF6B6B);" onclick="quickRematch('${winner.id}')">
                                üî• REVENGE MATCH
                            </button>
                            <button class="btn btn-secondary" onclick="challengeChampion()">
                                üëë Challenge the Champion Instead
                            </button>
                        ` : ''}
                        <button class="btn btn-secondary" style="opacity: 0.7;" onclick="closeVotingOverlay()">
                            Back to Home
                        </button>
                    </div>
                </div>
            `;
            
            overlay.innerHTML = revealHTML;
            
            if (youWon && !dethroned) {
                sounds.victory();
                createConfetti();
            } else if (youLost) {
                sounds.defeat();
            }
        }
        
        // Quick action functions
        function quickRematch(opponentId) {
            closeVotingOverlay();
            selectedOpponent = opponentId;
            selectedChallenge = challengeLibrary[Math.floor(Math.random() * challengeLibrary.length)];
            screen = 'challenge-reveal';
            render();
        }
        
        function challengeChampion() {
            closeVotingOverlay();
            const rankings = Object.values(members).sort((a, b) => b.points - a.points);
            const champion = rankings[0];
            
            if (champion.id === currentMemberId) {
                // You ARE the champion - pick someone to defend against
                showToast("You're the champion! Pick a challenger.", 'info');
                screen = 'select-opponent';
                render();
            } else {
                selectedOpponent = champion.id;
                selectedChallenge = challengeLibrary[Math.floor(Math.random() * challengeLibrary.length)];
                screen = 'challenge-reveal';
                render();
            }
        }
        
        async function showVotingScreen(challengeId) {
            await loadSquadData();
            
            const challenge = challenges.find(c => c.id === challengeId);
            if (!challenge) return;
            
            // Check if already voted (handle case where no vote exists)
            let existingVote = null;
            try {
                const { data, error } = await db
                    .from('votes')
                    .select('*')
                    .eq('challenge_id', challengeId)
                    .eq('voter_id', currentMemberId)
                    .maybeSingle();
                
                if (!error) existingVote = data;
            } catch (err) {
                console.log('No existing vote found');
            }
            
            if (existingVote) {
                showModal(
                    '‚úÖ Already Voted',
                    `<div style="text-align: center;">
                        <p>You've already cast your vote on this challenge.</p>
                        <p style="font-size: 13px; color: #8E8E93; margin-top: 12px;">Waiting for others to vote...</p>
                    </div>`,
                    null,
                    'OK',
                    () => closeModal()
                );
                return;
            }
            
            const challenger = members[challenge.challenger_id];
            const opponent = members[challenge.opponent_id];
            
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            overlay.id = 'votingOverlay';
            
            overlay.innerHTML = `
                <div class="reveal-container" style="max-width: 600px;">
                    <div style="font-size: 13px; color: #FF9500; font-weight: 700; letter-spacing: 1px; margin-bottom: 8px;">CAST YOUR VOTE</div>
                    <div style="font-size: 20px; font-weight: 700; margin-bottom: 24px;">${challenge.challenge_type}</div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 32px;">
                        <div style="text-align: center;">
                            ${challenge.challenger_media_type === 'video' ?
                                `<video src="${challenge.challenger_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid #3C3C3E;" controls playsinline></video>` :
                                `<img src="${challenge.challenger_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid #3C3C3E;">`
                            }
                            <div style="margin-top: 12px;">
                                <div style="font-size: 32px;">${challenger?.avatar || 'üë§'}</div>
                                <div style="font-size: 15px; font-weight: 600;">${challenger?.name || 'Challenger'}</div>
                            </div>
                            <button class="btn btn-secondary" style="margin-top: 12px;" onclick="castVote('${challengeId}', '${challenge.challenger_id}')">
                                Vote ${challenger?.name || 'Challenger'}
                            </button>
                        </div>
                        
                        <div style="text-align: center;">
                            ${challenge.opponent_media_type === 'video' ?
                                `<video src="${challenge.opponent_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid #3C3C3E;" controls playsinline></video>` :
                                `<img src="${challenge.opponent_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid #3C3C3E;">`
                            }
                            <div style="margin-top: 12px;">
                                <div style="font-size: 32px;">${opponent?.avatar || 'üë§'}</div>
                                <div style="font-size: 15px; font-weight: 600;">${opponent?.name || 'Opponent'}</div>
                            </div>
                            <button class="btn btn-secondary" style="margin-top: 12px;" onclick="castVote('${challengeId}', '${challenge.opponent_id}')">
                                Vote ${opponent?.name || 'Opponent'}
                            </button>
                        </div>
                    </div>
                    
                    <button style="background: none; border: none; color: #8E8E93; font-size: 13px; cursor: pointer;" onclick="closeVotingOverlay()">
                        Cancel
                    </button>
                </div>
            `;
            
            document.body.appendChild(overlay);
        }
        
        async function castVote(challengeId, voteForId) {
            const overlay = document.getElementById('votingOverlay');
            
            // Show voting animation
            overlay.innerHTML = `
                <div class="reveal-container">
                    <div style="font-size: 64px; margin-bottom: 24px; animation: pulse 1s ease-in-out infinite;">üó≥Ô∏è</div>
                    <div style="font-size: 24px; font-weight: 700; color: #8E8E93;">
                        Recording vote...
                    </div>
                </div>
            `;
            
            try {
                const challenge = challenges.find(c => c.id === challengeId);
                
                // Record vote
                await db
                    .from('votes')
                    .insert({
                        challenge_id: challengeId,
                        voter_id: currentMemberId,
                        vote_for: voteForId
                    });
                
                // Update vote counts
                const isVoteForChallenger = voteForId === challenge.challenger_id;
                await db
                    .from('challenges')
                    .update({
                        votes_for_challenger: (challenge.votes_for_challenger || 0) + (isVoteForChallenger ? 1 : 0),
                        votes_for_opponent: (challenge.votes_for_opponent || 0) + (isVoteForChallenger ? 0 : 1)
                    })
                    .eq('id', challengeId);
                
                // Check if all eligible voters have voted
                await checkVotingComplete(challengeId);
                
                // Show confirmation
                await sleep(500);
                
                overlay.innerHTML = `
                    <div class="reveal-container">
                        <div style="font-size: 64px; margin-bottom: 24px;">‚úÖ</div>
                        <div style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">Vote Cast!</div>
                        <div style="font-size: 14px; color: #8E8E93; margin-bottom: 24px;">Your vote for ${members[voteForId]?.name} has been recorded.</div>
                        <button class="btn btn-primary" onclick="closeVotingOverlay()">Done</button>
                    </div>
                `;
                
                sounds.click();
            } catch (err) {
                console.error('Vote error:', err);
                alert('Failed to cast vote: ' + (err.message || 'Unknown error'));
                closeVotingOverlay();
            }
        }
        
        async function checkVotingComplete(challengeId) {
            await loadSquadData();
            
            const challenge = challenges.find(c => c.id === challengeId);
            if (!challenge || challenge.status !== 'voting') return;
            
            // Count eligible voters (everyone except participants)
            const eligibleVoters = Object.keys(members).filter(id => 
                id !== challenge.challenger_id && id !== challenge.opponent_id
            );
            
            const totalVotes = (challenge.votes_for_challenger || 0) + (challenge.votes_for_opponent || 0);
            
            // If all eligible voters have voted, determine winner
            if (totalVotes >= eligibleVoters.length) {
                await determineWinner(challengeId);
            }
        }
        
        async function determineWinner(challengeId) {
            const challenge = challenges.find(c => c.id === challengeId);
            if (!challenge) return;
            
            const votesChallenger = challenge.votes_for_challenger || 0;
            const votesOpponent = challenge.votes_for_opponent || 0;
            
            let winnerId;
            if (votesChallenger > votesOpponent) {
                winnerId = challenge.challenger_id;
            } else if (votesOpponent > votesChallenger) {
                winnerId = challenge.opponent_id;
            } else {
                // Tie - pick random (or could do AI tiebreaker)
                winnerId = Math.random() < 0.5 ? challenge.challenger_id : challenge.opponent_id;
            }
            
            // Complete the challenge
            await completeChallenge(challengeId, winnerId, votesChallenger, votesOpponent);
        }
        
        function closeVotingOverlay() {
            const overlay = document.getElementById('votingOverlay');
            if (overlay) overlay.remove();
            
            // Reset challenge-related state
            selectedMedia = null;
            selectedChallenge = null;
            selectedOpponent = null;
            window.currentChallengeId = null;
            isSubmitting = false;
            
            // Go to home screen
            screen = 'arena';
            
            loadSquadData().then(() => render());
        }
        
        async function showAIJudging(challengeId) {
            const challenge = challenges.find(c => c.id === challengeId);
            if (!challenge) return;
            
            const challenger = members[challenge.challenger_id];
            const opponent = members[challenge.opponent_id];
            
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            overlay.id = 'aiJudgeOverlay';
            
            // Show the matchup
            overlay.innerHTML = `
                <div class="reveal-container" style="max-width: 600px;">
                    <div style="font-size: 20px; font-weight: 700; margin-bottom: 24px;">${challenge.challenge_type}</div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                        <div style="text-align: center;">
                            ${challenge.challenger_media_type === 'video' ?
                                `<video src="${challenge.challenger_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid #3C3C3E;" controls playsinline></video>` :
                                `<img src="${challenge.challenger_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid #3C3C3E;">`
                            }
                            <div style="margin-top: 12px;">
                                <div style="font-size: 32px;">${challenger?.avatar || 'üë§'}</div>
                                <div style="font-size: 15px; font-weight: 600;">${challenger?.name || 'Challenger'}</div>
                            </div>
                        </div>
                        
                        <div style="text-align: center;">
                            ${challenge.opponent_media_type === 'video' ?
                                `<video src="${challenge.opponent_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid #3C3C3E;" controls playsinline></video>` :
                                `<img src="${challenge.opponent_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid #3C3C3E;">`
                            }
                            <div style="margin-top: 12px;">
                                <div style="font-size: 32px;">${opponent?.avatar || 'üë§'}</div>
                                <div style="font-size: 15px; font-weight: 600;">${opponent?.name || 'Opponent'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="runAIJudge('${challengeId}')">
                        ü§ñ Let AI Judge Decide
                    </button>
                    
                    <button style="background: none; border: none; color: #8E8E93; font-size: 13px; cursor: pointer; margin-top: 16px; display: block; width: 100%;" onclick="closeAIJudgeOverlay()">
                        Cancel
                    </button>
                </div>
            `;
            
            document.body.appendChild(overlay);
        }
        
        async function runAIJudge(challengeId) {
            const overlay = document.getElementById('aiJudgeOverlay');
            const challenge = challenges.find(c => c.id === challengeId);
            if (!challenge) return;
            
            const challenger = members[challenge.challenger_id];
            const opponent = members[challenge.opponent_id];
            
            // Dramatic judging animation
            overlay.innerHTML = `
                <div class="reveal-container">
                    <div style="font-size: 64px; margin-bottom: 24px; animation: pulse 1.5s ease-in-out infinite;">ü§ñ</div>
                    <div style="font-size: 24px; font-weight: 700; color: #8E8E93;">
                        AI Judge analyzing...
                    </div>
                </div>
            `;
            
            await sleep(2000);
            
            // AI commentary based on challenge type
            const commentaries = [
                "Based on creativity and execution...",
                "After careful analysis...",
                "Considering effort and style...",
                "Looking at technique and flair...",
                "The verdict is in..."
            ];
            
            overlay.innerHTML = `
                <div class="reveal-container">
                    <div style="font-size: 64px; margin-bottom: 24px;">ü§ñ</div>
                    <div style="font-size: 18px; color: #FFD700; font-style: italic;">
                        "${commentaries[Math.floor(Math.random() * commentaries.length)]}"
                    </div>
                </div>
            `;
            
            await sleep(1500);
            
            // Pick winner (weighted random for drama)
            const winnerId = Math.random() < 0.5 ? challenge.challenger_id : challenge.opponent_id;
            const winner = members[winnerId];
            const loser = winnerId === challenge.challenger_id ? opponent : challenger;
            const youWon = winnerId === currentMemberId;
            
            // Record result
            await completeChallenge(challengeId, winnerId, 0, 0);
            
            // Dramatic reveal
            overlay.innerHTML = `
                <div class="reveal-container">
                    <div style="font-size: 80px; margin-bottom: 16px;">${winner?.avatar || 'üë§'}</div>
                    <div style="font-size: 32px; font-weight: 900; margin-bottom: 8px; color: #FFD700;">
                        ${winner?.name?.toUpperCase()} WINS!
                    </div>
                    <div style="font-size: 16px; color: #8E8E93; margin-bottom: 24px;">
                        ${youWon ? '+10 points for you!' : `${winner?.name} earns 10 points`}
                    </div>
                    
                    <button class="btn btn-primary" onclick="closeAIJudgeOverlay()">
                        ${youWon ? 'üéâ Celebrate!' : 'Continue'}
                    </button>
                </div>
            `;
            
            if (youWon) {
                sounds.victory();
                createConfetti();
            } else {
                sounds.defeat();
            }
        }
        
        function closeAIJudgeOverlay() {
            const overlay = document.getElementById('aiJudgeOverlay');
            if (overlay) overlay.remove();
            loadSquadData().then(() => render());
        }
        
        async function showShowdown(challengeId) {
            // Reload data first to get latest status
            await loadSquadData();
            
            var challenge = challenges.find(function(c) { return c.id === challengeId; });
            if (!challenge) return;
            
            var isParticipant = challenge.challenger_id === currentMemberId || challenge.opponent_id === currentMemberId;
            
            // Route to appropriate screen based on status
            if (challenge.status === 'completed') {
                showCompletedChallenge(challengeId);
            } else if (challenge.status === 'voting') {
                if (isParticipant) {
                    showTwoPersonVoting(challengeId);
                } else {
                    // Non-participants can't vote in this model
                    showModal(
                        '‚öîÔ∏è Duel in Progress',
                        '<div style="text-align: center;">' +
                            '<p>The two challengers are voting on this duel.</p>' +
                            '<p style="font-size: 13px; color: #8E8E93; margin-top: 12px;">Results will appear in the Arena when complete!</p>' +
                        '</div>',
                        null,
                        'OK',
                        function() { closeModal(); }
                    );
                }
            } else if (challenge.status === 'ready') {
                initiateJudging(challengeId);
            }
        }
        
        function showCompletedChallenge(challengeId) {
            const challenge = challenges.find(c => c.id === challengeId);
            if (!challenge) return;
            
            const challenger = members[challenge.challenger_id];
            const opponent = members[challenge.opponent_id];
            const winner = members[challenge.winner_id];
            const youWon = challenge.winner_id === currentMemberId;
            
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            overlay.id = 'resultsOverlay';
            
            overlay.innerHTML = `
                <div class="reveal-container" style="max-width: 600px;">
                    <div style="font-size: 20px; font-weight: 700; margin-bottom: 24px;">${challenge.challenge_type}</div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                        <div style="text-align: center;">
                            ${challenge.challenger_media_type === 'video' ?
                                `<video src="${challenge.challenger_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid ${challenge.winner_id === challenge.challenger_id ? '#FFD700' : '#3C3C3E'};" controls playsinline></video>` :
                                `<img src="${challenge.challenger_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid ${challenge.winner_id === challenge.challenger_id ? '#FFD700' : '#3C3C3E'};">`
                            }
                            <div style="margin-top: 12px;">
                                <div style="font-size: 32px;">${challenger?.avatar || 'üë§'}${challenge.winner_id === challenge.challenger_id ? ' üëë' : ''}</div>
                                <div style="font-size: 15px; font-weight: 600;">${challenger?.name || 'Challenger'}</div>
                                ${challenge.votes_for_challenger > 0 ? `<div style="font-size: 14px; color: #8E8E93;">${challenge.votes_for_challenger} votes</div>` : ''}
                            </div>
                        </div>
                        
                        <div style="text-align: center;">
                            ${challenge.opponent_media_type === 'video' ?
                                `<video src="${challenge.opponent_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid ${challenge.winner_id === challenge.opponent_id ? '#FFD700' : '#3C3C3E'};" controls playsinline></video>` :
                                `<img src="${challenge.opponent_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid ${challenge.winner_id === challenge.opponent_id ? '#FFD700' : '#3C3C3E'};">`
                            }
                            <div style="margin-top: 12px;">
                                <div style="font-size: 32px;">${opponent?.avatar || 'üë§'}${challenge.winner_id === challenge.opponent_id ? ' üëë' : ''}</div>
                                <div style="font-size: 15px; font-weight: 600;">${opponent?.name || 'Opponent'}</div>
                                ${challenge.votes_for_opponent > 0 ? `<div style="font-size: 14px; color: #8E8E93;">${challenge.votes_for_opponent} votes</div>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div style="padding: 20px; background: ${youWon ? 'rgba(255, 215, 0, 0.1)' : 'rgba(142, 142, 147, 0.1)'}; border-radius: 12px; margin-bottom: 24px;">
                        <div style="font-size: 24px; font-weight: 900; color: ${youWon ? '#FFD700' : '#8E8E93'};">
                            ${youWon ? 'üèÜ YOU WON!' : `${winner?.name || 'Winner'} won!`}
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="closeResultsOverlay()">
                        Continue
                    </button>
                </div>
            `;
            
            document.body.appendChild(overlay);
        }
        
        function closeResultsOverlay() {
            const overlay = document.getElementById('resultsOverlay');
            if (overlay) overlay.remove();
            loadSquadData().then(() => render());
        }
        
        function renderLadder() {
            const currentMember = getCurrentMember();
            if (!currentMember) return '';
            
            const rankings = Object.values(members).sort((a, b) => b.points - a.points);
            const champion = rankings[0];
            const yourRank = rankings.findIndex(m => m.id === currentMemberId) + 1;
            
            // Calculate weekly stats
            const now = new Date();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay());
            startOfWeek.setHours(0, 0, 0, 0);
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 7);
            const daysLeft = Math.ceil((endOfWeek - now) / (1000 * 60 * 60 * 24));
            
            // Get this week's squad challenge
            const weekNumber = Math.floor((now - new Date(now.getFullYear(), 0, 1)) / (7 * 24 * 60 * 60 * 1000));
            const thisWeeksChallenge = weeklyChallenges[weekNumber % weeklyChallenges.length];
            
            // Filter challenges completed this week
            const weekChallenges = challenges.filter(c => {
                if (c.status !== 'completed' || !c.completed_at) return false;
                const completedDate = new Date(c.completed_at);
                return completedDate >= startOfWeek && completedDate < endOfWeek;
            });
            
            // Calculate weekly wins per member
            const weeklyWins = {};
            Object.values(members).forEach(m => { weeklyWins[m.id] = 0; });
            weekChallenges.forEach(c => {
                if (c.winner_id) weeklyWins[c.winner_id] = (weeklyWins[c.winner_id] || 0) + 1;
            });
            
            // Get recent battles (battle log) ‚Äî include forfeits
            const recentBattles = challenges
                .filter(c => (c.status === 'completed' || c.status === 'forfeited') && c.winner_id)
                .sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at))
                .slice(0, 10);
            
            // Find dramatic moments
            const streakBreaks = recentBattles.filter(c => {
                const loser = c.winner_id === c.challenger_id ? members[c.opponent_id] : members[c.challenger_id];
                return loser && c.loser_streak_broken > 0;
            });
            
            const closeCalls = recentBattles.filter(c => 
                c.votes_for_challenger === c.votes_for_opponent
            );
            
            return `
                <div class="fade-in">
                    <!-- Power Rankings (Volatile) -->
                    <div class="section-title">‚ö° POWER RANKINGS</div>
                    <div style="font-size: 11px; color: #8E8E93; margin-top: -16px; margin-bottom: 12px; padding: 0 20px;">Every duel reshapes the ladder</div>
                    <div style="background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 12px; overflow: hidden; margin-bottom: 24px;">
                        ${rankings.map((m, i) => {
                            const isYou = m.id === currentMemberId;
                            const isChamp = i === 0;
                            const weekWins = weeklyWins[m.id] || 0;
                            const allTimeWins = m.all_time_wins || 0;
                            return `
                                <div style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; ${i > 0 ? 'border-top: 1px solid #2C2C2E;' : ''} ${isYou ? 'background: rgba(255, 215, 0, 0.1);' : ''} ${isChamp ? 'background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 165, 0, 0.05));' : ''}">
                                    <div style="font-size: 20px; font-weight: 900; color: ${isChamp ? '#FFD700' : '#8E8E93'}; width: 28px;">
                                        ${i === 0 ? 'üëë' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : i + 1}
                                    </div>
                                    <div style="font-size: 32px;">${m.avatar}</div>
                                    <div style="flex: 1;">
                                        <div style="font-size: 15px; font-weight: 600;">${m.name}${isYou ? ' (you)' : ''}</div>
                                        <div style="font-size: 12px; color: #8E8E93;">
                                            ${m.streak > 0 ? 'üî• ' + m.streak + ' streak ‚Ä¢ ' : ''}
                                            ${allTimeWins > 0 ? allTimeWins + ' career win' + (allTimeWins !== 1 ? 's' : '') : weekWins > 0 ? weekWins + 'W this week' : 'No wins yet'}
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 18px; font-weight: 700; color: #FFD700;">${m.points}</div>
                                        <div style="font-size: 11px; color: #8E8E93;">pts</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- Weekly Squad Challenge with LIVE COUNTDOWN -->
                    <div style="background: linear-gradient(135deg, rgba(175, 82, 222, 0.2), rgba(255, 45, 85, 0.1)); border: 2px solid rgba(175, 82, 222, 0.4); border-radius: 16px; padding: 20px; margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 20px;">üéØ</span>
                                <span style="font-size: 12px; color: #AF52DE; font-weight: 700; letter-spacing: 1px;">WEEKLY SQUAD CHALLENGE</span>
                            </div>
                            <div style="text-align: right;">
                                <div id="weeklyCountdown" data-end="${endOfWeek.toISOString()}" style="font-size: 14px; font-weight: 700; color: ${daysLeft <= 1 ? '#FF9500' : '#AF52DE'}; ${daysLeft <= 1 ? 'animation: pulse 2s infinite;' : ''}">
                                    ${formatWeeklyCountdown(endOfWeek)}
                                </div>
                                <div style="font-size: 10px; color: #8E8E93;">remaining</div>
                            </div>
                        </div>
                        <div style="font-size: 18px; font-weight: 900; margin-bottom: 6px;">${thisWeeksChallenge.name}</div>
                        <div style="font-size: 13px; color: #8E8E93; margin-bottom: 8px;">${thisWeeksChallenge.desc}</div>
                        <div style="font-size: 11px; color: #AF52DE; margin-bottom: 12px;">All squad members compete ‚Ä¢ Participants vote ‚Ä¢ AI breaks ties</div>
                        <button class="btn btn-secondary" style="border-color: #AF52DE; color: #AF52DE;" onclick="startWeeklyChallenge()">
                            Submit Entry
                        </button>
                    </div>
                    
                    <!-- Battle Log (with volatile scoring) -->
                    <div class="section-title">‚öîÔ∏è BATTLE LOG</div>
                    ${recentBattles.length > 0 ? `
                        <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 24px;">
                            ${recentBattles.map(c => {
                                const winner = members[c.winner_id];
                                const loserId = c.winner_id === c.challenger_id ? c.opponent_id : c.challenger_id;
                                const loser = members[loserId];
                                const wasClose = c.votes_for_challenger === c.votes_for_opponent;
                                const wasDethrone = c.was_dethrone;
                                const wasForfeit = c.status === 'forfeited';
                                
                                // Determine the narrative
                                let badge = '';
                                
                                if (wasForfeit) {
                                    badge = '<span style="color: #FF9500; font-size: 11px; font-weight: 700;">‚ö†Ô∏è FORFEIT</span>';
                                } else if (wasDethrone) {
                                    badge = '<span style="color: #FF3B30; font-size: 11px; font-weight: 700;">üëë DETHRONED</span>';
                                } else if (wasClose) {
                                    badge = '<span style="color: #FF9500; font-size: 11px; font-weight: 700;">üéØ CLOSE CALL</span>';
                                }
                                
                                return `
                                    <div style="background: #1C1C1E; border-radius: 10px; padding: 12px 16px; display: flex; align-items: center; gap: 12px;">
                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <span style="font-size: 24px;">${winner?.avatar || 'üë§'}</span>
                                            <span style="font-size: 14px; color: #8E8E93;">${wasForfeit ? 'won vs' : 'beat'}</span>
                                            <span style="font-size: 24px;">${loser?.avatar || 'üë§'}</span>
                                        </div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 13px; font-weight: 600;">${c.challenge_type}</div>
                                            ${badge ? '<div style="margin-top: 2px;">' + badge + '</div>' : ''}
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 12px; color: #34C759; font-weight: 600;">+${WIN_POINTS}</div>
                                            <div style="font-size: 11px; color: #FF3B30;">${wasForfeit && c.forfeit_grace ? '' : '-' + LOSS_POINTS}</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : `
                        <div style="background: #1C1C1E; border-radius: 12px; padding: 24px; text-align: center; margin-bottom: 24px;">
                            <div style="font-size: 32px; margin-bottom: 12px;">üìú</div>
                            <div style="font-size: 14px; color: #8E8E93;">No battles yet. Start some chaos!</div>
                        </div>
                    `}
                </div>
            `;
        }
        
        // Keep old function names for backward compatibility
        function renderRankings() {
            return renderLadder();
        }
        
        function renderWeekly() {
            return renderLadder();
        }
        
        function challengeWeeklyLeader() {
            const rankings = Object.values(members).sort((a, b) => b.points - a.points);
            const leader = rankings[0];
            if (leader && leader.id !== currentMemberId) {
                selectedOpponent = leader.id;
                selectedChallenge = challengeLibrary[Math.floor(Math.random() * challengeLibrary.length)];
                screen = 'challenge-reveal';
                render();
            } else {
                showToast("You're already the leader!", 'info');
            }
        }
        
        function getStartOfWeek() {
            const now = new Date();
            const start = new Date(now);
            start.setDate(now.getDate() - now.getDay());
            start.setHours(0, 0, 0, 0);
            return start;
        }
        
        function renderSettings() {
            var currentMember = getCurrentMember();
            var admin = null;
            var memberList = Object.values(members);
            memberList.forEach(function(m) { if (m.is_admin) admin = m; });
            var isAdmin = currentMember && currentMember.is_admin;
            var minorMembers = memberList.filter(function(m) { return m.is_minor; });
            
            // Activity log from challenges
            var recentActivity = challenges
                .filter(function(c) { return c.status === 'completed' && c.completed_at; })
                .sort(function(a, b) { return new Date(b.completed_at) - new Date(a.completed_at); })
                .slice(0, 15);
            
            var html = '<div class="fade-in">';
            html += '<button class="back-btn" onclick="screen=\'arena\'; render();">‚Üê Back</button>';
            html += '<div class="section-title">‚öôÔ∏è Squad Settings</div>';
            
            // Squad Info Card
            html += '<div style="background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 12px; padding: 20px; margin-bottom: 24px;">';
            html += '<div style="font-size: 17px; font-weight: 600; margin-bottom: 8px;">' + (squad ? squad.name : 'Squad') + '</div>';
            html += '<div style="font-size: 13px; color: #8E8E93; margin-bottom: 4px;">Admin: ' + (admin ? admin.name : 'Unknown') + '</div>';
            html += '<div style="font-size: 13px; color: #8E8E93;">Members: ' + Object.keys(members).length + '</div>';
            html += '</div>';
            
            // Squad Code & Invite (moved here from Ladder)
            html += '<div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 165, 0, 0.05)); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 24px;">';
            html += '<div style="font-size: 15px; font-weight: 600; margin-bottom: 12px; color: #FFD700;">üì≤ Invite Members</div>';
            html += '<div style="font-size: 28px; font-weight: 900; letter-spacing: 6px; color: #FFD700; margin-bottom: 12px; text-align: center;">' + squadCode + '</div>';
            html += '<button class="btn btn-primary" style="margin-bottom: 8px;" onclick="shareInvite()">üì± Send Invite via Text</button>';
            html += '<button class="btn btn-secondary" onclick="copyCode(\'' + squadCode + '\')">üìã Copy Squad Code</button>';
            html += '</div>';
            
            // Members List
            html += '<div class="section-title">üë• Members</div>';
            memberList.forEach(function(m) {
                var isYou = m.id === currentMemberId;
                var statusBadge = '';
                if (m.is_minor) statusBadge = '<span style="font-size: 11px; background: rgba(0, 122, 255, 0.2); color: #007AFF; padding: 2px 6px; border-radius: 4px; margin-left: 8px;">Minor</span>';
                if (m.suspended) statusBadge = '<span style="font-size: 11px; background: rgba(255, 59, 48, 0.2); color: #FF3B30; padding: 2px 6px; border-radius: 4px; margin-left: 8px;">Suspended</span>';
                
                html += '<div style="background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 12px; padding: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 12px;">';
                html += '<div style="font-size: 32px;">' + m.avatar + '</div>';
                html += '<div style="flex: 1;">';
                html += '<div style="font-size: 17px; font-weight: 600;">' + m.name + (isYou ? ' (You)' : '') + (m.is_admin ? ' üëë' : '') + statusBadge + '</div>';
                html += '<div style="font-size: 13px; color: #8E8E93;">' + m.points + ' pts' + (m.age ? ' ‚Ä¢ Age: ' + m.age : '') + '</div>';
                html += '</div>';
                
                // Admin controls for non-admin members
                if (isAdmin && !m.is_admin && !isYou) {
                    html += '<div style="display: flex; gap: 6px;">';
                    if (m.suspended) {
                        html += '<button onclick="toggleSuspend(\'' + m.id + '\', false)" style="background: rgba(52, 199, 89, 0.2); border: 1px solid #34C759; color: #34C759; font-size: 11px; font-weight: 700; padding: 6px 10px; border-radius: 6px; cursor: pointer;">Unsuspend</button>';
                    } else {
                        html += '<button onclick="toggleSuspend(\'' + m.id + '\', true)" style="background: rgba(255, 59, 48, 0.1); border: 1px solid rgba(255, 59, 48, 0.3); color: #FF3B30; font-size: 11px; font-weight: 700; padding: 6px 10px; border-radius: 6px; cursor: pointer;">Suspend</button>';
                    }
                    html += '</div>';
                }
                
                html += '</div>';
            });
            
            // Admin Panel (only visible to admin)
            if (isAdmin) {
                html += '<div class="section-title" style="margin-top: 24px;">üõ°Ô∏è Admin Panel</div>';
                
                // Minor Accounts Summary
                if (minorMembers.length > 0) {
                    html += '<div style="background: rgba(0, 122, 255, 0.1); border: 2px solid rgba(0, 122, 255, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 16px;">';
                    html += '<div style="font-size: 13px; color: #007AFF; font-weight: 700; margin-bottom: 8px;">üë∂ Minor Accounts (' + minorMembers.length + ')</div>';
                    minorMembers.forEach(function(m) {
                        html += '<div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-top: 1px solid rgba(0, 122, 255, 0.15);">';
                        html += '<div style="display: flex; align-items: center; gap: 8px;">';
                        html += '<span style="font-size: 20px;">' + m.avatar + '</span>';
                        html += '<span style="font-size: 14px; font-weight: 600;">' + m.name + '</span>';
                        html += '<span style="font-size: 12px; color: #8E8E93;">(Age: ' + (m.age || '?') + ')</span>';
                        html += '</div>';
                        html += '<span style="font-size: 12px; color: ' + (m.suspended ? '#FF3B30' : '#34C759') + '; font-weight: 600;">' + (m.suspended ? 'Suspended' : 'Active') + '</span>';
                        html += '</div>';
                    });
                    html += '</div>';
                }
                
                // Activity Log
                html += '<div style="background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 12px; padding: 16px; margin-bottom: 16px;">';
                html += '<div style="font-size: 13px; color: #8E8E93; font-weight: 700; letter-spacing: 1px; margin-bottom: 12px;">üìã ACTIVITY LOG</div>';
                if (recentActivity.length > 0) {
                    recentActivity.forEach(function(c, i) {
                        var challenger = members[c.challenger_id];
                        var opponent = members[c.opponent_id];
                        var winner = members[c.winner_id];
                        var loserId = c.winner_id === c.challenger_id ? c.opponent_id : c.challenger_id;
                        var loser = members[loserId];
                        var timeAgo = getTimeAgo(new Date(c.completed_at));
                        html += '<div style="padding: 8px 0; ' + (i > 0 ? 'border-top: 1px solid #2C2C2E;' : '') + ' font-size: 13px;">';
                        html += '<div style="display: flex; justify-content: space-between; align-items: center;">';
                        html += '<span>' + (winner ? winner.avatar : '?') + ' ' + (winner ? winner.name : '?') + ' beat ' + (loser ? loser.avatar : '?') + ' ' + (loser ? loser.name : '?') + '</span>';
                        html += '<span style="font-size: 11px; color: #8E8E93;">' + timeAgo + '</span>';
                        html += '</div>';
                        html += '<div style="font-size: 11px; color: #8E8E93; margin-top: 2px;">' + c.challenge_type + '</div>';
                        html += '</div>';
                    });
                } else {
                    html += '<div style="text-align: center; padding: 16px; color: #8E8E93; font-size: 13px;">No activity yet</div>';
                }
                html += '</div>';
            }
            
            // Terms & Legal
            html += '<div class="section-title" style="margin-top: 24px;">üìú Terms & Legal</div>';
            html += '<div style="background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 12px; padding: 16px; margin-bottom: 16px;">';
            html += '<button onclick="showTermsModal()" style="width: 100%; background: none; border: none; color: #FFFFFF; font-size: 14px; font-weight: 600; padding: 10px 0; cursor: pointer; text-align: left; display: flex; justify-content: space-between; align-items: center;">';
            html += '<span>üìÑ Terms of Service</span><span style="color: #8E8E93;">‚Üí</span></button>';
            html += '<div style="border-top: 1px solid #2C2C2E;"></div>';
            html += '<button onclick="showPrivacyModal()" style="width: 100%; background: none; border: none; color: #FFFFFF; font-size: 14px; font-weight: 600; padding: 10px 0; cursor: pointer; text-align: left; display: flex; justify-content: space-between; align-items: center;">';
            html += '<span>üîí Privacy Policy</span><span style="color: #8E8E93;">‚Üí</span></button>';
            html += '<div style="border-top: 1px solid #2C2C2E;"></div>';
            html += '<button onclick="showCOPPAModal()" style="width: 100%; background: none; border: none; color: #FFFFFF; font-size: 14px; font-weight: 600; padding: 10px 0; cursor: pointer; text-align: left; display: flex; justify-content: space-between; align-items: center;">';
            html += '<span>üë∂ COPPA & Child Safety</span><span style="color: #8E8E93;">‚Üí</span></button>';
            html += '</div>';
            
            html += '<div style="padding: 12px; text-align: center; font-size: 11px; color: #8E8E93; margin-bottom: 16px;">';
            html += 'By using VERSUS you agree to the Terms of Service and Privacy Policy.<br>All user-generated content is the sole responsibility of the user who posted it.';
            html += '</div>';
            
            // Leave Squad
            html += '<div style="margin-top: 16px; margin-bottom: 32px;">';
            html += '<button class="btn btn-secondary" style="border-color: #FF3B30; color: #FF3B30;" onclick="handleLogout()">Leave Squad</button>';
            html += '</div>';
            
            html += '</div>';
            return html;
        }
        
        async function toggleSuspend(memberId, suspend) {
            var member = members[memberId];
            if (!member) return;
            var action = suspend ? 'suspend' : 'unsuspend';
            if (!confirm('Are you sure you want to ' + action + ' ' + member.name + '?')) return;
            
            try {
                await db
                    .from('members')
                    .update({ suspended: suspend })
                    .eq('id', memberId);
                
                await loadSquadData();
                render();
                showToast((suspend ? 'üö´' : '‚úÖ') + ' ' + member.name + ' has been ' + action + 'ed', 'info');
            } catch (err) {
                console.error('Failed to ' + action + ':', err);
                alert('Failed to ' + action + ' member');
            }
        }
        
        function showTermsModal() {
            showModal(
                'üìÑ Terms of Service',
                '<div style="max-height: 60vh; overflow-y: auto; font-size: 12px; color: #A1A1A6; line-height: 1.6; text-align: left;">' +
                '<p style="font-weight: 700; color: #FFFFFF; margin-bottom: 8px;">VERSUS Terms of Service</p>' +
                '<p style="margin-bottom: 8px;">Last updated: ' + new Date().toLocaleDateString() + '</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">1. ACCEPTANCE.</strong> By creating an account or using VERSUS ("the App"), you agree to these Terms. If you are under 18, your parent or legal guardian must agree on your behalf and supervise your use.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">2. USER-GENERATED CONTENT (UGC).</strong> You retain ownership of content you submit. By posting, you grant VERSUS a non-exclusive, royalty-free, worldwide license to display, distribute, and moderate your content within the App. You are solely responsible for all content you upload. You represent that you have the right to share such content and that it does not violate any law or third-party right.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">3. PROHIBITED CONTENT.</strong> You may not post content that is: obscene, sexually explicit, or pornographic; depicting or exploiting minors; harassing, threatening, or promoting violence; infringing on intellectual property rights; illegal or promoting illegal activity; containing personal information of others without consent.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">4. SQUAD ADMIN RESPONSIBILITY.</strong> The Squad Admin is responsible for managing their squad, including monitoring member activity, enforcing community standards, and supervending minor accounts. VERSUS provides tools (suspend, activity log) but the Admin bears primary responsibility for squad conduct.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">5. DISCLAIMER OF WARRANTIES.</strong> THE APP IS PROVIDED "AS IS" WITHOUT WARRANTIES OF ANY KIND, EXPRESS OR IMPLIED. VERSUS DOES NOT WARRANT UNINTERRUPTED OR ERROR-FREE SERVICE.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">6. LIMITATION OF LIABILITY.</strong> TO THE MAXIMUM EXTENT PERMITTED BY LAW, VERSUS AND ITS OPERATORS SHALL NOT BE LIABLE FOR ANY INDIRECT, INCIDENTAL, SPECIAL, CONSEQUENTIAL, OR PUNITIVE DAMAGES, OR ANY LOSS OF DATA, USE, OR PROFITS, ARISING OUT OF OR RELATED TO YOUR USE OF THE APP. TOTAL LIABILITY SHALL NOT EXCEED $100 USD.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">7. INDEMNIFICATION.</strong> You agree to indemnify and hold harmless VERSUS, its operators, and affiliates from any claims, losses, or damages arising from your use of the App, your content, or your violation of these Terms.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">8. CONTENT MODERATION.</strong> We reserve the right to remove any content and suspend or terminate any account at our sole discretion, without notice. We are not obligated to monitor content but may do so.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">9. TERMINATION.</strong> We may terminate or suspend access to the App at any time, for any reason, without prior notice.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">10. GOVERNING LAW.</strong> These Terms are governed by the laws of the State of California. Any disputes shall be resolved in the courts of Los Angeles County, California.</p>' +
                '<p><strong style="color: #FFD700;">11. CHANGES.</strong> We may modify these Terms at any time. Continued use constitutes acceptance of modified Terms.</p>' +
                '</div>',
                null,
                'Close',
                function() { closeModal(); }
            );
        }
        
        function showPrivacyModal() {
            showModal(
                'üîí Privacy Policy',
                '<div style="max-height: 60vh; overflow-y: auto; font-size: 12px; color: #A1A1A6; line-height: 1.6; text-align: left;">' +
                '<p style="font-weight: 700; color: #FFFFFF; margin-bottom: 8px;">VERSUS Privacy Policy</p>' +
                '<p style="margin-bottom: 8px;">Last updated: ' + new Date().toLocaleDateString() + '</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">DATA COLLECTED.</strong> We collect: display name, age, avatar selection, photos/videos submitted to challenges, vote data, and device identifiers stored locally. We do NOT collect email addresses, real names beyond display names, location data, or contact lists.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">HOW DATA IS USED.</strong> Data is used solely to operate the App: display challenges, calculate scores, and show rankings within your squad. We do not sell, rent, or share personal data with third parties. Media is stored in encrypted cloud storage accessible only within your squad.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">DATA RETENTION.</strong> Squad data is retained while the squad is active. Users may leave a squad at any time, which removes their local session. Squad admins may request deletion of squad data by contacting us.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">CHILDREN\'S PRIVACY.</strong> See our COPPA compliance section for details on how we protect children under 13.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">THIRD-PARTY SERVICES.</strong> We use Supabase for data storage and real-time functionality. Supabase\'s privacy policy applies to data stored on their infrastructure.</p>' +
                '<p><strong style="color: #FFD700;">CONTACT.</strong> For privacy concerns or data deletion requests, contact the squad administrator or reach out through our support channels.</p>' +
                '</div>',
                null,
                'Close',
                function() { closeModal(); }
            );
        }
        
        function showCOPPAModal() {
            showModal(
                'üë∂ COPPA & Child Safety',
                '<div style="max-height: 60vh; overflow-y: auto; font-size: 12px; color: #A1A1A6; line-height: 1.6; text-align: left;">' +
                '<p style="font-weight: 700; color: #FFFFFF; margin-bottom: 8px;">Children\'s Online Privacy Protection</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">PARENTAL CONSENT.</strong> VERSUS is designed for family use. Accounts for users under 18 ("Minors") must be created with the knowledge and consent of a parent or legal guardian. The Squad Admin (typically a parent) serves as the supervising adult. By allowing a minor to join a squad, the parent/guardian affirms verifiable parental consent for that minor\'s participation.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">MINOR PROTECTIONS.</strong> Minor accounts are flagged and visible to the squad admin. Admins can suspend minor accounts at any time. All activity involving minors is logged and visible to the admin. Squads are private, invite-only groups ‚Äî no public discovery or stranger interaction.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">DATA MINIMIZATION FOR CHILDREN.</strong> We collect the minimum data necessary: display name, age, avatar, and challenge submissions. No real names, email, phone numbers, or precise location data are collected from minors. We do not engage in behavioral advertising or profiling of minors.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">PARENTAL RIGHTS.</strong> Parents/guardians may at any time: review their child\'s activity via the admin activity log; suspend their child\'s account; request deletion of their child\'s data; revoke consent by removing the minor from the squad.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">NO THIRD-PARTY SHARING.</strong> We do not share any minor\'s personal information with third parties. No data from minor accounts is used for advertising, analytics, or any purpose beyond operating the App within the squad.</p>' +
                '<p><strong style="color: #FFD700;">REPORTING.</strong> If you believe a minor\'s safety is at risk or content guidelines have been violated, the Squad Admin should immediately suspend the relevant account and remove offending content.</p>' +
                '</div>',
                null,
                'Close',
                function() { closeModal(); }
            );
        }
        
        function handleLogout() {
            if (confirm('Leave this squad? You can rejoin with the squad code.')) {
                localStorage.clear();
                location.reload();
            }
        }

        // ============================================
        // MODAL SYSTEM
        // ============================================
        
        function showModal(title, content, cancelText, confirmText, confirmAction, cancelAction) {
            const modal = document.createElement('div');
            modal.id = 'modalOverlay';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10, 10, 12, 0.95); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;';
            
            modal.innerHTML = `
                <div style="background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 16px; padding: 24px; max-width: 400px; width: 100%;">
                    <div style="font-size: 20px; font-weight: 700; margin-bottom: 16px;">${title}</div>
                    <div style="margin-bottom: 24px;">${content}</div>
                    <div style="display: grid; grid-template-columns: ${cancelText && confirmText ? '1fr 1fr' : '1fr'}; gap: 12px;">
                        ${cancelText ? `<button class="btn btn-secondary" onclick="modalCancelAction()">${cancelText}</button>` : ''}
                        ${confirmText ? `<button class="btn btn-primary" onclick="modalConfirmAction()">${confirmText}</button>` : ''}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentModalAction = confirmAction;
            window.currentModalCancelAction = cancelAction;
        }

        function closeModal() {
            const modal = document.getElementById('modalOverlay');
            if (modal) modal.remove();
            window.currentModalAction = null;
            window.currentModalCancelAction = null;
        }

        function modalConfirmAction() {
            if (window.currentModalAction) {
                window.currentModalAction();
            } else {
                closeModal();
            }
        }

        function modalCancelAction() {
            if (window.currentModalCancelAction) {
                window.currentModalCancelAction();
            } else {
                closeModal();
            }
        }
        
        function copyCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                alert('‚úÖ Code copied!');
            });
        }
        
        function createConfetti() {
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const c = document.createElement('div');
                    c.className = 'confetti';
                    c.style.left = Math.random() * 100 + '%';
                    c.style.background = ['#D4AF37', '#FFD700', '#FFA500'][Math.floor(Math.random() * 3)];
                    document.body.appendChild(c);
                    setTimeout(() => c.remove(), 3000);
                }, i * 30);
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        
        async function init() {
            console.log('üöÄ Initializing VERSUS v21 ‚Äî Phase 1: Tension Mechanics');
            
            if (squadId && currentMemberId) {
                // Returning user
                try {
                    await loadSquadData();
                    
                    if (squad && members[currentMemberId]) {
                        subscribeToSquad();
                        
                        // v21: Check for expired challenges (forfeits)
                        await checkForForfeits();
                        
                        // v21: Build "While You Were Away" report
                        var returnEvents = buildReturnReport();
                        if (returnEvents && returnEvents.length > 0 && !hasSeenReturnScreen) {
                            window._returnEvents = returnEvents;
                            screen = 'return-screen';
                        } else {
                            screen = 'arena';
                        }
                        
                        // Update last seen
                        lastSeenAt = new Date().toISOString();
                        localStorage.setItem('lastSeenAt', lastSeenAt);
                        
                        console.log('‚úÖ Logged in as:', members[currentMemberId].name);
                    } else {
                        // Session invalid
                        console.log('‚ö†Ô∏è Invalid session, resetting...');
                        localStorage.clear();
                        screen = 'welcome';
                    }
                } catch (err) {
                    console.error('Init error:', err);
                    screen = 'welcome';
                }
            } else {
                screen = 'welcome';
            }
            
            render();
            
            // v21: Start live countdown timers
            startCountdownTimers();
            
            // v21: Periodic forfeit check (every 2 minutes)
            setInterval(function() {
                if (squadId && currentMemberId) {
                    checkForForfeits();
                }
            }, 120000);
        }
        
        // Start the app
        init();
    </script>
</body>
</html>
