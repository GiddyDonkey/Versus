<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Versus - Cloud Edition</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .screen {
            background: white;
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
        }

        .logo {
            font-size: 36px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .connection-status {
            font-size: 12px;
            color: #48bb78;
            margin-top: 4px;
        }

        .connection-status.offline {
            color: #ef4444;
        }

        .screen-title {
            font-size: 28px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .screen-desc {
            color: #718096;
            font-size: 15px;
            margin-bottom: 24px;
        }

        .btn {
            width: 100%;
            padding: 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 12px;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #2d3748;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        input, textarea, select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 12px;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .challenge-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 24px;
        }

        .challenge-card h3 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .challenge-card p {
            opacity: 0.9;
            margin-bottom: 16px;
        }

        .timer-badge {
            background: rgba(255,255,255,0.2);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            display: inline-block;
        }

        .submission-preview {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 12px;
            margin: 12px 0;
        }

        .vote-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            margin: 20px 0;
        }

        .vote-card {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .vote-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .vote-card.selected {
            border-color: #667eea;
            background: #f7fafc;
        }

        .vote-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .results-podium {
            text-align: center;
            margin: 32px 0;
        }

        .winner {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .winner-name {
            font-size: 32px;
            font-weight: 700;
            color: #2d3748;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 20px 0;
        }

        .stat-card {
            background: #f7fafc;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            color: #667eea;
        }

        .stat-label {
            font-size: 13px;
            color: #718096;
            margin-top: 4px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin: 12px 0;
        }

        .progress-fill {
            height: 100%;
            background: #48bb78;
            transition: width 1s linear;
        }

        .hidden {
            display: none;
        }

        .player-switcher {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .player-btn {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .player-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .player-indicator {
            background: #f7fafc;
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 13px;
            color: #718096;
            margin-bottom: 16px;
        }

        .player-indicator strong {
            color: #667eea;
        }

        .coin-flip-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .coin {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #ffd700 100%);
            box-shadow: 0 10px 40px rgba(255, 215, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 64px;
            animation: coinFlip 2s ease-in-out;
            transform-style: preserve-3d;
        }

        @keyframes coinFlip {
            0% {
                transform: rotateY(0deg) scale(1);
            }
            25% {
                transform: rotateY(180deg) scale(1.2);
            }
            50% {
                transform: rotateY(360deg) scale(1);
            }
            75% {
                transform: rotateY(540deg) scale(1.2);
            }
            100% {
                transform: rotateY(720deg) scale(1);
            }
        }

        .tie-message {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 32px;
            font-weight: 700;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }

        .winner-reveal {
            position: absolute;
            bottom: 30%;
            left: 50%;
            transform: translateX(-50%);
            color: #ffd700;
            font-size: 48px;
            font-weight: 800;
            text-align: center;
            opacity: 0;
            animation: revealWinner 1s ease 2s forwards;
        }

        @keyframes revealWinner {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* Notification Badge */
        .notification-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ef4444;
            color: white;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
            animation: slideIn 0.3s ease, pulse 2s ease infinite;
            cursor: pointer;
            z-index: 100;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .notification-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 16px;
        }

        .notification-item {
            padding: 12px;
            background: #f7fafc;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
        }

        .notification-item.unread {
            background: #edf2f7;
            font-weight: 600;
        }

        .notification-time {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }

        /* History Styles */
        .history-grid {
            display: grid;
            gap: 16px;
            margin-top: 16px;
        }

        .history-card {
            background: #f7fafc;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid transparent;
        }

        .history-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .history-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .history-card-title {
            font-weight: 700;
            font-size: 16px;
            color: #2d3748;
        }

        .history-card-date {
            font-size: 12px;
            color: #999;
        }

        .history-card-content {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .history-thumbnail {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
        }

        .history-winner {
            flex: 1;
        }

        .history-winner-name {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 4px;
        }

        .history-score {
            font-size: 14px;
            color: #718096;
        }

        .filter-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .filter-tab {
            flex: 1;
            padding: 12px;
            background: #e2e8f0;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-tab.active {
            background: #667eea;
            color: white;
        }

        .detail-submissions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 20px 0;
        }

        .detail-submission {
            text-align: center;
        }

        .detail-submission img {
            width: 100%;
            border-radius: 12px;
            margin-bottom: 8px;
        }

        .detail-submission.winner {
            border: 3px solid #ffd700;
            padding: 8px;
            border-radius: 16px;
        }

        /* Template Grid */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }

        .template-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid transparent;
        }

        .template-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
            border-color: #ffd700;
        }

        .template-icon {
            font-size: 36px;
            margin-bottom: 8px;
        }

        .template-title {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .template-category {
            font-size: 11px;
            opacity: 0.8;
        }

        /* Achievement System */
        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }

        .achievement-card {
            background: #f7fafc;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
        }

        .achievement-card.unlocked {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            border-color: #ffd700;
            animation: unlockPulse 0.6s ease;
        }

        @keyframes unlockPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .achievement-card.locked {
            opacity: 0.4;
        }

        .achievement-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .achievement-name {
            font-weight: 700;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .achievement-desc {
            font-size: 10px;
            color: #718096;
        }

        /* Streak Display */
        .streak-banner {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .streak-number {
            font-size: 48px;
            margin: 8px 0;
        }

        /* Profile Section */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            border: 4px solid rgba(255,255,255,0.3);
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .profile-stats {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 20px 0;
        }

        .quick-action-btn {
            padding: 20px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-action-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .quick-action-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .quick-action-label {
            font-weight: 600;
            font-size: 14px;
            color: #2d3748;
        }

        /* Enhanced Create Screen */
        .create-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 700;
            color: #2d3748;
            margin: 20px 0 12px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Tab System */
        .tab-container {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #718096;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .loading:after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* Mobile Improvements */
        @media (max-width: 600px) {
            .container {
                padding: 0;
            }
            
            .screen {
                border-radius: 0;
                min-height: 100vh;
            }
            
            .template-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .detail-submissions {
                grid-template-columns: 1fr;
            }
            
            .profile-header {
                border-radius: 0;
            }
        }

        /* Smooth Page Transitions */
        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        .slide-up {
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Dashboard/Home Screen */
        .dashboard-container {
            display: grid;
            gap: 20px;
        }

        .score-comparison {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            gap: 20px;
            padding: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            color: white;
            margin-bottom: 24px;
        }

        .player-score {
            text-align: center;
        }

        .player-score.current {
            transform: scale(1.1);
            position: relative;
        }

        .player-score.current::after {
            content: '‚≠ê';
            position: absolute;
            top: -10px;
            right: 50%;
            transform: translateX(50%);
        }

        .player-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .player-points {
            font-size: 36px;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 4px;
        }

        .player-wins {
            font-size: 12px;
            opacity: 0.9;
        }

        .score-vs {
            font-size: 24px;
            font-weight: 800;
            opacity: 0.5;
        }

        /* Active Challenge Card */
        .active-challenge-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            border: 3px solid #667eea;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
            margin-bottom: 20px;
        }

        .challenge-status {
            display: inline-block;
            padding: 4px 12px;
            background: #48bb78;
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .challenge-status.voting {
            background: #ed8936;
        }

        /* Action Cards Grid */
        .action-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .action-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 16px;
            padding: 24px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .action-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
        }

        .action-card:active {
            transform: translateY(-2px);
        }

        .action-card-icon {
            font-size: 40px;
            margin-bottom: 8px;
        }

        .action-card-title {
            font-weight: 700;
            font-size: 14px;
        }

        .action-card.secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .action-card.tertiary {
            background: linear-gradient(135deg, #fddb92 0%, #d1fdff 100%);
            color: #2d3748;
        }

        /* Recent Activity Feed */
        .activity-feed {
            background: #f7fafc;
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
        }

        .activity-icon {
            font-size: 24px;
        }

        .activity-text {
            flex: 1;
            font-size: 14px;
            color: #2d3748;
        }

        .activity-time {
            font-size: 11px;
            color: #999;
        }

        /* Enhanced Waiting Screen */
        .waiting-animation {
            text-align: center;
            padding: 40px 20px;
        }

        .waiting-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #e2e8f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-bar {
            background: #e2e8f0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Challenge Phase Indicator */
        .phase-indicator {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            position: relative;
        }

        .phase-indicator::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 30px;
            right: 30px;
            height: 2px;
            background: #e2e8f0;
            z-index: 0;
        }

        .phase-step {
            background: white;
            border: 3px solid #e2e8f0;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            position: relative;
            z-index: 1;
        }

        .phase-step.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .phase-step.completed {
            border-color: #48bb78;
            background: #48bb78;
            color: white;
        }

        /* Leaderboard */
        .leaderboard {
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .leaderboard-rank {
            font-size: 24px;
            font-weight: 800;
            color: #cbd5e0;
            min-width: 40px;
            text-align: center;
        }

        .leaderboard-rank.first {
            color: #ffd700;
        }

        .leaderboard-rank.second {
            color: #c0c0c0;
        }

        .leaderboard-rank.third {
            color: #cd7f32;
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-weight: 700;
            color: #2d3748;
        }

        .leaderboard-stats {
            font-size: 12px;
            color: #718096;
        }

        .leaderboard-score {
            font-size: 24px;
            font-weight: 800;
            color: #667eea;
        }

        /* Floating Navigation Menu */
        .floating-nav {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .nav-menu-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-menu-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .nav-menu {
            position: absolute;
            bottom: 70px;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            padding: 8px;
            min-width: 200px;
            display: none;
        }

        .nav-menu.show {
            display: block;
            animation: slideUp 0.2s ease;
        }

        .nav-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
            color: #2d3748;
        }

        .nav-menu-item:hover {
            background: #f7fafc;
        }

        .nav-menu-icon {
            font-size: 20px;
        }

        /* Better Results Screen */
        .results-container {
            text-align: center;
        }

        .winner-announcement {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            padding: 32px 20px;
            border-radius: 16px;
            margin: 20px 0;
            animation: unlockPulse 0.6s ease;
        }

        .winner-trophy {
            font-size: 64px;
            margin-bottom: 12px;
        }

        .winner-text {
            font-size: 28px;
            font-weight: 800;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .winner-subtitle {
            font-size: 14px;
            color: #718096;
        }

        /* Challenge Info Card */
        .challenge-info-card {
            background: #f7fafc;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            text-align: left;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #718096;
            font-size: 14px;
        }

        .info-value {
            color: #2d3748;
            font-weight: 600;
            font-size: 14px;
        }

        /* Enhanced Buttons */
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
        }

        .btn-icon {
            font-size: 18px;
            margin-right: 8px;
        }

        /* Stats Comparison */
        .stats-comparison {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 16px;
            align-items: center;
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 12px;
        }

        .stat-column {
            text-align: center;
        }

        .stat-big-number {
            font-size: 48px;
            font-weight: 800;
            line-height: 1;
            color: #667eea;
        }

        .stat-vs {
            font-size: 20px;
            font-weight: 800;
            color: #cbd5e0;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .empty-state-desc {
            color: #718096;
            margin-bottom: 24px;
        }

        /* Breadcrumb Navigation */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #718096;
        }

        .breadcrumb-item {
            cursor: pointer;
            transition: color 0.2s;
        }

        .breadcrumb-item:hover {
            color: #667eea;
        }

        .breadcrumb-separator {
            color: #cbd5e0;
        }

        .breadcrumb-current {
            color: #2d3748;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="screen">
            <div class="header">
                <div class="logo">VERSUS</div>
                <div id="connectionStatus" class="connection-status">‚òÅÔ∏è Connected</div>
                <div id="playerSwitcher" style="display: none; margin-top: 12px;"></div>
            </div>
            <div id="screenContent"></div>
        </div>
    </div>

    <!-- Floating Navigation Menu -->
    <div class="floating-nav" id="floatingNav" style="display: none;">
        <button class="nav-menu-btn" onclick="toggleNavMenu()">‚ò∞</button>
        <div class="nav-menu" id="navMenu">
            <button class="nav-menu-item" onclick="goToDashboard()">
                <span class="nav-menu-icon">üè†</span>
                <span>Arena</span>
            </button>
            <button class="nav-menu-item" onclick="viewHistory()">
                <span class="nav-menu-icon">üìö</span>
                <span>History</span>
            </button>
            <button class="nav-menu-item" onclick="viewAchievements()">
                <span class="nav-menu-icon">üèÜ</span>
                <span>Achievements</span>
            </button>
            <button class="nav-menu-item" onclick="showTemplates()">
                <span class="nav-menu-icon">‚ö°</span>
                <span>Quick Start</span>
            </button>
            <button class="nav-menu-item" onclick="showCustom()">
                <span class="nav-menu-icon">‚úèÔ∏è</span>
                <span>Custom Challenge</span>
            </button>
        </div>
    </div>

    <script>
        // ==========================================
        // FIREBASE CONFIGURATION
        // ==========================================
        const firebaseConfig = {
          apiKey: "AIzaSyBbHiG6wEBvMRwhH_f8cotQc2HQoZ0V8ZU",
          authDomain: "versus-b202b.firebaseapp.com",
          databaseURL: "https://versus-b202b-default-rtdb.firebaseio.com",
          projectId: "versus-b202b",
          storageBucket: "versus-b202b.firebasestorage.app",
          messagingSenderId: "878415783187",
          appId: "1:878415783187:web:b917374dd39132bafda6e6"
        };

        // Initialize Firebase
        let db = null;
        let pairId = null; // Unique ID for this pair session
        
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            console.log('Firebase initialized successfully!');
            
            // Monitor connection status
            var connectedRef = firebase.database().ref('.info/connected');
            connectedRef.on('value', function(snap) {
                console.log('Firebase connection status:', snap.val());
                var status = document.getElementById('connectionStatus');
                if (status) {
                    if (snap.val() === true) {
                        status.textContent = '‚òÅÔ∏è Connected';
                        status.className = 'connection-status';
                    } else {
                        status.textContent = 'üì¥ Offline';
                        status.className = 'connection-status offline';
                    }
                } else {
                    console.warn('Connection status element not found');
                }
            });
            
            // Get or create pair ID from URL
            var urlParams = new URLSearchParams(window.location.search);
            pairId = urlParams.get('pair');
            if (!pairId) {
                pairId = 'pair_' + Date.now();
                // Update URL without reload
                window.history.replaceState({}, '', '?pair=' + pairId);
            }
            console.log('Pair ID:', pairId);
        } catch (error) {
            console.error('Firebase initialization error:', error);
            alert('Firebase setup required! Please check FIREBASE_SETUP.md');
        }

        // ==========================================
        // DATA & STATE
        // ==========================================
        // Data
        var pair = null;
        var challenges = [];
        var submissions = [];
        var votes = {};
        var currentPlayer = 'parent'; // 'parent' or 'teen'
        var notifications = []; // New: notification history
        var achievements = []; // New: unlocked achievements
        var streakData = { current: 0, longest: 0, lastDate: null }; // New: daily streak tracking

        // Workflow state
        var currentScreen = 'welcome';
        var activeChallenge = null;
        var selectedHistoryChallenge = null; // For viewing challenge details
        var selectedCategory = 'all'; // For filtering templates
        
        // Challenge templates
        var challengeTemplates = [
            { title: 'Best Breakfast', desc: 'Who can make the most delicious breakfast?', icon: 'üç≥', category: 'Food' },
            { title: 'Cleanest Room', desc: 'Show off your organization skills!', icon: 'üõèÔ∏è', category: 'Home' },
            { title: 'Creative Selfie', desc: 'Most creative self-portrait wins!', icon: 'ü§≥', category: 'Photo' },
            { title: 'Best Pet Pic', desc: 'Capture your pet doing something adorable', icon: 'üêï', category: 'Pets' },
            { title: 'Outfit of the Day', desc: 'Who has the best style today?', icon: 'üëî', category: 'Fashion' },
            { title: 'Funny Face', desc: 'Make the funniest face possible!', icon: 'üòÇ', category: 'Fun' },
            { title: 'Nature Shot', desc: 'Best outdoor or nature photo', icon: 'üå≥', category: 'Nature' },
            { title: 'Cooking Challenge', desc: 'Create the best looking meal', icon: 'üçΩÔ∏è', category: 'Food' },
            { title: 'Workspace Setup', desc: 'Show your study or work area', icon: 'üíª', category: 'Productivity' },
            { title: 'Before & After', desc: 'Show a transformation (room, project, etc)', icon: '‚ú®', category: 'Challenge' },
            { title: 'Best Sketch', desc: 'Draw or doodle something creative', icon: 'üé®', category: 'Art' },
            { title: 'Coffee/Tea Art', desc: 'Most artistic beverage presentation', icon: '‚òï', category: 'Food' }
        ];
        
        // Achievement definitions
        var achievementDefinitions = [
            { id: 'first_win', name: 'First Victory', desc: 'Win your first challenge', icon: 'üèÜ', threshold: 1 },
            { id: 'win_streak_3', name: 'Hot Streak', desc: 'Win 3 challenges in a row', icon: 'üî•', threshold: 3 },
            { id: 'win_streak_5', name: 'Unstoppable', desc: 'Win 5 challenges in a row', icon: '‚ö°', threshold: 5 },
            { id: 'challenges_10', name: 'Veteran', desc: 'Complete 10 challenges', icon: 'üéñÔ∏è', threshold: 10 },
            { id: 'challenges_25', name: 'Champion', desc: 'Complete 25 challenges', icon: 'üëë', threshold: 25 },
            { id: 'challenges_50', name: 'Legend', desc: 'Complete 50 challenges', icon: 'üåü', threshold: 50 },
            { id: 'perfect_day', name: 'Perfect Day', desc: 'Complete 3 challenges in one day', icon: 'üìÖ', threshold: 3 },
            { id: 'week_streak', name: 'Dedicated', desc: 'Complete challenges 7 days in a row', icon: 'üìÜ', threshold: 7 }
        ];

        // Initialize
        loadData();

        // Debounce updateScreen to prevent multiple rapid calls during Firebase sync
        var updateScreenTimeout = null;
        function scheduleUpdateScreen() {
            if (updateScreenTimeout) {
                clearTimeout(updateScreenTimeout);
            }
            updateScreenTimeout = setTimeout(function() {
                updateScreen();
            }, 100); // Wait 100ms for all Firebase updates to complete
        }

        function loadData() {
            if (!db || !pairId) {
                console.error('Firebase not initialized');
                return;
            }
            
            // Listen for realtime updates
            db.ref('pairs/' + pairId).on('value', function(snapshot) {
                var data = snapshot.val();
                console.log('Firebase pair updated:', data);
                if (data) {
                    pair = data;
                    scheduleUpdateScreen();
                }
            });
            
            db.ref('challenges/' + pairId).on('value', function(snapshot) {
                challenges = [];
                snapshot.forEach(function(child) {
                    challenges.push(child.val());
                });
                console.log('Firebase challenges updated:', challenges.length, 'challenges');
                scheduleUpdateScreen();
            });
            
            db.ref('submissions/' + pairId).on('value', function(snapshot) {
                submissions = [];
                snapshot.forEach(function(child) {
                    submissions.push(child.val());
                });
                console.log('Firebase submissions updated:', submissions.length, 'submissions');
                scheduleUpdateScreen();
            });
            
            db.ref('votes/' + pairId).on('value', function(snapshot) {
                votes = snapshot.val() || {};
                console.log('Firebase votes updated:', Object.keys(votes).length, 'votes');
                scheduleUpdateScreen();
            });
            
            // Load achievements
            db.ref('achievements/' + pairId).on('value', function(snapshot) {
                achievements = [];
                snapshot.forEach(function(child) {
                    achievements.push(child.val());
                });
                scheduleUpdateScreen();
            });
            
            // Load streak data
            db.ref('streaks/' + pairId).on('value', function(snapshot) {
                var data = snapshot.val();
                if (data) {
                    streakData = data;
                }
                scheduleUpdateScreen();
            });
            
            // Initial render
            updateScreen();
        }

        function saveData() {
            console.log('saveData called - db:', db ? 'initialized' : 'null', 'pairId:', pairId);
            console.log('Data to save - Challenges:', challenges.length, 'Submissions:', submissions.length, 'Votes:', Object.keys(votes).length);
            
            if (!db || !pairId) {
                console.error('Firebase not initialized - db:', db, 'pairId:', pairId);
                return;
            }
            
            console.log('Saving pair:', pair);
            
            // Save to Firebase (replaces localStorage)
            if (pair) {
                db.ref('pairs/' + pairId).set(pair)
                    .then(function() {
                        console.log('‚úì Pair saved successfully to Firebase');
                    })
                    .catch(function(error) {
                        console.error('‚úó Error saving pair:', error);
                    });
            }
            
            // Save challenges
            console.log('Saving challenges:', challenges.length);
            if (challenges.length > 0) {
                // Build challenges object
                var challengesObj = {};
                challenges.forEach(function(challenge) {
                    challengesObj[challenge.id] = challenge;
                });
                
                console.log('Saving', Object.keys(challengesObj).length, 'challenges as batch');
                db.ref('challenges/' + pairId).set(challengesObj)
                    .then(function() {
                        console.log('‚úì All challenges saved successfully');
                    })
                    .catch(function(error) {
                        console.error('‚úó Error saving challenges:', error);
                    });
            } else {
                console.log('No challenges to save');
                // Clear challenges if array is empty
                db.ref('challenges/' + pairId).set(null);
            }
            
            // Save submissions
            console.log('Saving submissions:', submissions.length);
            if (submissions.length > 0) {
                // Build submissions object
                var submissionsObj = {};
                submissions.forEach(function(submission) {
                    submissionsObj[submission.id] = submission;
                });
                
                console.log('Saving', Object.keys(submissionsObj).length, 'submissions as batch');
                db.ref('submissions/' + pairId).set(submissionsObj)
                    .then(function() {
                        console.log('‚úì All submissions saved successfully');
                    })
                    .catch(function(error) {
                        console.error('‚úó Error saving submissions:', error);
                    });
            } else {
                console.log('No submissions to save');
                // Clear submissions if array is empty
                db.ref('submissions/' + pairId).set(null);
            }
            
            // Save votes
            console.log('Saving votes:', Object.keys(votes).length);
            db.ref('votes/' + pairId).set(votes)
                .then(function() {
                    console.log('‚úì Votes saved successfully');
                })
                .catch(function(error) {
                    console.error('‚úó Error saving votes:', error);
                });
            
            // Save achievements
            if (achievements.length > 0) {
                var achievementsObj = {};
                achievements.forEach(function(achievement) {
                    achievementsObj[achievement.id] = achievement;
                });
                db.ref('achievements/' + pairId).set(achievementsObj);
            }
            
            // Save streak data
            db.ref('streaks/' + pairId).set(streakData);
        }

        function updateScreen() {
            console.log('=== updateScreen called ===');
            console.log('Pair:', pair ? pair.parentName + ' & ' + pair.teenName : 'null');
            console.log('Challenges:', challenges.length);
            console.log('Submissions:', submissions.length);
            console.log('Current player:', currentPlayer);
            
            // Show player switcher if pair exists
            if (pair) {
                showPlayerSwitcher();
            }
            
            // Determine what screen to show
            if (!pair) {
                console.log('‚Üí No pair, showing welcome');
                currentScreen = 'welcome';
            } else {
                var activeEnrollment = null;
                var activeVoting = null;
                
                for (var i = 0; i < challenges.length; i++) {
                    console.log('Challenge', i, '- phase:', challenges[i].phase, 'id:', challenges[i].id);
                    if (challenges[i].phase === 'enrollment') activeEnrollment = challenges[i];
                    if (challenges[i].phase === 'voting') activeVoting = challenges[i];
                }

                if (activeVoting) {
                    console.log('‚Üí Active voting challenge found');
                    activeChallenge = activeVoting;
                    // Check if THIS player has voted
                    var playerVoteKey = activeVoting.id + '_' + currentPlayer;
                    if (votes[playerVoteKey]) {
                        console.log('‚Üí Player has voted, showing results');
                        currentScreen = 'results';
                    } else {
                        console.log('‚Üí Player needs to vote');
                        currentScreen = 'vote';
                    }
                } else if (activeEnrollment) {
                    console.log('‚Üí Active enrollment challenge found');
                    activeChallenge = activeEnrollment;
                    // Check if THIS player has submitted
                    var hasSubmitted = submissions.some(function(s) {
                        return s.challengeId === activeEnrollment.id && s.player === currentPlayer;
                    });
                    
                    console.log('‚Üí Player has submitted:', hasSubmitted);
                    
                    if (hasSubmitted) {
                        currentScreen = 'waiting';
                    } else {
                        currentScreen = 'submit';
                    }
                } else {
                    console.log('‚Üí No active challenges, showing create');
                    currentScreen = 'create';
                }
            }

            console.log('‚Üí Final screen:', currentScreen);
            renderScreen();
        }

        function renderScreen() {
            var html = '';

            // Show/hide floating nav based on screen
            var floatingNav = document.getElementById('floatingNav');
            if (floatingNav) {
                var showNav = pair && currentScreen !== 'welcome';
                floatingNav.style.display = showNav ? 'block' : 'none';
            }

            // Add player indicator at top of screen
            if (pair && currentScreen !== 'welcome') {
                var playerName = currentPlayer === 'parent' ? pair.parentName : pair.teenName;
                html += '<div class="player-indicator">Playing as: <strong>' + playerName + '</strong></div>';
            }

            if (currentScreen === 'welcome') {
                html += renderWelcome();
            } else if (currentScreen === 'create') {
                html += renderCreate();
            } else if (currentScreen === 'templates') {
                html += renderTemplates();
            } else if (currentScreen === 'custom') {
                html += renderCustom();
            } else if (currentScreen === 'submit') {
                html += renderSubmit();
            } else if (currentScreen === 'waiting') {
                html += renderWaiting();
            } else if (currentScreen === 'vote') {
                html += renderVote();
            } else if (currentScreen === 'results') {
                html += renderResults();
            } else if (currentScreen === 'history') {
                html += renderHistory();
            } else if (currentScreen === 'challengeDetail') {
                html += renderChallengeDetail();
            } else if (currentScreen === 'achievements') {
                html += renderAchievements();
            }

            document.getElementById('screenContent').innerHTML = html;
        }

        // Navigation menu functions
        function toggleNavMenu() {
            var menu = document.getElementById('navMenu');
            menu.classList.toggle('show');
        }

        function goToDashboard() {
            toggleNavMenu();
            currentScreen = 'create';
            renderScreen();
        }

        function renderWelcome() {
            return '<h1 class="screen-title">Welcome!</h1>' +
                   '<p class="screen-desc">Create your parent-teen pair to start competing</p>' +
                   '<input type="text" id="parentName" placeholder="Parent name (e.g., Sarah)">' +
                   '<input type="text" id="teenName" placeholder="Teen name (e.g., Alex)">' +
                   '<button class="btn" onclick="createPair()">Create Pair</button>';
        }

        function createPair() {
            var parentName = document.getElementById('parentName').value.trim();
            var teenName = document.getElementById('teenName').value.trim();
            
            console.log('createPair called - Parent:', parentName, 'Teen:', teenName);
            
            if (!parentName || !teenName) {
                alert('Please enter both names');
                return;
            }

            pair = {
                id: pairId,
                parentName: parentName,
                teenName: teenName,
                parentScore: 0,
                teenScore: 0,
                parentWins: 0,
                teenWins: 0
            };

            console.log('Pair object created:', pair);
            console.log('About to call saveData()');
            saveData();
            console.log('saveData() called');
            
            showPlayerSwitcher();
            
            // Show share link
            var shareUrl = window.location.href;
            alert('Pair created! Share this link with your partner:\n\n' + shareUrl + '\n\nBoth devices must use the SAME link!');
            
            updateScreen();
        }

        function showPlayerSwitcher() {
            if (!pair) return;
            
            document.getElementById('playerSwitcher').innerHTML = 
                '<div class="player-switcher">' +
                '<button class="player-btn ' + (currentPlayer === 'parent' ? 'active' : '') + '" onclick="switchPlayer(\'parent\')">üë® ' + pair.parentName + '</button>' +
                '<button class="player-btn ' + (currentPlayer === 'teen' ? 'active' : '') + '" onclick="switchPlayer(\'teen\')">üë¶ ' + pair.teenName + '</button>' +
                '</div>';
            document.getElementById('playerSwitcher').style.display = 'block';
        }

        function switchPlayer(player) {
            currentPlayer = player;
            showPlayerSwitcher();
            updateScreen();
        }

        function renderCreate() {
            var completedCount = challenges.filter(function(c) { return c.phase === 'completed'; }).length;
            
            var html = '<div class="dashboard-container">';
            
            // Active Challenge Card - HIGHEST PRIORITY
            var activeEnrollment = challenges.find(function(c) { return c.phase === 'enrollment'; });
            var activeVoting = challenges.find(function(c) { return c.phase === 'voting'; });
            var activeChallenge = activeVoting || activeEnrollment;
            
            if (activeChallenge) {
                var phaseIcon = activeChallenge.phase === 'enrollment' ? 'üü°' : 'üîµ';
                var phaseLabel = activeChallenge.phase === 'enrollment' ? 'Enrollment' : 'Showdown';
                var timerEnd = activeChallenge.phase === 'enrollment' ? activeChallenge.enrollmentEndsAt : activeChallenge.votingEndsAt;
                
                // Check submission status
                var playerSub = submissions.find(function(s) {
                    return s.challengeId === activeChallenge.id && s.player === currentPlayer;
                });
                var otherPlayer = currentPlayer === 'parent' ? 'teen' : 'parent';
                var otherPlayerSub = submissions.find(function(s) {
                    return s.challengeId === activeChallenge.id && s.player === otherPlayer;
                });
                var otherPlayerName = currentPlayer === 'parent' ? pair.teenName : pair.parentName;
                
                html += '<div class="active-challenge-card">';
                
                if (activeChallenge.phase === 'enrollment') {
                    html += '<div class="challenge-status">Active Challenge</div>';
                    html += '<h2 style="font-size: 20px; margin: 8px 0;">üî• ' + activeChallenge.title + '</h2>';
                    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin: 12px 0;">';
                    html += '<span style="font-size: 14px; color: #718096;">Phase: ' + phaseIcon + ' ' + phaseLabel + '</span>';
                    html += '<span style="font-size: 14px; font-weight: 600; color: #667eea;" data-timer-end="' + timerEnd + '">‚è≥ ' + formatTime(timerEnd) + '</span>';
                    html += '</div>';
                    
                    if (playerSub && !otherPlayerSub) {
                        html += '<div style="background: #f7fafc; padding: 12px; border-radius: 8px; margin-top: 12px;">';
                        html += '<div style="font-size: 14px; color: #718096; margin-bottom: 4px;">‚è≥ Waiting for ' + otherPlayerName + ' to submit</div>';
                        html += '<div style="font-size: 12px; color: #999;">Your entry is hidden until both submit.</div>';
                        html += '</div>';
                    } else if (!playerSub) {
                        html += '<button class="btn" onclick="currentScreen=\'submit\'; renderScreen();" style="margin-top: 12px;">üì∏ Submit Entry</button>';
                    } else {
                        html += '<div style="background: #48bb78; color: white; padding: 12px; border-radius: 8px; margin-top: 12px; text-align: center;">';
                        html += '<div style="font-weight: 600;">‚úÖ Both Entries Submitted!</div>';
                        html += '<div style="font-size: 12px; opacity: 0.9; margin-top: 4px;">Voting begins when timer expires</div>';
                        html += '</div>';
                    }
                } else {
                    // Voting phase
                    html += '<div class="challenge-status voting">üîµ Showdown</div>';
                    html += '<h2 style="font-size: 20px; margin: 8px 0;">üé¨ ' + activeChallenge.title + '</h2>';
                    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin: 12px 0;">';
                    html += '<span style="font-size: 14px; color: #718096;">Phase: Reveal & Vote</span>';
                    html += '<span style="font-size: 14px; font-weight: 600; color: #ed8936;" data-timer-end="' + timerEnd + '">‚è≥ ' + formatTime(timerEnd) + '</span>';
                    html += '</div>';
                    
                    var playerVoteKey = activeChallenge.id + '_' + currentPlayer;
                    var hasVoted = votes[playerVoteKey];
                    
                    if (!hasVoted) {
                        html += '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px; border-radius: 8px; text-align: center; margin-top: 12px;">';
                        html += '<div style="font-size: 16px; font-weight: 700; margin-bottom: 8px;">üé¨ Reveal Ready</div>';
                        html += '<div style="font-size: 13px; opacity: 0.9; margin-bottom: 12px;">See submissions and vote for the winner</div>';
                        html += '<button class="btn" onclick="currentScreen=\'vote\'; renderScreen();" style="background: white; color: #667eea; border: none;">Reveal & Vote</button>';
                        html += '</div>';
                    } else {
                        html += '<div style="background: #f7fafc; padding: 12px; border-radius: 8px; margin-top: 12px; text-align: center;">';
                        html += '<div style="font-weight: 600; color: #48bb78;">‚úÖ You Voted!</div>';
                        html += '<div style="font-size: 12px; color: #718096; margin-top: 4px;">Waiting for results...</div>';
                        html += '</div>';
                    }
                }
                
                html += '</div>';
            } else {
                // No active challenge - call to action
                html += '<div class="active-challenge-card" style="text-align: center; border: 3px dashed #e2e8f0;">';
                html += '<div style="font-size: 48px; margin-bottom: 12px;">üî•</div>';
                html += '<h2 style="font-size: 20px; margin-bottom: 8px; color: #2d3748;">No Active Challenge</h2>';
                html += '<p style="color: #718096; margin-bottom: 16px;">Ready to compete?</p>';
                html += '<button class="btn" onclick="currentScreen=\'templates\'; renderScreen();">Start a Challenge</button>';
                html += '</div>';
            }
            
            // Score Comparison
            html += '<div class="score-comparison">' +
                    '<div class="player-score' + (currentPlayer === 'parent' ? ' current' : '') + '">' +
                    '<div class="player-name">' + pair.parentName + '</div>' +
                    '<div class="player-points">' + pair.parentScore + '</div>' +
                    '<div class="player-wins">' + (pair.parentWins === 0 ? 'First win awaits üëÄ' : pair.parentWins + ' wins') + '</div>' +
                    '</div>' +
                    '<div class="score-vs">VS</div>' +
                    '<div class="player-score' + (currentPlayer === 'teen' ? ' current' : '') + '">' +
                    '<div class="player-name">' + pair.teenName + '</div>' +
                    '<div class="player-points">' + pair.teenScore + '</div>' +
                    '<div class="player-wins">' + (pair.teenWins === 0 ? 'First win awaits üëÄ' : pair.teenWins + ' wins') + '</div>' +
                    '</div>' +
                    '</div>';
            
            // Streak banner
            html += '<div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 12px 16px; border-radius: 12px; text-align: center; margin-bottom: 20px; font-weight: 600;">';
            html += 'üî• Current Streak: ' + streakData.current + (streakData.current === 0 ? ' (Start your first!)' : ' days');
            html += '</div>';
            
            // Primary CTA Section
            html += '<h2 style="margin: 24px 0 16px 0; font-size: 18px; font-weight: 700;">üî• Start a Challenge</h2>';
            
            // Action cards - START PRIMARY
            html += '<div class="action-cards">' +
                    '<button class="action-card" onclick="showTemplates()">' +
                    '<div class="action-card-icon">‚ö°</div>' +
                    '<div class="action-card-title">Quick Start</div>' +
                    '</button>' +
                    '<button class="action-card secondary" onclick="showCustom()">' +
                    '<div class="action-card-icon">‚úèÔ∏è</div>' +
                    '<div class="action-card-title">Custom</div>' +
                    '</button>' +
                    '</div>';
            
            // Secondary actions moved lower
            html += '<h2 style="margin: 24px 0 16px 0; font-size: 16px; font-weight: 700; color: #718096;">üìä Track Progress</h2>';
            html += '<div class="action-cards">' +
                    '<button class="action-card tertiary" onclick="viewHistory()">' +
                    '<div class="action-card-icon">üìö</div>' +
                    '<div class="action-card-title">History</div>' +
                    '</button>' +
                    '<button class="action-card tertiary" onclick="viewAchievements()">' +
                    '<div class="action-card-icon">üèÜ</div>' +
                    '<div class="action-card-title">Achievements</div>' +
                    '</button>' +
                    '</div>';
            
            // Recent activity
            if (completedCount > 0) {
                html += '<h2 style="margin: 24px 0 16px 0; font-size: 18px; font-weight: 700;">üìä Recent Activity</h2>';
                html += '<div class="activity-feed">';
                
                var recentChallenges = challenges.filter(function(c) { return c.phase === 'completed'; })
                    .sort(function(a, b) { return b.votingEndsAt - a.votingEndsAt; })
                    .slice(0, 3);
                
                for (var i = 0; i < recentChallenges.length; i++) {
                    var ch = recentChallenges[i];
                    var coinFlipKey = ch.id + '_coinflip_winner';
                    var winner = votes[coinFlipKey];
                    
                    if (!winner) {
                        var parentVoteKey = ch.id + '_parent';
                        var teenVoteKey = ch.id + '_teen';
                        var parentVote = votes[parentVoteKey];
                        var teenVote = votes[teenVoteKey];
                        
                        var challengeSubs = submissions.filter(function(s) {
                            return s.challengeId === ch.id;
                        });
                        
                        if (challengeSubs.length === 2) {
                            var parentSub = challengeSubs.find(function(s) { return s.player === 'parent'; });
                            var teenSub = challengeSubs.find(function(s) { return s.player === 'teen'; });
                            
                            if (parentSub && teenSub) {
                                var parentVotes = 0;
                                var teenVotes = 0;
                                if (parentVote === parentSub.id) parentVotes++;
                                if (parentVote === teenSub.id) teenVotes++;
                                if (teenVote === parentSub.id) parentVotes++;
                                if (teenVote === teenSub.id) teenVotes++;
                                
                                winner = parentVotes > teenVotes ? 'parent' : (teenVotes > parentVotes ? 'teen' : 'parent');
                            }
                        }
                    }
                    
                    var winnerName = winner === 'parent' ? pair.parentName : pair.teenName;
                    var timeAgo = getTimeAgo(ch.votingEndsAt);
                    
                    html += '<div class="activity-item">' +
                            '<div class="activity-icon">üèÜ</div>' +
                            '<div class="activity-text"><strong>' + winnerName + '</strong> won "' + ch.title + '"</div>' +
                            '<div class="activity-time">' + timeAgo + '</div>' +
                            '</div>';
                }
                
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }

        function getTimeAgo(timestamp) {
            var now = Date.now();
            var diff = now - timestamp;
            var minutes = Math.floor(diff / 60000);
            var hours = Math.floor(diff / 3600000);
            var days = Math.floor(diff / 86400000);
            
            if (days > 0) return days + 'd ago';
            if (hours > 0) return hours + 'h ago';
            if (minutes > 0) return minutes + 'm ago';
            return 'just now';
        }

        function showTemplates() {
            currentScreen = 'templates';
            renderScreen();
        }

        function showCustom() {
            currentScreen = 'custom';
            renderScreen();
        }

        function renderTemplates() {
            var html = '<div class="breadcrumb">' +
                       '<span class="breadcrumb-item" onclick="currentScreen=\'create\'; renderScreen();">Arena</span>' +
                       '<span class="breadcrumb-separator">‚Ä∫</span>' +
                       '<span class="breadcrumb-current">Quick Start</span>' +
                       '</div>';
            
            html += '<h1 class="screen-title">‚ö° Quick Start Templates</h1>' +
                    '<p class="screen-desc">Choose a pre-made challenge to get started fast</p>';
            
            // Simplified category filter
            var categories = ['All', 'Fun', 'Skill', 'Creative', 'Lifestyle'];
            html += '<div class="filter-tabs" style="overflow-x: auto; white-space: nowrap; margin-bottom: 20px;">';
            for (var i = 0; i < categories.length; i++) {
                var cat = categories[i];
                html += '<button class="filter-tab' + (selectedCategory === cat.toLowerCase() ? ' active' : '') + '" ' +
                        'onclick="selectedCategory=\'' + cat.toLowerCase() + '\'; renderScreen();">' + cat + '</button>';
            }
            html += '</div>';
            
            html += '<div class="template-grid">';
            
            for (var i = 0; i < challengeTemplates.length; i++) {
                var template = challengeTemplates[i];
                
                // Map old categories to new simplified ones
                var simplifiedCategory = template.category;
                if (template.category === 'Photo' || template.category === 'Art') simplifiedCategory = 'Creative';
                if (template.category === 'Food' || template.category === 'Fashion' || template.category === 'Home' || template.category === 'Pets') simplifiedCategory = 'Lifestyle';
                if (template.category === 'Productivity' || template.category === 'Challenge') simplifiedCategory = 'Skill';
                if (template.category === 'Nature') simplifiedCategory = 'Fun';
                
                if (selectedCategory !== 'all' && simplifiedCategory.toLowerCase() !== selectedCategory) {
                    continue;
                }
                html += '<div class="template-card" onclick="useTemplate(' + i + ')">' +
                        '<div class="template-icon">' + template.icon + '</div>' +
                        '<div class="template-title">' + template.title + '</div>' +
                        '<div class="template-category">' + simplifiedCategory + '</div>' +
                        '</div>';
            }
            
            html += '</div>';
            
            return html;
        }

        function renderCustom() {
            var html = '<div class="breadcrumb">' +
                       '<span class="breadcrumb-item" onclick="currentScreen=\'create\'; renderScreen();">Arena</span>' +
                       '<span class="breadcrumb-separator">‚Ä∫</span>' +
                       '<span class="breadcrumb-current">Custom Challenge</span>' +
                       '</div>';
            
            html += '<h1 class="screen-title">‚úèÔ∏è Create Custom Challenge</h1>' +
                    '<p class="screen-desc">Design your own unique competition</p>';
            
            html += '<div class="section-title">üìù Challenge Details</div>' +
                    '<input type="text" id="title" placeholder="Challenge name (e.g., Best Pancakes)">' +
                    '<textarea id="desc" placeholder="Description - what are the rules?" rows="4"></textarea>';
            
            html += '<div class="section-title">‚è±Ô∏è Duration</div>' +
                    '<select id="duration">' +
                    '<option value="300">5 minutes (demo/test)</option>' +
                    '<option value="1800">30 minutes</option>' +
                    '<option value="3600" selected>1 hour</option>' +
                    '<option value="21600">6 hours</option>' +
                    '<option value="86400">24 hours</option>' +
                    '<option value="259200">3 days</option>' +
                    '</select>';
            
            html += '<button class="btn" onclick="createChallengeWorkflow()">üöÄ Start Challenge</button>';
            
            return html;
        }

        function createChallengeWorkflow() {
            var title = document.getElementById('title').value.trim();
            var desc = document.getElementById('desc').value.trim();
            var duration = parseInt(document.getElementById('duration').value);

            if (!title) {
                alert('Enter a title');
                return;
            }

            var now = Date.now();
            challenges.push({
                id: 'chal_' + Date.now(),
                title: title,
                description: desc,
                phase: 'enrollment',
                createdAt: now,
                enrollmentEndsAt: now + (duration * 1000),
                votingEndsAt: now + (duration * 2 * 1000)
            });

            // Add notification
            var playerName = currentPlayer === 'parent' ? pair.parentName : pair.teenName;
            addNotification('New challenge "' + title + '" created by ' + playerName + '!', 'challenge');

            saveData();
            updateScreen();
        }

        function useTemplate(index) {
            var template = challengeTemplates[index];
            
            var now = Date.now();
            var duration = 3600; // Default 1 hour for templates
            
            challenges.push({
                id: 'chal_' + Date.now(),
                title: template.title,
                description: template.desc,
                category: template.category,
                icon: template.icon,
                phase: 'enrollment',
                createdAt: now,
                enrollmentEndsAt: now + (duration * 1000),
                votingEndsAt: now + (duration * 2 * 1000)
            });

            // Add notification
            var playerName = currentPlayer === 'parent' ? pair.parentName : pair.teenName;
            addNotification('New challenge "' + template.title + '" started by ' + playerName + '!', 'challenge');

            saveData();
            updateScreen();
        }

        function renderSubmit() {
            return '<div class="challenge-card">' +
                   '<h3>' + activeChallenge.title + '</h3>' +
                   '<p>' + activeChallenge.description + '</p>' +
                   '<div class="timer-badge">‚è±Ô∏è <span data-timer-end="' + activeChallenge.enrollmentEndsAt + '">' + formatTime(activeChallenge.enrollmentEndsAt) + '</span></div>' +
                   '</div>' +
                   '<h1 class="screen-title">Submit Your Entry</h1>' +
                   '<p class="screen-desc">Take a photo or choose from library</p>' +
                   '<label for="photo" class="btn" style="display: block; text-align: center; cursor: pointer;">üì∑ Take Photo</label>' +
                   '<input type="file" id="photo" accept="image/*" capture="environment" style="display:none;" onchange="previewPhoto()">' +
                   '<div id="preview"></div>' +
                   '<div id="submitBtnContainer" style="display:none;">' +
                   '<button class="btn" onclick="submitPhoto()">‚úì Submit Entry</button>' +
                   '<label for="photo" class="btn btn-secondary" style="display: block; text-align: center; cursor: pointer; margin-top: 8px;">Change Photo</label>' +
                   '</div>';
        }

        function previewPhoto() {
            var file = document.getElementById('photo').files[0];
            if (!file) return;

            // Check file size
            if (file.size > 5 * 1024 * 1024) {
                alert('File too large. Please choose a smaller photo (under 5MB).');
                document.getElementById('photo').value = '';
                return;
            }

            try {
                var reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        document.getElementById('preview').innerHTML = 
                            '<img src="' + e.target.result + '" class="submission-preview">' +
                            '<p style="color: #48bb78; font-size: 14px; text-align: center;">‚úì Photo ready!</p>';
                        document.getElementById('submitBtnContainer').style.display = 'block';
                    } catch (err) {
                        console.error('Error displaying preview:', err);
                        alert('Error displaying photo. Please try again.');
                    }
                };
                reader.onerror = function(err) {
                    console.error('FileReader error:', err);
                    alert('Error reading photo. Please try again.');
                };
                reader.readAsDataURL(file);
            } catch (err) {
                console.error('Error in previewPhoto:', err);
                alert('Error loading photo. Please try again.');
            }
        }

        function submitPhoto() {
            var file = document.getElementById('photo').files[0];
            if (!file) {
                alert('Please select a photo first');
                return;
            }

            try {
                var reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        // Compress the image before storing
                        var img = new Image();
                        img.onload = function() {
                            try {
                                // Create canvas and compress
                                var canvas = document.createElement('canvas');
                                var maxWidth = 800;
                                var scale = maxWidth / img.width;
                                
                                if (scale < 1) {
                                    canvas.width = maxWidth;
                                    canvas.height = img.height * scale;
                                } else {
                                    canvas.width = img.width;
                                    canvas.height = img.height;
                                }
                                
                                var ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                
                                // Convert to JPEG with quality 0.7
                                var compressedData = canvas.toDataURL('image/jpeg', 0.7);
                                
                                console.log('Original size:', e.target.result.length, 'Compressed:', compressedData.length);
                                
                                var playerName = currentPlayer === 'parent' ? pair.parentName : pair.teenName;
                                
                                submissions.push({
                                    id: 'sub_' + Date.now(),
                                    challengeId: activeChallenge.id,
                                    player: currentPlayer,
                                    playerName: playerName,
                                    imageData: compressedData
                                });
                                
                                // Add notification
                                var otherPlayer = currentPlayer === 'parent' ? pair.teenName : pair.parentName;
                                addNotification(playerName + ' submitted their entry! ' + otherPlayer + ', your turn!', 'submission');
                                
                                saveData();
                                updateScreen();
                            } catch (err) {
                                console.error('Error compressing image:', err);
                                alert('Error compressing image. Please try a smaller photo.');
                            }
                        };
                        img.onerror = function() {
                            alert('Error loading image. Please try again.');
                        };
                        img.src = e.target.result;
                    } catch (err) {
                        console.error('Error saving submission:', err);
                        if (err.name === 'QuotaExceededError') {
                            alert('Storage full! Please reset or use smaller photos.');
                        } else {
                            alert('Error submitting photo. Please try again.');
                        }
                    }
                };
                reader.onerror = function(err) {
                    console.error('FileReader error:', err);
                    alert('Error reading photo. Please try again.');
                };
                reader.readAsDataURL(file);
            } catch (err) {
                console.error('Error in submitPhoto:', err);
                alert('Error submitting photo. Please try again.');
            }
        }

        function renderWaiting() {
            var parentSub = submissions.find(function(s) {
                return s.challengeId === activeChallenge.id && s.player === 'parent';
            });
            var teenSub = submissions.find(function(s) {
                return s.challengeId === activeChallenge.id && s.player === 'teen';
            });
            
            var bothSubmitted = parentSub && teenSub;
            var progress = bothSubmitted ? 100 : 50;
            
            var html = '<div class="challenge-card">' +
                       '<h3>' + activeChallenge.title + '</h3>' +
                       '<p>' + activeChallenge.description + '</p>' +
                       '<div class="timer-badge">‚è±Ô∏è <span data-timer-end="' + activeChallenge.enrollmentEndsAt + '">' + formatTime(activeChallenge.enrollmentEndsAt) + '</span></div>' +
                       '</div>';
            
            // Phase indicator
            html += '<div class="phase-indicator">' +
                    '<div class="phase-step completed">‚úì</div>' +
                    '<div class="phase-step' + (bothSubmitted ? ' completed' : ' active') + '">' + (bothSubmitted ? '‚úì' : '‚è≥') + '</div>' +
                    '<div class="phase-step">üó≥Ô∏è</div>' +
                    '</div>';
            
            html += '<h1 class="screen-title">Entry Submitted! ‚úÖ</h1>' +
                    '<p class="screen-desc">' + (bothSubmitted ? 'Both entries are in!' : 'Waiting for other player...') + '</p>';
            
            // Progress bar
            html += '<div class="progress-bar">' +
                    '<div class="progress-fill" style="width: ' + progress + '%"></div>' +
                    '</div>';
            
            html += '<div class="stats-grid">' +
                    '<div class="stat-card"><div class="stat-value">' + (parentSub ? '‚úì' : '‚è≥') + '</div><div class="stat-label">' + pair.parentName + '</div></div>' +
                    '<div class="stat-card"><div class="stat-value">' + (teenSub ? '‚úì' : '‚è≥') + '</div><div class="stat-label">' + pair.teenName + '</div></div>' +
                    '</div>';
            
            if (bothSubmitted) {
                html += '<div style="text-align: center; margin: 24px 0; padding: 20px; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; border-radius: 12px;">' +
                        '<div style="font-size: 32px; margin-bottom: 8px;">üéâ</div>' +
                        '<div style="font-weight: 700; font-size: 18px;">Ready for Voting!</div>' +
                        '<div style="font-size: 14px; margin-top: 4px; opacity: 0.9;">Voting starts when the timer expires</div>' +
                        '</div>';
            } else {
                html += '<div class="waiting-animation">' +
                        '<div class="waiting-spinner"></div>' +
                        '<p style="color: #718096;">Waiting for ' + (parentSub ? pair.teenName : pair.parentName) + ' to submit...</p>' +
                        '</div>';
            }
            
            html += '<button class="btn btn-secondary" onclick="skipToVoting()">‚öôÔ∏è Skip to Voting (Demo)</button>';
            
            return html;
        }

        function skipToVoting() {
            // Check if both players have submitted
            var parentSubmitted = submissions.some(function(s) {
                return s.challengeId === activeChallenge.id && s.player === 'parent';
            });
            var teenSubmitted = submissions.some(function(s) {
                return s.challengeId === activeChallenge.id && s.player === 'teen';
            });
            
            if (!parentSubmitted || !teenSubmitted) {
                var missing = [];
                if (!parentSubmitted) missing.push(pair.parentName);
                if (!teenSubmitted) missing.push(pair.teenName);
                
                if (confirm('Warning: ' + missing.join(' and ') + ' has not submitted yet.\n\nSkip to voting anyway?')) {
                    activeChallenge.phase = 'voting';
                    saveData();
                    updateScreen();
                }
            } else {
                activeChallenge.phase = 'voting';
                saveData();
                updateScreen();
            }
        }

        function renderVote() {
            var html = '<div class="challenge-card">' +
                       '<h3>' + activeChallenge.title + '</h3>' +
                       '<p>Vote for the best entry!</p>' +
                       '<div class="timer-badge">‚è±Ô∏è <span data-timer-end="' + activeChallenge.votingEndsAt + '">' + formatTime(activeChallenge.votingEndsAt) + '</span></div>' +
                       '</div>' +
                       '<h1 class="screen-title">Vote Now!</h1>' +
                       '<p class="screen-desc">Tap to select the winner (you can vote for any entry!)</p>' +
                       '<div class="vote-grid">';

            var challengeSubs = submissions.filter(function(s) {
                return s.challengeId === activeChallenge.id;
            });

            for (var i = 0; i < challengeSubs.length; i++) {
                var sub = challengeSubs[i];
                
                html += '<div class="vote-card" onclick="selectWinner(\'' + sub.id + '\')">' +
                        '<img src="' + sub.imageData + '">' +
                        '<strong>' + sub.playerName + '</strong>' +
                        (sub.player === currentPlayer ? '<div style="color: #667eea; font-size: 12px; margin-top: 4px;">Your entry</div>' : '') +
                        '</div>';
            }

            html += '</div>';
            return html;
        }

        function selectWinner(subId) {
            var playerVoteKey = activeChallenge.id + '_' + currentPlayer;
            votes[playerVoteKey] = subId;
            
            // Add notification
            var playerName = currentPlayer === 'parent' ? pair.parentName : pair.teenName;
            var otherPlayer = currentPlayer === 'parent' ? pair.teenName : pair.parentName;
            
            // Check if other player has voted
            var otherPlayerKey = activeChallenge.id + '_' + (currentPlayer === 'parent' ? 'teen' : 'parent');
            if (votes[otherPlayerKey]) {
                addNotification('All votes are in! Check the results!', 'results');
            } else {
                addNotification(playerName + ' voted! Waiting for ' + otherPlayer, 'vote');
            }
            
            saveData();
            updateScreen();
        }

        function renderResults() {
            var parentVoteKey = activeChallenge.id + '_parent';
            var teenVoteKey = activeChallenge.id + '_teen';
            
            var parentVote = votes[parentVoteKey];
            var teenVote = votes[teenVoteKey];
            
            var bothVoted = parentVote && teenVote;
            
            if (!bothVoted) {
                return '<h1 class="screen-title">Voted! ‚úì</h1>' +
                       '<p class="screen-desc">Waiting for other player to vote...</p>' +
                       '<div class="stats-grid">' +
                       '<div class="stat-card"><div class="stat-value">' + (parentVote ? '‚úì' : '‚è≥') + '</div><div class="stat-label">' + pair.parentName + '</div></div>' +
                       '<div class="stat-card"><div class="stat-value">' + (teenVote ? '‚úì' : '‚è≥') + '</div><div class="stat-label">' + pair.teenName + '</div></div>' +
                       '</div>';
            }
            
            // Check if points have already been awarded for this challenge FIRST
            var pointsAwardedKey = activeChallenge.id + '_points_awarded';
            var pointsAlreadyAwarded = votes[pointsAwardedKey] || false;
            
            console.log('Points already awarded?', pointsAlreadyAwarded, 'Key:', pointsAwardedKey);
            
            // Check if we need to show coin flip animation
            var coinFlipKey = activeChallenge.id + '_coinflip_shown';
            var coinFlipShown = votes[coinFlipKey] || false;
            
            // Calculate winner
            var parentSubmission = submissions.find(function(s) {
                return s.challengeId === activeChallenge.id && s.player === 'parent';
            });
            var teenSubmission = submissions.find(function(s) {
                return s.challengeId === activeChallenge.id && s.player === 'teen';
            });
            
            var parentVotes = 0;
            var teenVotes = 0;
            
            if (parentVote === parentSubmission.id) parentVotes++;
            if (parentVote === teenSubmission.id) teenVotes++;
            if (teenVote === parentSubmission.id) parentVotes++;
            if (teenVote === teenSubmission.id) teenVotes++;
            
            var isTie = parentVotes === teenVotes;
            var winner = null;
            var winnerName = '';
            var tieBreaker = false;
            
            if (isTie && !coinFlipShown) {
                // Show coin flip animation
                votes[coinFlipKey] = true;
                
                // STORE the coin flip result so it's consistent
                var coinFlipResultKey = activeChallenge.id + '_coinflip_winner';
                var coinFlipResult = Math.random() < 0.5 ? 'parent' : 'teen';
                votes[coinFlipResultKey] = coinFlipResult;
                console.log('Coin flip result stored:', coinFlipResult);
                
                saveData();
                
                setTimeout(function() {
                    showCoinFlip();
                }, 500);
                
                // Return placeholder while coin flips
                return '<h1 class="screen-title">Calculating Results...</h1>' +
                       '<p class="screen-desc">Both votes are in!</p>';
            }
            
            // AWARD POINTS ONLY ONCE - Before determining winner for display
            if (!pointsAlreadyAwarded) {
                console.log('AWARDING POINTS - First time seeing completed votes');
                
                // SET FLAG IMMEDIATELY before doing ANYTHING else
                votes[pointsAwardedKey] = true;
                
                // Calculate and award points
                if (parentVotes > teenVotes) {
                    pair.parentScore += 3;
                    pair.parentWins += 1;
                    console.log('Points awarded to', pair.parentName);
                } else if (teenVotes > parentVotes) {
                    pair.teenScore += 3;
                    pair.teenWins += 1;
                    console.log('Points awarded to', pair.teenName);
                } else {
                    // Tie - use STORED coin flip result
                    tieBreaker = true;
                    var coinFlipResultKey = activeChallenge.id + '_coinflip_winner';
                    var coinFlipWinner = votes[coinFlipResultKey];
                    
                    if (!coinFlipWinner) {
                        // Shouldn't happen, but fallback
                        coinFlipWinner = Math.random() < 0.5 ? 'parent' : 'teen';
                        votes[coinFlipResultKey] = coinFlipWinner;
                        console.warn('Coin flip result missing, generated:', coinFlipWinner);
                    }
                    
                    if (coinFlipWinner === 'parent') {
                        pair.parentScore += 3;
                        pair.parentWins += 1;
                        console.log('Points awarded to', pair.parentName, '(coin flip)');
                    } else {
                        pair.teenScore += 3;
                        pair.teenWins += 1;
                        console.log('Points awarded to', pair.teenName, '(coin flip)');
                    }
                }
                
                // Update streak and check achievements
                updateStreak();
                checkAchievements();
                
                // Show win animation
                showWinAnimation();
                
                // Save once - this will trigger Firebase listeners but flag is already set
                saveData();
                
                // CRITICAL: Don't continue rendering this time - let the next render show results
                // This prevents the save->listener->render loop from happening immediately
                return '<h1 class="screen-title">Calculating Final Results...</h1>' +
                       '<p class="screen-desc">Updating scores...</p>';
            } else {
                console.log('Points already awarded for this challenge, skipping');
            }
            
            // Determine winner for display (after points are awarded)
            if (parentVotes > teenVotes) {
                winner = 'parent';
                winnerName = pair.parentName;
            } else if (teenVotes > parentVotes) {
                winner = 'teen';
                winnerName = pair.teenName;
            } else {
                // Tie - use STORED coin flip result for display
                tieBreaker = true;
                var coinFlipResultKey = activeChallenge.id + '_coinflip_winner';
                winner = votes[coinFlipResultKey] || 'parent';
                winnerName = winner === 'parent' ? pair.parentName : pair.teenName;
            }
            
            var winnerSubmission = winner === 'parent' ? parentSubmission : teenSubmission;

            // Enhanced winner announcement
            var html = '<div class="winner-announcement">' +
                       '<div class="winner-trophy">üèÜ</div>' +
                       '<div class="winner-text">' + winnerName + ' Wins!</div>' +
                       '<div class="winner-subtitle">+3 points</div>' +
                       (tieBreaker ? '<div style="margin-top: 12px; font-size: 14px;">ü™ô Won by coin flip!</div>' : '') +
                       '</div>';

            // Challenge info card
            html += '<div class="challenge-info-card">' +
                    '<div class="info-row">' +
                    '<span class="info-label">Challenge</span>' +
                    '<span class="info-value">' + activeChallenge.title + '</span>' +
                    '</div>' +
                    '<div class="info-row">' +
                    '<span class="info-label">Final Vote</span>' +
                    '<span class="info-value">' + parentVotes + ' - ' + teenVotes + '</span>' +
                    '</div>' +
                    '</div>';

            // Winning submission
            if (winnerSubmission) {
                html += '<div style="text-align: center; margin: 20px 0;">' +
                        '<div style="font-weight: 700; margin-bottom: 12px; color: #2d3748;">Winning Entry</div>' +
                        '<img src="' + winnerSubmission.imageData + '" class="submission-preview" style="border: 4px solid #ffd700;">' +
                        '</div>';
            }

            // Current standings
            html += '<div class="stats-comparison">' +
                    '<div class="stat-column">' +
                    '<div style="font-weight: 700; margin-bottom: 8px; color: #2d3748;">' + pair.parentName + '</div>' +
                    '<div class="stat-big-number">' + pair.parentScore + '</div>' +
                    '<div style="font-size: 12px; color: #718096; margin-top: 4px;">' + pair.parentWins + ' wins</div>' +
                    '</div>' +
                    '<div class="stat-vs">VS</div>' +
                    '<div class="stat-column">' +
                    '<div style="font-weight: 700; margin-bottom: 8px; color: #2d3748;">' + pair.teenName + '</div>' +
                    '<div class="stat-big-number">' + pair.teenScore + '</div>' +
                    '<div style="font-size: 12px; color: #718096; margin-top: 4px;">' + pair.teenWins + ' wins</div>' +
                    '</div>' +
                    '</div>';

            // Action buttons
            html += '<div class="btn-group">' +
                    '<button class="btn" onclick="startNew()"><span class="btn-icon">üéÆ</span>New Challenge</button>' +
                    '<button class="btn btn-secondary" onclick="viewHistory()"><span class="btn-icon">üìö</span>View History</button>' +
                    '</div>';

            return html;
        }

        function showCoinFlip() {
            // Calculate who wins the coin flip
            var winner = Math.random() < 0.5 ? pair.parentName : pair.teenName;
            
            // Create overlay
            var overlay = document.createElement('div');
            overlay.className = 'coin-flip-container';
            overlay.innerHTML = 
                '<div class="tie-message">It\'s a Tie!<br>Coin Flip Time! ü™ô</div>' +
                '<div class="coin">ü™ô</div>' +
                '<div class="winner-reveal">' + winner + ' Wins!</div>';
            
            document.body.appendChild(overlay);
            
            // Remove overlay after 3.5 seconds and refresh
            setTimeout(function() {
                document.body.removeChild(overlay);
                updateScreen();
            }, 3500);
        }

        function showWinAnimation() {
            // Simple confetti effect
            var confetti = document.createElement('div');
            confetti.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9999;';
            
            // Create confetti pieces
            var colors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1', '#f093fb'];
            for (var i = 0; i < 50; i++) {
                var piece = document.createElement('div');
                piece.style.cssText = 
                    'position:absolute;' +
                    'width:10px;height:10px;' +
                    'background:' + colors[Math.floor(Math.random() * colors.length)] + ';' +
                    'left:' + Math.random() * 100 + '%;' +
                    'top:-20px;' +
                    'border-radius:50%;' +
                    'animation:confettiFall ' + (2 + Math.random() * 2) + 's linear forwards;';
                confetti.appendChild(piece);
            }
            
            // Add animation
            var style = document.createElement('style');
            style.textContent = '@keyframes confettiFall { to { transform: translateY(100vh) rotate(360deg); opacity: 0; } }';
            document.head.appendChild(style);
            
            document.body.appendChild(confetti);
            
            // Remove after animation
            setTimeout(function() {
                if (confetti.parentNode) confetti.parentNode.removeChild(confetti);
                if (style.parentNode) style.parentNode.removeChild(style);
            }, 4000);
        }

        function startNew() {
            // Archive current challenge
            activeChallenge.phase = 'completed';
            saveData();
            updateScreen();
        }

        function resetAll() {
            if (confirm('Reset all data for this pair?')) {
                if (db && pairId) {
                    db.ref('pairs/' + pairId).remove();
                    db.ref('challenges/' + pairId).remove();
                    db.ref('submissions/' + pairId).remove();
                    db.ref('votes/' + pairId).remove();
                }
                location.reload();
            }
        }

        function showStorageInfo() {
            var total = 0;
            for (var key in localStorage) {
                if (localStorage.hasOwnProperty(key) && key.startsWith('versus_')) {
                    total += localStorage[key].length;
                }
            }
            
            var totalMB = (total / 1024 / 1024).toFixed(2);
            var submissionsCount = submissions.length;
            
            alert('Storage Usage:\n\nTotal: ' + totalMB + ' MB\nSubmissions: ' + submissionsCount + '\n\nLimit: ~5-10 MB\n\nTip: Reset to clear storage');
        }

        function formatTime(endTime) {
            var now = Date.now();
            var remaining = endTime - now;
            
            if (remaining <= 0) return 'Ended';
            
            var minutes = Math.floor(remaining / 60000);
            var seconds = Math.floor((remaining % 60000) / 1000);
            
            if (minutes > 60) {
                var hours = Math.floor(minutes / 60);
                return hours + 'h ' + (minutes % 60) + 'm';
            }
            
            return minutes + 'm ' + seconds + 's';
        }

        // Global error handler
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Global error:', msg, error);
            return false; // Let default handler run
        };

        // ==========================================
        // ACHIEVEMENTS & STREAKS
        // ==========================================
        function checkAchievements() {
            var completedChallenges = challenges.filter(function(c) { return c.phase === 'completed'; });
            var newAchievements = [];
            
            // Check each achievement
            for (var i = 0; i < achievementDefinitions.length; i++) {
                var achievement = achievementDefinitions[i];
                var alreadyUnlocked = achievements.some(function(a) { return a.id === achievement.id; });
                
                if (!alreadyUnlocked) {
                    var unlocked = false;
                    
                    // First win
                    if (achievement.id === 'first_win' && (pair.parentWins >= 1 || pair.teenWins >= 1)) {
                        unlocked = true;
                    }
                    
                    // Total challenges
                    if (achievement.id === 'challenges_10' && completedChallenges.length >= 10) unlocked = true;
                    if (achievement.id === 'challenges_25' && completedChallenges.length >= 25) unlocked = true;
                    if (achievement.id === 'challenges_50' && completedChallenges.length >= 50) unlocked = true;
                    
                    // Streak achievements
                    if (achievement.id === 'week_streak' && streakData.current >= 7) unlocked = true;
                    
                    // Win streaks (would need to track separately in real implementation)
                    
                    if (unlocked) {
                        achievements.push({
                            id: achievement.id,
                            unlockedAt: Date.now(),
                            player: currentPlayer
                        });
                        newAchievements.push(achievement);
                    }
                }
            }
            
            // Show achievement notifications
            for (var i = 0; i < newAchievements.length; i++) {
                var ach = newAchievements[i];
                addNotification('üèÜ Achievement Unlocked: ' + ach.name + '!', 'achievement');
            }
            
            return newAchievements.length > 0;
        }

        function updateStreak() {
            var today = new Date().toDateString();
            var lastDate = streakData.lastDate ? new Date(streakData.lastDate).toDateString() : null;
            
            if (lastDate === today) {
                // Already played today
                return;
            }
            
            var yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            var yesterdayStr = yesterday.toDateString();
            
            if (lastDate === yesterdayStr) {
                // Continuing streak
                streakData.current++;
            } else if (!lastDate) {
                // First day
                streakData.current = 1;
            } else {
                // Streak broken
                streakData.current = 1;
            }
            
            streakData.lastDate = new Date().toISOString();
            
            if (streakData.current > streakData.longest) {
                streakData.longest = streakData.current;
            }
            
            saveData();
        }

        function viewAchievements() {
            currentScreen = 'achievements';
            renderScreen();
        }

        function renderAchievements() {
            var html = '<div class="breadcrumb">' +
                       '<span class="breadcrumb-item" onclick="currentScreen=\'create\'; renderScreen();">Arena</span>' +
                       '<span class="breadcrumb-separator">‚Ä∫</span>' +
                       '<span class="breadcrumb-current">Achievements</span>' +
                       '</div>';
            
            html += '<h1 class="screen-title">üèÜ Achievements</h1>';
            
            // Streak banner
            if (streakData.current > 0) {
                html += '<div class="streak-banner">' +
                        'üî• Current Streak' +
                        '<div class="streak-number">' + streakData.current + '</div>' +
                        'days in a row!' +
                        (streakData.longest > streakData.current ? '<div style="font-size: 12px; margin-top: 8px;">Best: ' + streakData.longest + ' days</div>' : '') +
                        '</div>';
            }
            
            // Overall stats
            var completedChallenges = challenges.filter(function(c) { return c.phase === 'completed'; });
            var unlockedCount = achievements.length;
            var totalAchievements = achievementDefinitions.length;
            
            html += '<div class="stats-grid" style="margin-bottom: 24px;">' +
                    '<div class="stat-card">' +
                    '<div class="stat-value">' + completedChallenges.length + '</div>' +
                    '<div class="stat-label">Total Challenges</div>' +
                    '</div>' +
                    '<div class="stat-card">' +
                    '<div class="stat-value">' + unlockedCount + '/' + totalAchievements + '</div>' +
                    '<div class="stat-label">Achievements</div>' +
                    '</div>' +
                    '</div>';
            
            html += '<div class="achievement-grid">';
            
            for (var i = 0; i < achievementDefinitions.length; i++) {
                var achievement = achievementDefinitions[i];
                var isUnlocked = achievements.some(function(a) { return a.id === achievement.id; });
                
                html += '<div class="achievement-card ' + (isUnlocked ? 'unlocked' : 'locked') + '">' +
                        '<div class="achievement-icon">' + achievement.icon + '</div>' +
                        '<div class="achievement-name">' + achievement.name + '</div>' +
                        '<div class="achievement-desc">' + achievement.desc + '</div>' +
                        (isUnlocked ? '<div style="color: #48bb78; font-size: 10px; margin-top: 4px;">‚úì Unlocked</div>' : '') +
                        '</div>';
            }
            
            html += '</div>';
            
            html += '<button class="btn btn-secondary" style="margin-top: 20px;" onclick="currentScreen=\'create\'; renderScreen();">‚Üê Back</button>';
            
            return html;
        }

        // ==========================================
        // NOTIFICATION SYSTEM
        // ==========================================
        function addNotification(message, type) {
            var notification = {
                id: 'notif_' + Date.now(),
                message: message,
                type: type || 'info',
                timestamp: Date.now(),
                read: false,
                forPlayer: currentPlayer
            };
            
            notifications.push(notification);
            console.log('Notification added:', message);
            showNotificationBadge(message);
        }

        function showNotificationBadge(message) {
            var existing = document.getElementById('notificationBadge');
            if (existing) existing.remove();
            
            var badge = document.createElement('div');
            badge.id = 'notificationBadge';
            badge.className = 'notification-badge';
            badge.textContent = message;
            badge.onclick = function() { badge.remove(); };
            
            document.body.appendChild(badge);
            
            setTimeout(function() {
                if (badge && badge.parentNode) badge.remove();
            }, 5000);
        }

        // ==========================================
        // CHALLENGE HISTORY
        // ==========================================
        function viewHistory() {
            currentScreen = 'history';
            renderScreen();
        }

        function viewChallengeDetail(challengeId) {
            selectedHistoryChallenge = challenges.find(function(c) {
                return c.id === challengeId;
            });
            currentScreen = 'challengeDetail';
            renderScreen();
        }

        function renderHistory() {
            var completedChallenges = challenges.filter(function(c) {
                return c.phase === 'completed';
            });
            
            var html = '<div class="breadcrumb">' +
                       '<span class="breadcrumb-item" onclick="currentScreen=\'create\'; renderScreen();">Arena</span>' +
                       '<span class="breadcrumb-separator">‚Ä∫</span>' +
                       '<span class="breadcrumb-current">History</span>' +
                       '</div>';
            
            html += '<h1 class="screen-title">üìö Challenge History</h1>';
            
            html += '<div class="stats-grid" style="margin-bottom: 24px;">' +
                    '<div class="stat-card">' +
                    '<div class="stat-value">' + completedChallenges.length + '</div>' +
                    '<div class="stat-label">Completed</div>' +
                    '</div>' +
                    '<div class="stat-card">' +
                    '<div class="stat-value">' + pair.parentWins + ' - ' + pair.teenWins + '</div>' +
                    '<div class="stat-label">W-L Record</div>' +
                    '</div>' +
                    '</div>';
            
            if (completedChallenges.length === 0) {
                html += '<div class="empty-state">' +
                        '<div class="empty-state-icon">üìö</div>' +
                        '<div class="empty-state-title">Your arena is empty</div>' +
                        '<div class="empty-state-desc">Start your first showdown to begin tracking history</div>' +
                        '<button class="btn" onclick="currentScreen=\'templates\'; renderScreen();">Start First Challenge</button>' +
                        '</div>';
                return html;
            }
            
            completedChallenges.sort(function(a, b) {
                return b.votingEndsAt - a.votingEndsAt;
            });
            
            html += '<div class="history-grid">';
            
            for (var i = 0; i < completedChallenges.length; i++) {
                var challenge = completedChallenges[i];
                
                var coinFlipKey = challenge.id + '_coinflip_winner';
                var winner = votes[coinFlipKey] || 'unknown';
                
                if (winner === 'unknown') {
                    var parentVoteKey = challenge.id + '_parent';
                    var teenVoteKey = challenge.id + '_teen';
                    var parentVote = votes[parentVoteKey];
                    var teenVote = votes[teenVoteKey];
                    
                    var challengeSubs = submissions.filter(function(s) {
                        return s.challengeId === challenge.id;
                    });
                    
                    if (challengeSubs.length === 2) {
                        var parentSub = challengeSubs.find(function(s) { return s.player === 'parent'; });
                        var teenSub = challengeSubs.find(function(s) { return s.player === 'teen'; });
                        
                        if (parentSub && teenSub) {
                            var parentVotes = 0;
                            var teenVotes = 0;
                            if (parentVote === parentSub.id) parentVotes++;
                            if (parentVote === teenSub.id) teenVotes++;
                            if (teenVote === parentSub.id) parentVotes++;
                            if (teenVote === teenSub.id) teenVotes++;
                            
                            winner = parentVotes > teenVotes ? 'parent' : (teenVotes > parentVotes ? 'teen' : 'tie');
                        }
                    }
                }
                
                var winnerName = winner === 'parent' ? pair.parentName : (winner === 'teen' ? pair.teenName : 'Tie');
                var winnerIcon = winner === 'parent' ? 'üë®' : (winner === 'teen' ? 'üë¶' : 'ü§ù');
                
                var winnerSub = submissions.find(function(s) {
                    return s.challengeId === challenge.id && s.player === winner;
                });
                var thumbnail = winnerSub ? winnerSub.imageData : '';
                
                var date = new Date(challenge.createdAt);
                var dateStr = date.toLocaleDateString();
                
                html += '<div class="history-card" onclick="viewChallengeDetail(\'' + challenge.id + '\')">' +
                        '<div class="history-card-header">' +
                        '<div class="history-card-title">' + challenge.title + '</div>' +
                        '<div class="history-card-date">' + dateStr + '</div>' +
                        '</div>' +
                        '<div class="history-card-content">';
                
                if (thumbnail) {
                    html += '<img src="' + thumbnail + '" class="history-thumbnail">';
                }
                
                html += '<div class="history-winner">' +
                        '<div class="history-winner-name">' + winnerIcon + ' ' + winnerName + '</div>' +
                        '<div class="history-score">+3 points</div>' +
                        '</div>' +
                        '</div>' +
                        '</div>';
            }
            
            html += '</div>';
            html += '<button class="btn btn-secondary" style="margin-top: 20px;" onclick="currentScreen=\'create\'; renderScreen();">‚Üê Back</button>';
            
            return html;
        }

        function renderChallengeDetail() {
            if (!selectedHistoryChallenge) {
                return '<p>Challenge not found</p>';
            }
            
            var challenge = selectedHistoryChallenge;
            
            var html = '<div class="breadcrumb">' +
                       '<span class="breadcrumb-item" onclick="currentScreen=\'create\'; renderScreen();">Arena</span>' +
                       '<span class="breadcrumb-separator">‚Ä∫</span>' +
                       '<span class="breadcrumb-item" onclick="currentScreen=\'history\'; renderScreen();">History</span>' +
                       '<span class="breadcrumb-separator">‚Ä∫</span>' +
                       '<span class="breadcrumb-current">' + challenge.title + '</span>' +
                       '</div>';
            
            html += '<h1 class="screen-title">' + challenge.title + '</h1>';
            html += '<p class="screen-desc">' + challenge.description + '</p>';
            
            var challengeSubs = submissions.filter(function(s) {
                return s.challengeId === challenge.id;
            });
            
            var parentSub = challengeSubs.find(function(s) { return s.player === 'parent'; });
            var teenSub = challengeSubs.find(function(s) { return s.player === 'teen'; });
            
            var parentVoteKey = challenge.id + '_parent';
            var teenVoteKey = challenge.id + '_teen';
            var parentVote = votes[parentVoteKey];
            var teenVote = votes[teenVoteKey];
            
            var parentVotes = 0;
            var teenVotes = 0;
            if (parentSub && teenSub) {
                if (parentVote === parentSub.id) parentVotes++;
                if (parentVote === teenSub.id) teenVotes++;
                if (teenVote === parentSub.id) parentVotes++;
                if (teenVote === teenSub.id) teenVotes++;
            }
            
            var winner = parentVotes > teenVotes ? 'parent' : (teenVotes > parentVotes ? 'teen' : 'tie');
            
            html += '<div class="detail-submissions">';
            
            if (parentSub) {
                html += '<div class="detail-submission' + (winner === 'parent' ? ' winner' : '') + '">' +
                        '<img src="' + parentSub.imageData + '">' +
                        '<strong>' + pair.parentName + '</strong>' +
                        '<div style="margin-top: 8px; color: #667eea; font-weight: 600;">' + parentVotes + ' votes</div>' +
                        (winner === 'parent' ? '<div style="color: #ffd700;">üèÜ Winner</div>' : '') +
                        '</div>';
            }
            
            if (teenSub) {
                html += '<div class="detail-submission' + (winner === 'teen' ? ' winner' : '') + '">' +
                        '<img src="' + teenSub.imageData + '">' +
                        '<strong>' + pair.teenName + '</strong>' +
                        '<div style="margin-top: 8px; color: #667eea; font-weight: 600;">' + teenVotes + ' votes</div>' +
                        (winner === 'teen' ? '<div style="color: #ffd700;">üèÜ Winner</div>' : '') +
                        '</div>';
            }
            
            html += '</div>';
            
            var created = new Date(challenge.createdAt);
            var votingEnded = new Date(challenge.votingEndsAt);
            
            html += '<div style="margin-top: 24px; padding: 16px; background: #f7fafc; border-radius: 12px;">' +
                    '<h3 style="margin-bottom: 12px;">Challenge Details</h3>' +
                    '<p><strong>Created:</strong> ' + created.toLocaleString() + '</p>' +
                    '<p><strong>Completed:</strong> ' + votingEnded.toLocaleString() + '</p>' +
                    '<p><strong>Final Score:</strong> ' + pair.parentName + ' ' + parentVotes + ' - ' + pair.teenName + ' ' + teenVotes + '</p>';
            
            if (winner === 'tie') {
                var coinFlipWinner = votes[challenge.id + '_coinflip_winner'];
                html += '<p><strong>Tie Breaker:</strong> ' + (coinFlipWinner === 'parent' ? pair.parentName : pair.teenName) + ' won coin flip</p>';
            }
            
            html += '</div>';
            html += '<button class="btn btn-secondary" style="margin-top: 20px;" onclick="currentScreen=\'history\'; renderScreen();">‚Üê Back</button>';
            
            return html;
        }

        // Update timers every second
        setInterval(function() {
            try {
                var timers = document.querySelectorAll('[data-timer-end]');
                for (var i = 0; i < timers.length; i++) {
                    var end = parseInt(timers[i].getAttribute('data-timer-end'));
                    timers[i].textContent = formatTime(end);
                }

                // Check for auto-transitions
                if (activeChallenge) {
                    var now = Date.now();
                    if (activeChallenge.phase === 'enrollment' && now >= activeChallenge.enrollmentEndsAt) {
                        // Only move to voting if BOTH players have submitted
                        var parentSubmitted = submissions.some(function(s) {
                            return s.challengeId === activeChallenge.id && s.player === 'parent';
                        });
                        var teenSubmitted = submissions.some(function(s) {
                            return s.challengeId === activeChallenge.id && s.player === 'teen';
                        });
                        
                        if (parentSubmitted && teenSubmitted) {
                            console.log('Both submitted - moving to voting');
                            activeChallenge.phase = 'voting';
                            saveData();
                            updateScreen();
                        } else {
                            console.log('Timer expired but waiting for submissions. Parent:', parentSubmitted, 'Teen:', teenSubmitted);
                        }
                    } else if (activeChallenge.phase === 'voting' && now >= activeChallenge.votingEndsAt) {
                        // Only complete if BOTH players have voted
                        var parentVoteKey = activeChallenge.id + '_parent';
                        var teenVoteKey = activeChallenge.id + '_teen';
                        var parentVoted = votes[parentVoteKey] ? true : false;
                        var teenVoted = votes[teenVoteKey] ? true : false;
                        
                        if (parentVoted && teenVoted) {
                            console.log('Both voted - completing challenge');
                            activeChallenge.phase = 'completed';
                            saveData();
                            updateScreen();
                        } else {
                            console.log('Timer expired but waiting for votes. Parent:', parentVoted, 'Teen:', teenVoted);
                        }
                    }
                }
            } catch (err) {
                console.error('Timer update error:', err);
            }
        }, 1000);
    </script>
</body>
</html>
