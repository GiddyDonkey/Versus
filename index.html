<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VERSUS - Every Snap Matters</title>
    
    <!-- PWA / iOS Web App -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="VERSUS">
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="./manifest.json">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700;900&display=swap" rel="stylesheet">
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Fix for sandboxed environments (file:// protocol or iframes)
        // Override fetch to avoid postMessage cloning issues
        if (window.location.protocol === 'file:' || window.self !== window.top) {
            console.log('üîß Applying fetch fix for sandboxed environment');
        }
    </script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000000;
            color: #FFFFFF;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .app {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background: radial-gradient(circle at 20% 80%, rgba(255, 215, 0, 0.03) 0%, transparent 50%),
                        #000000;
        }

        .header {
            padding: 20px;
            border-bottom: 1px solid #1C1C1E;
            position: sticky;
            top: 0;
            z-index: 100;
            background: #000000;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .settings-icon {
            font-size: 24px;
            cursor: pointer;
            opacity: 0.8;
            transition: all 0.2s;
        }

        .settings-icon:hover {
            opacity: 1;
            transform: scale(1.1) rotate(90deg);
        }

        .logo {
            font-size: 28px;
            font-weight: 900;
            letter-spacing: 3px;
            text-align: center;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tagline {
            text-align: center;
            font-size: 9px;
            color: #A1A1A6;
            letter-spacing: 2px;
            margin-top: 4px;
            text-transform: uppercase;
            font-weight: 700;
        }

        .nav {
            display: flex;
            gap: 8px;
            padding: 12px 20px;
            background: #0A0A0C;
            border-bottom: 1px solid #1C1C1E;
            position: sticky;
            top: 73px;
            z-index: 99;
        }

        .nav-btn {
            flex: 1;
            padding: 10px;
            background: #1C1C1E;
            border: 1px solid #2C2C2E;
            border-radius: 8px;
            color: #8E8E93;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-btn:hover { background: #2C2C2E; }
        .nav-btn.active { 
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000000;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
        }

        .content { padding: 24px 20px 100px; }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #000000;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.25);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 215, 0, 0.3);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #2C2C2E;
            color: #F5F5F7;
            border: 1px solid #3C3C3E;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .section-title {
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #8E8E93;
            margin-bottom: 16px;
        }

        .challenge-tile {
            padding: 16px;
            background: #1C1C1E;
            border: 2px solid #2C2C2E;
            border-left: 4px solid #2C2C2E;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.25s ease;
            position: relative;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .challenge-tile:hover {
            border-color: #FFD700;
            background: #2C2C2E;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.2);
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 12, 0.98);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            overflow-y: auto;
            padding: 20px;
        }

        .reveal-container {
            text-align: center;
            max-width: 500px;
            width: 100%;
        }

        .upload-zone {
            background: #1C1C1E;
            border: 2px dashed #3C3C3E;
            border-radius: 12px;
            padding: 48px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 24px;
        }

        .upload-zone:hover {
            border-color: #D4AF37;
            background: rgba(212, 175, 55, 0.05);
        }

        .preview-media {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #D4AF37;
            animation: confettiFall 3s linear forwards;
        }

        @keyframes confettiFall {
            to { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .fade-in { animation: fadeIn 0.4s ease; }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .hidden { display: none; }

        .back-btn {
            background: none;
            border: none;
            color: #8E8E93;
            font-size: 15px;
            padding: 12px 0;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .ladder-row {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: #1C1C1E;
            border: 1px solid #2C2C2E;
            border-radius: 12px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .ladder-row.rank-1 {
            border-color: #FFD700;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.05) 0%, rgba(255, 165, 0, 0.02) 100%);
        }

        .rank {
            font-size: 24px;
            font-weight: 900;
            min-width: 36px;
            text-align: center;
        }

        .rank-1 { color: #FFD700; }
        .rank-2 { color: #C0C0C0; }
        .rank-3 { color: #CD7F32; }

        .avatar { font-size: 48px; }

        .member-info { flex: 1; }

        .member-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .points {
            font-size: 24px;
            font-weight: 900;
            color: #FFD700;
        }

        .streak {
            display: inline-block;
            background: rgba(255, 59, 48, 0.2);
            color: #FF3B30;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            margin-left: 8px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #3C3C3E;
            border-top-color: #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        @keyframes crownPop {
            0% { transform: translate(-50%, -50%) scale(0) rotate(-180deg); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2) rotate(10deg); }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 1; }
        }
        
        @keyframes crownFly {
            0% { top: 0; transform: translateX(-50%) rotate(0deg); }
            25% { top: -30px; transform: translateX(-50%) rotate(-15deg); }
            50% { top: 20px; transform: translateX(-50%) rotate(10deg); }
            75% { top: 40px; transform: translateX(-50%) rotate(-5deg); }
            100% { top: 60px; transform: translateX(-50%) rotate(0deg); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }
            50% { box-shadow: 0 0 40px rgba(255, 215, 0, 0.6); }
        }
        
        /* Welcome screen animations */
        @keyframes ember {
            0%, 100% { transform: translateY(0px) translateX(0px); opacity: 0.2; }
            25% { transform: translateY(-15px) translateX(5px); opacity: 0.5; }
            50% { transform: translateY(-25px) translateX(-5px); opacity: 0.7; }
            75% { transform: translateY(-10px) translateX(8px); opacity: 0.4; }
        }
        
        @keyframes shimmer {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        @keyframes buttonGlow {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
            max-width: 90%;
        }
        
        .toast {
            background: #1C1C1E;
            border: 2px solid #3C3C3E;
            border-radius: 12px;
            padding: 14px 20px;
            font-size: 14px;
            font-weight: 600;
            color: #FFFFFF;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            animation: toastIn 0.3s ease-out, toastOut 0.3s ease-in 2.7s forwards;
            pointer-events: auto;
        }
        
        .toast.member {
            border-color: #34C759;
            background: linear-gradient(135deg, rgba(52, 199, 89, 0.2), #1C1C1E);
        }
        
        .toast.challenge {
            border-color: #FF9500;
            background: linear-gradient(135deg, rgba(255, 149, 0, 0.2), #1C1C1E);
        }
        
        .toast.victory {
            border-color: #FFD700;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), #1C1C1E);
        }
        
        .toast.info {
            border-color: #007AFF;
            background: linear-gradient(135deg, rgba(0, 122, 255, 0.2), #1C1C1E);
        }
        
        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes toastOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
        
        /* Stir the Pot Button - Mischievous Ember Glow */
        .stir-the-pot-btn {
            animation: emberGlow 3s ease-in-out infinite;
        }
        
        .stir-the-pot-btn:hover {
            background: linear-gradient(135deg, rgba(255, 149, 0, 0.2), rgba(255, 69, 0, 0.15)) !important;
            border-color: rgba(255, 149, 0, 0.5) !important;
            transform: scale(1.01);
        }
        
        .stir-the-pot-btn:active {
            transform: scale(0.98);
        }
        
        @keyframes emberGlow {
            0%, 100% { 
                box-shadow: 0 0 8px rgba(255, 149, 0, 0.15), inset 0 0 20px rgba(255, 149, 0, 0.03);
            }
            50% { 
                box-shadow: 0 0 16px rgba(255, 149, 0, 0.25), inset 0 0 30px rgba(255, 149, 0, 0.06);
            }
        }
        
        /* Install Prompt Banner */
        .install-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #1C1C1E 0%, #0A0A0C 100%);
            border-top: 2px solid #FF9500;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            z-index: 9999;
            animation: slideUpBanner 0.3s ease-out;
        }
        
        .install-banner.hidden {
            display: none;
        }
        
        @keyframes slideUpBanner {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Install Modal Overlay */
        .install-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.2s ease-out;
        }
        
        .install-modal {
            background: #1C1C1E;
            border: 2px solid #2C2C2E;
            border-radius: 20px;
            max-width: 360px;
            width: 100%;
            overflow: hidden;
            animation: scaleIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .install-step {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #2C2C2E;
        }
        
        .install-step:last-child {
            border-bottom: none;
        }
        
        .install-step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF9500, #FF3B30);
            color: #FFFFFF;
            font-size: 14px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .install-step-content {
            flex: 1;
        }
        
        .install-step-title {
            font-size: 14px;
            font-weight: 700;
            color: #FFFFFF;
            margin-bottom: 2px;
        }
        
        .install-step-desc {
            font-size: 12px;
            color: #8E8E93;
            line-height: 1.4;
        }
        
        .install-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #007AFF;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Install Prompt Banner (shown when not installed) -->
    <div class="install-banner hidden" id="installBanner">
        <div style="flex: 1;">
            <div style="font-size: 13px; font-weight: 700; color: #FFFFFF;">üì≤ Install for notifications</div>
            <div style="font-size: 11px; color: #8E8E93;">Get challenge alerts & never miss a duel</div>
        </div>
        <button onclick="showInstallModal()" style="background: linear-gradient(135deg, #FF9500, #FF3B30); border: none; border-radius: 8px; padding: 10px 16px; color: white; font-size: 12px; font-weight: 700; cursor: pointer;">
            Install
        </button>
        <button onclick="dismissInstallBanner()" style="background: none; border: none; color: #6E6E73; font-size: 18px; cursor: pointer; padding: 4px;">‚úï</button>
    </div>
    
    <div class="app">
        <div class="header" id="app-header">
            <div style="flex: 1; display: flex; align-items: center;">
                <div id="squadSwitcher" onclick="toggleSquadSwitcher()" style="display: flex; align-items: center; gap: 6px; padding: 6px 10px; background: rgba(255, 255, 255, 0.1); border-radius: 8px; cursor: pointer; max-width: 140px;">
                    <span id="currentSquadName" style="font-size: 12px; font-weight: 600; color: #FFFFFF; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Squad</span>
                    <span style="font-size: 10px; color: #8E8E93;">‚ñº</span>
                </div>
                <!-- Dropdown menu -->
                <div id="squadDropdown" style="display: none; position: absolute; top: 60px; left: 12px; background: #1C1C1E; border: 1px solid #3C3C3E; border-radius: 12px; min-width: 200px; z-index: 1000; box-shadow: 0 8px 32px rgba(0,0,0,0.4); overflow: hidden;">
                    <div id="squadList" style="max-height: 250px; overflow-y: auto;"></div>
                    <div style="border-top: 1px solid #3C3C3E; padding: 8px;">
                        <div onclick="joinNewSquad()" style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; cursor: pointer; border-radius: 8px;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">
                            <span style="font-size: 16px;">‚ûï</span>
                            <span style="font-size: 13px; color: #0A84FF; font-weight: 600;">Join New Squad</span>
                        </div>
                    </div>
                </div>
            </div>
            <div style="text-align: center;">
                <div class="logo">VERSUS</div>
                <div class="tagline">EVERY SNAP MATTERS</div>
            </div>
            <div style="flex: 1; display: flex; justify-content: flex-end; align-items: center; gap: 12px;">
                <div id="headerAvatar" onclick="screen='profile'; render();" style="font-size: 24px; cursor: pointer;"></div>
                <div class="settings-icon" onclick="screen='settings'; render();">‚öôÔ∏è</div>
            </div>
        </div>

        <div class="nav" id="app-nav">
            <button class="nav-btn active" onclick="goTo('arena')">‚öîÔ∏è Arena</button>
            <button class="nav-btn" onclick="goTo('ladder')">üëë Ladder</button>
        </div>

        <div class="content" id="content">
            <div style="text-align: center; padding: 60px 20px;">
                <div class="loading-spinner"></div>
                <p style="margin-top: 16px; color: #8E8E93;">Loading...</p>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://kxwwnqqwelgnrtjtkufl.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4d3ducXF3ZWxnbnJ0anRrdWZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4NTgwMTksImV4cCI6MjA4NTQzNDAxOX0.H03Qhf4hymkMpuIEnOwpuMHLie8oNaJNRbm4r72iSFM';
        
        // Create client with default settings
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        console.log('‚úÖ Supabase client initialized');

        // ============================================
        // GLOBAL ERROR HANDLER
        // ============================================
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Global error:', msg, 'at line', lineNo);
            document.getElementById('content').innerHTML = `
                <div style="padding: 40px; text-align: center;">
                    <h2 style="color: #FF3B30;">Error Loading App</h2>
                    <p style="color: #8E8E93; margin: 16px 0;">${msg}</p>
                    <p style="color: #8E8E93; font-size: 12px;">Line: ${lineNo}</p>
                    <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 20px;">Reload App</button>
                </div>
            `;
            return true;
        };

        // ============================================
        // STATE
        // ============================================
        let screen = 'welcome';
        let squadId = localStorage.getItem('squadId') || null;
        let squadCode = localStorage.getItem('squadCode') || null;
        let currentMemberId = localStorage.getItem('memberId') || null;
        let selectedOpponent = null;
        let selectedChallenge = null;
        let selectedMedia = null;
        let mediaType = null;
        let isSubmitting = false;
        
        // Multi-squad support: saved squads list
        let savedSquads = JSON.parse(localStorage.getItem('savedSquads') || '[]');
        
        // In-memory squad data (refreshed from Supabase)
        let squad = null;
        let members = {};
        let challenges = [];
        let previousMemberCount = 0; // Track member count for notifications
        let knownMemberIds = new Set(); // Track known members
        
        // v21: Phase 1 - Tension mechanics
        const DEADLINE_HOURS = 24; // Response deadline in hours
        const WIN_POINTS = 10;
        const LOSS_POINTS = 3; // Points lost on defeat
        const FORFEIT_POINTS = 3; // Points lost on forfeit (after grace used)
        
        // Grace mechanic: first forfeit per week = no penalty
        let lastSeenAt = localStorage.getItem('lastSeenAt') || null;
        let hasSeenReturnScreen = false;
        
        // v21: Champion state model (Phase 2 data, inactive)
        // States: 'secure' | 'vulnerable' | 'bleeding'
        // These fields will be read from squad data when Phase 2 activates
        
        // Countdown timer interval
        let countdownInterval = null;
        
        // v21: Push notifications
        // VAPID public key ‚Äî generate your keypair via: npx web-push generate-vapid-keys
        // Put the public key here, private key goes in the Edge Function as a secret
        const VAPID_PUBLIC_KEY = 'BDpQxeSOnGARNvFf3XTCKtaWqdHo-RSjLz4kDPxTzhnVbcbjOcre3VxbLaeuFtBwxjAnGCvn0Ctyn6u7wB1Qv4c';
        let pushSubscription = null;
        let pushSupported = ('serviceWorker' in navigator) && ('PushManager' in window) && (window.location.protocol === 'https:');

        // ============================================
        // v25: SQUAD CHALLENGE STATE
        // ============================================
        let squadChallenges = []; // Active + recent squad challenges
        let squadSubmissions = {}; // Keyed by squad_challenge_id
        let captainQueue = [];
        let seasonConfig = null;
        
        // Squad challenge scoring: placement ‚Üí points
        const SQUAD_POINTS = { 1: 5, 2: 3, 3: 2, 4: 1, 5: 0 };
        
        // Universal challenge prompts for captain to pick from
        const SQUAD_CHALLENGE_PROMPTS = [
            "What's in front of you right now",
            "Prove you left the house today",
            "The last thing you ate or drank",
            "Your shoes right now",
            "Best angle of your face ‚Äî 3 seconds, go",
            "Something that made you smile today",
            "Your current view from where you're sitting",
            "The oldest thing within arm's reach",
            "Proof you're not on your couch right now",
            "The most interesting thing within 10 feet of you",
            "Show us your current vibe in one photo",
            "What does your day look like right now",
            "Your surroundings ‚Äî no context, just snap",
            "Action shot ‚Äî you doing literally anything",
            "The weather where you are right now",
        ];

        // Install Prompt System
        let deferredInstallPrompt = null; // For Android beforeinstallprompt
        let installBannerDismissedAt = localStorage.getItem('installBannerDismissedAt') || null;
        let installModalShownThisSession = false;
        const INSTALL_BANNER_RESURFACE_HOURS = 24; // Show banner again after this many hours

        // ============================================
        // CHALLENGE LIBRARY
        // ============================================
        
        // 1:1 Duels - Fast, ego-driven, rematchable
        const duelChallenges = [
            // üî• UNIVERSAL INSTANT SNAPS ‚Äî works anywhere, 5 seconds, no staging
            { name: "Right In Front", type: "photo", time: "30s", desc: "What's directly in front of you. No moving." },
            { name: "Prove You Left the House", type: "photo", time: "30s", desc: "Show us you're not on the couch" },
            { name: "Last Thing You Ate", type: "photo", time: "30s", desc: "Or drank. No judgment." },
            { name: "Your Shoes Right Now", type: "photo", time: "30s", desc: "Whatever's on your feet" },
            { name: "Best Angle ‚Äî 3 Seconds", type: "photo", time: "30s", desc: "Your face. Go." },
            { name: "Something That Made You Smile", type: "photo", time: "30s", desc: "Today. Find it fast." },
            { name: "Your Current View", type: "photo", time: "30s", desc: "From wherever you're sitting" },
            { name: "Oldest Thing Near You", type: "photo", time: "30s", desc: "Within arm's reach" },
            { name: "Not On Your Couch", type: "photo", time: "30s", desc: "Proof you're somewhere interesting" },
            { name: "Most Interesting Thing in 10 Feet", type: "photo", time: "30s", desc: "Look around. Snap it." },
            { name: "Current Vibe in One Photo", type: "photo", time: "30s", desc: "Show us your energy" },
            { name: "Your Day Right Now", type: "photo", time: "30s", desc: "What does it look like" },
            { name: "No Context ‚Äî Just Snap", type: "photo", time: "30s", desc: "Your surroundings. Zero explanation." },
            { name: "Action Shot", type: "photo", time: "30s", desc: "You doing literally anything" },
            { name: "The Weather Where You Are", type: "photo", time: "30s", desc: "Show us what it looks like outside" },
            // üî• RIVALRY PHOTOS (ego-driven)
            { name: "Represents Your Opponent", type: "photo", time: "30s", desc: "Something near you that IS them" },
            { name: "Proof You're Winning", type: "photo", time: "30s", desc: "Closest object that proves it" },
            { name: "Their Last Performance", type: "photo", time: "30s", desc: "Something that describes how they did" },
            { name: "Working Harder", type: "photo", time: "30s", desc: "Proof you're grinding right now" },
            { name: "About To Win Face", type: "photo", time: "30s", desc: "Show us that confidence" },
            { name: "Something Gold", type: "photo", time: "30s", desc: "Find it. Claim it." },
            { name: "Your Throne", type: "photo", time: "30s", desc: "Where you're sitting right now" },
            { name: "Battle Station", type: "photo", time: "30s", desc: "Your current setup" },
            { name: "Victory Snack", type: "photo", time: "30s", desc: "What winners eat" },
            { name: "Champion's View", type: "photo", time: "30s", desc: "What you see from the top" },
            // Standard fun
            { name: "Most Chaotic Selfie", type: "photo", time: "30s", desc: "Mid-action. Weird angle." },
            { name: "Goblin Mode", type: "photo", time: "30s", desc: "Ugliest face you can make" },
            { name: "Don't Look Grab", type: "photo", time: "30s", desc: "Reach blindly behind you, snap what you grab" },
            { name: "Main Character Energy", type: "photo", time: "30s", desc: "You're the star" },
            { name: "Most Unhinged Angle", type: "photo", time: "30s", desc: "Get weird with it" },
            { name: "Mood Object", type: "photo", time: "30s", desc: "Find it fast" },
            { name: "Dramatic Lighting", type: "photo", time: "30s", desc: "Work with what you got" },
            // Video
            { name: "Bottle Flip", type: "video", time: "2m", desc: "Stick the landing üî•" },
            { name: "Trash Can Shot", type: "video", time: "2m", desc: "From across the room" },
            { name: "One-Take Trick Shot", type: "video", time: "2m", desc: "Any object, any target" },
            { name: "Worst Dance Move Ever", type: "video", time: "30s", desc: "So bad it's good" },
            { name: "PG Roast", type: "video", time: "30s", desc: "Roast them. Keep it clean. Make it sting." },
            { name: "Victory Prediction", type: "video", time: "30s", desc: "Tell the camera exactly how you'll win" },
            { name: "If I Lose I'll...", type: "video", time: "30s", desc: "Name your stakes. Make it embarrassing." },
            { name: "Crown Acceptance Speech", type: "video", time: "30s", desc: "Thank everyone except your opponent" }
        ];
        
        // Weekly Squad Challenges - Identity, ritual, shareable
        const weeklyChallenges = [
            { name: "Squad Rebrand", type: "photo", time: "5m", desc: "New team name + logo" },
            { name: "Squad Anthem Drop", type: "video", time: "3m", desc: "15 sec performance" },
            { name: "Fake Album Cover", type: "photo", time: "3m", desc: "You're the artist" },
            { name: "Meme Recreation", type: "photo", time: "3m", desc: "Pick your favorite" },
            { name: "Best Fake Commercial", type: "video", time: "3m", desc: "Sell us something" },
            { name: "Movie Scene Recreation", type: "video", time: "3m", desc: "Act it out" },
            { name: "Style Swap Chaos", type: "photo", time: "5m", desc: "Assign each other outfits" },
            { name: "Squad Villain Origin Story", type: "video", time: "3m", desc: "How you became evil" },
            { name: "Breaking News: Squad Edition", type: "photo", time: "3m", desc: "Fake headline about your squad" },
            { name: "60-Second Room Glow Up", type: "video", time: "2m", desc: "Transform your space" }
        ];
        
        // Combined for backward compatibility (duels are the default)
        const challengeLibrary = duelChallenges;

        // ============================================
        // SOUNDS
        // ============================================
        const sounds = {
            click: () => playTone(800, 0.05),
            challenge: () => playTone(600, 0.1),
            victory: () => {
                playTone(500, 0.15);
                setTimeout(() => playTone(650, 0.15), 150);
                setTimeout(() => playTone(800, 0.2), 300);
            },
            defeat: () => playTone(300, 0.2)
        };

        function playTone(freq, duration) {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(0.2, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + duration);
            } catch (e) {}
        }

        // ============================================
        // SUPABASE DATA FUNCTIONS
        // ============================================
        
        async function loadSquadData() {
            if (!squadId) return null;
            
            try {
                // Load squad
                const { data: squadData, error: squadError } = await db
                    .from('squads')
                    .select('*')
                    .eq('id', squadId)
                    .single();
                
                if (squadError) throw squadError;
                squad = squadData;
                
                // Load members
                const { data: membersData, error: membersError } = await db
                    .from('members')
                    .select('*')
                    .eq('squad_id', squadId);
                
                if (membersError) throw membersError;
                
                // Check for new members (for notifications)
                const newMemberIds = membersData
                    .filter(m => !knownMemberIds.has(m.id) && m.id !== currentMemberId)
                    .map(m => m.id);
                
                // Show notification for new members (only if we already had members loaded)
                if (knownMemberIds.size > 0 && newMemberIds.length > 0) {
                    newMemberIds.forEach(newId => {
                        const newMember = membersData.find(m => m.id === newId);
                        if (newMember) {
                            console.log('üÜï New member detected:', newMember.name);
                            showToast(`${newMember.avatar || 'üë§'} ${newMember.name} joined the squad!`, 'member');
                            sounds.victory();
                        }
                    });
                }
                
                // Update known members
                membersData.forEach(m => knownMemberIds.add(m.id));
                
                // Convert to object keyed by ID
                members = {};
                membersData.forEach(m => {
                    members[m.id] = m;
                });
                
                // Load challenges
                const { data: challengesData, error: challengesError } = await db
                    .from('challenges')
                    .select('*')
                    .eq('squad_id', squadId)
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                if (challengesError) throw challengesError;
                challenges = challengesData || [];
                
                // Load ambient pings (stir the pot messages)
                await loadAmbientPings();
                
                console.log('‚úÖ Squad data loaded:', squad.name);
                console.log('   Members:', Object.keys(members).length);
                console.log('   Challenges:', challenges.length);
                console.log('   Pings:', cachedPings.length);
                
                return squad;
            } catch (err) {
                console.error('‚ùå Failed to load squad data:', err);
                return null;
            }
        }
        
        // ============================================
        // v25: SQUAD CHALLENGE DATA FUNCTIONS
        // ============================================
        
        async function loadSquadChallenges() {
            if (!squadId) return;
            try {
                // Load squad challenges
                const { data, error } = await db
                    .from('squad_challenges')
                    .select('*')
                    .eq('squad_id', squadId)
                    .order('challenge_number', { ascending: false })
                    .limit(20);
                if (!error) squadChallenges = data || [];
                
                // Load submissions for active/voting challenges
                const activeIds = squadChallenges
                    .filter(c => c.status === 'active' || c.status === 'voting')
                    .map(c => c.id);
                
                if (activeIds.length > 0) {
                    const { data: subs } = await db
                        .from('squad_submissions')
                        .select('*')
                        .in('squad_challenge_id', activeIds);
                    
                    squadSubmissions = {};
                    (subs || []).forEach(s => {
                        if (!squadSubmissions[s.squad_challenge_id]) squadSubmissions[s.squad_challenge_id] = [];
                        squadSubmissions[s.squad_challenge_id].push(s);
                    });
                }
                
                // Also load submissions for recently completed (for results display)
                const completedIds = squadChallenges
                    .filter(c => c.status === 'completed')
                    .slice(0, 5)
                    .map(c => c.id);
                if (completedIds.length > 0) {
                    const { data: compSubs } = await db
                        .from('squad_submissions')
                        .select('*')
                        .in('squad_challenge_id', completedIds);
                    (compSubs || []).forEach(s => {
                        if (!squadSubmissions[s.squad_challenge_id]) squadSubmissions[s.squad_challenge_id] = [];
                        // Avoid duplicates
                        if (!squadSubmissions[s.squad_challenge_id].find(x => x.id === s.id)) {
                            squadSubmissions[s.squad_challenge_id].push(s);
                        }
                    });
                }
                
                // Load captain queue
                const { data: cq } = await db
                    .from('captain_queue')
                    .select('*')
                    .eq('squad_id', squadId)
                    .in('status', ['pending', 'upcoming'])
                    .order('challenge_number', { ascending: true });
                captainQueue = cq || [];
                
                // Load season config
                const { data: sc } = await db
                    .from('season_config')
                    .select('*')
                    .eq('squad_id', squadId)
                    .eq('is_active', true)
                    .maybeSingle();
                seasonConfig = sc || null;
                
                console.log('‚úÖ v25 data loaded:', squadChallenges.length, 'squad challenges');
            } catch (err) {
                console.error('v25 data load error (non-fatal, tables may not exist yet):', err.message);
                // Non-fatal ‚Äî tables might not exist yet
            }
        }
        
        async function createSquadChallenge(prompt, captainId) {
            try {
                const currentSeason = seasonConfig?.season_number || 1;
                const lastNum = squadChallenges.length > 0 ? Math.max(...squadChallenges.map(c => c.challenge_number)) : 0;
                const newNum = lastNum + 1;
                
                // Calculate deadlines based on season config
                const respHours = parseWindowHours(seasonConfig?.response_window || '24h');
                const voteHours = parseWindowHours(seasonConfig?.voting_window || '8h');
                
                const respDeadline = new Date(Date.now() + respHours * 3600000);
                const voteDeadline = new Date(respDeadline.getTime() + voteHours * 3600000);
                
                // Determine weight (last 1/3 of challenges get 1.5x)
                const totalExpected = estimateTotalChallenges();
                const weight = newNum > Math.ceil(totalExpected * 0.67) ? 1.5 : 1.0;
                
                const { data, error } = await db
                    .from('squad_challenges')
                    .insert({
                        squad_id: squadId,
                        challenge_number: newNum,
                        season_number: currentSeason,
                        prompt: prompt,
                        rule: 'üì∏ One photo. No staging. Just snap it.',
                        type: 'snap',
                        weight: weight,
                        captain_id: captainId,
                        status: 'active',
                        response_deadline: respDeadline.toISOString(),
                        voting_deadline: voteDeadline.toISOString(),
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                
                squadChallenges.unshift(data);
                
                // Update captain queue ‚Äî mark this one as picked
                await db.from('captain_queue')
                    .update({ status: 'picked', picked_at: new Date().toISOString() })
                    .eq('squad_id', squadId)
                    .eq('challenge_number', newNum);
                
                // Create next captain in queue
                await advanceCaptainQueue(newNum + 1);
                
                showToast('üéØ Challenge created!', 'victory');
                sounds.victory();
                
                await loadSquadChallenges();
                render();
                return data;
            } catch (err) {
                console.error('Failed to create squad challenge:', err);
                showToast('Failed to create challenge', 'error');
            }
        }
        
        async function submitToSquadChallenge(challengeId, mediaUrl, mediaType) {
            try {
                const { data, error } = await db
                    .from('squad_submissions')
                    .upsert({
                        squad_challenge_id: challengeId,
                        member_id: currentMemberId,
                        media_url: mediaUrl,
                        media_type: mediaType || 'image',
                    }, { onConflict: 'squad_challenge_id,member_id' })
                    .select()
                    .single();
                
                if (error) throw error;
                
                showToast('üì∏ Snapped!', 'victory');
                sounds.victory();
                
                // Check if all members submitted ‚Äî auto-advance to voting
                await checkSquadChallengeReady(challengeId);
                
                await loadSquadChallenges();
                render();
                return data;
            } catch (err) {
                console.error('Failed to submit:', err);
                showToast('Failed to submit', 'error');
            }
        }
        
        async function checkSquadChallengeReady(challengeId) {
            const subs = squadSubmissions[challengeId] || [];
            const memberCount = Object.keys(members).length;
            // Auto-advance to voting when all members submit (or deadline passes)
            if (subs.length >= memberCount) {
                await db.from('squad_challenges')
                    .update({ status: 'voting' })
                    .eq('id', challengeId)
                    .eq('status', 'active');
            }
        }
        
        async function submitSquadVote(challengeId, rankings) {
            // rankings = [{member_id: "...", rank: 1}, ...]
            try {
                const { data, error } = await db
                    .from('squad_votes')
                    .upsert({
                        squad_challenge_id: challengeId,
                        voter_id: currentMemberId,
                        rankings: rankings,
                    }, { onConflict: 'squad_challenge_id,voter_id' })
                    .select()
                    .single();
                
                if (error) throw error;
                
                showToast('üó≥Ô∏è Vote submitted!', 'victory');
                sounds.victory();
                
                // Check if all votes in ‚Äî auto-complete
                await checkSquadVotingComplete(challengeId);
                
                await loadSquadChallenges();
                render();
                return data;
            } catch (err) {
                console.error('Failed to vote:', err);
                showToast('Failed to vote', 'error');
            }
        }
        
        async function checkSquadVotingComplete(challengeId) {
            const { data: votes } = await db
                .from('squad_votes')
                .select('*')
                .eq('squad_challenge_id', challengeId);
            
            const memberCount = Object.keys(members).length;
            if ((votes || []).length >= memberCount) {
                await tallySquadResults(challengeId, votes);
            }
        }
        
        async function tallySquadResults(challengeId, votes) {
            // Aggregate rankings: sum each member's rank across all votes, lowest total = 1st
            const scores = {};
            (votes || []).forEach(v => {
                (v.rankings || []).forEach(r => {
                    if (!scores[r.member_id]) scores[r.member_id] = 0;
                    scores[r.member_id] += r.rank;
                });
            });
            
            // Sort by total rank score (lower = better)
            const sorted = Object.entries(scores).sort((a, b) => a[1] - b[1]);
            
            // Assign placements and points
            const challenge = squadChallenges.find(c => c.id === challengeId);
            const weight = challenge?.weight || 1.0;
            
            for (let i = 0; i < sorted.length; i++) {
                const [memberId] = sorted[i];
                const placement = i + 1;
                const basePoints = SQUAD_POINTS[placement] || 0;
                const pts = Math.round(basePoints * weight);
                
                // Update submission with rank and points
                await db.from('squad_submissions')
                    .update({ rank: placement, points_awarded: pts })
                    .eq('squad_challenge_id', challengeId)
                    .eq('member_id', memberId);
                
                // Update member points
                const member = members[memberId];
                if (member) {
                    await db.from('members')
                        .update({ points: (member.points || 0) + pts })
                        .eq('id', memberId);
                }
            }
            
            // Mark challenge completed
            await db.from('squad_challenges')
                .update({ status: 'completed', completed_at: new Date().toISOString() })
                .eq('id', challengeId);
            
            showToast('üèÜ Results are in!', 'victory');
            await loadSquadData();
            await loadSquadChallenges();
            render();
        }
        
        async function advanceCaptainQueue(nextChallengeNum) {
            // Rotate through members in standings order
            const rankings = Object.values(members).sort((a, b) => (b.points || 0) - (a.points || 0));
            const memberCount = rankings.length;
            if (memberCount === 0) return;
            
            const captainIndex = (nextChallengeNum - 1) % memberCount;
            const nextCaptain = rankings[captainIndex];
            
            const pickDeadline = new Date(Date.now() + 4 * 3600000); // 4 hours
            
            await db.from('captain_queue').upsert({
                squad_id: squadId,
                season_number: seasonConfig?.season_number || 1,
                challenge_number: nextChallengeNum,
                captain_id: nextCaptain.id,
                status: 'pending',
                pick_deadline: pickDeadline.toISOString(),
            }, { onConflict: 'id' });
        }
        
        async function initializeFirstCaptain() {
            // Call when starting a new season or when no captain queue exists
            if (captainQueue.length > 0) return; // Already initialized
            const lastNum = squadChallenges.length > 0 ? Math.max(...squadChallenges.map(c => c.challenge_number)) : 0;
            await advanceCaptainQueue(lastNum + 1);
            await loadSquadChallenges();
        }
        
        async function saveSeasonConfig(config) {
            try {
                const { data, error } = await db
                    .from('season_config')
                    .upsert({
                        squad_id: squadId,
                        season_number: config.season_number || 1,
                        season_length: config.season_length,
                        challenge_cadence: config.challenge_cadence,
                        response_window: config.response_window,
                        voting_window: config.voting_window,
                        is_active: true,
                    }, { onConflict: 'squad_id,season_number' })
                    .select()
                    .single();
                
                if (error) throw error;
                seasonConfig = data;
                showToast('‚öôÔ∏è Season config saved!', 'info');
            } catch (err) {
                console.error('Failed to save season config:', err);
            }
        }
        
        function parseWindowHours(window) {
            const map = { '2h': 2, '4h': 4, '6h': 6, '8h': 8, '12h': 12, '24h': 24 };
            return map[window] || 24;
        }
        
        function estimateTotalChallenges() {
            const lens = { '4d': 4, '1wk': 7, '2wk': 14, '3wk': 21, '4wk': 28, '6wk': 42 };
            const freqs = { '2xday': 2, '1xday': 1, 'mwf': 3/7, 'eod': 0.5 };
            const days = lens[seasonConfig?.season_length || '3wk'] || 21;
            const perDay = freqs[seasonConfig?.challenge_cadence || 'mwf'] || 0.43;
            return Math.round(days * perDay);
        }
        
        function getTimeRemaining(deadlineStr) {
            if (!deadlineStr) return { text: '', urgent: false };
            const ms = new Date(deadlineStr) - Date.now();
            if (ms <= 0) return { text: 'EXPIRED', urgent: true };
            const h = Math.floor(ms / 3600000);
            const m = Math.floor((ms % 3600000) / 60000);
            if (h > 4) return { text: h + 'h ' + m + 'm', urgent: false };
            if (h >= 1) return { text: h + 'h ' + m + 'm', urgent: false };
            return { text: m + 'm', urgent: true };
        }
        
        async function createSquad(name, adminName, adminAvatar, adminPin) {
            const code = generateSquadCode();
            
            console.log('üìù Creating squad:', { name, code, adminName, adminAvatar });
            
            try {
                // Create squad
                console.log('üì§ Inserting squad into database...');
                const { data: squadData, error: squadError } = await db
                    .from('squads')
                    .insert({ name, code })
                    .select()
                    .single();
                
                console.log('üì• Squad insert result:', { squadData, squadError });
                
                if (squadError) {
                    console.error('Squad error details:', JSON.stringify(squadError, null, 2));
                    throw new Error(squadError.message || squadError.details || 'Failed to create squad');
                }
                
                // Create admin member
                console.log('üì§ Inserting admin member...');
                const { data: memberData, error: memberError } = await db
                    .from('members')
                    .insert({
                        squad_id: squadData.id,
                        user_key: 'admin_' + Date.now(),
                        name: adminName,
                        avatar: adminAvatar,
                        is_admin: true,
                        is_minor: false,
                        pin: adminPin
                    })
                    .select()
                    .single();
                
                console.log('üì• Member insert result:', { memberData, memberError });
                
                if (memberError) {
                    console.error('Member error details:', JSON.stringify(memberError, null, 2));
                    throw new Error(memberError.message || memberError.details || 'Failed to create member');
                }
                
                // Save to localStorage
                squadId = squadData.id;
                squadCode = code;
                currentMemberId = memberData.id;
                localStorage.setItem('squadId', squadId);
                localStorage.setItem('squadCode', squadCode);
                localStorage.setItem('memberId', currentMemberId);
                
                // Load full data
                await loadSquadData();
                
                // Save to squad switcher
                saveCurrentSquad();
                updateSquadSwitcherUI();
                
                // Subscribe to real-time updates
                subscribeToSquad();
                
                console.log('‚úÖ Squad created:', code);
                return { squad: squadData, member: memberData };
            } catch (err) {
                console.error('‚ùå Failed to create squad:', err);
                throw err;
            }
        }
        
        async function joinSquad(code, memberName, memberAge, memberAvatar, memberPin) {
            try {
                // Find squad by code
                const { data: squadData, error: squadError } = await db
                    .from('squads')
                    .select('*')
                    .eq('code', code.toUpperCase())
                    .single();
                
                if (squadError || !squadData) {
                    throw new Error('Squad not found');
                }
                
                // Create member
                const { data: memberData, error: memberError } = await db
                    .from('members')
                    .insert({
                        squad_id: squadData.id,
                        user_key: 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        name: memberName,
                        avatar: memberAvatar,
                        is_admin: false,
                        is_minor: memberAge < 18,
                        age: memberAge,
                        pin: memberPin
                    })
                    .select()
                    .single();
                
                if (memberError) throw memberError;
                
                // Save to localStorage
                squadId = squadData.id;
                squadCode = squadData.code;
                currentMemberId = memberData.id;
                localStorage.setItem('squadId', squadId);
                localStorage.setItem('squadCode', squadCode);
                localStorage.setItem('memberId', currentMemberId);
                
                // Load full data
                await loadSquadData();
                
                // Save to squad switcher
                saveCurrentSquad();
                updateSquadSwitcherUI();
                
                // Subscribe to real-time updates
                subscribeToSquad();
                
                console.log('‚úÖ Joined squad:', squadData.name);
                return { squad: squadData, member: memberData };
            } catch (err) {
                console.error('‚ùå Failed to join squad:', err);
                throw err;
            }
        }
        
        async function uploadMedia(file, challengeId, role) {
            // Determine file extension from the pending file or fallback
            var rawFile = window._pendingFile || null;
            var fileExt = 'jpg';
            if (rawFile && rawFile.name) {
                var parts = rawFile.name.split('.');
                if (parts.length > 1) fileExt = parts[parts.length - 1];
            } else if (typeof file === 'string') {
                // Extract from data URI
                var match = file.match(/^data:(\w+)\/(\w+)/);
                if (match) fileExt = match[2] === 'quicktime' ? 'mov' : match[2];
            }
            var fileName = challengeId + '_' + role + '_' + Date.now() + '.' + fileExt;
            var filePath = squadId + '/' + fileName;
            
            try {
                var uploadData;
                
                if (rawFile) {
                    // Use the raw File object directly (most reliable on iOS)
                    uploadData = rawFile;
                    console.log('Uploading raw File object:', rawFile.name, (rawFile.size / 1024 / 1024).toFixed(2) + 'MB');
                } else if (typeof file === 'string' && file.startsWith('data:')) {
                    // Fallback: convert base64 to blob
                    try {
                        var response = await fetch(file);
                        uploadData = await response.blob();
                    } catch (fetchErr) {
                        // Manual base64 decode fallback for iOS Safari
                        console.log('fetch() blob conversion failed, using manual decode');
                        var parts = file.split(',');
                        var mimeMatch = parts[0].match(/:(.*?);/);
                        var mime = mimeMatch ? mimeMatch[1] : 'image/jpeg';
                        var b64 = atob(parts[1]);
                        var arr = new Uint8Array(b64.length);
                        for (var i = 0; i < b64.length; i++) {
                            arr[i] = b64.charCodeAt(i);
                        }
                        uploadData = new Blob([arr], { type: mime });
                    }
                } else if (typeof file === 'string' && file.startsWith('blob:')) {
                    // Object URL - fetch the blob
                    var blobResp = await fetch(file);
                    uploadData = await blobResp.blob();
                } else {
                    uploadData = file;
                }
                
                var result = await db.storage
                    .from('challenge-media')
                    .upload(filePath, uploadData, {
                        cacheControl: '3600',
                        upsert: true
                    });
                
                if (result.error) throw result.error;
                
                // Get public URL
                var urlData = db.storage
                    .from('challenge-media')
                    .getPublicUrl(filePath);
                
                // Clean up pending file reference
                window._pendingFile = null;
                
                console.log('Media uploaded:', urlData.data.publicUrl);
                return urlData.data.publicUrl;
            } catch (err) {
                console.error('Failed to upload media:', err);
                window._pendingFile = null;
                throw err;
            }
        }
        
        async function createChallenge(opponentId, challengeType, challengeDesc, challengeTime, mediaUrl, mediaType) {
            try {
                // v21: Set 24h response deadline
                var deadlineAt = new Date();
                deadlineAt.setHours(deadlineAt.getHours() + DEADLINE_HOURS);
                
                const { data, error } = await db
                    .from('challenges')
                    .insert({
                        squad_id: squadId,
                        challenge_type: challengeType,
                        challenge_desc: challengeDesc,
                        challenge_time: challengeTime,
                        challenger_id: currentMemberId,
                        opponent_id: opponentId,
                        challenger_media_url: mediaUrl,
                        challenger_media_type: mediaType,
                        status: 'waiting',
                        deadline_at: deadlineAt.toISOString()
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                
                challenges.unshift(data);
                console.log('‚úÖ Challenge created:', data.id);
                
                // Trigger push notification directly (bypasses pg_net)
                triggerPushNotification('challenge_created', data.id, squadId);
                
                return data;
            } catch (err) {
                console.error('‚ùå Failed to create challenge:', err);
                throw err;
            }
        }
        
        async function respondToChallenge(challengeId, mediaUrl, mediaType) {
            try {
                const { data, error } = await db
                    .from('challenges')
                    .update({
                        opponent_media_url: mediaUrl,
                        opponent_media_type: mediaType,
                        status: 'ready'
                    })
                    .eq('id', challengeId)
                    .select()
                    .single();
                
                if (error) throw error;
                
                // Update local cache
                const idx = challenges.findIndex(c => c.id === challengeId);
                if (idx >= 0) challenges[idx] = data;
                
                console.log('‚úÖ Challenge response submitted:', challengeId);
                
                // Trigger push notification directly
                triggerPushNotification('challenge_ready', challengeId, squadId);
                
                return data;
            } catch (err) {
                console.error('‚ùå Failed to respond to challenge:', err);
                throw err;
            }
        }
        
        async function completeChallenge(challengeId, winnerId, challengerScore, opponentScore) {
            try {
                // First, check if already completed (prevent race condition)
                const { data: currentChallenge } = await db
                    .from('challenges')
                    .select('status')
                    .eq('id', challengeId)
                    .single();
                
                if (currentChallenge?.status === 'completed') {
                    console.log('‚ö†Ô∏è Challenge already completed, skipping');
                    await loadSquadData();
                    return currentChallenge;
                }
                
                const { data, error } = await db
                    .from('challenges')
                    .update({
                        status: 'completed',
                        winner_id: winnerId,
                        challenger_score: challengerScore,
                        opponent_score: opponentScore,
                        completed_at: new Date().toISOString()
                    })
                    .eq('id', challengeId)
                    .eq('status', 'voting')  // Only update if still in voting status
                    .select()
                    .single();
                
                if (error) {
                    // Might have been completed by other device - reload and check
                    await loadSquadData();
                    const updatedChallenge = challenges.find(c => c.id === challengeId);
                    if (updatedChallenge?.status === 'completed') {
                        console.log('‚ö†Ô∏è Challenge was completed by another device');
                        return updatedChallenge;
                    }
                    throw error;
                }
                
                // Update local cache
                const idx = challenges.findIndex(c => c.id === challengeId);
                if (idx >= 0) challenges[idx] = data;
                
                // v21: Volatile scoring ‚Äî winner gains, loser pays
                if (winnerId) {
                    var loserId2 = winnerId === data.challenger_id ? data.opponent_id : data.challenger_id;
                    var winnerMember = members[winnerId];
                    var loserMember = members[loserId2];
                    
                    // Winner: +WIN_POINTS and streak increments
                    await db
                        .from('members')
                        .update({ 
                            points: (winnerMember.points || 0) + WIN_POINTS,
                            streak: (winnerMember.streak || 0) + 1,
                            all_time_wins: (winnerMember.all_time_wins || 0) + 1
                        })
                        .eq('id', winnerId);
                    
                    // Loser: -LOSS_POINTS (min 0) and streak resets
                    var newLoserPoints = Math.max(0, (loserMember.points || 0) - LOSS_POINTS);
                    await db
                        .from('members')
                        .update({ 
                            streak: 0,
                            points: newLoserPoints
                        })
                        .eq('id', loserId2);
                }
                
                // Reload data
                await loadSquadData();
                
                // Trigger push notification directly
                triggerPushNotification('challenge_completed', challengeId, squadId, { exclude_member_id: currentMemberId });
                
                console.log('‚úÖ Challenge completed:', challengeId);
                return data;
            } catch (err) {
                console.error('‚ùå Failed to complete challenge:', err);
                throw err;
            }
        }
        
        function subscribeToSquad() {
            if (!squadId) return;
            
            // Subscribe to challenges changes
            db
                .channel('squad-challenges')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'challenges',
                    filter: `squad_id=eq.${squadId}`
                }, async (payload) => {
                    console.log('üîÑ Challenge update received:', payload.eventType);
                    const oldChallenges = [...challenges];
                    await loadSquadData();
                    
                    // Check for new challenges targeting current user
                    if (payload.eventType === 'INSERT' && payload.new.opponent_id === currentMemberId) {
                        const challenger = members[payload.new.challenger_id];
                        showToast(`‚öîÔ∏è ${challenger?.name || 'Someone'} challenged you! 24h to respond`, 'challenge');
                        sounds.challenge();
                    }
                    
                    // Check for challenge ready for voting
                    if (payload.eventType === 'UPDATE' && payload.new.status === 'voting') {
                        const isParticipant = payload.new.challenger_id === currentMemberId || payload.new.opponent_id === currentMemberId;
                        if (isParticipant) {
                            showToast('üó≥Ô∏è Showdown ready! Time to vote.', 'info');
                        }
                    }
                    
                    // Check for challenge completed
                    if (payload.eventType === 'UPDATE' && payload.new.status === 'completed' && payload.old?.status !== 'completed') {
                        const isParticipant = payload.new.challenger_id === currentMemberId || payload.new.opponent_id === currentMemberId;
                        if (isParticipant) {
                            const youWon = payload.new.winner_id === currentMemberId;
                            if (youWon) {
                                showToast('üèÜ You won the challenge!', 'victory');
                            } else {
                                showToast('Challenge complete! Check results.', 'info');
                            }
                        }
                    }
                    
                    if (['home', 'rankings', 'weekly'].includes(screen)) {
                        render();
                    }
                })
                .subscribe();
            
            // Subscribe to members changes
            db
                .channel('squad-members-' + squadId)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'members',
                    filter: `squad_id=eq.${squadId}`
                }, async (payload) => {
                    console.log('üîÑ New member joined:', payload.new);
                    
                    // Show notification for new member (not yourself)
                    if (payload.new.id !== currentMemberId) {
                        const newMemberName = payload.new.name;
                        const newMemberAvatar = payload.new.avatar || 'üë§';
                        showToast(`${newMemberAvatar} ${newMemberName} joined the squad!`, 'member');
                        sounds.victory();
                    }
                    
                    await loadSquadData();
                    render(); // Always re-render to update ladder
                })
                .on('postgres_changes', {
                    event: 'UPDATE',
                    schema: 'public',
                    table: 'members',
                    filter: `squad_id=eq.${squadId}`
                }, async (payload) => {
                    console.log('üîÑ Member updated:', payload.new);
                    await loadSquadData();
                    render(); // Re-render to update scores/rankings
                })
                .subscribe();
            
            // Subscribe to votes changes (for real-time vote updates)
            db
                .channel('squad-votes')
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'votes'
                }, async (payload) => {
                    console.log('üîÑ Vote received:', payload.new);
                    await loadSquadData();
                    
                    // Check if this completes a 2-person vote
                    const challengeId = payload.new.challenge_id;
                    const challenge = challenges.find(c => c.id === challengeId);
                    if (challenge) {
                        const isParticipant = challenge.challenger_id === currentMemberId || challenge.opponent_id === currentMemberId;
                        const totalVotes = (challenge.votes_for_challenger || 0) + (challenge.votes_for_opponent || 0);
                        
                        if (isParticipant && totalVotes >= 2 && challenge.status === 'voting') {
                            // Both have voted, trigger winner determination
                            await determineTwoPersonWinner(challengeId);
                        }
                    }
                })
                .subscribe();
            
            // v25: Subscribe to squad challenges
            db
                .channel('squad-challenges-' + squadId)
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'squad_challenges',
                    filter: `squad_id=eq.${squadId}`
                }, async (payload) => {
                    console.log('üîÑ Squad challenge update:', payload.eventType);
                    await loadSquadChallenges();
                    if (['arena', 'ladder'].includes(screen)) render();
                })
                .subscribe();
            
            // v25: Subscribe to squad submissions
            db
                .channel('squad-subs-' + squadId)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'squad_submissions'
                }, async (payload) => {
                    console.log('üîÑ New squad submission');
                    await loadSquadChallenges();
                    if (payload.new.member_id !== currentMemberId) {
                        const submitter = members[payload.new.member_id];
                        showToast(`üì∏ ${submitter?.name || 'Someone'} snapped!`, 'info');
                    }
                    if (screen === 'arena') render();
                })
                .subscribe();
            
            console.log('üëÇ Subscribed to real-time updates (v25 + v24)');
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        function generateSquadCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }
        
        async function shareInvite() {
            var baseUrl = window.location.href.split('?')[0].split('#')[0];
            var inviteUrl = baseUrl + '?squad=' + squadCode;
            var message = 'Join my VERSUS squad!\n\nJust tap this link:\n' + inviteUrl + '\n\nLet\'s battle! ‚öîÔ∏è';
            
            var isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            var isAndroid = /Android/i.test(navigator.userAgent);
            var isMobile = isIOS || isAndroid;
            
            // Show share method picker on mobile
            if (isMobile) {
                showModal(
                    'üì≤ Invite to Squad',
                    '<div style="text-align: center;">' +
                        '<div style="font-size: 28px; font-weight: 900; letter-spacing: 4px; color: #FFD700; padding: 12px; background: #0A0A0C; border-radius: 12px; margin-bottom: 16px;">' + squadCode + '</div>' +
                        '<div style="display: flex; flex-direction: column; gap: 10px;">' +
                            '<button class="btn btn-primary" onclick="sendSMSInvite()" style="background: linear-gradient(135deg, #34C759, #30B350);">üì± Send via Text Message</button>' +
                            (navigator.share ? '<button class="btn btn-secondary" onclick="nativeShareInvite()">üì§ Share via Other Apps</button>' : '') +
                            '<button class="btn btn-secondary" onclick="copyInviteToClipboard()">üìã Copy Invite Message</button>' +
                        '</div>' +
                    '</div>',
                    'Cancel',
                    null,
                    null,
                    function() { closeModal(); }
                );
            } else {
                // Desktop: copy to clipboard
                try {
                    await navigator.clipboard.writeText(message);
                    showToast('üìã Invite copied to clipboard!', 'info');
                } catch (err) {
                    showModal(
                        'üì≤ Invite to Squad',
                        '<div style="text-align: center;">' +
                            '<p style="margin-bottom: 16px;">Share this link with friends:</p>' +
                            '<div style="font-size: 14px; color: #FFD700; padding: 16px; background: #1C1C1E; border-radius: 12px; margin-bottom: 16px; word-break: break-all;">' + inviteUrl + '</div>' +
                        '</div>',
                        null,
                        'Done',
                        function() { closeModal(); }
                    );
                }
            }
        }
        
        function sendSMSInvite() {
            closeModal();
            var baseUrl = window.location.href.split('?')[0].split('#')[0];
            var inviteUrl = baseUrl + '?squad=' + squadCode;
            var smsText = 'Join my VERSUS squad! ‚öîÔ∏è\n\nTap to join: ' + inviteUrl;
            var isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            // iOS uses sms:&body=  Android uses sms:?body=
            var smsUrl = isIOS ? 'sms:&body=' + encodeURIComponent(smsText) : 'sms:?body=' + encodeURIComponent(smsText);
            window.location.href = smsUrl;
            setTimeout(function() { showToast('üì± Opening Messages...', 'info'); }, 300);
        }
        
        async function nativeShareInvite() {
            closeModal();
            var baseUrl = window.location.href.split('?')[0].split('#')[0];
            var inviteUrl = baseUrl + '?squad=' + squadCode;
            try {
                await navigator.share({
                    title: 'Join my VERSUS squad!',
                    text: 'Join my VERSUS squad! ‚öîÔ∏è',
                    url: inviteUrl
                });
                showToast('üì§ Invite shared!', 'info');
            } catch (err) {
                if (err.name !== 'AbortError') {
                    showToast('Share cancelled', 'info');
                }
            }
        }
        
        async function copyInviteToClipboard() {
            closeModal();
            var baseUrl = window.location.href.split('?')[0].split('#')[0];
            var inviteUrl = baseUrl + '?squad=' + squadCode;
            var message = 'Join my VERSUS squad! ‚öîÔ∏è\n\nTap to join: ' + inviteUrl;
            try {
                await navigator.clipboard.writeText(message);
                showToast('üìã Invite copied!', 'info');
            } catch (err) {
                // Fallback for older browsers
                var ta = document.createElement('textarea');
                ta.value = message;
                ta.style.position = 'fixed';
                ta.style.left = '-9999px';
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                showToast('üìã Invite copied!', 'info');
            }
        }
        
        // Share functions for squad creation modal (take code as parameter)
        function shareInviteText(code) {
            var baseUrl = window.location.href.split('?')[0].split('#')[0];
            var inviteUrl = baseUrl + '?squad=' + code;
            var smsText = '‚öîÔ∏è Join my VERSUS squad!\n\nTap to join: ' + inviteUrl + '\n\nLet\'s battle for the crown! üëë';
            var isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            var smsUrl = isIOS ? 'sms:&body=' + encodeURIComponent(smsText) : 'sms:?body=' + encodeURIComponent(smsText);
            window.location.href = smsUrl;
            setTimeout(function() { showToast('üì± Opening Messages...', 'info'); }, 300);
        }
        
        async function shareInviteNative(code) {
            var baseUrl = window.location.href.split('?')[0].split('#')[0];
            var inviteUrl = baseUrl + '?squad=' + code;
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Join my VERSUS squad!',
                        text: '‚öîÔ∏è Join my VERSUS squad! Let\'s battle for the crown! üëë',
                        url: inviteUrl
                    });
                    showToast('üì§ Invite shared!', 'info');
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        // Fallback to copy
                        copyInviteLink(code);
                    }
                }
            } else {
                // Fallback for browsers without native share
                copyInviteLink(code);
            }
        }
        
        async function copyInviteLink(code) {
            var baseUrl = window.location.href.split('?')[0].split('#')[0];
            var inviteUrl = baseUrl + '?squad=' + code;
            var message = '‚öîÔ∏è Join my VERSUS squad!\n\nTap to join: ' + inviteUrl + '\n\nLet\'s battle for the crown! üëë';
            try {
                await navigator.clipboard.writeText(message);
                showToast('üìã Invite link copied!', 'info');
            } catch (err) {
                var ta = document.createElement('textarea');
                ta.value = message;
                ta.style.position = 'fixed';
                ta.style.left = '-9999px';
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                showToast('üìã Invite link copied!', 'info');
            }
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            // Remove after animation
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }
        
        function getCurrentMember() {
            return members[currentMemberId] || null;
        }
        
        async function refreshData() {
            console.log('üîÑ Manual refresh triggered');
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = 'üîÑ Refreshing...';
            
            try {
                await loadSquadData();
                await loadSquadChallenges();
                console.log('‚úÖ Data refreshed');
                console.log('   Members:', Object.keys(members).length);
                console.log('   Challenges:', challenges.length);
                render();
            } catch (err) {
                console.error('Refresh error:', err);
                alert('Failed to refresh: ' + err.message);
            }
            
            btn.disabled = false;
            btn.innerHTML = 'üîÑ Refresh Data';
        }

        // ============================================
        // SQUAD SWITCHER
        // ============================================
        
        function saveCurrentSquad() {
            if (!squadId || !squadCode || !currentMemberId) return;
            
            const currentSquadData = {
                squadId: squadId,
                squadCode: squadCode,
                memberId: currentMemberId,
                squadName: squad?.name || 'Squad',
                memberName: members[currentMemberId]?.name || 'You',
                memberAvatar: members[currentMemberId]?.avatar || 'üë§'
            };
            
            // Check if already saved
            const existingIndex = savedSquads.findIndex(s => s.squadId === squadId);
            if (existingIndex >= 0) {
                savedSquads[existingIndex] = currentSquadData;
            } else {
                savedSquads.push(currentSquadData);
            }
            
            localStorage.setItem('savedSquads', JSON.stringify(savedSquads));
        }
        
        function updateSquadSwitcherUI() {
            const nameEl = document.getElementById('currentSquadName');
            const listEl = document.getElementById('squadList');
            
            if (nameEl && squad) {
                nameEl.textContent = squad.name || 'Squad';
            }
            
            if (listEl) {
                if (savedSquads.length === 0) {
                    listEl.innerHTML = '<div style="padding: 12px 16px; color: #8E8E93; font-size: 12px;">No saved squads</div>';
                } else {
                    listEl.innerHTML = savedSquads.map(s => {
                        const isActive = s.squadId === squadId;
                        return `
                            <div onclick="switchToSquad('${s.squadId}')" style="display: flex; align-items: center; gap: 10px; padding: 12px 16px; cursor: pointer; ${isActive ? 'background: rgba(255, 215, 0, 0.1);' : ''}" onmouseover="this.style.background='${isActive ? 'rgba(255, 215, 0, 0.15)' : 'rgba(255,255,255,0.05)'}'" onmouseout="this.style.background='${isActive ? 'rgba(255, 215, 0, 0.1)' : 'transparent'}'">
                                <span style="font-size: 24px;">${s.memberAvatar || 'üë§'}</span>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-size: 14px; font-weight: 600; color: #FFFFFF; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${s.squadName || 'Squad'}</div>
                                    <div style="font-size: 11px; color: #8E8E93;">as ${s.memberName || 'Member'}</div>
                                </div>
                                ${isActive ? '<span style="color: #34C759; font-size: 14px;">‚úì</span>' : ''}
                            </div>
                        `;
                    }).join('');
                }
            }
        }
        
        function toggleSquadSwitcher() {
            const dropdown = document.getElementById('squadDropdown');
            if (dropdown) {
                const isVisible = dropdown.style.display !== 'none';
                dropdown.style.display = isVisible ? 'none' : 'block';
                
                if (!isVisible) {
                    updateSquadSwitcherUI();
                    // Close on outside click
                    setTimeout(() => {
                        document.addEventListener('click', closeSquadSwitcherOnOutsideClick);
                    }, 10);
                }
            }
        }
        
        function closeSquadSwitcherOnOutsideClick(e) {
            const dropdown = document.getElementById('squadDropdown');
            const switcher = document.getElementById('squadSwitcher');
            if (dropdown && switcher && !dropdown.contains(e.target) && !switcher.contains(e.target)) {
                dropdown.style.display = 'none';
                document.removeEventListener('click', closeSquadSwitcherOnOutsideClick);
            }
        }
        
        async function switchToSquad(newSquadId) {
            const squadData = savedSquads.find(s => s.squadId === newSquadId);
            if (!squadData) {
                showToast('Squad not found', 'error');
                return;
            }
            
            // Close dropdown
            const dropdown = document.getElementById('squadDropdown');
            if (dropdown) dropdown.style.display = 'none';
            
            if (newSquadId === squadId) {
                // Already on this squad
                return;
            }
            
            // Save current squad before switching
            saveCurrentSquad();
            
            // Switch to new squad
            squadId = squadData.squadId;
            squadCode = squadData.squadCode;
            currentMemberId = squadData.memberId;
            
            localStorage.setItem('squadId', squadId);
            localStorage.setItem('squadCode', squadCode);
            localStorage.setItem('memberId', currentMemberId);
            
            // Reload squad data
            showToast('Switching to ' + squadData.squadName + '...', 'info');
            
            // Clear current data
            squad = null;
            members = {};
            challenges = [];
            
            // Load new squad
            const loaded = await loadSquadData();
            if (loaded) {
                saveCurrentSquad(); // Update saved data with fresh info
                updateSquadSwitcherUI();
                screen = 'arena';
                render();
                showToast('Switched to ' + squad.name, 'info');
            } else {
                showToast('Failed to load squad', 'error');
            }
        }
        
        function joinNewSquad() {
            // Close dropdown
            const dropdown = document.getElementById('squadDropdown');
            if (dropdown) dropdown.style.display = 'none';
            
            // Save current squad before leaving
            saveCurrentSquad();
            
            // Go to join screen
            screen = 'join-squad';
            render();
        }
        
        function removeSquadFromSaved(squadIdToRemove) {
            savedSquads = savedSquads.filter(s => s.squadId !== squadIdToRemove);
            localStorage.setItem('savedSquads', JSON.stringify(savedSquads));
            updateSquadSwitcherUI();
        }

        // ============================================
        // NAVIGATION
        // ============================================
        
        function goTo(newScreen) {
            screen = newScreen;
            sounds.click();
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
                const btnText = btn.textContent.toLowerCase();
                if ((newScreen === 'arena' && btnText.includes('arena')) ||
                    (newScreen === 'ladder' && btnText.includes('ladder'))) {
                    btn.classList.add('active');
                }
            });
            
            render();
        }

        // ============================================
        // RENDER FUNCTIONS
        // ============================================
        
        function render() {
            try {
                const content = document.getElementById('content');
                const header = document.getElementById('app-header');
                const nav = document.getElementById('app-nav');
                
                if (!content) return;
                
                const onboardingScreens = ['welcome', 'create-squad', 'join-squad', 'setup-identity', 'rejoin-squad', 'rejoin-pick-member'];
                if (onboardingScreens.includes(screen)) {
                    if (header) header.style.display = 'none';
                    if (nav) nav.style.display = 'none';
                } else {
                    if (header) header.style.display = 'flex';
                    if (nav) nav.style.display = 'flex';
                }
                
                if (screen === 'welcome') content.innerHTML = renderWelcome();
                else if (screen === 'create-squad') content.innerHTML = renderCreateSquad();
                else if (screen === 'join-squad') content.innerHTML = renderJoinSquad();
                else if (screen === 'setup-identity') content.innerHTML = renderSetupIdentity();
                else if (screen === 'rejoin-squad') content.innerHTML = renderRejoinSquad();
                else if (screen === 'rejoin-pick-member') content.innerHTML = renderRejoinPickMember();
                else if (screen === 'return-screen') content.innerHTML = renderReturnScreen(window._returnEvents || []);
                else if (screen === 'arena') content.innerHTML = renderArena();
                else if (screen === 'ladder') content.innerHTML = renderLadder();
                else if (screen === 'submit-squad') content.innerHTML = renderSubmitSquad();
                else if (screen === 'captain-pick') content.innerHTML = renderCaptainPick();
                else if (screen === 'squad-vote') content.innerHTML = renderSquadVote();
                else if (screen === 'home') content.innerHTML = renderArena(); // backward compat
                else if (screen === 'rankings') content.innerHTML = renderLadder(); // backward compat
                else if (screen === 'weekly') content.innerHTML = renderLadder(); // backward compat
                else if (screen === 'select-opponent') content.innerHTML = renderSelectOpponent();
                else if (screen === 'challenge-reveal') content.innerHTML = renderChallengeReveal();
                else if (screen === 'submit-media') content.innerHTML = renderSubmitMedia();
                else if (screen === 'submit-weekly') content.innerHTML = renderSubmitWeekly();
                else if (screen === 'settings') content.innerHTML = renderSettings();
                else if (screen === 'profile') content.innerHTML = renderProfile();
                else content.innerHTML = renderArena();
                
                // Update header avatar
                updateHeaderAvatar();
            } catch (err) {
                console.error('Render error:', err);
            }
        }
        
        function updateHeaderAvatar() {
            var avatarEl = document.getElementById('headerAvatar');
            var currentMember = getCurrentMember();
            if (avatarEl && currentMember) {
                avatarEl.textContent = currentMember.avatar;
            } else if (avatarEl) {
                avatarEl.textContent = '';
            }
        }
        
        function renderWelcome() {
            // Generate dynamic social proof stats (seeded by date for consistency)
            const today = new Date();
            const daySeed = today.getDate() + today.getMonth() * 31;
            const crownsToday = 2 + (daySeed % 5);
            const activeRivalries = 12 + (daySeed % 8);
            const duelsToday = 8 + (daySeed * 3) % 15;
            
            // Store stats for ticker rotation
            window._welcomeStats = [
                'üëë ' + crownsToday + ' crowns changed hands today',
                'üî• ' + duelsToday + ' duels completed today',
                '‚öîÔ∏è ' + activeRivalries + ' active rivalries'
            ];
            window._welcomeStatIndex = 0;
            
            // Start ticker rotation after render
            setTimeout(startWelcomeTicker, 100);
            
            return `
                <div class="fade-in" style="min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; text-align: center; position: relative; overflow: hidden;">
                    
                    <!-- Animated background particles -->
                    <div style="position: absolute; inset: 0; pointer-events: none; overflow: hidden;">
                        <div class="ember" style="position: absolute; top: 20%; left: 10%; width: 4px; height: 4px; background: rgba(255, 215, 0, 0.4); border-radius: 50%; animation: ember 6s ease-in-out infinite;"></div>
                        <div class="ember" style="position: absolute; top: 40%; right: 15%; width: 6px; height: 6px; background: rgba(255, 165, 0, 0.3); border-radius: 50%; animation: ember 8s ease-in-out infinite 1s;"></div>
                        <div class="ember" style="position: absolute; bottom: 30%; left: 20%; width: 3px; height: 3px; background: rgba(255, 100, 50, 0.4); border-radius: 50%; animation: ember 7s ease-in-out infinite 2s;"></div>
                        <div class="ember" style="position: absolute; top: 60%; right: 25%; width: 5px; height: 5px; background: rgba(255, 215, 0, 0.3); border-radius: 50%; animation: ember 9s ease-in-out infinite 0.5s;"></div>
                        <div class="ember" style="position: absolute; top: 75%; left: 30%; width: 4px; height: 4px; background: rgba(255, 140, 0, 0.3); border-radius: 50%; animation: ember 10s ease-in-out infinite 3s;"></div>
                    </div>
                    
                    <!-- Glowing swords with pulse -->
                    <div style="font-size: 80px; margin-bottom: 24px; animation: glow 3s ease-in-out infinite; filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.4));">‚öîÔ∏è</div>
                    
                    <h1 style="font-size: 42px; font-weight: 900; letter-spacing: 6px; margin-bottom: 8px; background: linear-gradient(135deg, #FFD700, #FFA500, #FFD700); background-size: 200% 200%; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: shimmer 3s ease-in-out infinite;">VERSUS</h1>
                    
                    <p style="font-size: 13px; color: #8E8E93; letter-spacing: 3px; margin-bottom: 6px; text-transform: uppercase;">Every Duel Matters</p>
                    
                    <!-- Stakes line -->
                    <p style="font-size: 11px; color: #FF9500; letter-spacing: 1px; margin-bottom: 20px; font-weight: 600;">Win. Lose. Get dethroned.</p>
                    
                    <!-- Rotating social proof stats -->
                    <div id="statTicker" style="background: rgba(255, 215, 0, 0.08); border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 20px; padding: 8px 16px; margin-bottom: 40px; min-width: 220px; transition: opacity 0.3s ease;">
                        <span style="font-size: 12px; color: #FFD700; font-weight: 600;">üëë ${crownsToday} crowns changed hands today</span>
                    </div>
                    
                    <div style="width: 100%; max-width: 320px;">
                        <button class="btn btn-primary" style="margin-bottom: 16px; font-size: 16px; padding: 18px; position: relative; overflow: hidden;" onclick="screen='create-squad'; render();">
                            <span style="position: relative; z-index: 1;">üèÜ Start a Rivalry</span>
                            <div style="position: absolute; inset: 0; background: radial-gradient(circle at center, rgba(255, 215, 0, 0.3) 0%, transparent 70%); animation: buttonGlow 2s ease-in-out infinite;"></div>
                        </button>
                        <button class="btn btn-secondary" style="margin-bottom: 16px;" onclick="screen='join-squad'; render();">
                            Join a Squad
                        </button>
                        <button class="btn btn-secondary" style="opacity: 0.6; border-color: #3C3C3E;" onclick="screen='rejoin-squad'; render();">
                            Rejoin My Squad
                        </button>
                    </div>
                    
                    <p style="font-size: 12px; color: #6E6E73; margin-top: 40px; font-weight: 500;">
                        Private. Intense. Invite-only.
                    </p>
                    
                    <div style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);">
                        <div style="background: rgba(52, 199, 89, 0.1); border: 1px solid rgba(52, 199, 89, 0.3); border-radius: 8px; padding: 8px 16px;">
                            <span style="color: #34C759; font-size: 12px; font-weight: 600;">‚úÖ Connected</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function startWelcomeTicker() {
            if (screen !== 'welcome') return;
            
            const ticker = document.getElementById('statTicker');
            if (!ticker || !window._welcomeStats) return;
            
            // Clear any existing interval
            if (window._tickerInterval) clearInterval(window._tickerInterval);
            
            window._tickerInterval = setInterval(function() {
                if (screen !== 'welcome') {
                    clearInterval(window._tickerInterval);
                    return;
                }
                
                window._welcomeStatIndex = (window._welcomeStatIndex + 1) % window._welcomeStats.length;
                ticker.style.opacity = '0';
                
                setTimeout(function() {
                    var tickerEl = document.getElementById('statTicker');
                    if (tickerEl) {
                        tickerEl.innerHTML = '<span style="font-size: 12px; color: #FFD700; font-weight: 600;">' + window._welcomeStats[window._welcomeStatIndex] + '</span>';
                        tickerEl.style.opacity = '1';
                    }
                }, 300);
            }, 4000);
        }
        
        function renderCreateSquad() {
            return `
                <div class="fade-in" style="padding: 40px 20px;">
                    <button class="back-btn" onclick="screen='welcome'; render();">‚Üê Back</button>

                    <h2 style="font-size: 24px; font-weight: 900; margin-bottom: 8px;">Create Your Squad</h2>
                    <p style="font-size: 14px; color: #A1A1A6; margin-bottom: 32px;">Set up your competition arena</p>

                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; color: #A1A1A6; margin-bottom: 8px; text-transform: uppercase;">Squad Name</label>
                        <input type="text" id="squadName" placeholder="The Legends" style="width: 100%; padding: 14px; background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 8px; color: #FFFFFF; font-size: 15px;" />
                    </div>

                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; color: #A1A1A6; margin-bottom: 8px; text-transform: uppercase;">Your Name</label>
                        <input type="text" id="adminName" placeholder="Dad" style="width: 100%; padding: 14px; background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 8px; color: #FFFFFF; font-size: 15px;" />
                    </div>

                    <div style="margin-bottom: 32px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; color: #A1A1A6; margin-bottom: 8px; text-transform: uppercase;">Create Your Avatar</label>
                        
                        <!-- Randomize Button -->
                        <button onclick="randomizeAvatar('admin')" style="width: 100%; padding: 12px; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px; color: #FFD700; font-size: 13px; font-weight: 700; cursor: pointer; margin-bottom: 24px;">
                            üé≤ Randomize
                        </button>
                        
                        <!-- Avatar Preview -->
                        <div style="width: 120px; height: 120px; margin: 0 auto 24px; border-radius: 60px; background: #1C1C1E; display: flex; align-items: center; justify-content: center; border: 3px solid #FFD700;">
                            <div id="adminAvatarDisplay" style="font-size: 72px;">üë®üèª</div>
                        </div>
                        
                        <!-- Skin Tone -->
                        <div style="margin-bottom: 20px;">
                            <div style="font-size: 12px; font-weight: 600; color: #8E8E93; margin-bottom: 8px;">SKIN TONE</div>
                            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;">
                                ${['üèª', 'üèº', 'üèΩ', 'üèæ', 'üèø', ''].map((tone, i) => {
                                    const colors = ['#FFE5D9', '#F4D3C4', '#D9A679', '#A67C52', '#6B4423', '#FFD700'];
                                    const labels = ['Light', 'Fair', 'Medium', 'Tan', 'Dark', 'Gold'];
                                    return `
                                        <div onclick="selectSkinTone('${tone}', ${i}, 'admin')" class="admin-tone-option" data-tone="${i}" style="height: 48px; background: ${colors[i]}; border: 2px solid ${i === 0 ? '#FFD700' : '#2C2C2E'}; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                            <div style="font-size: 9px; color: ${i === 5 ? '#000' : '#666'}; font-weight: 700;">${labels[i]}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        <!-- Style -->
                        <div style="margin-bottom: 20px;">
                            <div style="font-size: 12px; font-weight: 600; color: #8E8E93; margin-bottom: 8px;">STYLE</div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                                ${styleEmojis.map((style, i) => `
                                    <div onclick="selectStyle(${i}, 'admin')" class="admin-style-option" data-style="${i}" style="padding: 12px 8px; background: #1C1C1E; border: 2px solid ${i === 0 ? '#FFD700' : '#2C2C2E'}; border-radius: 8px; text-align: center; cursor: pointer;">
                                        <div style="font-size: 32px; margin-bottom: 4px;">${style.base}</div>
                                        <div style="font-size: 8px; color: #8E8E93; font-weight: 600;">${style.label}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <input type="hidden" id="adminAvatar" value="üë®üèª" />
                        <input type="hidden" id="adminSkinTone" value="üèª" />
                        <input type="hidden" id="adminStyleIndex" value="0" />
                    </div>

                    <div style="margin-bottom: 32px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; color: #A1A1A6; margin-bottom: 8px; text-transform: uppercase;">Set Your PIN</label>
                        <input type="tel" id="adminPin" placeholder="4 digits" maxlength="4" inputmode="numeric" pattern="[0-9]*" style="width: 100%; padding: 14px; background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 8px; color: #FFFFFF; font-size: 24px; font-weight: 900; text-align: center; letter-spacing: 12px;" />
                        <p style="font-size: 11px; color: #8E8E93; margin-top: 8px;">üîí Used to sign back in if you switch devices</p>
                    </div>

                    <button class="btn btn-primary" id="createBtn" onclick="handleCreateSquad();">
                        Create Squad
                    </button>
                </div>
            `;
        }
        
        // Avatar skin tone modifiers
        const skinTones = ['üèª', 'üèº', 'üèΩ', 'üèæ', 'üèø', ''];
        const styleEmojis = [
            { base: 'üë®', label: 'Man' },
            { base: 'üë©', label: 'Woman' },
            { base: 'üßî', label: 'Beard' },
            { base: 'üë¥', label: 'Older' },
            { base: 'üë¶', label: 'Boy' },
            { base: 'üëß', label: 'Girl' },
            { base: 'üßë', label: 'Person' },
            { base: 'üßí', label: 'Child' }
        ];
        
        function selectSkinTone(tone, index, prefix) {
            document.querySelectorAll(`.${prefix}-tone-option`).forEach(el => {
                el.style.borderColor = '#2C2C2E';
            });
            document.querySelector(`.${prefix}-tone-option[data-tone="${index}"]`).style.borderColor = '#FFD700';
            document.getElementById(`${prefix}SkinTone`).value = tone;
            updateAvatarPreview(prefix);
        }
        
        function selectStyle(index, prefix) {
            document.querySelectorAll(`.${prefix}-style-option`).forEach(el => {
                el.style.borderColor = '#2C2C2E';
            });
            document.querySelector(`.${prefix}-style-option[data-style="${index}"]`).style.borderColor = '#FFD700';
            document.getElementById(`${prefix}StyleIndex`).value = index;
            updateAvatarPreview(prefix);
        }
        
        function updateAvatarPreview(prefix) {
            const styleIndex = parseInt(document.getElementById(`${prefix}StyleIndex`).value) || 0;
            const tone = document.getElementById(`${prefix}SkinTone`).value;
            const base = styleEmojis[styleIndex].base;
            const combined = base + tone;
            document.getElementById(`${prefix}AvatarDisplay`).textContent = combined;
            document.getElementById(`${prefix}Avatar`).value = combined;
        }
        
        function randomizeAvatar(prefix) {
            const randomTone = Math.floor(Math.random() * skinTones.length);
            const randomStyle = Math.floor(Math.random() * styleEmojis.length);
            
            // Update UI
            document.querySelectorAll(`.${prefix}-tone-option`).forEach(el => {
                el.style.borderColor = '#2C2C2E';
            });
            document.querySelectorAll(`.${prefix}-style-option`).forEach(el => {
                el.style.borderColor = '#2C2C2E';
            });
            
            const toneEl = document.querySelector(`.${prefix}-tone-option[data-tone="${randomTone}"]`);
            const styleEl = document.querySelector(`.${prefix}-style-option[data-style="${randomStyle}"]`);
            if (toneEl) toneEl.style.borderColor = '#FFD700';
            if (styleEl) styleEl.style.borderColor = '#FFD700';
            
            document.getElementById(`${prefix}SkinTone`).value = skinTones[randomTone];
            document.getElementById(`${prefix}StyleIndex`).value = randomStyle;
            updateAvatarPreview(prefix);
            
            sounds.click();
        }
        
        async function handleCreateSquad() {
            const squadName = document.getElementById('squadName').value.trim();
            const adminName = document.getElementById('adminName').value.trim();
            const adminAvatar = document.getElementById('adminAvatar').value;
            const adminPin = document.getElementById('adminPin').value.trim();
            
            if (!squadName || !adminName) {
                alert('Please fill in all fields');
                return;
            }
            
            if (!adminPin || adminPin.length !== 4 || !/^\d{4}$/.test(adminPin)) {
                alert('Please set a 4-digit PIN');
                return;
            }
            
            const btn = document.getElementById('createBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Creating...';
            
            try {
                await createSquad(squadName, adminName, adminAvatar, adminPin);
                
                const inviteUrl = window.location.origin + window.location.pathname + '?squad=' + squadCode;
                
                showModal(
                    'üéâ Squad Created!',
                    `
                    <div style="text-align: center;">
                        <p style="margin-bottom: 12px;">Your squad code is:</p>
                        <div style="font-size: 36px; font-weight: 900; letter-spacing: 8px; color: #FFD700; margin-bottom: 8px;">${squadCode}</div>
                        <p style="font-size: 12px; color: #8E8E93; margin-bottom: 20px;">Share this with rivals to start the competition</p>
                        
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 16px;">
                            <button onclick="shareInviteText('${squadCode}')" class="btn btn-primary" style="background: linear-gradient(135deg, #34C759, #30B350);">
                                üì± Invite via Text
                            </button>
                            <button onclick="shareInviteNative('${squadCode}')" class="btn btn-secondary" style="border-color: #0A84FF; color: #0A84FF;">
                                üì§ Share Link
                            </button>
                            <button onclick="copyInviteLink('${squadCode}')" class="btn btn-secondary">
                                üìã Copy Link
                            </button>
                        </div>
                        
                        <p style="font-size: 11px; color: #6E6E73;">You can always invite more from Settings</p>
                    </div>
                    `,
                    null,
                    'Start Battling ‚Üí',
                    () => { 
                        closeModal(); 
                        screen = 'arena'; 
                        render(); 
                        // High-intent moment: prompt install after creating squad
                        setTimeout(() => {
                            maybeShowInstallPrompt('squad-created');
                        }, 1500);
                    }
                );
            } catch (err) {
                console.error('Create squad error:', err);
                const errorMsg = err.message || err.error_description || JSON.stringify(err);
                alert('Failed to create squad: ' + errorMsg);
                btn.disabled = false;
                btn.textContent = 'Create Squad';
            }
        }
        
        function renderJoinSquad() {
            var prefillCode = window.prefillSquadCode || '';
            return `
                <div class="fade-in" style="padding: 40px 20px;">
                    <button class="back-btn" onclick="window.prefillSquadCode=null; screen='welcome'; render();">‚Üê Back</button>

                    <h2 style="font-size: 24px; font-weight: 900; margin-bottom: 8px;">Join a Squad</h2>
                    <p style="font-size: 14px; color: #A1A1A6; margin-bottom: 32px;">${prefillCode ? 'You\'ve been invited!' : 'Enter the squad code to join'}</p>

                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; color: #A1A1A6; margin-bottom: 8px; text-transform: uppercase;">Squad Code</label>
                        <input type="text" id="joinCode" placeholder="ABC123" maxlength="6" value="${prefillCode}" style="width: 100%; padding: 14px; background: #1C1C1E; border: 2px solid ${prefillCode ? '#34C759' : '#2C2C2E'}; border-radius: 8px; color: #FFFFFF; font-size: 20px; font-weight: 900; text-align: center; letter-spacing: 4px; text-transform: uppercase;" />
                    </div>

                    <button class="btn btn-primary" id="verifyBtn" onclick="handleVerifyCode();">
                        ${prefillCode ? 'Join Squad' : 'Continue'}
                    </button>

                    ${!prefillCode ? `
                    <div style="margin-top: 24px; padding: 16px; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px;">
                        <p style="font-size: 13px; color: #FFD700; line-height: 1.5;">
                            üí° Ask your squad admin for the 6-character code
                        </p>
                    </div>
                    ` : ''}
                </div>
            `;
        }
        
        async function handleVerifyCode() {
            const code = document.getElementById('joinCode').value.trim().toUpperCase();
            
            if (!code || code.length !== 6) {
                alert('Please enter a valid 6-character code');
                return;
            }
            
            const btn = document.getElementById('verifyBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Finding squad...';
            
            try {
                const { data, error } = await db
                    .from('squads')
                    .select('*')
                    .eq('code', code)
                    .single();
                
                if (error || !data) {
                    throw new Error('Squad not found');
                }
                
                // Store temporarily and go to identity setup
                window.pendingSquadId = data.id;
                window.pendingSquadCode = data.code;
                window.pendingSquadName = data.name;
                
                screen = 'setup-identity';
                render();
            } catch (err) {
                alert('‚ùå Squad code not found. Make sure you entered it correctly.');
                btn.disabled = false;
                btn.textContent = 'Continue';
            }
        }
        
        function renderSetupIdentity() {
            return `
                <div class="fade-in" style="padding: 40px 20px;">
                    <h2 style="font-size: 24px; font-weight: 900; margin-bottom: 8px;">Create Your Profile</h2>
                    <p style="font-size: 14px; color: #A1A1A6; margin-bottom: 32px;">Join ${window.pendingSquadName || 'the squad'}</p>

                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; color: #A1A1A6; margin-bottom: 8px; text-transform: uppercase;">Your Name</label>
                        <input type="text" id="memberName" placeholder="Enter your name" style="width: 100%; padding: 14px; background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 8px; color: #FFFFFF; font-size: 15px;" />
                    </div>

                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; color: #A1A1A6; margin-bottom: 8px; text-transform: uppercase;">Your Age</label>
                        <input type="number" id="memberAge" placeholder="Enter your age" min="1" max="120" style="width: 100%; padding: 14px; background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 8px; color: #FFFFFF; font-size: 15px;" />
                        <p style="font-size: 11px; color: #8E8E93; margin-top: 8px;">üîí Under 18? A parent or guardian must approve your participation. Parental controls will be enabled for your account.</p>
                    </div>

                    <div style="margin-bottom: 32px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; color: #A1A1A6; margin-bottom: 8px; text-transform: uppercase;">Create Your Avatar</label>
                        
                        <!-- Randomize Button -->
                        <button onclick="randomizeAvatar('member')" style="width: 100%; padding: 12px; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px; color: #FFD700; font-size: 13px; font-weight: 700; cursor: pointer; margin-bottom: 24px;">
                            üé≤ Randomize
                        </button>
                        
                        <!-- Avatar Preview -->
                        <div style="width: 120px; height: 120px; margin: 0 auto 24px; border-radius: 60px; background: #1C1C1E; display: flex; align-items: center; justify-content: center; border: 3px solid #FFD700;">
                            <div id="memberAvatarDisplay" style="font-size: 72px;">üë®üèª</div>
                        </div>
                        
                        <!-- Skin Tone -->
                        <div style="margin-bottom: 20px;">
                            <div style="font-size: 12px; font-weight: 600; color: #8E8E93; margin-bottom: 8px;">SKIN TONE</div>
                            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;">
                                ${['üèª', 'üèº', 'üèΩ', 'üèæ', 'üèø', ''].map((tone, i) => {
                                    const colors = ['#FFE5D9', '#F4D3C4', '#D9A679', '#A67C52', '#6B4423', '#FFD700'];
                                    const labels = ['Light', 'Fair', 'Medium', 'Tan', 'Dark', 'Gold'];
                                    return `
                                        <div onclick="selectSkinTone('${tone}', ${i}, 'member')" class="member-tone-option" data-tone="${i}" style="height: 48px; background: ${colors[i]}; border: 2px solid ${i === 0 ? '#FFD700' : '#2C2C2E'}; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                            <div style="font-size: 9px; color: ${i === 5 ? '#000' : '#666'}; font-weight: 700;">${labels[i]}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        <!-- Style -->
                        <div style="margin-bottom: 20px;">
                            <div style="font-size: 12px; font-weight: 600; color: #8E8E93; margin-bottom: 8px;">STYLE</div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                                ${styleEmojis.map((style, i) => `
                                    <div onclick="selectStyle(${i}, 'member')" class="member-style-option" data-style="${i}" style="padding: 12px 8px; background: #1C1C1E; border: 2px solid ${i === 0 ? '#FFD700' : '#2C2C2E'}; border-radius: 8px; text-align: center; cursor: pointer;">
                                        <div style="font-size: 32px; margin-bottom: 4px;">${style.base}</div>
                                        <div style="font-size: 8px; color: #8E8E93; font-weight: 600;">${style.label}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <input type="hidden" id="memberAvatar" value="üë®üèª" />
                        <input type="hidden" id="memberSkinTone" value="üèª" />
                        <input type="hidden" id="memberStyleIndex" value="0" />
                    </div>

                    <div style="margin-bottom: 32px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; color: #A1A1A6; margin-bottom: 8px; text-transform: uppercase;">Set Your PIN</label>
                        <input type="tel" id="memberPin" placeholder="4 digits" maxlength="4" inputmode="numeric" pattern="[0-9]*" style="width: 100%; padding: 14px; background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 8px; color: #FFFFFF; font-size: 24px; font-weight: 900; text-align: center; letter-spacing: 12px;" />
                        <p style="font-size: 11px; color: #8E8E93; margin-top: 8px;">üîí Used to sign back in if you switch devices</p>
                    </div>

                    <button class="btn btn-primary" id="joinBtn" onclick="handleJoinSquad();">
                        Join Squad
                    </button>
                </div>
            `;
        }
        
        function selectMemberAvatar(emoji) {
            // Legacy function - no longer used but kept for compatibility
        }
        
        async function handleJoinSquad() {
            const memberName = document.getElementById('memberName').value.trim();
            const memberAge = parseInt(document.getElementById('memberAge').value);
            const memberAvatar = document.getElementById('memberAvatar').value;
            const memberPin = document.getElementById('memberPin').value.trim();
            
            if (!memberName) {
                alert('Please enter your name');
                return;
            }
            
            if (!memberAge || memberAge < 1) {
                alert('Please enter your age');
                return;
            }
            
            if (!memberPin || memberPin.length !== 4 || !/^\d{4}$/.test(memberPin)) {
                alert('Please set a 4-digit PIN');
                return;
            }
            
            const btn = document.getElementById('joinBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Joining...';
            
            try {
                await joinSquad(window.pendingSquadCode, memberName, memberAge, memberAvatar, memberPin);
                screen = 'arena';
                render();
                
                // High-intent moment: prompt install after joining squad
                setTimeout(() => {
                    maybeShowInstallPrompt('squad-joined');
                }, 1500);
            } catch (err) {
                alert('Failed to join squad: ' + err.message);
                btn.disabled = false;
                btn.textContent = 'Join Squad';
            }
        }
        
        // ============================================
        // REJOIN FLOW (existing member, new device/session)
        // ============================================
        
        function renderRejoinSquad() {
            return `
                <div class="fade-in" style="padding: 40px 20px;">
                    <button class="back-btn" onclick="screen='welcome'; render();">‚Üê Back</button>

                    <h2 style="font-size: 24px; font-weight: 900; margin-bottom: 8px;">Rejoin Your Squad</h2>
                    <p style="font-size: 14px; color: #A1A1A6; margin-bottom: 32px;">Enter your squad code to reconnect</p>

                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; color: #A1A1A6; margin-bottom: 8px; text-transform: uppercase;">Squad Code</label>
                        <input type="text" id="rejoinCode" placeholder="ABC123" maxlength="6" style="width: 100%; padding: 14px; background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 8px; color: #FFFFFF; font-size: 20px; font-weight: 900; text-align: center; letter-spacing: 4px; text-transform: uppercase;" />
                    </div>

                    <button class="btn btn-primary" id="rejoinVerifyBtn" onclick="handleRejoinVerify();">
                        Find My Squad
                    </button>

                    <div style="margin-top: 24px; padding: 16px; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px;">
                        <p style="font-size: 13px; color: #FFD700; line-height: 1.5;">
                            üí° Switching devices or reinstalled? Enter your squad code and pick your name to reconnect.
                        </p>
                    </div>
                </div>
            `;
        }
        
        async function handleRejoinVerify() {
            var code = document.getElementById('rejoinCode').value.trim().toUpperCase();
            
            if (!code || code.length !== 6) {
                alert('Please enter a valid 6-character code');
                return;
            }
            
            var btn = document.getElementById('rejoinVerifyBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Finding squad...';
            
            try {
                var result = await db
                    .from('squads')
                    .select('*')
                    .eq('code', code)
                    .single();
                
                if (result.error || !result.data) {
                    throw new Error('Squad not found');
                }
                
                // Load the members of this squad
                var membersResult = await db
                    .from('members')
                    .select('*')
                    .eq('squad_id', result.data.id);
                
                if (membersResult.error || !membersResult.data || membersResult.data.length === 0) {
                    throw new Error('No members found in this squad');
                }
                
                // Store for the pick screen
                window.rejoinSquad = result.data;
                window.rejoinMembers = membersResult.data;
                
                screen = 'rejoin-pick-member';
                render();
            } catch (err) {
                alert('‚ùå ' + (err.message || 'Squad not found. Check the code.'));
                btn.disabled = false;
                btn.textContent = 'Find My Squad';
            }
        }
        
        function renderRejoinPickMember() {
            var squadData = window.rejoinSquad;
            var memberList = window.rejoinMembers || [];
            
            if (!squadData) return '<div style="padding: 40px; text-align: center;">Error. Go back and try again.</div>';
            
            // If a member has been selected, show PIN entry
            if (window.rejoinSelectedMember) {
                var m = window.rejoinSelectedMember;
                var html = '<div class="fade-in" style="padding: 40px 20px;">';
                html += '<button class="back-btn" onclick="window.rejoinSelectedMember=null; screen=\'rejoin-pick-member\'; render();">‚Üê Back</button>';
                html += '<div style="text-align: center; margin-bottom: 32px;">';
                html += '<div style="font-size: 64px; margin-bottom: 12px;">' + (m.avatar || 'üë§') + '</div>';
                html += '<div style="font-size: 20px; font-weight: 900;">' + m.name + '</div>';
                html += '<div style="font-size: 13px; color: #8E8E93; margin-top: 4px;">' + squadData.name + '</div>';
                html += '</div>';
                
                html += '<div style="margin-bottom: 24px;">';
                html += '<label style="display: block; font-size: 13px; font-weight: 600; color: #A1A1A6; margin-bottom: 8px; text-transform: uppercase;">Enter Your PIN</label>';
                html += '<input type="tel" id="rejoinPin" placeholder="‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢" maxlength="4" inputmode="numeric" pattern="[0-9]*" style="width: 100%; padding: 18px; background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 8px; color: #FFFFFF; font-size: 28px; font-weight: 900; text-align: center; letter-spacing: 16px;" />';
                html += '</div>';
                
                if (window.rejoinPinError) {
                    html += '<div style="background: rgba(255, 59, 48, 0.1); border: 1px solid rgba(255, 59, 48, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 16px; text-align: center;">';
                    html += '<span style="font-size: 13px; color: #FF3B30; font-weight: 600;">' + window.rejoinPinError + '</span>';
                    html += '</div>';
                }
                
                html += '<button class="btn btn-primary" id="rejoinPinBtn" onclick="handleRejoinPinSubmit();" style="margin-bottom: 16px;">Sign In</button>';
                
                html += '<div style="text-align: center;">';
                html += '<button onclick="showForgotPinHelp()" style="background: none; border: none; color: #8E8E93; font-size: 13px; cursor: pointer; padding: 8px;">Forgot PIN?</button>';
                html += '</div>';
                
                html += '</div>';
                return html;
            }
            
            // Show member list
            var html = '<div class="fade-in" style="padding: 40px 20px;">';
            html += '<button class="back-btn" onclick="screen=\'rejoin-squad\'; render();">‚Üê Back</button>';
            html += '<h2 style="font-size: 24px; font-weight: 900; margin-bottom: 8px;">Welcome Back</h2>';
            html += '<p style="font-size: 14px; color: #A1A1A6; margin-bottom: 32px;">' + squadData.name + ' ‚Äî who are you?</p>';
            
            html += '<div style="display: flex; flex-direction: column; gap: 12px;">';
            memberList.forEach(function(m) {
                html += '<button onclick="selectRejoinMember(\'' + m.id + '\')" style="display: flex; align-items: center; gap: 14px; padding: 16px; background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 12px; color: #FFFFFF; font-size: 15px; cursor: pointer; text-align: left;">';
                html += '<span style="font-size: 36px;">' + (m.avatar || 'üë§') + '</span>';
                html += '<div style="flex: 1;">';
                html += '<div style="font-weight: 700;">' + m.name + '</div>';
                html += '<div style="font-size: 12px; color: #8E8E93;">' + (m.points || 0) + ' pts';
                if (m.is_admin) html += ' ‚Ä¢ Admin';
                if (m.streak > 0) html += ' ‚Ä¢ üî• ' + m.streak + ' streak';
                html += '</div>';
                html += '</div>';
                html += '<span style="font-size: 14px; color: #8E8E93;">‚Üí</span>';
                html += '</button>';
            });
            html += '</div>';
            
            html += '<div style="margin-top: 24px; padding: 12px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">';
            html += '<p style="font-size: 12px; color: #8E8E93; text-align: center;">Don\'t see your name? Go back and join as a new member.</p>';
            html += '</div>';
            
            html += '</div>';
            return html;
        }
        
        function selectRejoinMember(memberId) {
            var memberList = window.rejoinMembers || [];
            var m = memberList.find(function(member) { return member.id === memberId; });
            if (!m) return;
            
            // If member has no PIN set (legacy), let them in and prompt to set one
            if (!m.pin) {
                handleRejoinAs(memberId);
                return;
            }
            
            window.rejoinSelectedMember = m;
            window.rejoinPinError = null;
            window.rejoinPinAttempts = 0;
            screen = 'rejoin-pick-member';
            render();
        }
        
        async function handleRejoinPinSubmit() {
            var pin = document.getElementById('rejoinPin').value.trim();
            var m = window.rejoinSelectedMember;
            
            if (!pin || pin.length !== 4) {
                window.rejoinPinError = 'Enter your 4-digit PIN';
                render();
                return;
            }
            
            if (!m) return;
            
            // Always fetch fresh PIN from database (in case admin just reset it)
            try {
                var freshResult = await db
                    .from('members')
                    .select('pin')
                    .eq('id', m.id)
                    .single();
                
                var freshPin = freshResult.data ? freshResult.data.pin : m.pin;
                
                if (pin === freshPin) {
                    // Success
                    window.rejoinPinError = null;
                    window.rejoinSelectedMember = null;
                    await handleRejoinAs(m.id);
                } else {
                    // Wrong PIN
                    window.rejoinPinAttempts = (window.rejoinPinAttempts || 0) + 1;
                    
                    if (window.rejoinPinAttempts >= 3) {
                        window.rejoinPinError = 'Too many attempts. Ask your squad admin to reset your PIN.';
                    } else {
                        var remaining = 3 - window.rejoinPinAttempts;
                        window.rejoinPinError = 'Wrong PIN. ' + remaining + ' attempt' + (remaining > 1 ? 's' : '') + ' remaining.';
                    }
                    render();
                }
            } catch (err) {
                console.error('PIN check error:', err);
                window.rejoinPinError = 'Error checking PIN. Try again.';
                render();
            }
        }
        
        function showForgotPinHelp() {
            showModal(
                'üîë Forgot Your PIN?',
                '<div style="text-align: center;">' +
                    '<p style="margin-bottom: 16px;">Ask your squad admin to reset your PIN.</p>' +
                    '<p style="font-size: 13px; color: #8E8E93; margin-bottom: 16px;">The admin can find "Reset PIN" next to your name in Settings ‚Üí Admin Panel.</p>' +
                    '<p style="font-size: 13px; color: #8E8E93;">They\'ll get a temporary PIN to share with you.</p>' +
                '</div>',
                null,
                'Got It',
                function() { closeModal(); }
            );
        }
        
        async function handleRejoinAs(memberId) {
            var squadData = window.rejoinSquad;
            if (!squadData) return;
            
            // Set session
            squadId = squadData.id;
            squadCode = squadData.code;
            currentMemberId = memberId;
            
            localStorage.setItem('squadId', squadId);
            localStorage.setItem('squadCode', squadCode);
            localStorage.setItem('memberId', memberId);
            
            // Load full data
            await loadSquadData();
            
            if (squad && members[currentMemberId]) {
                subscribeToSquad();
                
                // Save to squad switcher
                saveCurrentSquad();
                updateSquadSwitcherUI();
                
                var member = members[currentMemberId];
                showToast(member.avatar + ' Welcome back, ' + member.name + '!', 'member');
                sounds.victory();
                
                screen = 'arena';
                render();
                startCountdownTimers();
            } else {
                alert('Something went wrong. Try again.');
                localStorage.clear();
                screen = 'welcome';
                render();
            }
            
            // Cleanup
            window.rejoinSquad = null;
            window.rejoinMembers = null;
        }
        
        // ============================================
        // v25: SQUAD CHALLENGE RENDER HELPERS
        // ============================================
        
        function renderSquadChallengeCard() {
            const active = squadChallenges.find(c => c.status === 'active');
            if (!active) return '';
            
            const subs = squadSubmissions[active.id] || [];
            const iSubmitted = subs.some(s => s.member_id === currentMemberId);
            const subCount = subs.length;
            const memberCount = Object.keys(members).length;
            const captain = members[active.captain_id];
            const time = getTimeRemaining(active.response_deadline);
            const weightLabel = active.weight > 1 ? active.weight + '√ó' : '';
            
            return `
                <div style="background: linear-gradient(135deg, rgba(255,215,0,.12), rgba(255,165,0,.04)); border: 2px solid rgba(255,215,0,.35); border-radius: 16px; padding: 20px; margin-bottom: 14px; position: relative; overflow: hidden; ${!iSubmitted ? 'animation: pulse 3s ease-in-out infinite;' : ''}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="font-size: 9px; color: #FFD700; font-weight: 800; letter-spacing: 1px;">SQUAD CHALLENGE ¬∑ Ch.${active.challenge_number}</span>
                        </div>
                        <span style="font-size: 13px; font-weight: 900; color: ${time.urgent ? '#FF3B30' : '#FFD700'};">${time.text}</span>
                    </div>
                    
                    ${captain ? `
                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 10px;">
                            <span style="font-size: 16px;">${captain.avatar || 'üë§'}</span>
                            <span style="font-size: 11px; color: #8E8E93;"><strong style="color: #FFF;">${captain.name}'s pick</strong></span>
                            <span style="font-size: 8px; background: rgba(52,199,89,.1); color: #34C759; padding: 2px 6px; border-radius: 4px; font-weight: 800;">üì∏ SNAP</span>
                            ${weightLabel ? `<span style="font-size: 8px; background: rgba(255,149,0,.1); color: #FF9500; padding: 2px 6px; border-radius: 4px; font-weight: 800;">${weightLabel}</span>` : ''}
                        </div>
                    ` : ''}
                    
                    <div style="font-size: 22px; font-weight: 900; margin-bottom: 6px; line-height: 1.2;">${active.prompt}</div>
                    <div style="font-size: 12px; color: #8E8E93; margin-bottom: 16px; padding: 6px 10px; background: rgba(255,255,255,.03); border-radius: 6px; border-left: 3px solid #FF9500;">${active.rule || 'üì∏ One photo. No staging. Just snap it.'}</div>
                    
                    ${iSubmitted ? `
                        <div style="text-align: center; padding: 10px; background: rgba(52,199,89,.06); border-radius: 8px; border: 1px solid rgba(52,199,89,.2);">
                            <span style="color: #34C759; font-weight: 700; font-size: 13px;">‚úÖ Snapped ¬∑ ${subCount}/${memberCount} submitted</span>
                        </div>
                    ` : `
                        <div style="font-size: 11px; color: #FF9500; text-align: center; margin-bottom: 10px;">
                            ${subCount === 0 ? 'Be the first.' : subCount >= memberCount - 1 ? "Everyone's in except you." : subCount + '/' + memberCount + ' snapped'}
                        </div>
                        <button onclick="startSquadSnap('${active.id}')" class="btn btn-primary" style="font-size: 16px;">
                            üì∏ Snap it ‚Äî one take, done
                        </button>
                    `}
                </div>
            `;
        }
        
        function renderCaptainPickCard() {
            if (captainQueue.length === 0) return '';
            const next = captainQueue.find(c => c.status === 'pending' && c.captain_id === currentMemberId);
            if (!next) return '';
            
            const time = getTimeRemaining(next.pick_deadline);
            
            return `
                <div style="background: rgba(255,215,0,.06); border: 2px solid rgba(255,215,0,.25); border-radius: 12px; padding: 14px; margin-bottom: 14px; text-align: center;">
                    <div style="font-size: 9px; color: #FFD700; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 6px;">üéØ YOU'RE UP ‚Äî PICK CH.${next.challenge_number}</div>
                    <div style="font-size: 13px; color: #8E8E93; margin-bottom: 12px;">Choose the next squad challenge. ${time.text} left or the system picks for you.</div>
                    <button onclick="showCaptainPicker(${next.challenge_number})" class="btn btn-primary" style="font-size: 14px;">
                        üéØ Pick a Challenge
                    </button>
                </div>
            `;
        }
        
        function renderSquadVotingCard() {
            const voting = squadChallenges.find(c => c.status === 'voting');
            if (!voting) return '';
            
            const time = getTimeRemaining(voting.voting_deadline);
            
            return `
                <div style="background: linear-gradient(135deg,rgba(175,82,222,.1),rgba(175,82,222,.03)); border: 2px solid rgba(175,82,222,.3); border-radius: 14px; padding: 16px; margin-bottom: 14px; text-align: center;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 8px; color: #AF52DE; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;">üó≥Ô∏è VOTING ¬∑ Ch.${voting.challenge_number}</span>
                        <span style="font-size: 12px; font-weight: 700; color: ${time.urgent ? '#FF3B30' : '#AF52DE'};">${time.text}</span>
                    </div>
                    <div style="font-size: 16px; font-weight: 800; margin-bottom: 10px;">${voting.prompt}</div>
                    <button onclick="showSquadVoting('${voting.id}')" style="width: 100%; padding: 14px; border-radius: 10px; background: linear-gradient(135deg,#AF52DE,#7B2D8E); color: #FFF; border: none; font-size: 14px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 16px rgba(175,82,222,.3);">
                        ‚öîÔ∏è Vote Now
                    </button>
                </div>
            `;
        }
        
        // Squad snap ‚Äî uses existing media capture flow
        function startSquadSnap(challengeId) {
            window._squadChallengeId = challengeId;
            screen = 'submit-squad';
            render();
        }
        
        function renderSubmitSquad() {
            const challengeId = window._squadChallengeId;
            const challenge = squadChallenges.find(c => c.id === challengeId);
            if (!challenge) return '<div style="padding: 40px; text-align: center;">Challenge not found</div>';
            
            return `
                <div class="fade-in" style="padding: 0;">
                    <button class="back-btn" onclick="screen='arena'; render();">‚Üê Back</button>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 9px; color: #FFD700; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 6px;">SQUAD CHALLENGE ¬∑ Ch.${challenge.challenge_number}</div>
                        <div style="font-size: 20px; font-weight: 900;">${challenge.prompt}</div>
                        <div style="font-size: 12px; color: #8E8E93; margin-top: 6px;">${challenge.rule || 'üì∏ One photo. No staging.'}</div>
                    </div>
                    
                    <div class="upload-zone" onclick="document.getElementById('squadFileInput').click();">
                        <div style="font-size: 48px; margin-bottom: 12px;">üì∏</div>
                        <div style="font-size: 15px; font-weight: 600; color: #D4AF37;">Tap to snap</div>
                        <div style="font-size: 12px; color: #8E8E93; margin-top: 8px;">Take a photo or choose from gallery</div>
                    </div>
                    
                    <input type="file" id="squadFileInput" accept="image/*" capture="environment" style="display: none;" onchange="handleSquadMediaSelect(this, '${challengeId}')">
                    
                    <div id="squadPreview" style="display: none; text-align: center; margin-bottom: 20px;">
                        <img id="squadPreviewImg" style="width: 100%; max-height: 400px; object-fit: contain; border-radius: 12px; margin-bottom: 16px;">
                        <button class="btn btn-primary" id="squadSubmitBtn" onclick="handleSquadSubmit('${challengeId}')">
                            üì∏ Submit Entry
                        </button>
                    </div>
                </div>
            `;
        }
        
        async function handleSquadMediaSelect(input, challengeId) {
            const file = input.files[0];
            if (!file) return;
            
            window._pendingFile = file;
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('squadPreviewImg').src = e.target.result;
                document.getElementById('squadPreview').style.display = 'block';
                document.querySelector('.upload-zone').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
        
        async function handleSquadSubmit(challengeId) {
            const btn = document.getElementById('squadSubmitBtn');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Uploading...';
            
            try {
                const mediaUrl = await uploadMedia(null, challengeId, 'squad');
                await submitToSquadChallenge(challengeId, mediaUrl, 'image');
                screen = 'arena';
                render();
            } catch (err) {
                console.error('Squad submit error:', err);
                showToast('Failed to submit: ' + err.message, 'error');
                btn.disabled = false;
                btn.innerHTML = 'üì∏ Submit Entry';
            }
        }
        
        // Captain picker screen
        function showCaptainPicker(challengeNumber) {
            window._captainChallengeNum = challengeNumber;
            screen = 'captain-pick';
            render();
        }
        
        function renderCaptainPick() {
            const chalNum = window._captainChallengeNum;
            
            return `
                <div class="fade-in" style="padding: 0;">
                    <button class="back-btn" onclick="screen='arena'; render();">‚Üê Back</button>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 36px; margin-bottom: 6px;">üéØ</div>
                        <div style="font-size: 9px; color: #FFD700; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 3px;">You're the Challenge Captain</div>
                        <div style="font-size: 18px; font-weight: 900; margin-bottom: 4px;">Pick Ch.${chalNum}</div>
                        <div style="font-size: 12px; color: #6E6E73;">Everyone in ${squad?.name || 'the squad'} will compete. Choose wisely.</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 6px; margin-bottom: 16px;">
                        ${SQUAD_CHALLENGE_PROMPTS.map(function(p) {
                            return '<button onclick="captainPickChallenge(\'' + p.replace(/'/g, "\\'") + '\')" style="width: 100%; padding: 14px 16px; text-align: left; background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 10px; color: #FFF; font-size: 14px; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: space-between;">' +
                                '<span>' + p + '</span>' +
                                '<span style="font-size: 10px; color: #FFD700; font-weight: 700;">SELECT</span>' +
                            '</button>';
                        }).join('')}
                    </div>
                    <div style="text-align: center; font-size: 10px; color: #48484A; margin-top: 8px;">
                        Can't decide? Go back and the system picks when time runs out.<br>
                        <span style="color: #FF3B30;">Ghost tax: you'll get a üè≥Ô∏è on the standings.</span>
                    </div>
                </div>
            `;
        }
        
        async function captainPickChallenge(prompt) {
            await createSquadChallenge(prompt, currentMemberId);
            screen = 'arena';
            render();
        }
        
        // Squad voting screen
        async function showSquadVoting(challengeId) {
            window._squadVoteChallengeId = challengeId;
            
            // Check if already voted
            try {
                const { data } = await db.from('squad_votes')
                    .select('*')
                    .eq('squad_challenge_id', challengeId)
                    .eq('voter_id', currentMemberId)
                    .maybeSingle();
                
                if (data) {
                    showToast('‚úÖ You already voted on this one!', 'info');
                    return;
                }
            } catch (e) {}
            
            screen = 'squad-vote';
            render();
        }
        
        function renderSquadVote() {
            const challengeId = window._squadVoteChallengeId;
            const challenge = squadChallenges.find(c => c.id === challengeId);
            if (!challenge) return '<div style="padding: 40px; text-align: center;">Not found</div>';
            
            const subs = (squadSubmissions[challengeId] || [])
                .filter(s => s.member_id !== currentMemberId); // Can't vote for yourself
            
            // Initialize vote order if not set
            if (!window._voteOrder || window._voteOrder.length !== subs.length) {
                window._voteOrder = subs.map(s => s.member_id);
            }
            
            const order = window._voteOrder;
            const labels = ['ü•á 1st', 'ü•à 2nd', 'ü•â 3rd', '4th', '5th'];
            const ptLabels = challenge.weight > 1 
                ? [Math.round(5*challenge.weight), Math.round(3*challenge.weight), Math.round(2*challenge.weight), Math.round(1*challenge.weight), 0]
                : [5, 3, 2, 1, 0];
            
            return `
                <div class="fade-in" style="padding: 0;">
                    <button class="back-btn" onclick="screen='arena'; render();">‚Üê Back</button>
                    <div style="text-align: center; margin-bottom: 18px;">
                        <div style="font-size: 9px; color: #AF52DE; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 3px;">Rank the Submissions</div>
                        <div style="font-size: 16px; font-weight: 900;">${challenge.prompt}</div>
                        <div style="font-size: 10px; color: #555; margin-top: 3px;">Your ranking = their points. Use arrows to reorder.</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px;">
                        ${order.map(function(mid, idx) {
                            const sub = subs.find(s => s.member_id === mid);
                            const mem = members[mid];
                            if (!mem || !sub) return '';
                            return '<div style="background: #1C1C1E; border: 2px solid ' + (idx === 0 ? 'rgba(255,215,0,.3)' : '#2C2C2E') + '; border-radius: 12px; padding: 11px; display: flex; align-items: center; gap: 8px;">' +
                                '<div style="display: flex; flex-direction: column;">' +
                                    (idx > 0 ? '<button onclick="moveVoteUp(' + idx + ')" style="background: none; border: none; font-size: 14px; padding: 1px 3px; cursor: pointer; color: #6E6E73;">‚ñ≤</button>' : '<div style="height: 20px;"></div>') +
                                    (idx < order.length - 1 ? '<button onclick="moveVoteDown(' + idx + ')" style="background: none; border: none; font-size: 14px; padding: 1px 3px; cursor: pointer; color: #6E6E73;">‚ñº</button>' : '<div style="height: 20px;"></div>') +
                                '</div>' +
                                (sub.media_url ? '<img src="' + sub.media_url + '" style="width: 44px; height: 44px; border-radius: 8px; object-fit: cover;">' : '<div style="width: 44px; height: 44px; border-radius: 8px; background: #2C2C2E; display: flex; align-items: center; justify-content: center; font-size: 18px;">üì∑</div>') +
                                '<div style="flex: 1;">' +
                                    '<div style="font-size: 13px; font-weight: 700;">' + (mem.avatar || 'üë§') + ' ' + mem.name + '</div>' +
                                    '<div style="font-size: 9px; color: ' + (idx === 0 ? '#FFD700' : '#555') + '; font-weight: 600; margin-top: 1px;">' + (labels[idx] || '') + ' ‚Äî ' + ptLabels[idx] + ' pts</div>' +
                                '</div>' +
                            '</div>';
                        }).join('')}
                    </div>
                    <button onclick="submitSquadVoteFromUI('${challengeId}')" class="btn" style="background: linear-gradient(135deg,#AF52DE,#7B2D8E); color: #FFF; font-size: 15px;">
                        Submit Rankings
                    </button>
                </div>
            `;
        }
        
        function moveVoteUp(idx) {
            if (idx <= 0) return;
            const o = window._voteOrder;
            [o[idx-1], o[idx]] = [o[idx], o[idx-1]];
            render();
        }
        
        function moveVoteDown(idx) {
            const o = window._voteOrder;
            if (idx >= o.length - 1) return;
            [o[idx], o[idx+1]] = [o[idx+1], o[idx]];
            render();
        }
        
        async function submitSquadVoteFromUI(challengeId) {
            const order = window._voteOrder;
            const rankings = order.map(function(mid, idx) {
                return { member_id: mid, rank: idx + 1 };
            });
            await submitSquadVote(challengeId, rankings);
            screen = 'arena';
            render();
        }
        
        function renderArena() {
            if (!squad || !members || Object.keys(members).length === 0) {
                return `
                    <div style="text-align: center; padding: 60px 20px;">
                        <div class="loading-spinner"></div>
                        <p style="margin-top: 16px; color: #8E8E93;">Loading squad...</p>
                    </div>
                `;
            }
            
            const currentMember = getCurrentMember();
            if (!currentMember) {
                return `<div style="text-align: center; padding: 40px;"><p>Session error. Please reload.</p></div>`;
            }
            
            const memberCount = Object.keys(members).length;
            const rankings = Object.values(members).sort((a, b) => b.points - a.points);
            const champion = rankings[0];
            const isChampion = champion.id === currentMemberId;
            
            // Challenge categories
            const pendingForYou = challenges.filter(c => c.status === 'waiting' && c.opponent_id === currentMemberId);
            const waitingForOpponent = challenges.filter(c => c.status === 'waiting' && c.challenger_id === currentMemberId);
            const myVotingChallenges = challenges.filter(c => 
                c.status === 'voting' && 
                (c.challenger_id === currentMemberId || c.opponent_id === currentMemberId)
            );
            const readyChallenges = challenges.filter(c => 
                c.status === 'ready' && 
                (c.challenger_id === currentMemberId || c.opponent_id === currentMemberId)
            );
            
            // All active duels (for live indicator)
            const allActiveDuels = challenges.filter(c => 
                c.status === 'waiting' || c.status === 'ready' || c.status === 'voting'
            );
            const liveDuel = allActiveDuels[0];
            
            // Champion at risk?
            const championAtRisk = allActiveDuels.some(c => 
                c.challenger_id === champion.id || c.opponent_id === champion.id
            );
            
            // Completed challenges for history
            const completedChallenges = challenges.filter(c => c.status === 'completed' && c.completed_at)
                .sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at));
            const lastDuel = completedChallenges[0];
            
            // Points calculations
            const yourPoints = currentMember.points || 0;
            const championPoints = champion.points || 0;
            const pointsToChampion = championPoints - yourPoints;
            
            // Crown stability
            const secondPlace = rankings[1];
            const crownGap = secondPlace ? (championPoints - (secondPlace.points || 0)) : 999;
            const membersWithinStrike = rankings.filter(m => m.id !== champion.id && (championPoints - m.points) <= 20).length;
            
            // Calculate rivalries
            const rivalries = {};
            completedChallenges.forEach(c => {
                if (!c.winner_id) return;
                const ids = [c.challenger_id, c.opponent_id].sort();
                const key = ids.join('-');
                if (!rivalries[key]) rivalries[key] = { a: ids[0], b: ids[1], aWins: 0, bWins: 0, lastDuel: null };
                if (c.winner_id === ids[0]) rivalries[key].aWins++;
                else rivalries[key].bWins++;
                rivalries[key].lastDuel = c.completed_at;
            });
            
            const hottestRivalry = Object.values(rivalries)
                .filter(r => r.aWins + r.bWins >= 2)
                .sort((a, b) => (b.aWins + b.bWins) - (a.aWins + a.bWins))[0];
            
            // Activity feed (last 5 events) - includes forfeits
            // Build comprehensive activity feed from all challenge events
            const activityFeed = [];
            
            // Add all challenges (not just completed) to create ongoing narrative
            challenges.forEach(c => {
                const challenger = members[c.challenger_id];
                const opponent = members[c.opponent_id];
                const winner = members[c.winner_id];
                const loserId = c.winner_id === c.challenger_id ? c.opponent_id : c.challenger_id;
                const loser = members[loserId];
                
                // Challenge sent (waiting status)
                if (c.status === 'waiting' && c.created_at) {
                    activityFeed.push({
                        icon: '‚öîÔ∏è',
                        text: (challenger?.name || '?') + ' challenged ' + (opponent?.name || '?'),
                        subtext: c.challenge_type,
                        time: new Date(c.created_at),
                        timeAgo: getTimeAgo(new Date(c.created_at)),
                        type: 'challenge',
                        color: '#0A84FF'
                    });
                }
                
                // Response submitted (ready status)
                if (c.status === 'ready' && c.created_at) {
                    activityFeed.push({
                        icon: '‚ö°',
                        text: (opponent?.name || '?') + ' responded to ' + (challenger?.name || '?'),
                        subtext: 'Showdown ready',
                        time: new Date(c.created_at),
                        timeAgo: getTimeAgo(new Date(c.created_at)),
                        type: 'response',
                        color: '#34C759'
                    });
                }
                
                // Completed challenge
                if (c.status === 'completed' && c.completed_at && winner) {
                    // Check if this was a dethrone (winner took #1 from loser)
                    const winnerWasBehind = (winner.points - 10) < (loser?.points + 3 || 0);
                    const loserWasChamp = rankings[0]?.id === loserId;
                    const isDethrone = loserWasChamp || (winner.points >= (rankings[0]?.points || 0));
                    
                    // Check streak milestone
                    const streakMilestone = winner.streak >= 3 ? winner.streak : 0;
                    
                    // Check for close margin (tie decided by AI)
                    const wasClose = c.votes_for_challenger === c.votes_for_opponent;
                    
                    let icon = 'üèÜ';
                    let text = (winner.name || '?') + ' defeated ' + (loser?.name || '?');
                    let color = '#FFD700';
                    let taunt = c.winner_taunt || c.loser_taunt || null;
                    
                    if (wasClose) {
                        icon = '‚öñÔ∏è';
                        text = (winner.name || '?') + ' edged out ' + (loser?.name || '?') + ' (AI tiebreak!)';
                        color = '#AF52DE';
                    } else if (isDethrone) {
                        icon = 'üëë';
                        text = (winner.name || '?') + ' dethroned ' + (loser?.name || '?') + '!';
                        color = '#FFD700';
                    } else if (streakMilestone >= 5) {
                        icon = 'üî•';
                        text = (winner.name || '?') + ' hit ' + streakMilestone + '-win streak!';
                        color = '#FF9500';
                    } else if (loser?.streak >= 3) {
                        icon = 'üí•';
                        text = (winner.name || '?') + ' ended ' + (loser?.name || '?') + '\'s ' + loser.streak + '-win streak';
                        color = '#FF3B30';
                    }
                    
                    // Build subtext with optional taunt
                    let subtext = c.challenge_type + ' ‚Ä¢ +10 / -3 pts';
                    if (taunt) {
                        subtext = '"' + taunt + '" ‚Äî ' + (c.winner_taunt ? winner.name : loser?.name);
                    }
                    
                    activityFeed.push({
                        icon: icon,
                        text: text,
                        subtext: subtext,
                        time: new Date(c.completed_at),
                        timeAgo: getTimeAgo(new Date(c.completed_at)),
                        type: 'result',
                        color: color,
                        hasTaunt: !!taunt
                    });
                }
                
                // Forfeit
                if (c.status === 'forfeited' && c.completed_at) {
                    activityFeed.push({
                        icon: '‚ö†Ô∏è',
                        text: (opponent?.name || '?') + ' forfeited to ' + (challenger?.name || '?'),
                        subtext: 'No response in 24h',
                        time: new Date(c.completed_at),
                        timeAgo: getTimeAgo(new Date(c.completed_at)),
                        type: 'forfeit',
                        color: '#FF9500'
                    });
                }
            });
            
            // Add ambient pings to feed
            const pings = getAmbientPings();
            pings.forEach(p => {
                const sender = members[p.member_id];
                const target = p.target_id ? members[p.target_id] : null;
                if (sender) {
                    // Format: "Sender ‚Üí Target" or just "Sender" if no target
                    const nameText = target 
                        ? sender.name + ' ‚Üí ' + target.name
                        : sender.name;
                    
                    activityFeed.push({
                        icon: 'üî•',
                        text: nameText,
                        subtext: '"' + p.ping_text + '"',
                        time: new Date(p.created_at),
                        timeAgo: getTimeAgo(new Date(p.created_at)),
                        type: 'ping',
                        color: '#FF9500',
                        hasTaunt: true
                    });
                }
            });
            
            // Sort by time descending
            activityFeed.sort((a, b) => b.time - a.time);
            
            // Collapse consecutive identical events (e.g., multiple dethrones)
            const collapsedFeed = [];
            activityFeed.forEach(event => {
                const lastEvent = collapsedFeed[collapsedFeed.length - 1];
                // Check if this is a duplicate of the previous event (same text within 1 hour)
                if (lastEvent && 
                    lastEvent.text === event.text && 
                    lastEvent.type === event.type &&
                    Math.abs(lastEvent.time - event.time) < 60 * 60 * 1000) {
                    // Increment count on existing event
                    lastEvent.count = (lastEvent.count || 1) + 1;
                } else {
                    event.count = 1;
                    collapsedFeed.push(event);
                }
            });
            
            const recentActivity = collapsedFeed.slice(0, 10);
            
            // Calculate season info ‚Äî use v25 season_config if available
            const now = new Date();
            var seasonNumber, daysLeftInSeason, weekInSeason, seasonUrgent;
            if (seasonConfig && seasonConfig.ends_at) {
                seasonNumber = seasonConfig.season_number || 1;
                daysLeftInSeason = Math.max(0, Math.ceil((new Date(seasonConfig.ends_at) - now) / (24 * 60 * 60 * 1000)));
                var totalDays = Math.ceil((new Date(seasonConfig.ends_at) - new Date(seasonConfig.started_at)) / (24 * 60 * 60 * 1000));
                var elapsedDays = totalDays - daysLeftInSeason;
                weekInSeason = Math.floor(elapsedDays / 7) + 1;
                seasonUrgent = daysLeftInSeason <= 2;
            } else {
                const yearStart = new Date(now.getFullYear(), 0, 1);
                const weekOfYear = Math.floor((now - yearStart) / (7 * 24 * 60 * 60 * 1000));
                seasonNumber = Math.floor(weekOfYear / 4) + 1;
                weekInSeason = (weekOfYear % 4) + 1;
                const seasonEndDate = new Date(yearStart.getTime() + (seasonNumber * 4 * 7 * 24 * 60 * 60 * 1000));
                daysLeftInSeason = Math.max(0, Math.ceil((seasonEndDate - now) / (24 * 60 * 60 * 1000)));
                seasonUrgent = daysLeftInSeason <= 7;
            }
            
            return `
                <div class="fade-in">
                    <!-- NOTIFICATION PROMPT -->
                    ${shouldShowNotifPrompt() ? renderNotificationPrompt() : ''}
                    
                    <!-- v25: SQUAD CHALLENGE HERO CARD -->
                    ${renderSquadChallengeCard()}
                    
                    <!-- v25: CAPTAIN PICK CARD (if it's your turn) -->
                    ${renderCaptainPickCard()}
                    
                    <!-- v25: SQUAD VOTING CARD -->
                    ${renderSquadVotingCard()}
                    
                    <!-- üö® ACTION REQUIRED ‚Äî 1v1 CALLOUTS -->
                    ${pendingForYou.length > 0 ? `
                        <div style="background: linear-gradient(135deg, rgba(255, 59, 48, 0.15), rgba(255, 59, 48, 0.05)); border: 2px solid rgba(255, 59, 48, 0.5); border-radius: 14px; padding: 20px; margin-bottom: 12px; animation: pulse 2s infinite;">
                            <div style="font-size: 13px; color: #FF3B30; text-transform: uppercase; letter-spacing: 1px; font-weight: 900; margin-bottom: 14px;">üî• YOU'VE BEEN CHALLENGED</div>
                            ${pendingForYou.map(c => {
                                var deadlineStr = c.deadline_at ? formatCountdown(c.deadline_at) : '';
                                var urgent = c.deadline_at ? isDeadlineUrgent(c.deadline_at) : false;
                                var critical = c.deadline_at ? isDeadlineCritical(c.deadline_at) : false;
                                return `
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 14px;">
                                    <div style="font-size: 40px;">${members[c.challenger_id]?.avatar || 'üë§'}</div>
                                    <div style="flex: 1;">
                                        <div style="font-size: 17px; font-weight: 900;">${members[c.challenger_id]?.name || '?'}</div>
                                        <div style="font-size: 14px; color: #FFFFFF; font-weight: 600;">${c.challenge_type}</div>
                                        ${c.deadline_at ? `
                                            <div style="margin-top: 4px;">
                                                <span data-deadline="${c.deadline_at}" style="font-size: 13px; font-weight: 700; color: ${critical ? '#FF3B30' : urgent ? '#FF9500' : '#FFD700'}; ${critical ? 'animation: pulse 1s infinite;' : ''}">${deadlineStr}</span>
                                                <span style="font-size: 11px; color: #8E8E93;"> left to respond</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                                <button class="btn btn-primary" style="width: 100%; padding: 16px; font-size: 16px; font-weight: 900; background: linear-gradient(135deg, #FF3B30, #FF6B35);" onclick="startResponse('${c.id}')">‚öîÔ∏è FIGHT BACK NOW</button>
                            `}).join('')}
                        </div>
                    ` : ''}
                    
                    ${readyChallenges.length > 0 ? `
                        <div style="background: linear-gradient(135deg, rgba(52, 199, 89, 0.15), rgba(52, 199, 89, 0.05)); border: 2px solid rgba(52, 199, 89, 0.5); border-radius: 14px; padding: 20px; margin-bottom: 12px;">
                            <div style="font-size: 13px; color: #34C759; text-transform: uppercase; letter-spacing: 1px; font-weight: 900; margin-bottom: 14px;">‚ö° SHOWDOWN READY</div>
                            ${readyChallenges.map(c => {
                                var opponentId = c.challenger_id === currentMemberId ? c.opponent_id : c.challenger_id;
                                return `
                                <div style="display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 14px;">
                                    <div style="text-align: center;"><div style="font-size: 40px;">${members[c.challenger_id]?.avatar || 'üë§'}</div><div style="font-size: 12px; font-weight: 600;">${members[c.challenger_id]?.name || '?'}</div></div>
                                    <div style="font-size: 20px; font-weight: 900; color: #FFD700;">VS</div>
                                    <div style="text-align: center;"><div style="font-size: 40px;">${members[c.opponent_id]?.avatar || 'üë§'}</div><div style="font-size: 12px; font-weight: 600;">${members[c.opponent_id]?.name || '?'}</div></div>
                                </div>
                                <div style="font-size: 14px; color: #FFFFFF; text-align: center; margin-bottom: 12px; font-weight: 600;">${c.challenge_type}</div>
                                <button class="btn btn-primary" style="width: 100%; padding: 16px; font-size: 16px; font-weight: 900; background: linear-gradient(135deg, #34C759, #30B350);" onclick="initiateJudging('${c.id}')">‚öñÔ∏è SEE WHO WINS</button>
                            `}).join('')}
                        </div>
                    ` : ''}

                    ${myVotingChallenges.length > 0 ? `
                        <div style="background: rgba(255, 215, 0, 0.08); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 14px; padding: 16px; margin-bottom: 12px;">
                            <div style="font-size: 11px; color: #FFD700; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-bottom: 12px;">‚è≥ AWAITING VOTES</div>
                            ${myVotingChallenges.map(c => {
                                const opponent = c.challenger_id === currentMemberId ? members[c.opponent_id] : members[c.challenger_id];
                                const totalVotes = (c.votes_for_challenger || 0) + (c.votes_for_opponent || 0);
                                return `
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                        <span style="font-size: 24px;">${currentMember.avatar}</span>
                                        <span style="font-size: 16px;">‚öîÔ∏è</span>
                                        <span style="font-size: 24px;">${opponent?.avatar || 'üë§'}</span>
                                        <span style="flex: 1; font-size: 12px; color: #8E8E93; text-align: right;">${totalVotes} vote${totalVotes !== 1 ? 's' : ''}</span>
                                    </div>
                                    <button class="btn btn-secondary" style="width: 100%;" onclick="showTwoPersonVoting('${c.id}')">View Duel</button>
                                `;
                            }).join('')}
                        </div>
                    ` : ''}
                    
                    <!-- 1Ô∏è‚É£ HEAT INDICATOR (expandable) -->
                    ${allActiveDuels.length > 0 ? `
                        <div id="liveDuelsBanner" style="background: linear-gradient(90deg, rgba(255, 59, 48, 0.2), rgba(255, 149, 0, 0.2)); border: 1px solid rgba(255, 59, 48, 0.4); border-radius: 10px; padding: 12px 16px; margin-bottom: 16px;">
                            <div onclick="toggleLiveDuels()" style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 14px;">üî•</span>
                                    <span style="font-size: 13px; font-weight: 700; color: #FF3B30;">${allActiveDuels.length} LIVE DUEL${allActiveDuels.length > 1 ? 'S' : ''}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    ${championAtRisk ? `
                                        <span style="font-size: 11px; color: #FF9500; font-weight: 600;">üëë CROWN AT RISK</span>
                                    ` : ''}
                                    <span id="liveDuelsChevron" style="color: #8E8E93; font-size: 14px; transition: transform 0.2s;">‚Ä∫</span>
                                </div>
                            </div>
                            <div id="liveDuelsList" style="display: none; margin-top: 12px; border-top: 1px solid rgba(255, 59, 48, 0.3); padding-top: 12px;">
                                ${allActiveDuels.map(duel => {
                                    const challenger = members[duel.challenger_id];
                                    const opponent = members[duel.opponent_id];
                                    const hasChallenger = duel.challenger_submission_url;
                                    const hasOpponent = duel.opponent_submission_url;
                                    const amChallenger = duel.challenger_id === currentMemberId;
                                    const amOpponent = duel.opponent_id === currentMemberId;
                                    const amParticipant = amChallenger || amOpponent;
                                    
                                    // Determine status text based on who's waiting
                                    let statusText = '';
                                    let statusColor = '#FF9500';
                                    
                                    if (hasChallenger && hasOpponent) {
                                        statusText = '‚úì Ready to judge';
                                        statusColor = '#34C759';
                                    } else if (amParticipant) {
                                        // I'm in this duel
                                        const iSubmitted = (amChallenger && hasChallenger) || (amOpponent && hasOpponent);
                                        const theySubmitted = (amChallenger && hasOpponent) || (amOpponent && hasChallenger);
                                        const theirName = amChallenger ? (opponent?.name || '?') : (challenger?.name || '?');
                                        
                                        if (iSubmitted && !theySubmitted) {
                                            statusText = '‚è≥ Waiting for ' + theirName;
                                            statusColor = '#8E8E93';
                                        } else if (!iSubmitted && theySubmitted) {
                                            statusText = 'üî¥ YOUR TURN';
                                            statusColor = '#FF3B30';
                                        } else if (!iSubmitted && !theySubmitted) {
                                            statusText = 'üî¥ Submit yours';
                                            statusColor = '#FF3B30';
                                        }
                                    } else {
                                        // I'm not in this duel
                                        if (hasChallenger && !hasOpponent) {
                                            statusText = 'Waiting for ' + (opponent?.name || '?');
                                        } else if (!hasChallenger && hasOpponent) {
                                            statusText = 'Waiting for ' + (challenger?.name || '?');
                                        } else {
                                            statusText = 'In progress';
                                        }
                                    }
                                    
                                    return `
                                        <div style="display: flex; align-items: center; gap: 10px; padding: 8px 0; ${allActiveDuels.indexOf(duel) > 0 ? 'border-top: 1px solid rgba(255,255,255,0.1);' : ''}">
                                            <div style="display: flex; align-items: center; gap: 4px; flex: 1; min-width: 0;">
                                                <span style="font-size: 18px;">${challenger?.avatar || 'üë§'}</span>
                                                <span style="font-size: 11px; color: #8E8E93;">vs</span>
                                                <span style="font-size: 18px;">${opponent?.avatar || 'üë§'}</span>
                                                <div style="margin-left: 8px; overflow: hidden;">
                                                    <div style="font-size: 12px; color: #FFFFFF; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${duel.challenge_type}</div>
                                                    <div style="font-size: 10px; color: ${statusColor}; font-weight: ${statusColor === '#FF3B30' ? '700' : '400'};">${statusText}</div>
                                                </div>
                                            </div>
                                            <button onclick="event.stopPropagation(); viewLiveDuel('${duel.id}')" style="padding: 6px 12px; background: rgba(255, 59, 48, 0.2); border: 1px solid rgba(255, 59, 48, 0.4); border-radius: 6px; color: #FF6B6B; font-size: 11px; font-weight: 600; cursor: pointer;">View</button>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : lastDuel ? `
                        <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px; padding: 10px 14px; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 12px; color: #8E8E93;">‚ö° The ladder is exposed‚Ä¶</span>
                                <span style="font-size: 12px; color: #FFFFFF;">üî• Last: ${members[lastDuel.winner_id]?.name || '?'} defeated ${members[lastDuel.winner_id === lastDuel.challenger_id ? lastDuel.opponent_id : lastDuel.challenger_id]?.name || '?'}</span>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- 2Ô∏è‚É£ CHAMPION CARD (Hero Section) -->
                    <div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 165, 0, 0.05)); border: 2px solid rgba(255, 215, 0, 0.4); border-radius: 16px; padding: 20px; margin-bottom: 14px; text-align: center; position: relative; overflow: hidden;">
                        <!-- Subtle glow effect -->
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 180px; height: 180px; background: radial-gradient(circle, rgba(255, 215, 0, 0.1) 0%, transparent 70%); pointer-events: none;"></div>
                        
                        <div style="position: relative; z-index: 1;">
                            <!-- Crown + Avatar -->
                            <div style="font-size: 24px; margin-bottom: -6px; ${champion.streak >= 3 ? 'animation: pulse 1.5s infinite;' : ''}">üëë</div>
                            <div style="font-size: 52px; margin-bottom: 6px;">${champion.avatar}</div>
                            
                            ${isChampion ? `
                                <div style="font-size: 10px; color: #8E8E93; text-transform: uppercase; letter-spacing: 2px;">YOU HOLD THE CROWN</div>
                                <div style="font-size: 20px; font-weight: 900; margin: 6px 0;">${champion.name}</div>
                                ${champion.streak > 0 ? `<div style="font-size: 13px; color: #FF9500; font-weight: 600;">üî• ${champion.streak}-Win Streak</div>` : ''}
                                <div style="font-size: 12px; color: #8E8E93; margin-top: 6px;">
                                    ${membersWithinStrike > 0 ? `${membersWithinStrike} member${membersWithinStrike > 1 ? 's' : ''} within striking distance` : 'The crown must be defended'}
                                </div>
                                <button class="btn btn-primary" style="margin-top: 14px; padding: 12px 20px; background: linear-gradient(135deg, #FFD700, #FFA500);" onclick="screen='select-opponent'; render();">
                                    üõ° Defend Your Position
                                </button>
                            ` : `
                                <div style="font-size: 10px; color: #8E8E93; text-transform: uppercase; letter-spacing: 2px;">${champion.name.toUpperCase()} REIGNS</div>
                                <div style="font-size: 26px; font-weight: 900; margin: 6px 0;">${champion.points} pts</div>
                                ${champion.streak > 0 ? `<div style="font-size: 13px; color: #FF9500; font-weight: 600;">üî• ${champion.streak}-Win Streak</div>` : ''}
                                <div style="font-size: 12px; color: #FFFFFF; margin-top: 6px; font-weight: 600;">
                                    You're ${pointsToChampion} pts behind ‚Äî every duel reshapes the ladder
                                </div>
                                <button class="btn btn-primary" style="margin-top: 14px; padding: 12px 20px; background: linear-gradient(135deg, #FFD700, #FFA500);" onclick="challengeChampion()">
                                    ‚öîÔ∏è Risk Your Rank
                                </button>
                            `}
                        </div>
                    </div>
                    
                    <!-- 3Ô∏è‚É£ RIVALRY SPOTLIGHT -->
                    ${hottestRivalry ? `
                        <div style="background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 12px; padding: 14px; margin-bottom: 14px;">
                            <div style="font-size: 10px; color: #FF9500; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; font-weight: 700;">üî• HOT RIVALRY</div>
                            <div style="display: flex; align-items: center; justify-content: space-around;">
                                <div style="text-align: center;">
                                    <div style="font-size: 30px;">${members[hottestRivalry.a]?.avatar || 'üë§'}</div>
                                    <div style="font-size: 12px; font-weight: 600; margin-top: 3px;">${members[hottestRivalry.a]?.name || '?'}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 20px; font-weight: 900; color: #FFFFFF;">${hottestRivalry.aWins} ‚Äì ${hottestRivalry.bWins}</div>
                                    <div style="font-size: 9px; color: #8E8E93; margin-top: 2px;">all-time battles</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 30px;">${members[hottestRivalry.b]?.avatar || 'üë§'}</div>
                                    <div style="font-size: 12px; font-weight: 600; margin-top: 3px;">${members[hottestRivalry.b]?.name || '?'}</div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- 4Ô∏è‚É£ ACTION STRIP -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                        <button onclick="screen='select-opponent'; render();" style="background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 10px; padding: 12px; color: #FFFFFF; font-size: 13px; font-weight: 700; cursor: pointer;">
                            ‚öîÔ∏è Pick a Target
                        </button>
                        <button onclick="quickRandomDuel()" style="background: linear-gradient(135deg, rgba(175, 82, 222, 0.2), rgba(255, 45, 85, 0.2)); border: 2px solid rgba(175, 82, 222, 0.4); border-radius: 10px; padding: 12px; color: #AF52DE; font-size: 13px; font-weight: 700; cursor: pointer;">
                            üé≤ Quick Random
                        </button>
                    </div>
                    
                    <!-- STIR THE POT BUTTON -->
                    <button onclick="showAmbientPingMenu()" class="stir-the-pot-btn" style="width: 100%; background: linear-gradient(135deg, rgba(255, 149, 0, 0.1), rgba(255, 69, 0, 0.08)); border: 1px solid rgba(255, 149, 0, 0.3); border-radius: 10px; padding: 12px; margin-bottom: 14px; color: #FF9500; font-size: 13px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; position: relative; overflow: hidden; transition: all 0.3s ease;">
                        <span style="font-size: 15px; filter: brightness(1.2);">üî•</span> 
                        <span>Stir the Pot</span>
                    </button>
                    
                    ${waitingForOpponent.length > 0 ? `
                        <div style="background: #1C1C1E; border: 1px solid #2C2C2E; border-radius: 14px; padding: 16px; margin-bottom: 12px;">
                            <div style="font-size: 11px; color: #8E8E93; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-bottom: 8px;">‚è≥ WAITING FOR THEM</div>
                            ${waitingForOpponent.map(c => {
                                var deadlineStr = c.deadline_at ? formatCountdown(c.deadline_at) : '';
                                var urgent = c.deadline_at ? isDeadlineUrgent(c.deadline_at) : false;
                                return `
                                <div style="display: flex; align-items: center; gap: 8px; padding: 4px 0;">
                                    <span style="font-size: 13px; color: #FFFFFF;">${c.challenge_type}</span>
                                    <span style="font-size: 12px; color: #8E8E93;">‚Ä¢ waiting for ${members[c.opponent_id]?.name || '?'}</span>
                                    ${c.deadline_at ? `
                                        <span data-deadline="${c.deadline_at}" style="font-size: 12px; font-weight: 600; color: ${urgent ? '#FF9500' : '#8E8E93'}; margin-left: auto;">${deadlineStr}</span>
                                    ` : ''}
                                </div>
                            `}).join('')}
                        </div>
                    ` : ''}
                    
                    <!-- 5Ô∏è‚É£ LADDER SNAPSHOT with Season Info -->
                    <div style="background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 12px; overflow: hidden; margin-bottom: 16px;">
                        <!-- Season header bar -->
                        <div onclick="goTo('ladder')" style="background: linear-gradient(135deg, rgba(175, 82, 222, 0.2), rgba(255, 215, 0, 0.1)); padding: 8px 14px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid #2C2C2E;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="font-size: 11px; color: #AF52DE; font-weight: 700;">SEASON ${seasonNumber}</span>
                                <span style="font-size: 10px; color: #8E8E93;">Week ${weekInSeason}/4</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="font-size: 12px; font-weight: 700; color: ${seasonUrgent ? '#FF9500' : '#FFD700'}; ${seasonUrgent ? 'animation: pulse 2s infinite;' : ''}">${daysLeftInSeason}d left</span>
                                <span style="color: #8E8E93; font-size: 11px;">‚Ä∫</span>
                            </div>
                        </div>
                        <!-- Rankings -->
                        <div style="padding: 10px 14px;">
                            ${rankings.slice(0, 3).map((m, i) => {
                                const pointsGap = i === 0 ? null : rankings[0].points - m.points;
                                return `
                                <div style="display: flex; align-items: center; gap: 8px; padding: 8px 0; ${i > 0 ? 'border-top: 1px solid #2C2C2E;' : ''}">
                                    <span style="font-size: 14px; font-weight: 800; color: ${i === 0 ? '#FFD700' : '#8E8E93'}; width: 22px;">${i === 0 ? 'üëë' : i + 1}</span>
                                    <span style="font-size: 20px;">${m.avatar}</span>
                                    <div style="flex: 1;">
                                        <div style="font-size: 13px; font-weight: 600;">${m.name}${m.id === currentMemberId ? ' (you)' : ''}</div>
                                        ${i === 0 ? `<div style="font-size: 9px; color: #AF52DE; font-weight: 600;">SEASON LEADER</div>` : 
                                          pointsGap !== null ? `<div style="font-size: 9px; color: #8E8E93;">${pointsGap} pts behind</div>` : ''}
                                    </div>
                                    <div style="text-align: right;">
                                        <span style="font-size: 15px; font-weight: 800; color: #FFD700;">${m.points}</span>
                                        ${m.streak > 0 ? `<span style="font-size: 11px; color: #FF9500; margin-left: 3px;">üî•${m.streak}</span>` : ''}
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                    
                    <!-- 6Ô∏è‚É£ RIVALRY FEED -->
                    ${recentActivity.length > 0 ? `
                        <div style="background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 14px; padding: 16px;">
                            <div style="font-size: 11px; color: #8E8E93; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-bottom: 14px;">üìú RIVALRY FEED</div>
                            ${recentActivity.map((event, i) => `
                                <div style="padding: 12px 0; ${i > 0 ? 'border-top: 1px solid rgba(44, 44, 46, 0.6);' : ''}">
                                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                                        <span style="font-size: 18px; line-height: 1; margin-top: 2px;">${event.icon}</span>
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="font-size: 14px; color: ${event.color}; font-weight: 600;">
                                                ${event.text}${event.count > 1 ? ` <span style="color: #8E8E93; font-weight: 400;">√ó${event.count}</span>` : ''}
                                            </div>
                                            <div style="font-size: 12px; color: ${event.hasTaunt ? '#FFD700' : '#8E8E93'}; margin-top: 4px; line-height: 1.4; ${event.hasTaunt ? 'font-style: italic;' : ''}">${event.subtext}</div>
                                        </div>
                                        <span style="font-size: 11px; color: #6E6E73; white-space: nowrap; margin-top: 2px;">${event.timeAgo}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div style="background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 14px; padding: 24px; text-align: center;">
                            <div style="font-size: 32px; margin-bottom: 8px;">‚öîÔ∏è</div>
                            <div style="font-size: 14px; color: #8E8E93;">No activity yet</div>
                            <div style="font-size: 12px; color: #6E6E73; margin-top: 4px;">Challenge someone to get the rivalry started!</div>
                        </div>
                    `}
                </div>
            `;
        }
        
        // Quick random duel function
        function quickRandomDuel() {
            var currentMember = getCurrentMember();
            if (currentMember && currentMember.suspended) {
                showToast('Your account is currently suspended by the admin', 'info');
                return;
            }
            const opponents = Object.values(members).filter(m => m.id !== currentMemberId && !m.suspended);
            if (opponents.length === 0) {
                showToast('No opponents available!', 'error');
                return;
            }
            const randomOpponent = opponents[Math.floor(Math.random() * opponents.length)];
            const randomChallenge = duelChallenges[Math.floor(Math.random() * duelChallenges.length)];
            selectedOpponent = randomOpponent.id;
            selectedChallenge = randomChallenge;
            screen = 'challenge-reveal';
            render();
        }
        
        // Start a weekly squad challenge (all members, not 1:1)
        function startWeeklyChallenge() {
            var now = new Date();
            var weekNumber = Math.floor((now - new Date(now.getFullYear(), 0, 1)) / (7 * 24 * 60 * 60 * 1000));
            var thisWeeksChallenge = weeklyChallenges[weekNumber % weeklyChallenges.length];
            
            showModal(
                'üéØ Weekly Squad Challenge',
                '<div style="text-align: center;">' +
                    '<div style="font-size: 20px; font-weight: 900; margin-bottom: 8px;">' + thisWeeksChallenge.name + '</div>' +
                    '<div style="font-size: 13px; color: #8E8E93; margin-bottom: 16px;">' + thisWeeksChallenge.desc + '</div>' +
                    '<div style="background: rgba(175, 82, 222, 0.1); border: 1px solid rgba(175, 82, 222, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 16px;">' +
                        '<div style="font-size: 12px; color: #AF52DE; font-weight: 600;">HOW IT WORKS</div>' +
                        '<div style="font-size: 12px; color: #8E8E93; margin-top: 6px; line-height: 1.5;">' +
                            '1. All squad members submit entries<br>' +
                            '2. Entries are paired up for head-to-head voting<br>' +
                            '3. Participants in each pairing vote on the winner<br>' +
                            '4. AI breaks any ties<br>' +
                            '5. Winner of each round advances!' +
                        '</div>' +
                    '</div>' +
                    '<div style="font-size: 11px; color: #8E8E93;">Type: ' + (thisWeeksChallenge.type === 'video' ? 'üìπ Video' : 'üì∏ Photo') + ' ‚Ä¢ Time: ' + thisWeeksChallenge.time + '</div>' +
                '</div>',
                'Cancel',
                'Submit My Entry',
                function() {
                    closeModal();
                    // Set up challenge for submission
                    var now2 = new Date();
                    var weekNumber2 = Math.floor((now2 - new Date(now2.getFullYear(), 0, 1)) / (7 * 24 * 60 * 60 * 1000));
                    var weeklyChallenge = weeklyChallenges[weekNumber2 % weeklyChallenges.length];
                    selectedChallenge = weeklyChallenge;
                    selectedOpponent = null; // Will be matched later
                    window.isWeeklySubmission = true;
                    screen = 'submit-weekly';
                    render();
                },
                function() { closeModal(); }
            );
        }
        
        // Time ago helper
        function getTimeAgo(date) {
            const seconds = Math.floor((Date.now() - date) / 1000);
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return minutes + 'm ago';
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return hours + 'h ago';
            const days = Math.floor(hours / 24);
            return days + 'd ago';
        }
        
        // ============================================
        // v21: DEADLINE & FORFEIT SYSTEM
        // ============================================
        
        // Check for expired challenges and handle forfeits
        async function checkForForfeits() {
            if (!squadId || !currentMemberId) return;
            
            var now = new Date();
            var expiredChallenges = challenges.filter(function(c) {
                return c.status === 'waiting' && c.deadline_at && new Date(c.deadline_at) < now;
            });
            
            for (var i = 0; i < expiredChallenges.length; i++) {
                var c = expiredChallenges[i];
                await handleForfeit(c);
            }
            
            if (expiredChallenges.length > 0) {
                await loadSquadData();
                render();
            }
        }
        
        async function handleForfeit(challenge) {
            // The opponent (who didn't respond) forfeits
            var forfeiterId = challenge.opponent_id;
            var winnerId = challenge.challenger_id;
            var forfeiter = members[forfeiterId];
            var winner = members[winnerId];
            
            if (!forfeiter || !winner) return;
            
            // Check grace: has this person forfeited this week already?
            var startOfWeek = getStartOfWeek();
            var hasUsedGrace = false;
            try {
                var result = await db
                    .from('challenges')
                    .select('id')
                    .eq('squad_id', squadId)
                    .eq('opponent_id', forfeiterId)
                    .eq('status', 'forfeited')
                    .gte('completed_at', startOfWeek.toISOString());
                
                hasUsedGrace = result.data && result.data.length > 0;
            } catch (e) {
                console.log('Grace check failed, defaulting to no grace used');
            }
            
            // Update challenge status
            await db
                .from('challenges')
                .update({
                    status: 'forfeited',
                    winner_id: winnerId,
                    completed_at: new Date().toISOString(),
                    forfeit_grace: !hasUsedGrace
                })
                .eq('id', challenge.id);
            
            // Winner always gets points
            await db
                .from('members')
                .update({
                    points: (winner.points || 0) + WIN_POINTS,
                    streak: (winner.streak || 0) + 1,
                    all_time_wins: (winner.all_time_wins || 0) + 1
                })
                .eq('id', winnerId);
            
            if (hasUsedGrace) {
                // Second+ forfeit this week: real penalty
                var newPoints = Math.max(0, (forfeiter.points || 0) - FORFEIT_POINTS);
                await db
                    .from('members')
                    .update({
                        points: newPoints,
                        streak: 0
                    })
                    .eq('id', forfeiterId);
                
                console.log('‚ö†Ô∏è Forfeit with penalty:', forfeiter.name, '-' + FORFEIT_POINTS + ' pts');
            } else {
                // First forfeit this week: grace ‚Äî just reset streak
                await db
                    .from('members')
                    .update({ streak: 0 })
                    .eq('id', forfeiterId);
                
                console.log('‚ö†Ô∏è Forfeit with grace (no penalty):', forfeiter.name);
            }
        }
        
        // Format remaining time as countdown string
        function formatCountdown(deadline) {
            var now = new Date();
            var target = new Date(deadline);
            var diff = target - now;
            
            if (diff <= 0) return 'EXPIRED';
            
            var hours = Math.floor(diff / (1000 * 60 * 60));
            var minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (hours > 0) {
                return hours + 'h ' + minutes + 'm';
            }
            return minutes + 'm';
        }
        
        // Format countdown for weekly challenge  
        function formatWeeklyCountdown(endOfWeek) {
            var now = new Date();
            var diff = endOfWeek - now;
            
            if (diff <= 0) return 'Ended';
            
            var days = Math.floor(diff / (1000 * 60 * 60 * 24));
            var hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            var minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (days > 0) return days + 'd ' + hours + 'h';
            if (hours > 0) return hours + 'h ' + minutes + 'm';
            return minutes + 'm';
        }
        
        // Is deadline urgent? (under 4 hours)
        function isDeadlineUrgent(deadline) {
            var diff = new Date(deadline) - new Date();
            return diff > 0 && diff < (4 * 60 * 60 * 1000);
        }
        
        // Is deadline critical? (under 1 hour)
        function isDeadlineCritical(deadline) {
            var diff = new Date(deadline) - new Date();
            return diff > 0 && diff < (60 * 60 * 1000);
        }
        
        // Start ticking countdown timers on screen
        function startCountdownTimers() {
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(function() {
                // Update all visible countdown elements
                var els = document.querySelectorAll('[data-deadline]');
                els.forEach(function(el) {
                    var deadline = el.getAttribute('data-deadline');
                    var remaining = formatCountdown(deadline);
                    el.textContent = remaining;
                    
                    // Color coding
                    if (remaining === 'EXPIRED') {
                        el.style.color = '#FF3B30';
                    } else if (isDeadlineCritical(deadline)) {
                        el.style.color = '#FF3B30';
                        el.style.animation = 'pulse 1s infinite';
                    } else if (isDeadlineUrgent(deadline)) {
                        el.style.color = '#FF9500';
                    }
                });
                
                // Update weekly timer
                var weeklyEl = document.getElementById('weeklyCountdown');
                if (weeklyEl) {
                    var endOfWeek = new Date(weeklyEl.getAttribute('data-end'));
                    weeklyEl.textContent = formatWeeklyCountdown(endOfWeek);
                }
            }, 15000); // Every 15 seconds
        }
        
        // ============================================
        // INSTALL PROMPT SYSTEM (PWA)
        // ============================================
        
        // Detect if app is installed as PWA
        function isInstalledPWA() {
            // iOS: standalone mode
            if (window.navigator.standalone === true) return true;
            
            // Android/Desktop: display-mode: standalone
            if (window.matchMedia('(display-mode: standalone)').matches) return true;
            
            return false;
        }
        
        // Detect platform for install instructions
        function getInstallPlatform() {
            const ua = navigator.userAgent || navigator.vendor || window.opera;
            
            // iOS detection
            if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) {
                return 'ios';
            }
            
            // Android detection
            if (/android/i.test(ua)) {
                return 'android';
            }
            
            // Desktop/other
            return 'desktop';
        }
        
        // Check if we should show the install banner
        function shouldShowInstallBanner() {
            // Already installed? Don't show
            if (isInstalledPWA()) return false;
            
            // Not on HTTPS? Can't install anyway
            if (window.location.protocol !== 'https:') return false;
            
            // Check if dismissed recently
            if (installBannerDismissedAt) {
                const dismissedTime = new Date(installBannerDismissedAt).getTime();
                const now = Date.now();
                const hoursSinceDismiss = (now - dismissedTime) / (1000 * 60 * 60);
                
                if (hoursSinceDismiss < INSTALL_BANNER_RESURFACE_HOURS) {
                    return false;
                }
            }
            
            return true;
        }
        
        // Show/hide install banner
        function updateInstallBanner() {
            const banner = document.getElementById('installBanner');
            if (!banner) return;
            
            if (shouldShowInstallBanner()) {
                banner.classList.remove('hidden');
                // Add padding to app content so banner doesn't overlap
                document.querySelector('.app').style.paddingBottom = '80px';
            } else {
                banner.classList.add('hidden');
                document.querySelector('.app').style.paddingBottom = '0';
            }
        }
        
        // Dismiss the install banner
        function dismissInstallBanner() {
            installBannerDismissedAt = new Date().toISOString();
            localStorage.setItem('installBannerDismissedAt', installBannerDismissedAt);
            updateInstallBanner();
        }
        
        // Show full install modal with instructions
        function showInstallModal() {
            const platform = getInstallPlatform();
            
            let instructionsHtml = '';
            
            if (platform === 'ios') {
                instructionsHtml = `
                    <div class="install-step">
                        <div class="install-step-number">1</div>
                        <div class="install-step-content">
                            <div class="install-step-title">Tap the Share button</div>
                            <div class="install-step-desc">Look for <span class="install-icon">‚Üë</span> at the bottom of Safari</div>
                        </div>
                    </div>
                    <div class="install-step">
                        <div class="install-step-number">2</div>
                        <div class="install-step-content">
                            <div class="install-step-title">Scroll & tap "Add to Home Screen"</div>
                            <div class="install-step-desc">It has a <span style="font-size: 14px;">‚ûï</span> icon next to it</div>
                        </div>
                    </div>
                    <div class="install-step">
                        <div class="install-step-number">3</div>
                        <div class="install-step-content">
                            <div class="install-step-title">Tap "Add" to confirm</div>
                            <div class="install-step-desc">Then open VERSUS from your home screen</div>
                        </div>
                    </div>
                `;
            } else if (platform === 'android') {
                instructionsHtml = `
                    <div class="install-step">
                        <div class="install-step-number">1</div>
                        <div class="install-step-content">
                            <div class="install-step-title">Tap the menu button</div>
                            <div class="install-step-desc">Look for <span style="font-size: 16px;">‚ãÆ</span> at the top right of Chrome</div>
                        </div>
                    </div>
                    <div class="install-step">
                        <div class="install-step-number">2</div>
                        <div class="install-step-content">
                            <div class="install-step-title">Tap "Add to Home screen"</div>
                            <div class="install-step-desc">Or "Install app" if you see it</div>
                        </div>
                    </div>
                    <div class="install-step">
                        <div class="install-step-number">3</div>
                        <div class="install-step-content">
                            <div class="install-step-title">Tap "Add" to confirm</div>
                            <div class="install-step-desc">Then open VERSUS from your home screen</div>
                        </div>
                    </div>
                `;
            } else {
                instructionsHtml = `
                    <div class="install-step">
                        <div class="install-step-number">1</div>
                        <div class="install-step-content">
                            <div class="install-step-title">Look for the install icon</div>
                            <div class="install-step-desc">In Chrome, it's in the address bar (right side)</div>
                        </div>
                    </div>
                    <div class="install-step">
                        <div class="install-step-number">2</div>
                        <div class="install-step-content">
                            <div class="install-step-title">Click "Install"</div>
                            <div class="install-step-desc">A popup will confirm the installation</div>
                        </div>
                    </div>
                `;
            }
            
            // Check if we have Android install prompt available
            const hasNativePrompt = deferredInstallPrompt !== null;
            
            const modalHtml = `
                <div class="install-modal-overlay" id="installModalOverlay" onclick="if(event.target === this) closeInstallModal()">
                    <div class="install-modal">
                        <div style="padding: 24px; text-align: center; background: linear-gradient(135deg, rgba(255, 149, 0, 0.15), rgba(255, 59, 48, 0.1));">
                            <div style="font-size: 48px; margin-bottom: 12px;">üîî</div>
                            <div style="font-size: 20px; font-weight: 900; color: #FFFFFF; margin-bottom: 8px;">Notifications are part of the game</div>
                            <div style="font-size: 13px; color: #A1A1A6; line-height: 1.5;">Install VERSUS to get challenge alerts, see when rivals respond, and never miss a duel.</div>
                        </div>
                        
                        ${hasNativePrompt ? `
                            <div style="padding: 20px;">
                                <button onclick="triggerNativeInstall()" style="
                                    width: 100%;
                                    padding: 16px;
                                    background: linear-gradient(135deg, #34C759, #30D158);
                                    border: none;
                                    border-radius: 12px;
                                    color: white;
                                    font-size: 16px;
                                    font-weight: 700;
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    gap: 8px;
                                ">
                                    <span style="font-size: 20px;">üì≤</span> Install VERSUS Now
                                </button>
                            </div>
                        ` : `
                            <div style="padding: 20px;">
                                <div style="font-size: 11px; color: #8E8E93; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; font-weight: 700;">
                                    ${platform === 'ios' ? 'üì± iOS SAFARI' : platform === 'android' ? 'üì± ANDROID CHROME' : 'üíª DESKTOP'} INSTRUCTIONS
                                </div>
                                ${instructionsHtml}
                            </div>
                        `}
                        
                        <div style="padding: 16px 20px 20px; display: flex; gap: 10px;">
                            <button onclick="closeInstallModal(true)" style="
                                flex: 1;
                                padding: 14px;
                                background: #2C2C2E;
                                border: 1px solid #3C3C3E;
                                border-radius: 12px;
                                color: #8E8E93;
                                font-size: 14px;
                                font-weight: 600;
                                cursor: pointer;
                            ">Skip for now</button>
                            <button onclick="checkIfInstalled()" style="
                                flex: 1.5;
                                padding: 14px;
                                background: linear-gradient(135deg, #FF9500, #FF3B30);
                                border: none;
                                border-radius: 12px;
                                color: white;
                                font-size: 14px;
                                font-weight: 700;
                                cursor: pointer;
                            ">I've installed it ‚úì</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove any existing modal
            const existing = document.getElementById('installModalOverlay');
            if (existing) existing.remove();
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // Close install modal
        function closeInstallModal(wasSkipped = false) {
            const modal = document.getElementById('installModalOverlay');
            if (modal) modal.remove();
            
            if (wasSkipped) {
                // Dismissed ‚Äî mark it but show banner
                installBannerDismissedAt = new Date().toISOString();
                localStorage.setItem('installBannerDismissedAt', installBannerDismissedAt);
                showToast('You can install later from the banner below', 'info');
            }
            
            updateInstallBanner();
        }
        
        // Check if user actually installed (after they claim they did)
        function checkIfInstalled() {
            if (isInstalledPWA()) {
                closeInstallModal();
                showToast('üéâ VERSUS installed! Notifications ready.', 'victory');
                // Prompt for notification permission
                setTimeout(() => {
                    promptNotificationPermission();
                }, 1000);
            } else {
                // Still in browser
                showToast('Still in browser ‚Äî try opening from your home screen icon', 'info');
            }
        }
        
        // Trigger native Android install prompt
        async function triggerNativeInstall() {
            if (!deferredInstallPrompt) {
                showToast('Install prompt not available', 'info');
                return;
            }
            
            try {
                deferredInstallPrompt.prompt();
                const choice = await deferredInstallPrompt.userChoice;
                
                if (choice.outcome === 'accepted') {
                    console.log('‚úÖ User accepted PWA install');
                    closeInstallModal();
                    showToast('üéâ Installing VERSUS...', 'victory');
                } else {
                    console.log('User dismissed PWA install');
                }
                
                deferredInstallPrompt = null;
            } catch (err) {
                console.error('Install prompt error:', err);
            }
        }
        
        // Prompt for notification permission (post-install)
        async function promptNotificationPermission() {
            if (!('Notification' in window)) return;
            
            if (Notification.permission === 'granted') {
                // Already have permission ‚Äî subscribe to push
                subscribeToPush();
                return;
            }
            
            if (Notification.permission === 'denied') {
                showToast('Notifications blocked. Enable in Settings ‚Üí VERSUS.', 'info');
                return;
            }
            
            // Ask for permission
            try {
                const result = await Notification.requestPermission();
                if (result === 'granted') {
                    showToast('üîî Notifications enabled!', 'victory');
                    subscribeToPush();
                } else {
                    showToast('Notifications off ‚Äî you might miss challenges', 'info');
                }
            } catch (err) {
                console.error('Notification permission error:', err);
            }
        }
        
        // Show install modal at key moments (high-intent triggers)
        function maybeShowInstallPrompt(trigger = 'default') {
            // Already installed? Skip
            if (isInstalledPWA()) return;
            
            // Already shown this session? Skip
            if (installModalShownThisSession) return;
            
            // Not on HTTPS? Skip
            if (window.location.protocol !== 'https:') return;
            
            console.log('üì≤ Showing install prompt (trigger: ' + trigger + ')');
            installModalShownThisSession = true;
            showInstallModal();
        }
        
        // Capture Android beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('‚úÖ beforeinstallprompt event captured');
            e.preventDefault();
            deferredInstallPrompt = e;
            // Update banner to show we have native install available
            updateInstallBanner();
        });
        
        // Listen for successful install
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ PWA was installed');
            deferredInstallPrompt = null;
            updateInstallBanner();
            showToast('üéâ VERSUS installed!', 'victory');
        });
        
        // ============================================
        // v21: PUSH NOTIFICATIONS
        // ============================================
        
        function urlBase64ToUint8Array(base64String) {
            var padding = '='.repeat((4 - base64String.length % 4) % 4);
            var base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            var rawData = window.atob(base64);
            var outputArray = new Uint8Array(rawData.length);
            for (var i = 0; i < rawData.length; i++) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }
        
        async function registerServiceWorker() {
            if (!pushSupported) {
                console.log('‚ö†Ô∏è Push not supported (needs HTTPS + service worker)');
                return null;
            }
            
            try {
                var registration = await navigator.serviceWorker.register('./versus-sw.js');
                console.log('‚úÖ Service Worker registered');
                return registration;
            } catch (err) {
                console.error('Service Worker registration failed:', err);
                return null;
            }
        }
        
        async function subscribeToPush() {
            if (!VAPID_PUBLIC_KEY) {
                console.log('‚ö†Ô∏è No VAPID public key set ‚Äî push disabled');
                return null;
            }
            
            var registration = await registerServiceWorker();
            if (!registration) return null;
            
            try {
                // Check existing subscription
                var existing = await registration.pushManager.getSubscription();
                if (existing) {
                    console.log('‚úÖ Existing push subscription found');
                    pushSubscription = existing;
                    await savePushSubscription(existing);
                    return existing;
                }
                
                // Request new subscription
                var subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                });
                
                console.log('‚úÖ New push subscription created');
                pushSubscription = subscription;
                await savePushSubscription(subscription);
                return subscription;
            } catch (err) {
                console.error('Push subscription failed:', err);
                return null;
            }
        }
        
        async function savePushSubscription(subscription) {
            if (!currentMemberId || !squadId) return;
            
            var subJson = subscription.toJSON();
            
            try {
                var result = await db
                    .from('push_subscriptions')
                    .upsert({
                        member_id: currentMemberId,
                        squad_id: squadId,
                        endpoint: subJson.endpoint,
                        p256dh: subJson.keys.p256dh,
                        auth: subJson.keys.auth,
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'member_id' });
                
                if (result.error) {
                    console.error('Failed to save push subscription:', result.error);
                } else {
                    console.log('‚úÖ Push subscription saved to Supabase');
                }
            } catch (err) {
                console.error('Error saving push subscription:', err);
            }
        }
        
        async function requestNotificationPermission() {
            if (!pushSupported) return 'unsupported';
            
            var permission = Notification.permission;
            
            if (permission === 'granted') {
                await subscribeToPush();
                return 'granted';
            }
            
            if (permission === 'denied') {
                return 'denied';
            }
            
            // Ask the user
            var result = await Notification.requestPermission();
            if (result === 'granted') {
                await subscribeToPush();
                return 'granted';
            }
            
            return result;
        }
        
        function renderNotificationPrompt() {
            // Only show if push is supported and permission not yet decided
            if (!pushSupported) return '';
            if (Notification.permission === 'granted' || Notification.permission === 'denied') return '';
            
            var html = '';
            html += '<div id="notifPrompt" style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 165, 0, 0.1)); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 16px;">';
            html += '<div style="display: flex; align-items: flex-start; gap: 12px;">';
            html += '<div style="font-size: 24px; flex-shrink: 0;">üîî</div>';
            html += '<div style="flex: 1;">';
            html += '<div style="font-size: 14px; font-weight: 700; color: #FFD700; margin-bottom: 4px;">Never miss a challenge</div>';
            html += '<div style="font-size: 12px; color: #A1A1A6; line-height: 1.4;">Get notified when someone challenges you or when a duel result drops.</div>';
            html += '</div>';
            html += '</div>';
            html += '<div style="display: flex; gap: 8px; margin-top: 12px;">';
            html += '<button onclick="handleEnableNotifications()" style="flex: 1; padding: 10px; background: #FFD700; border: none; border-radius: 8px; color: #000; font-size: 13px; font-weight: 700; cursor: pointer;">Turn On</button>';
            html += '<button onclick="dismissNotifPrompt()" style="padding: 10px 16px; background: none; border: 1px solid #3C3C3E; border-radius: 8px; color: #8E8E93; font-size: 13px; cursor: pointer;">Later</button>';
            html += '</div>';
            html += '</div>';
            return html;
        }
        
        async function handleEnableNotifications() {
            var btn = document.querySelector('#notifPrompt button');
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Enabling...';
            }
            
            var result = await requestNotificationPermission();
            
            if (result === 'granted') {
                showToast('üîî Notifications enabled!', 'info');
                var prompt = document.getElementById('notifPrompt');
                if (prompt) prompt.remove();
            } else if (result === 'denied') {
                showToast('Notifications blocked. Enable in browser settings.', 'info');
                var prompt = document.getElementById('notifPrompt');
                if (prompt) prompt.remove();
            }
        }
        
        function dismissNotifPrompt() {
            localStorage.setItem('notifPromptDismissed', 'true');
            var prompt = document.getElementById('notifPrompt');
            if (prompt) prompt.remove();
        }
        
        function shouldShowNotifPrompt() {
            if (!pushSupported) return false;
            if (Notification.permission !== 'default') return false;
            if (localStorage.getItem('notifPromptDismissed') === 'true') return false;
            return true;
        }
        
        // Deep link handler ‚Äî navigate to specific screen based on URL hash
        function handleDeepLink() {
            var hash = window.location.hash;
            if (!hash || !squadId || !currentMemberId) return;
            
            // Format: #challenge=<challengeId>
            if (hash.indexOf('#challenge=') === 0) {
                var challengeId = hash.replace('#challenge=', '');
                // Find this challenge
                var c = challenges.find(function(ch) { return ch.id === challengeId; });
                if (c) {
                    if (c.status === 'waiting' && c.opponent_id === currentMemberId) {
                        selectedChallenge = c;
                        screen = 'submit-media';
                    } else if (c.status === 'voting' || c.status === 'completed') {
                        selectedChallenge = c;
                        screen = 'challenge-reveal';
                    }
                }
                // Clear hash after handling
                history.replaceState(null, null, window.location.pathname);
            }
        }
        
        // ============================================
        // v21: "WHILE YOU WERE AWAY" RETURN SCREEN
        // ============================================
        
        function buildReturnReport() {
            var now = new Date();
            
            // If no lastSeenAt, set it to 1 hour ago so first return after any activity works
            if (!lastSeenAt) {
                lastSeenAt = new Date(now.getTime() - (60 * 60 * 1000)).toISOString();
                localStorage.setItem('lastSeenAt', lastSeenAt);
            }
            
            if (!challenges || challenges.length === 0) return null;
            
            var lastSeen = new Date(lastSeenAt);
            var minutesSinceLastSeen = (now - lastSeen) / (1000 * 60);
            
            // Show if gone for 2+ minutes
            if (minutesSinceLastSeen < 2) return null;
            
            var events = [];
            var currentMember = getCurrentMember();
            if (!currentMember) return null;
            
            // === SUBSTANTIVE EVENTS (things that actually happened) ===
            
            // Find challenges completed/forfeited since last seen
            var recentCompleted = challenges.filter(function(c) {
                return (c.status === 'completed' || c.status === 'forfeited') && 
                       c.completed_at && new Date(c.completed_at) > lastSeen;
            });
            
            recentCompleted.forEach(function(c) {
                var winner = members[c.winner_id];
                var loserId = c.winner_id === c.challenger_id ? c.opponent_id : c.challenger_id;
                var loser = members[loserId];
                
                if (!winner || !loser) return;
                
                if (c.status === 'forfeited') {
                    events.push({
                        icon: '‚ö†Ô∏è',
                        text: loser.name + ' forfeited to ' + winner.name + ' (+10 pts)',
                        color: '#FF9500'
                    });
                } else if (winner.id === currentMemberId) {
                    events.push({
                        icon: 'üèÜ',
                        text: 'You beat ' + loser.name + ' (+10 pts)',
                        color: '#34C759'
                    });
                } else if (loser.id === currentMemberId) {
                    events.push({
                        icon: 'üíÄ',
                        text: winner.name + ' beat you (-3 pts)',
                        color: '#FF3B30'
                    });
                } else if (winner.streak >= 3) {
                    events.push({
                        icon: 'üî•',
                        text: winner.name + ' is on a ' + winner.streak + '-win streak',
                        color: '#FF9500'
                    });
                } else {
                    events.push({
                        icon: '‚öîÔ∏è',
                        text: winner.name + ' beat ' + loser.name,
                        color: '#FFFFFF'
                    });
                }
            });
            
            // Pending challenges for you with deadlines (actionable ‚Äî always show)
            var pendingForYou = challenges.filter(function(c) {
                return c.status === 'waiting' && c.opponent_id === currentMemberId && c.deadline_at;
            });
            
            pendingForYou.forEach(function(c) {
                var challenger = members[c.challenger_id];
                var remaining = formatCountdown(c.deadline_at);
                events.push({
                    icon: '‚è≥',
                    text: remaining + ' to respond to ' + (challenger ? challenger.name : '?'),
                    color: isDeadlineUrgent(c.deadline_at) ? '#FF3B30' : '#FFD700',
                    urgent: isDeadlineUrgent(c.deadline_at)
                });
            });
            
            // === CONTEXT EVENT (only add if we already have substantive events) ===
            // Only show rank proximity if there's already something real to report
            if (events.length > 0) {
                var rankings = Object.values(members).sort(function(a, b) { return b.points - a.points; });
                var yourRank = rankings.findIndex(function(m) { return m.id === currentMemberId; }) + 1;
                
                if (rankings.length > 1 && yourRank > 1) {
                    var above = rankings[yourRank - 2];
                    if (above && above.id !== currentMemberId) {
                        var gap = above.points - currentMember.points;
                        // Only show if gap is meaningful (1-15) ‚Äî 0 means tied, not interesting
                        if (gap >= 1 && gap <= 15) {
                            events.push({
                                icon: '‚¨ÜÔ∏è',
                                text: 'One win takes you past ' + above.name + ' (' + gap + ' pts ahead)',
                                color: '#34C759'
                            });
                        }
                    }
                }
            }
            
            if (events.length === 0) return null;
            return events;
        }
        
        function renderReturnScreen(events) {
            var html = '<div class="fade-in" style="padding: 20px;">';
            html += '<div style="text-align: center; margin-bottom: 24px;">';
            html += '<div style="font-size: 12px; color: #8E8E93; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px;">WHILE YOU WERE AWAY</div>';
            html += '<div style="width: 40px; height: 2px; background: linear-gradient(90deg, #FFD700, #FF9500); margin: 0 auto;"></div>';
            html += '</div>';
            
            html += '<div style="background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 14px; padding: 16px; margin-bottom: 24px;">';
            
            events.forEach(function(event, i) {
                var borderTop = i > 0 ? 'border-top: 1px solid #2C2C2E; padding-top: 10px; margin-top: 10px;' : '';
                html += '<div style="display: flex; align-items: center; gap: 10px; ' + borderTop + '">';
                html += '<span style="font-size: 16px; flex-shrink: 0;">' + event.icon + '</span>';
                html += '<span style="font-size: 14px; font-weight: 600; color: ' + event.color + '; flex: 1;">' + event.text + '</span>';
                html += '</div>';
            });
            
            html += '</div>';
            
            html += '<button class="btn btn-primary" style="width: 100%;" onclick="dismissReturnScreen()">Enter the Arena</button>';
            html += '</div>';
            return html;
        }
        
        function dismissReturnScreen() {
            hasSeenReturnScreen = true;
            lastSeenAt = new Date().toISOString();
            localStorage.setItem('lastSeenAt', lastSeenAt);
            screen = 'arena';
            render();
        }
        
        // Keep old function name for backward compatibility
        function renderHome() {
            return renderArena();
        }
        
        
        function renderSelectOpponent() {
            const opponents = Object.values(members).filter(m => m.id !== currentMemberId && !m.suspended);
            
            return `
                <div class="fade-in">
                    <button class="back-btn" onclick="screen='arena'; render();">‚Üê Back</button>
                    
                    <div class="section-title">‚öîÔ∏è Select Opponent</div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 24px;">
                        ${opponents.map(m => `
                            <div onclick="selectOpponent('${m.id}')" style="background: ${selectedOpponent === m.id ? 'rgba(212, 175, 55, 0.1)' : '#1C1C1E'}; border: 2px solid ${selectedOpponent === m.id ? '#D4AF37' : '#2C2C2E'}; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer;">
                                <div style="font-size: 48px; margin-bottom: 12px;">${m.avatar}</div>
                                <div style="font-size: 15px; font-weight: 600;">${m.name}</div>
                                <div style="font-size: 12px; color: #8E8E93;">${m.points} pts</div>
                            </div>
                        `).join('')}
                    </div>

                    <button class="btn btn-primary ${!selectedOpponent ? 'hidden' : ''}" onclick="getRandomChallenge()">
                        Start Challenge
                    </button>
                </div>
            `;
        }
        
        function selectOpponent(id) {
            // Check if opponent is suspended
            var opponent = members[id];
            if (opponent && opponent.suspended) {
                showToast(opponent.name + ' is currently suspended', 'info');
                return;
            }
            selectedOpponent = id;
            sounds.click();
            render();
        }
        
        function getRandomChallenge() {
            sounds.click();
            selectedChallenge = challengeLibrary[Math.floor(Math.random() * challengeLibrary.length)];
            screen = 'challenge-reveal';
            render();
        }
        
        function renderChallengeReveal() {
            if (!selectedChallenge) return '';
            
            const isVideo = selectedChallenge.type === 'video';
            const opponent = members[selectedOpponent];
            
            return `
                <div class="fade-in" style="min-height: 80vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; text-align: center;">
                    <div style="font-size: 64px; margin-bottom: 24px;">üé≤</div>
                    
                    <h2 style="font-size: 24px; font-weight: 900; margin-bottom: 8px; color: #FFD700;">YOUR CHALLENGE</h2>
                    <p style="font-size: 14px; color: #8E8E93; margin-bottom: 32px;">Challenging ${opponent?.name || 'opponent'}</p>
                    
                    <div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 165, 0, 0.05)); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 20px; padding: 32px 24px; margin-bottom: 32px; max-width: 400px;">
                        <div style="font-size: 22px; font-weight: 900; line-height: 1.4; color: #FFFFFF; margin-bottom: 16px;">
                            ${selectedChallenge.name}
                        </div>
                        
                        <div style="display: flex; gap: 12px; justify-content: center; align-items: center;">
                            <div style="background: ${isVideo ? 'rgba(10, 132, 255, 0.2)' : 'rgba(52, 199, 89, 0.2)'}; color: ${isVideo ? '#0A84FF' : '#34C759'}; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 700;">
                                ${isVideo ? 'üìπ VIDEO' : 'üì∏ PHOTO'}
                            </div>
                            ${selectedChallenge.time ? `
                                <div style="background: rgba(255, 255, 255, 0.1); color: #A1A1A6; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 700;">
                                    ‚è±Ô∏è ${selectedChallenge.time}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 12px; width: 100%; max-width: 320px;">
                        <button class="btn btn-primary" onclick="screen='submit-media'; render();">
                            Accept Challenge
                        </button>
                        <button class="btn btn-secondary" onclick="getRandomChallenge();">
                            Skip & Get New
                        </button>
                        <button style="background: none; border: none; color: #8E8E93; font-size: 13px; cursor: pointer; margin-top: 8px;" onclick="screen='select-opponent'; selectedChallenge=null; render();">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
        }
        
        function renderSubmitMedia() {
            if (!selectedChallenge) return '';
            
            const isVideo = selectedChallenge.type === 'video';
            const opponent = members[selectedOpponent];
            
            return `
                <button class="back-btn" onclick="screen='challenge-reveal'; selectedMedia=null; window._pendingFile=null; render();">‚Üê Back</button>
                
                <div class="fade-in">
                    <div style="background: #1C1C1E; border: 2px solid #D4AF37; border-radius: 16px; padding: 24px; text-align: center; margin-bottom: 24px;">
                        <div style="display: inline-block; background: rgba(212, 175, 55, 0.15); color: #D4AF37; padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 700; margin-bottom: 12px;">
                            ‚öîÔ∏è CHALLENGE vs ${opponent?.name || 'Opponent'}
                        </div>
                        <div style="font-size: 24px; font-weight: 900; margin-bottom: 8px;">${selectedChallenge.name}</div>
                        <div style="font-size: 14px; color: #8E8E93;">${selectedChallenge.desc}</div>
                    </div>

                    ${!selectedMedia ? `
                        <div class="upload-zone" onclick="document.getElementById('mediaInput').click();">
                            <div style="font-size: 48px; margin-bottom: 16px;">${isVideo ? 'üìπ' : 'üì∏'}</div>
                            <div style="font-size: 15px; font-weight: 600; margin-bottom: 4px;">
                                ${isVideo ? 'Record Video' : 'Take Photo'}
                            </div>
                            <div style="font-size: 13px; color: #8E8E93;">
                                Tap to capture
                            </div>
                        </div>

                        <input type="file" 
                               id="mediaInput" 
                               accept="${isVideo ? 'video/mp4,video/quicktime,video/*' : 'image/*'}" 
                               ${isVideo ? '' : 'capture="environment"'}
                               onchange="handleMediaUpload(event, '${isVideo ? 'video' : 'photo'}')" 
                               style="display: none;">
                    ` : `
                        <div style="margin-bottom: 24px;">
                            ${mediaType === 'video' ? 
                                `<video src="${selectedMedia}" class="preview-media" controls></video>` :
                                `<img src="${selectedMedia}" class="preview-media">`
                            }
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <button class="btn btn-secondary" onclick="selectedMedia=null; window._pendingFile=null; render();">
                                Retake
                            </button>
                            <button class="btn btn-primary" id="submitBtn" onclick="handleSubmitChallenge()">
                                Submit
                            </button>
                        </div>
                    `}
                </div>
            `;
        }
        
        function renderSubmitWeekly() {
            if (!selectedChallenge) return '';
            
            var isVideo = selectedChallenge.type === 'video';
            
            var html = '<button class="back-btn" onclick="screen=\'ladder\'; selectedMedia=null; window._pendingFile=null; window.isWeeklySubmission=false; render();">‚Üê Back</button>';
            html += '<div class="fade-in">';
            html += '<div style="background: linear-gradient(135deg, rgba(175, 82, 222, 0.15), rgba(255, 45, 85, 0.05)); border: 2px solid rgba(175, 82, 222, 0.4); border-radius: 16px; padding: 24px; text-align: center; margin-bottom: 24px;">';
            html += '<div style="display: inline-block; background: rgba(175, 82, 222, 0.2); color: #AF52DE; padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 700; margin-bottom: 12px;">üéØ WEEKLY SQUAD CHALLENGE</div>';
            html += '<div style="font-size: 24px; font-weight: 900; margin-bottom: 8px;">' + selectedChallenge.name + '</div>';
            html += '<div style="font-size: 14px; color: #8E8E93;">' + selectedChallenge.desc + '</div>';
            html += '</div>';
            
            if (!selectedMedia) {
                html += '<div class="upload-zone" onclick="document.getElementById(\'weeklyMediaInput\').click();">';
                html += '<div style="font-size: 48px; margin-bottom: 16px;">' + (isVideo ? 'üìπ' : 'üì∏') + '</div>';
                html += '<div style="font-size: 15px; font-weight: 600; margin-bottom: 4px;">' + (isVideo ? 'Record Video' : 'Take Photo') + '</div>';
                html += '<div style="font-size: 13px; color: #8E8E93;">Tap to capture your entry</div>';
                html += '</div>';
                html += '<input type="file" id="weeklyMediaInput" accept="' + (isVideo ? 'video/mp4,video/quicktime,video/*' : 'image/*') + '" ' + (isVideo ? '' : 'capture="environment"') + ' onchange="handleMediaUpload(event, \'' + (isVideo ? 'video' : 'photo') + '\')" style="display: none;">';
            } else {
                html += '<div style="margin-bottom: 24px;">';
                if (mediaType === 'video') {
                    html += '<video src="' + selectedMedia + '" class="preview-media" controls></video>';
                } else {
                    html += '<img src="' + selectedMedia + '" class="preview-media">';
                }
                html += '</div>';
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">';
                html += '<button class="btn btn-secondary" onclick="selectedMedia=null; window._pendingFile=null; render();">Retake</button>';
                html += '<button class="btn btn-primary" id="submitBtn" onclick="handleSubmitWeekly()">Submit Entry</button>';
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }
        
        async function handleSubmitWeekly() {
            if (isSubmitting) return;
            isSubmitting = true;
            
            var btn = document.getElementById('submitBtn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading-spinner"></span> Uploading...';
            }
            
            try {
                var fileToUpload = window._pendingFile || selectedMedia;
                var challengeId = 'weekly_' + Date.now();
                
                var mediaUrl = await uploadMedia(fileToUpload, challengeId, 'entry');
                
                // Store the weekly submission (uses challenges table with weekly flag)
                var result = await db
                    .from('challenges')
                    .insert({
                        squad_id: squadId,
                        challenge_type: selectedChallenge.name,
                        challenge_desc: selectedChallenge.desc,
                        challenge_time: selectedChallenge.time,
                        challenger_id: currentMemberId,
                        opponent_id: null,
                        challenger_media_url: mediaUrl,
                        challenger_media_type: mediaType,
                        status: 'weekly_entry',
                        is_weekly: true
                    })
                    .select()
                    .single();
                
                if (result.error) throw result.error;
                
                sounds.challenge();
                
                if (selectedMedia && selectedMedia.startsWith('blob:')) {
                    URL.revokeObjectURL(selectedMedia);
                }
                
                showModal(
                    'üéØ Entry Submitted!',
                    '<div style="text-align: center;">' +
                        '<div style="font-size: 64px; margin-bottom: 16px;">‚úÖ</div>' +
                        '<p style="margin-bottom: 16px;">Your weekly challenge entry has been submitted!</p>' +
                        '<p style="font-size: 13px; color: #8E8E93;">When all members submit, entries will be paired for head-to-head voting. Participants vote, AI breaks ties.</p>' +
                    '</div>',
                    null,
                    'Done',
                    function() {
                        closeModal();
                        screen = 'ladder';
                        selectedMedia = null;
                        selectedChallenge = null;
                        window._pendingFile = null;
                        window.isWeeklySubmission = false;
                        isSubmitting = false;
                        render();
                    }
                );
            } catch (err) {
                console.error('Weekly submit error:', err);
                alert('Failed to submit: ' + (err.message || 'Upload failed'));
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'Submit Entry';
                }
                isSubmitting = false;
            }
        }
        
        function handleMediaUpload(event, type) {
            var file = event.target.files[0];
            if (!file) return;
            
            // Check file size (limit to 50MB for videos, 10MB for images)
            var maxSize = type === 'video' ? 50 * 1024 * 1024 : 10 * 1024 * 1024;
            if (file.size > maxSize) {
                alert('File too large! Maximum size is ' + (type === 'video' ? '50MB' : '10MB'));
                return;
            }
            
            console.log('Media selected:', { type: type, size: (file.size / 1024 / 1024).toFixed(2) + 'MB', name: file.name });
            
            // Store the raw file for upload (avoids iOS base64 issues)
            window._pendingFile = file;
            
            // For preview, use object URL (much faster than base64, avoids iOS memory issues)
            var objectUrl = URL.createObjectURL(file);
            selectedMedia = objectUrl;
            mediaType = type;
            console.log('Media loaded into preview via objectURL');
            render();
        }
        
        async function handleSubmitChallenge() {
            if (isSubmitting) return;
            isSubmitting = true;
            
            // Safety net: auto-reset after 30 seconds to prevent permanent freeze
            var submitTimeout = setTimeout(function() {
                if (isSubmitting) {
                    console.warn('Submission timeout ‚Äî resetting');
                    isSubmitting = false;
                    var btn = document.getElementById('submitBtn');
                    if (btn) { btn.disabled = false; btn.textContent = 'Submit'; }
                    showToast('Submission timed out. Try again.', 'info');
                }
            }, 30000);
            
            console.log('Starting submission...', { mediaType: mediaType, hasMedia: !!selectedMedia, hasRawFile: !!window._pendingFile });
            
            var btn = document.getElementById('submitBtn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading-spinner"></span> Uploading...';
            }
            
            try {
                // Use the raw file if available, otherwise fall back to selectedMedia
                var fileToUpload = window._pendingFile || selectedMedia;
                
                // Check if this is a response to existing challenge
                if (window.currentChallengeId) {
                    console.log('Submitting response to challenge:', window.currentChallengeId);
                    
                    // Upload media
                    var mediaUrl = await uploadMedia(fileToUpload, window.currentChallengeId, 'opponent');
                    console.log('Media uploaded for response');
                    
                    // Update challenge with response
                    await respondToChallenge(window.currentChallengeId, mediaUrl, mediaType);
                    console.log('Challenge response recorded');
                    
                    // Show success and go to showdown
                    sounds.challenge();
                    
                    // Reload to get updated challenge
                    await loadSquadData();
                    
                    // Clean up object URLs
                    if (selectedMedia && selectedMedia.startsWith('blob:')) {
                        URL.revokeObjectURL(selectedMedia);
                    }
                    
                    showShowdown(window.currentChallengeId);
                    window.currentChallengeId = null;
                    isSubmitting = false;
                    clearTimeout(submitTimeout);
                } else {
                    // New challenge
                    var challengeId = 'ch_' + Date.now();
                    
                    // Upload media
                    var mediaUrl = await uploadMedia(fileToUpload, challengeId, 'challenger');
                    
                    // Create challenge
                    await createChallenge(
                        selectedOpponent,
                        selectedChallenge.name,
                        selectedChallenge.desc,
                        selectedChallenge.time,
                        mediaUrl,
                        mediaType
                    );
                    
                    sounds.challenge();
                    
                    // Clean up object URLs
                    if (selectedMedia && selectedMedia.startsWith('blob:')) {
                        URL.revokeObjectURL(selectedMedia);
                    }
                    
                    var opponentName = members[selectedOpponent] ? members[selectedOpponent].name : 'opponent';
                    
                    // Show confirmation
                    showModal(
                        '‚öîÔ∏è Challenge Sent!',
                        '<div style="text-align: center;">' +
                            '<div style="font-size: 64px; margin-bottom: 16px;">üì§</div>' +
                            '<p style="margin-bottom: 16px;">Your challenge has been sent to <strong>' + opponentName + '</strong>!</p>' +
                            '<p style="font-size: 13px; color: #8E8E93;">They\'ll need to submit their response. You\'ll be notified when the showdown is ready.</p>' +
                        '</div>',
                        null,
                        'Done',
                        function() {
                            closeModal();
                            screen = 'arena';
                            selectedMedia = null;
                            selectedChallenge = null;
                            selectedOpponent = null;
                            window._pendingFile = null;
                            isSubmitting = false;
                            clearTimeout(submitTimeout);
                            render();
                        }
                    );
                }
            } catch (err) {
                console.error('Submit error:', err);
                alert('Failed to submit: ' + (err.message || 'Upload failed. Please try a smaller file or check your connection.'));
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'Submit';
                }
                isSubmitting = false;
                clearTimeout(submitTimeout);
            }
        }
        
        function startResponse(challengeId) {
            const challenge = challenges.find(c => c.id === challengeId);
            if (!challenge) return;
            
            window.currentChallengeId = challengeId;
            selectedChallenge = {
                name: challenge.challenge_type,
                desc: challenge.challenge_desc,
                time: challenge.challenge_time,
                type: challenge.challenger_media_type
            };
            selectedOpponent = challenge.challenger_id;
            
            screen = 'submit-media';
            render();
        }
        
        async function initiateJudging(challengeId) {
            // Reload to get latest status
            await loadSquadData();
            
            var challenge = challenges.find(function(c) { return c.id === challengeId; });
            if (!challenge) return;
            
            // Check if already completed
            if (challenge.status === 'completed') {
                showCompletedChallenge(challengeId);
                return;
            }
            
            // ALL challenges: Both participants vote, ties go to AI
            try {
                await db
                    .from('challenges')
                    .update({
                        status: 'voting',
                        voting_ends_at: new Date(Date.now() + 60 * 60 * 1000).toISOString()
                    })
                    .eq('id', challengeId);
                
                await loadSquadData();
                
                // Show voting screen for this user
                showTwoPersonVoting(challengeId);
            } catch (err) {
                console.error('Failed to open voting:', err);
                alert('Failed to start showdown');
            }
        }
        
        async function showTwoPersonVoting(challengeId) {
            await loadSquadData();
            
            const challenge = challenges.find(c => c.id === challengeId);
            if (!challenge) {
                screen = 'arena';
                render();
                return;
            }
            
            // Check if already completed (other person voted and triggered completion)
            if (challenge.status === 'completed') {
                showCompletedChallenge(challengeId);
                return;
            }
            
            // Check if already voted (handle case where no vote exists)
            let existingVote = null;
            try {
                const { data, error } = await db
                    .from('votes')
                    .select('*')
                    .eq('challenge_id', challengeId)
                    .eq('voter_id', currentMemberId)
                    .maybeSingle(); // Use maybeSingle instead of single to avoid 406 error
                
                if (!error) existingVote = data;
            } catch (err) {
                // Ignore error - means no vote exists
                console.log('No existing vote found');
            }
            
            if (existingVote) {
                // Already voted - check if other person voted too
                const totalVotes = (challenge.votes_for_challenger || 0) + (challenge.votes_for_opponent || 0);
                if (totalVotes >= 2) {
                    // Both voted - determine winner
                    await determineTwoPersonWinner(challengeId);
                } else {
                    showModal(
                        '‚è≥ Waiting for Opponent',
                        `<div style="text-align: center;">
                            <p>You've cast your vote!</p>
                            <p style="font-size: 13px; color: #8E8E93; margin-top: 12px;">Waiting for your opponent to vote...</p>
                        </div>`,
                        null,
                        'OK',
                        () => { closeModal(); screen = 'arena'; render(); }
                    );
                }
                return;
            }
            
            const challenger = members[challenge.challenger_id];
            const opponent = members[challenge.opponent_id];
            
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            overlay.id = 'votingOverlay';
            
            overlay.innerHTML = `
                <div class="reveal-container" style="max-width: 600px;">
                    <div style="font-size: 13px; color: #FFD700; font-weight: 700; letter-spacing: 1px; margin-bottom: 8px;">‚öîÔ∏è SHOWDOWN</div>
                    <div style="font-size: 20px; font-weight: 700; margin-bottom: 8px;">${challenge.challenge_type}</div>
                    <div style="font-size: 13px; color: #8E8E93; margin-bottom: 24px;">Both players vote ‚Ä¢ Ties go to AI judge</div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 32px;">
                        <div style="text-align: center;">
                            ${challenge.challenger_media_type === 'video' ?
                                `<video src="${challenge.challenger_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid #3C3C3E;" controls playsinline></video>` :
                                `<img src="${challenge.challenger_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid #3C3C3E;">`
                            }
                            <div style="margin-top: 12px;">
                                <div style="font-size: 32px;">${challenger?.avatar || 'üë§'}</div>
                                <div style="font-size: 15px; font-weight: 600;">${challenger?.name || 'Challenger'}</div>
                            </div>
                            <button class="btn btn-secondary" style="margin-top: 12px;" onclick="castTwoPersonVote('${challengeId}', '${challenge.challenger_id}')">
                                Vote ${challenger?.name || 'Challenger'}
                            </button>
                        </div>
                        
                        <div style="text-align: center;">
                            ${challenge.opponent_media_type === 'video' ?
                                `<video src="${challenge.opponent_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid #3C3C3E;" controls playsinline></video>` :
                                `<img src="${challenge.opponent_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid #3C3C3E;">`
                            }
                            <div style="margin-top: 12px;">
                                <div style="font-size: 32px;">${opponent?.avatar || 'üë§'}</div>
                                <div style="font-size: 15px; font-weight: 600;">${opponent?.name || 'Opponent'}</div>
                            </div>
                            <button class="btn btn-secondary" style="margin-top: 12px;" onclick="castTwoPersonVote('${challengeId}', '${challenge.opponent_id}')">
                                Vote ${opponent?.name || 'Opponent'}
                            </button>
                        </div>
                    </div>
                    
                    <button style="background: none; border: none; color: #8E8E93; font-size: 13px; cursor: pointer;" onclick="closeVotingOverlay()">
                        Cancel
                    </button>
                </div>
            `;
            
            document.body.appendChild(overlay);
        }
        
        async function castTwoPersonVote(challengeId, voteForId) {
            const overlay = document.getElementById('votingOverlay');
            
            overlay.innerHTML = `
                <div class="reveal-container">
                    <div style="font-size: 64px; margin-bottom: 24px; animation: pulse 1s ease-in-out infinite;">üó≥Ô∏è</div>
                    <div style="font-size: 24px; font-weight: 700; color: #8E8E93;">
                        Recording vote...
                    </div>
                </div>
            `;
            
            try {
                const challenge = challenges.find(c => c.id === challengeId);
                
                // Record vote
                await db
                    .from('votes')
                    .insert({
                        challenge_id: challengeId,
                        voter_id: currentMemberId,
                        vote_for: voteForId
                    });
                
                // Update vote counts
                const isVoteForChallenger = voteForId === challenge.challenger_id;
                await db
                    .from('challenges')
                    .update({
                        votes_for_challenger: (challenge.votes_for_challenger || 0) + (isVoteForChallenger ? 1 : 0),
                        votes_for_opponent: (challenge.votes_for_opponent || 0) + (isVoteForChallenger ? 0 : 1)
                    })
                    .eq('id', challengeId);
                
                // Reload to check if both have voted
                await loadSquadData();
                const updatedChallenge = challenges.find(c => c.id === challengeId);
                const totalVotes = (updatedChallenge.votes_for_challenger || 0) + (updatedChallenge.votes_for_opponent || 0);
                
                if (totalVotes >= 2) {
                    // Both voted - determine winner
                    await determineTwoPersonWinner(challengeId);
                } else {
                    // Waiting for other person
                    overlay.innerHTML = `
                        <div class="reveal-container">
                            <div style="font-size: 64px; margin-bottom: 24px;">‚úÖ</div>
                            <div style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">Vote Cast!</div>
                            <div style="font-size: 14px; color: #8E8E93; margin-bottom: 24px;">Waiting for your opponent to vote...</div>
                            <button class="btn btn-primary" onclick="closeVotingOverlay()">OK</button>
                        </div>
                    `;
                }
                
                sounds.click();
            } catch (err) {
                console.error('Vote error:', err);
                alert('Failed to cast vote: ' + (err.message || 'Unknown error'));
                closeVotingOverlay();
            }
        }
        
        async function determineTwoPersonWinner(challengeId) {
            // Reload to get latest
            await loadSquadData();
            
            const challenge = challenges.find(c => c.id === challengeId);
            if (!challenge) return;
            
            // Check if already completed (prevent double completion)
            if (challenge.status === 'completed') {
                showCompletedChallenge(challengeId);
                return;
            }
            
            const votesChallenger = challenge.votes_for_challenger || 0;
            const votesOpponent = challenge.votes_for_opponent || 0;
            const challenger = members[challenge.challenger_id];
            const opponent = members[challenge.opponent_id];
            
            // Get current champion BEFORE the result
            const rankingsBefore = Object.values(members).sort((a, b) => b.points - a.points);
            const championBefore = rankingsBefore[0];
            
            const overlay = document.getElementById('votingOverlay') || document.createElement('div');
            if (!overlay.id) {
                overlay.className = 'overlay';
                overlay.id = 'votingOverlay';
                document.body.appendChild(overlay);
            }
            
            // ========== DRAMATIC VOTE REVEAL ==========
            overlay.innerHTML = `
                <div class="reveal-container">
                    <div style="font-size: 48px; margin-bottom: 16px;">üó≥Ô∏è</div>
                    <div style="font-size: 28px; font-weight: 900; color: #FFD700;">THE VOTES ARE IN</div>
                    <div style="font-size: 14px; color: #8E8E93; margin-top: 8px;">Revealing in...</div>
                    <div id="countdown" style="font-size: 72px; font-weight: 900; margin-top: 16px;">3</div>
                </div>
            `;
            
            // Countdown
            await sleep(1000);
            document.getElementById('countdown').textContent = '2';
            await sleep(1000);
            document.getElementById('countdown').textContent = '1';
            await sleep(1000);
            
            // Show vote breakdown dramatically
            overlay.innerHTML = `
                <div class="reveal-container" style="max-width: 400px;">
                    <div style="font-size: 20px; font-weight: 700; margin-bottom: 24px; color: #8E8E93;">VOTE BREAKDOWN</div>
                    
                    <div style="display: flex; justify-content: space-around; align-items: center; margin-bottom: 32px;">
                        <div style="text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 8px;">${challenger?.avatar || 'üë§'}</div>
                            <div style="font-size: 15px; font-weight: 600;">${challenger?.name}</div>
                            <div id="voteCount1" style="font-size: 48px; font-weight: 900; color: #FFD700; margin-top: 8px;">?</div>
                        </div>
                        
                        <div style="font-size: 24px; color: #8E8E93;">vs</div>
                        
                        <div style="text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 8px;">${opponent?.avatar || 'üë§'}</div>
                            <div style="font-size: 15px; font-weight: 600;">${opponent?.name}</div>
                            <div id="voteCount2" style="font-size: 48px; font-weight: 900; color: #FFD700; margin-top: 8px;">?</div>
                        </div>
                    </div>
                    
                    <div style="font-size: 14px; color: #8E8E93;">Revealing votes...</div>
                </div>
            `;
            
            await sleep(800);
            document.getElementById('voteCount1').textContent = votesChallenger;
            sounds.click();
            await sleep(800);
            document.getElementById('voteCount2').textContent = votesOpponent;
            sounds.click();
            await sleep(500);
            
            // Determine winner
            let winnerId, isTie = false;
            if (votesChallenger === votesOpponent) {
                isTie = true;
                // Show tie moment
                overlay.querySelector('.reveal-container').innerHTML += `
                    <div style="font-size: 24px; font-weight: 900; color: #FF9500; margin-top: 24px; animation: pulse 0.5s ease-in-out infinite;">‚öñÔ∏è IT'S A TIE!</div>
                    <div style="font-size: 14px; color: #8E8E93; margin-top: 8px;">AI Judge will decide...</div>
                `;
                await sleep(2000);
                
                // Deterministic tiebreaker
                const hash = challengeId.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
                winnerId = hash % 2 === 0 ? challenge.challenger_id : challenge.opponent_id;
            } else {
                winnerId = votesChallenger > votesOpponent ? challenge.challenger_id : challenge.opponent_id;
            }
            
            const loserId = winnerId === challenge.challenger_id ? challenge.opponent_id : challenge.challenger_id;
            
            // Complete the challenge
            await completeChallenge(challengeId, winnerId, votesChallenger, votesOpponent);
            
            // Reload to get updated points
            await loadSquadData();
            const winner = members[winnerId];
            const loser = members[loserId];
            const youWon = winnerId === currentMemberId;
            const youLost = loserId === currentMemberId;
            
            // Check for DETHRONEMENT
            const rankingsAfter = Object.values(members).sort((a, b) => b.points - a.points);
            const championAfter = rankingsAfter[0];
            const dethroned = championBefore.id !== championAfter.id;
            const loserHadStreak = (loser?.streak || 0) > 0 || challenge.opponent_score > 0; // Check if streak was broken
            
            // ========== WINNER REVEAL ==========
            await showEpicWinnerReveal(overlay, winner, loser, youWon, youLost, isTie, dethroned, championBefore, championAfter, challenge);
        }
        
        async function showEpicWinnerReveal(overlay, winner, loser, youWon, youLost, isTie, dethroned, oldChampion, newChampion, challenge) {
            // Build the reveal screen
            let revealHTML = `
                <div class="reveal-container" style="max-width: 500px;">
            `;
            
            // DETHRONEMENT CHECK
            if (dethroned && newChampion.id === winner.id) {
                // Epic dethronement moment!
                overlay.innerHTML = `
                    <div class="reveal-container">
                        <div style="font-size: 100px; animation: shake 0.5s ease-in-out;">üëë</div>
                        <div style="font-size: 32px; font-weight: 900; color: #FF3B30; margin-top: 16px;">DETHRONED!</div>
                        <div style="font-size: 18px; color: #8E8E93; margin-top: 8px;">${oldChampion.name} has fallen...</div>
                    </div>
                `;
                sounds.defeat();
                await sleep(2000);
                
                // Crown transfer animation
                overlay.innerHTML = `
                    <div class="reveal-container">
                        <div style="position: relative; height: 150px;">
                            <div style="font-size: 80px; position: absolute; left: 50%; transform: translateX(-50%); animation: crownFly 1.5s ease-in-out forwards;">üëë</div>
                        </div>
                        <div style="font-size: 64px; margin-top: 16px;">${newChampion.avatar}</div>
                        <div style="font-size: 28px; font-weight: 900; color: #FFD700; margin-top: 16px;">
                            ${newChampion.name.toUpperCase()}
                        </div>
                        <div style="font-size: 18px; color: #34C759; margin-top: 8px;">IS THE NEW CHAMPION!</div>
                    </div>
                `;
                sounds.victory();
                createConfetti();
                await sleep(2500);
            }
            
            // Main winner reveal - taunts with edge for friend groups
            const winnerTaunts = [
                "Too easy üòé",
                "Is that all you got?",
                "Crown stays with me üëë",
                "Sit down ü™ë",
                "That was embarrassing for you",
                "You really tried üòÇ",
                "Not even close",
                "Stay in your lane",
                "Know your place",
                "Rent free in your head üß†"
            ];
            const loserTaunts = [
                "Rematch. Now.",
                "Lucky shot üçÄ",
                "I let you win",
                "Enjoy it while it lasts",
                "You needed that W more",
                "Asterisk on that win *",
                "Screenshot that, it won't happen again",
                "Main character moment for you",
                "Whatever helps you sleep",
                "Your peak üìàüìâ"
            ];
            
            const tauntsToShow = youWon ? winnerTaunts : (youLost ? loserTaunts : []);
            const tauntSection = tauntsToShow.length > 0 ? `
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 11px; color: #8E8E93; margin-bottom: 8px;">SEND A TAUNT</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
                        ${tauntsToShow.map(t => `
                            <button onclick="sendTaunt('${challenge.id}', '${t.replace(/'/g, "\\'")}', ${youWon}, this)" style="padding: 8px 14px; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 20px; color: #FFD700; font-size: 13px; cursor: pointer; transition: all 0.2s;">
                                ${t}
                            </button>
                        `).join('')}
                    </div>
                </div>
            ` : '';
            
            revealHTML = `
                <div class="reveal-container" style="max-width: 500px;">
                    <div style="font-size: 80px; margin-bottom: 8px;">${winner.avatar}${dethroned && newChampion.id === winner.id ? ' üëë' : ''}</div>
                    <div style="font-size: 36px; font-weight: 900; color: #FFD700; margin-bottom: 8px;">
                        ${winner.name.toUpperCase()} WINS!
                    </div>
                    ${isTie ? `<div style="font-size: 14px; color: #8E8E93; margin-bottom: 16px;">AI Judge decided the tie</div>` : ''}
                    
                    <div style="display: flex; justify-content: center; gap: 24px; margin-bottom: 24px;">
                        <div style="text-align: center;">
                            <div style="font-size: 22px; font-weight: 900; color: #34C759;">+${WIN_POINTS}</div>
                            <div style="font-size: 11px; color: #8E8E93;">${winner.name}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 22px; font-weight: 900; color: #FF3B30;">-${LOSS_POINTS}</div>
                            <div style="font-size: 11px; color: #8E8E93;">${loser.name}</div>
                        </div>
                    </div>
                    
                    ${dethroned ? `
                        <div style="background: rgba(255, 59, 48, 0.2); border: 1px solid #FF3B30; border-radius: 8px; padding: 12px; margin-bottom: 24px;">
                            <div style="font-size: 14px; color: #FF3B30; font-weight: 700;">üëë NEW CHAMPION!</div>
                            <div style="font-size: 12px; color: #8E8E93; margin-top: 4px;">${oldChampion.name} has been dethroned</div>
                        </div>
                    ` : ''}
                    
                    ${tauntSection}
                    
                    <!-- ACTION BUTTONS - No Dead Screens! -->
                    <div style="display: flex; flex-direction: column; gap: 12px; width: 100%;">
                        ${youWon ? `
                            <button class="btn btn-primary" onclick="quickRematch('${loser.id}')">
                                ‚öîÔ∏è Challenge ${loser.name} Again
                            </button>
                            <button class="btn btn-secondary" onclick="challengeChampion()">
                                üëë ${dethroned ? 'Defend Your Crown' : 'Challenge the Champion'}
                            </button>
                        ` : ''}
                        ${youLost ? `
                            <button class="btn btn-primary" style="background: linear-gradient(135deg, #FF3B30, #FF6B6B);" onclick="quickRematch('${winner.id}')">
                                üî• REVENGE MATCH
                            </button>
                            <button class="btn btn-secondary" onclick="challengeChampion()">
                                üëë Challenge the Champion Instead
                            </button>
                        ` : ''}
                        <button class="btn btn-secondary" style="opacity: 0.7;" onclick="closeVotingOverlay()">
                            Back to Home
                        </button>
                    </div>
                </div>
            `;
            
            overlay.innerHTML = revealHTML;
            
            if (youWon && !dethroned) {
                sounds.victory();
                createConfetti();
            } else if (youLost) {
                sounds.defeat();
            }
        }
        
        // Quick action functions
        function quickRematch(opponentId) {
            closeVotingOverlay();
            selectedOpponent = opponentId;
            selectedChallenge = challengeLibrary[Math.floor(Math.random() * challengeLibrary.length)];
            screen = 'challenge-reveal';
            render();
        }
        
        function challengeChampion() {
            closeVotingOverlay();
            const rankings = Object.values(members).sort((a, b) => b.points - a.points);
            const champion = rankings[0];
            
            if (champion.id === currentMemberId) {
                // You ARE the champion - pick someone to defend against
                showToast("You're the champion! Pick a challenger.", 'info');
                screen = 'select-opponent';
                render();
            } else {
                selectedOpponent = champion.id;
                selectedChallenge = challengeLibrary[Math.floor(Math.random() * challengeLibrary.length)];
                screen = 'challenge-reveal';
                render();
            }
        }
        
        // Quick challenge from ladder
        function quickChallengeRival(opponentId) {
            const opponent = members[opponentId];
            if (!opponent) return;
            
            selectedOpponent = opponentId;
            selectedChallenge = challengeLibrary[Math.floor(Math.random() * challengeLibrary.length)];
            screen = 'challenge-reveal';
            render();
        }
        
        // Toggle live duels list expansion
        function toggleLiveDuels() {
            const list = document.getElementById('liveDuelsList');
            const chevron = document.getElementById('liveDuelsChevron');
            if (list && chevron) {
                const isHidden = list.style.display === 'none';
                list.style.display = isHidden ? 'block' : 'none';
                chevron.style.transform = isHidden ? 'rotate(90deg)' : 'rotate(0deg)';
            }
        }
        
        // View a live duel - routes based on status
        function viewLiveDuel(challengeId) {
            const challenge = challenges.find(c => c.id === challengeId);
            if (!challenge) {
                showToast('Duel not found', 'error');
                return;
            }
            
            const hasChallenger = challenge.challenger_submission_url;
            const hasOpponent = challenge.opponent_submission_url;
            const isYouChallenger = challenge.challenger_id === currentMemberId;
            const isYouOpponent = challenge.opponent_id === currentMemberId;
            const isParticipant = isYouChallenger || isYouOpponent;
            
            // Determine what to show based on state
            if (challenge.status === 'completed' || challenge.status === 'forfeited') {
                // Already done - show the result
                showToast('This duel is already completed', 'info');
                return;
            }
            
            if (challenge.status === 'voting' || (hasChallenger && hasOpponent)) {
                // Both submitted - show voting screen
                showTwoPersonVoting(challengeId);
                return;
            }
            
            if (challenge.status === 'pending' && isYouOpponent && !hasOpponent) {
                // You need to respond
                startResponse(challengeId);
                return;
            }
            
            if (isParticipant && !hasChallenger && !hasOpponent) {
                // Waiting for submissions
                showToast('Waiting for submissions', 'info');
                return;
            }
            
            if (isYouChallenger && hasChallenger && !hasOpponent) {
                // You submitted, waiting for opponent
                showToast('Waiting for ' + (members[challenge.opponent_id]?.name || 'opponent') + ' to respond', 'info');
                return;
            }
            
            // Default - try to show voting if possible, otherwise just notify
            if (hasChallenger || hasOpponent) {
                showTwoPersonVoting(challengeId);
            } else {
                showToast('Duel in progress...', 'info');
            }
        }
        
        // ============================================
        // AMBIENT RIVALRY PINGS
        // ============================================
        
        // Ping categories
        // ============================================
        // STIR THE POT ‚Äî Contextual Trigger System
        // ============================================
        
        const stirThePotTemplates = {
            rivalry: [
                { template: "{theirWins}‚Äì{myWins}. That lead looks nervous.", vars: ['theirWins', 'myWins'] },
                { template: "{theirWins}‚Äì{myWins}. One duel from even.", vars: ['theirWins', 'myWins'] },
                { template: "{theirWins}‚Äì{myWins}. We both know this isn't settled.", vars: ['theirWins', 'myWins'] },
                { template: "Still riding that {winGap}-win cushion?", vars: ['winGap'] },
            ],
            comeback: [
                { template: "{pointGap} points behind. Big comeback energy?", vars: ['pointGap'] },
                { template: "{pointGap} points back. Plenty of time. Maybe.", vars: ['pointGap'] },
                { template: "Down {pointGap}. Redemption arc starts now.", vars: ['pointGap'] },
            ],
            protecting: [
                { template: "{pointGap} points up. Come get some.", vars: ['pointGap'] },
                { template: "{pointGap} ahead. You climbing or spectating?", vars: ['pointGap'] },
            ],
            winStreak: [
                { template: "{streak} in a row. Make it {streakPlusOne}?", vars: ['streak', 'streakPlusOne'] },
                { template: "{streak}-win streak. Feeling dangerous.", vars: ['streak'] },
            ],
            lossStreak: [
                { template: "{lossStreak} losses. Time to flip the script.", vars: ['lossStreak'] },
                { template: "Down {lossStreak} straight. Comeback loading?", vars: ['lossStreak'] },
            ],
            seasonUrgency: [
                { template: "{daysLeft} days left. Clock's getting loud.", vars: ['daysLeft'] },
                { template: "Season ends in {daysLeft} days. You going to matter?", vars: ['daysLeft'] },
                { template: "{daysLeft} days. Now or never.", vars: ['daysLeft'] },
            ],
            rhythm: [
                { template: "Run it back.", vars: [] },
                { template: "Let's settle this.", vars: [] },
                { template: "You warmed up yet?", vars: [] },
                { template: "Blink twice if you're nervous.", vars: [] },
                { template: "Should I spot you a point?", vars: [] },
                { template: "Stretch first. I don't want excuses.", vars: [] },
                { template: "Hydrate. You're going to need it.", vars: [] },
                { template: "I'll make this quick.", vars: [] },
                { template: "Checking in. Still competitive?", vars: [] },
                { template: "Confidence looks good on you. Let's test it.", vars: [] },
            ],
        };
        
        // Calculate rivalry data between two members
        function getRivalryData(myId, theirId) {
            const me = members[myId];
            const them = members[theirId];
            if (!me || !them) return null;
            
            // Get head-to-head record
            const h2h = getHeadToHead(myId, theirId);
            
            // Calculate streaks (simplified ‚Äî counts consecutive wins against THIS opponent)
            let myStreak = 0;
            let myLossStreak = 0;
            const relevantChallenges = challenges
                .filter(c => c.status === 'completed' && c.winner_id &&
                    ((c.challenger_id === myId && c.opponent_id === theirId) ||
                     (c.challenger_id === theirId && c.opponent_id === myId)))
                .sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at));
            
            for (const c of relevantChallenges) {
                if (c.winner_id === myId) {
                    if (myLossStreak === 0) myStreak++;
                    else break;
                } else {
                    if (myStreak === 0) myLossStreak++;
                    else break;
                }
            }
            
            return {
                myWins: h2h.yourWins,
                theirWins: h2h.theirWins,
                myPoints: me.points || 0,
                theirPoints: them.points || 0,
                myStreak: myStreak,
                myLossStreak: myLossStreak,
                daysLeftInSeason: calculateDaysLeftInSeason(),
            };
        }
        
        // Helper to calculate days left in current season
        function calculateDaysLeftInSeason() {
            const now = new Date();
            const yearStart = new Date(now.getFullYear(), 0, 1);
            const weekOfYear = Math.floor((now - yearStart) / (7 * 24 * 60 * 60 * 1000));
            const seasonNumber = Math.floor(weekOfYear / 4) + 1;
            const seasonEndDate = new Date(yearStart.getTime() + (seasonNumber * 4 * 7 * 24 * 60 * 60 * 1000));
            return Math.max(0, Math.ceil((seasonEndDate - now) / (24 * 60 * 60 * 1000)));
        }
        
        // Select which category of trigger to use based on context
        function selectTriggerCategory(rivalryData) {
            const {
                myWins = 0, theirWins = 0,
                myPoints = 0, theirPoints = 0,
                myStreak = 0, myLossStreak = 0,
                daysLeftInSeason = 30,
            } = rivalryData;
            
            const rivalryGap = Math.abs(myWins - theirWins);
            const pointGap = Math.abs(myPoints - theirPoints);
            const iAmAhead = myPoints > theirPoints;
            
            // Priority 1: Season urgency (‚â§7 days)
            if (daysLeftInSeason <= 7) return 'seasonUrgency';
            
            // Priority 2: Tight rivalry (within 1 win)
            if (rivalryGap <= 1 && (myWins + theirWins) > 0) return 'rivalry';
            
            // Priority 3: Losing streak (2+)
            if (myLossStreak >= 2) return 'lossStreak';
            
            // Priority 4: Winning streak (2+)
            if (myStreak >= 2) return 'winStreak';
            
            // Priority 5: Significant point gap
            if (pointGap >= 20) return iAmAhead ? 'protecting' : 'comeback';
            
            // Default: Rhythm lines
            return 'rhythm';
        }
        
        // Fill in template variables
        function fillTriggerTemplate(templateObj, rivalryData) {
            const {
                myWins = 0, theirWins = 0,
                myPoints = 0, theirPoints = 0,
                myStreak = 0, myLossStreak = 0,
                daysLeftInSeason = 30,
            } = rivalryData;
            
            const vars = {
                myWins,
                theirWins,
                winGap: Math.abs(myWins - theirWins),
                pointGap: Math.abs(myPoints - theirPoints),
                streak: myStreak,
                streakPlusOne: myStreak + 1,
                lossStreak: myLossStreak,
                daysLeft: daysLeftInSeason,
            };
            
            let result = templateObj.template;
            for (const [key, value] of Object.entries(vars)) {
                result = result.replace(new RegExp(`\\{${key}\\}`, 'g'), value);
            }
            return result;
        }
        
        // Generate a contextual trigger message
        function generateTrigger(rivalryData, excludeTemplate = null) {
            const category = selectTriggerCategory(rivalryData);
            const categoryTemplates = stirThePotTemplates[category];
            
            // Filter out the excluded template if provided
            let available = excludeTemplate 
                ? categoryTemplates.filter(t => t.template !== excludeTemplate)
                : categoryTemplates;
            if (available.length === 0) available = categoryTemplates;
            
            const selected = available[Math.floor(Math.random() * available.length)];
            const message = fillTriggerTemplate(selected, rivalryData);
            
            return { message, category, template: selected.template };
        }
        
        // Current stir the pot state
        let stirThePotState = {
            targetId: null,
            currentTrigger: null,
        };
        
        // Check ping rate limit (3 per day)
        function canSendPing() {
            const today = new Date().toDateString();
            const pingLog = JSON.parse(localStorage.getItem('pingLog') || '{}');
            const todayPings = pingLog[today] || 0;
            return todayPings < 3;
        }
        
        function recordPing() {
            const today = new Date().toDateString();
            const pingLog = JSON.parse(localStorage.getItem('pingLog') || '{}');
            pingLog[today] = (pingLog[today] || 0) + 1;
            // Clean old entries
            Object.keys(pingLog).forEach(date => {
                if (date !== today) delete pingLog[date];
            });
            localStorage.setItem('pingLog', JSON.stringify(pingLog));
        }
        
        function getPingsRemaining() {
            const today = new Date().toDateString();
            const pingLog = JSON.parse(localStorage.getItem('pingLog') || '{}');
            return 3 - (pingLog[today] || 0);
        }
        
        function showAmbientPingMenu() {
            const me = getCurrentMember();
            if (!me) return;
            
            const remaining = getPingsRemaining();
            
            if (remaining <= 0) {
                showToast('Max 3 pokes per day. Reset at midnight.', 'info');
                return;
            }
            
            // Get list of other squad members to target
            const targets = Object.values(members)
                .filter(m => m.id !== currentMemberId)
                .sort((a, b) => (b.points || 0) - (a.points || 0));
            
            if (targets.length === 0) {
                showToast('No one to stir the pot with yet!', 'info');
                return;
            }
            
            let html = '<div style="text-align: center;">';
            html += '<div style="font-size: 12px; color: #8E8E93; margin-bottom: 16px;">' + remaining + ' poke' + (remaining !== 1 ? 's' : '') + ' remaining today</div>';
            
            html += '<div style="font-size: 11px; color: #FF9500; font-weight: 700; margin-bottom: 12px; text-align: left;">üéØ WHO ARE YOU POKING?</div>';
            html += '<div style="display: flex; flex-direction: column; gap: 8px;">';
            
            targets.forEach(target => {
                const h2h = getHeadToHead(currentMemberId, target.id);
                const record = h2h.total > 0 ? `${h2h.yourWins}‚Äì${h2h.theirWins}` : 'No history';
                const pointDiff = (me.points || 0) - (target.points || 0);
                const diffLabel = pointDiff > 0 ? `+${pointDiff}` : pointDiff < 0 ? `${pointDiff}` : 'tied';
                
                html += `
                    <button onclick="showStirThePotMessage('${target.id}')" style="
                        display: flex; align-items: center; gap: 12px;
                        padding: 12px 14px;
                        background: #1C1C1E;
                        border: 1px solid #2C2C2E;
                        border-radius: 12px;
                        cursor: pointer;
                        transition: all 0.2s;
                        text-align: left;
                    " onmouseover="this.style.borderColor='#FF9500'" onmouseout="this.style.borderColor='#2C2C2E'">
                        <span style="font-size: 28px;">${target.avatar || 'üë§'}</span>
                        <div style="flex: 1;">
                            <div style="font-size: 14px; font-weight: 600; color: #FFFFFF;">${target.name}</div>
                            <div style="font-size: 11px; color: #8E8E93;">${record} ¬∑ ${diffLabel} pts</div>
                        </div>
                        <span style="font-size: 12px; color: #FF9500;">üî•</span>
                    </button>
                `;
            });
            
            html += '</div></div>';
            
            showModal('üî• Stir the Pot', html, 'Cancel', null, null, function() { closeModal(); });
        }
        
        function showStirThePotMessage(targetId) {
            closeModal();
            
            const me = getCurrentMember();
            const target = members[targetId];
            if (!me || !target) return;
            
            // Generate contextual trigger
            const rivalryData = getRivalryData(currentMemberId, targetId);
            const trigger = generateTrigger(rivalryData);
            
            stirThePotState = {
                targetId: targetId,
                currentTrigger: trigger,
                rivalryData: rivalryData,
            };
            
            renderStirThePotModal();
        }
        
        function renderStirThePotModal() {
            const target = members[stirThePotState.targetId];
            const trigger = stirThePotState.currentTrigger;
            if (!target || !trigger) return;
            
            const categoryLabels = {
                rivalry: '‚öîÔ∏è rivalry',
                comeback: 'üìà comeback',
                protecting: 'üõ°Ô∏è defending',
                winStreak: 'üî• on fire',
                lossStreak: 'üí™ redemption',
                seasonUrgency: '‚è∞ crunch time',
                rhythm: 'üí¨ classic',
            };
            
            // Remove any existing modal
            const existingModal = document.getElementById('stirThePotModal');
            if (existingModal) existingModal.remove();
            
            const modal = document.createElement('div');
            modal.id = 'stirThePotModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10, 10, 12, 0.95); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;';
            
            modal.innerHTML = `
                <div style="background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 16px; padding: 24px; max-width: 400px; width: 100%;">
                    <div style="font-size: 20px; font-weight: 700; margin-bottom: 16px;">üî• Stir the Pot</div>
                    <div style="text-align: center;">
                        <div style="font-size: 12px; color: #8E8E93; margin-bottom: 8px;">‚Üí ${target.name}</div>
                        
                        <div style="min-height: 80px; display: flex; align-items: center; justify-content: center; padding: 20px; margin: 16px 0;">
                            <p style="font-size: 20px; font-weight: 700; color: #FFFFFF; line-height: 1.4;">"${trigger.message}"</p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <span style="font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: #6E6E73; background: rgba(110, 110, 115, 0.2); padding: 4px 10px; border-radius: 10px;">
                                ${categoryLabels[trigger.category] || trigger.category}
                            </span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr auto 1.5fr; gap: 10px;">
                            <button id="stirCancelBtn" class="btn btn-secondary" style="padding: 14px;">Cancel</button>
                            <button id="stirRefreshBtn" style="width: 50px; padding: 14px; background: #2C2C2E; border: 1px solid #3C3C3E; border-radius: 12px; color: #8E8E93; cursor: pointer;">‚Üª</button>
                            <button id="stirSendBtn" style="padding: 14px; background: linear-gradient(135deg, #FF9500, #FF3B30); border: none; border-radius: 12px; color: #FFFFFF; font-weight: 700; font-size: 14px; cursor: pointer; box-shadow: 0 4px 12px rgba(255, 149, 0, 0.3);">Send üî•</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Attach event listeners directly
            document.getElementById('stirCancelBtn').addEventListener('click', function() {
                closeStirThePotModal();
            });
            
            document.getElementById('stirRefreshBtn').addEventListener('click', function() {
                doRefreshStirThePot();
            });
            
            document.getElementById('stirSendBtn').addEventListener('click', function() {
                doSendStirThePot();
            });
        }
        
        function closeStirThePotModal() {
            const modal = document.getElementById('stirThePotModal');
            if (modal) modal.remove();
        }
        
        function doRefreshStirThePot() {
            if (!stirThePotState.targetId || !stirThePotState.rivalryData) return;
            
            const newTrigger = generateTrigger(
                stirThePotState.rivalryData,
                stirThePotState.currentTrigger?.template
            );
            stirThePotState.currentTrigger = newTrigger;
            
            // Re-render
            closeStirThePotModal();
            renderStirThePotModal();
        }
        
        async function doSendStirThePot() {
            const targetId = stirThePotState.targetId;
            const trigger = stirThePotState.currentTrigger;
            const target = members[targetId];
            
            if (!targetId || !trigger || !target) {
                showToast('Something went wrong', 'error');
                closeStirThePotModal();
                return;
            }
            
            if (!canSendPing()) {
                showToast('Max 3 pokes per day', 'info');
                closeStirThePotModal();
                return;
            }
            
            // Disable send button
            const sendBtn = document.getElementById('stirSendBtn');
            if (sendBtn) {
                sendBtn.disabled = true;
                sendBtn.textContent = 'Sending...';
            }
            
            try {
                // Save targeted ping
                const { error } = await db
                    .from('ambient_pings')
                    .insert({
                        squad_id: squadId,
                        member_id: currentMemberId,
                        target_id: targetId,
                        ping_text: trigger.message,
                        ping_category: trigger.category,
                        created_at: new Date().toISOString()
                    });
                
                if (error) {
                    // Table might not exist or missing columns - store locally
                    if (error.message && (error.message.includes('relation') || error.message.includes('column'))) {
                        console.log('ambient_pings table issue, storing locally');
                        let localPings = JSON.parse(localStorage.getItem('localPings') || '[]');
                        localPings.push({
                            id: Date.now(),
                            squad_id: squadId,
                            member_id: currentMemberId,
                            target_id: targetId,
                            ping_text: trigger.message,
                            ping_category: trigger.category,
                            created_at: new Date().toISOString()
                        });
                        if (localPings.length > 20) localPings = localPings.slice(-20);
                        localStorage.setItem('localPings', JSON.stringify(localPings));
                    } else {
                        throw error;
                    }
                }
                
                // Send push notification to target
                try {
                    const me = getCurrentMember();
                    await fetch(SUPABASE_URL + '/functions/v1/send-push', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + SUPABASE_ANON_KEY
                        },
                        body: JSON.stringify({
                            type: 'stir_the_pot',
                            squad_id: squadId,
                            target_id: targetId,
                            sender_name: me?.name || 'Someone',
                            message: trigger.message
                        })
                    });
                } catch (pushErr) {
                    console.log('Push notification failed (non-critical):', pushErr);
                }
                
                recordPing();
                closeStirThePotModal();
                showToast('üî• Sent to ' + target.name, 'info');
                
                // Reset state
                stirThePotState = { targetId: null, currentTrigger: null };
                
                render();
                
            } catch (err) {
                console.error('Failed to send:', err);
                showToast('Failed to send', 'error');
                if (sendBtn) {
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'Send üî•';
                }
            }
        }
        
        // Cached pings from database
        let cachedPings = [];
        
        // Load pings from Supabase
        async function loadAmbientPings() {
            if (!squadId) return [];
            
            try {
                const { data, error } = await db
                    .from('ambient_pings')
                    .select('*')
                    .eq('squad_id', squadId)
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                if (error) {
                    console.log('Could not load pings from DB:', error.message);
                    // Fall back to localStorage
                    const localPings = JSON.parse(localStorage.getItem('localPings') || '[]');
                    cachedPings = localPings.filter(p => p.squad_id === squadId);
                } else {
                    cachedPings = data || [];
                }
            } catch (err) {
                console.log('Ping load error:', err);
                const localPings = JSON.parse(localStorage.getItem('localPings') || '[]');
                cachedPings = localPings.filter(p => p.squad_id === squadId);
            }
            
            return cachedPings;
        }
        
        function getAmbientPings() {
            // Return cached pings (loaded async during loadSquadData)
            return cachedPings;
        }
        
        // Send a taunt after winning/losing
        async function sendTaunt(challengeId, tauntText, isWinner, btn) {
            const currentMember = getCurrentMember();
            if (!currentMember) return;
            
            try {
                // Save taunt to the challenge record
                const tauntField = isWinner ? 'winner_taunt' : 'loser_taunt';
                const { error } = await db
                    .from('challenges')
                    .update({ [tauntField]: tauntText })
                    .eq('id', challengeId);
                
                if (error) {
                    console.error('Supabase error:', error);
                    // Check if it's a column doesn't exist error
                    if (error.message && error.message.includes('column')) {
                        showToast('Run SQL: ALTER TABLE challenges ADD COLUMN winner_taunt TEXT; ALTER TABLE challenges ADD COLUMN loser_taunt TEXT;', 'error');
                    } else {
                        showToast('Failed to send taunt: ' + error.message, 'error');
                    }
                    return;
                }
                
                // Visual feedback - highlight selected taunt
                if (btn) {
                    btn.style.background = 'rgba(52, 199, 89, 0.3)';
                    btn.style.borderColor = '#34C759';
                    btn.style.color = '#34C759';
                }
                
                // Disable all taunt buttons
                document.querySelectorAll('[onclick^="sendTaunt"]').forEach(b => {
                    b.disabled = true;
                    b.style.opacity = '0.5';
                    b.style.cursor = 'default';
                });
                
                showToast('üí¨ Taunt sent!', 'info');
                
            } catch (err) {
                console.error('Failed to send taunt:', err);
                showToast('Failed to send taunt: ' + (err.message || 'Unknown error'), 'error');
            }
        }
        
        function getHeadToHead(memberId1, memberId2) {
            let yourWins = 0;
            let theirWins = 0;
            
            challenges.forEach(c => {
                if (c.status !== 'completed' || !c.winner_id) return;
                const isMatch = (c.challenger_id === memberId1 && c.opponent_id === memberId2) ||
                               (c.challenger_id === memberId2 && c.opponent_id === memberId1);
                if (!isMatch) return;
                
                if (c.winner_id === memberId1) yourWins++;
                else theirWins++;
            });
            
            return { yourWins, theirWins, total: yourWins + theirWins };
        }
        
        async function showVotingScreen(challengeId) {
            await loadSquadData();
            
            const challenge = challenges.find(c => c.id === challengeId);
            if (!challenge) return;
            
            // Check if already voted (handle case where no vote exists)
            let existingVote = null;
            try {
                const { data, error } = await db
                    .from('votes')
                    .select('*')
                    .eq('challenge_id', challengeId)
                    .eq('voter_id', currentMemberId)
                    .maybeSingle();
                
                if (!error) existingVote = data;
            } catch (err) {
                console.log('No existing vote found');
            }
            
            if (existingVote) {
                showModal(
                    '‚úÖ Already Voted',
                    `<div style="text-align: center;">
                        <p>You've already cast your vote on this challenge.</p>
                        <p style="font-size: 13px; color: #8E8E93; margin-top: 12px;">Waiting for others to vote...</p>
                    </div>`,
                    null,
                    'OK',
                    () => closeModal()
                );
                return;
            }
            
            const challenger = members[challenge.challenger_id];
            const opponent = members[challenge.opponent_id];
            
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            overlay.id = 'votingOverlay';
            
            overlay.innerHTML = `
                <div class="reveal-container" style="max-width: 600px;">
                    <div style="font-size: 13px; color: #FF9500; font-weight: 700; letter-spacing: 1px; margin-bottom: 8px;">CAST YOUR VOTE</div>
                    <div style="font-size: 20px; font-weight: 700; margin-bottom: 24px;">${challenge.challenge_type}</div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 32px;">
                        <div style="text-align: center;">
                            ${challenge.challenger_media_type === 'video' ?
                                `<video src="${challenge.challenger_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid #3C3C3E;" controls playsinline></video>` :
                                `<img src="${challenge.challenger_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid #3C3C3E;">`
                            }
                            <div style="margin-top: 12px;">
                                <div style="font-size: 32px;">${challenger?.avatar || 'üë§'}</div>
                                <div style="font-size: 15px; font-weight: 600;">${challenger?.name || 'Challenger'}</div>
                            </div>
                            <button class="btn btn-secondary" style="margin-top: 12px;" onclick="castVote('${challengeId}', '${challenge.challenger_id}')">
                                Vote ${challenger?.name || 'Challenger'}
                            </button>
                        </div>
                        
                        <div style="text-align: center;">
                            ${challenge.opponent_media_type === 'video' ?
                                `<video src="${challenge.opponent_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid #3C3C3E;" controls playsinline></video>` :
                                `<img src="${challenge.opponent_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid #3C3C3E;">`
                            }
                            <div style="margin-top: 12px;">
                                <div style="font-size: 32px;">${opponent?.avatar || 'üë§'}</div>
                                <div style="font-size: 15px; font-weight: 600;">${opponent?.name || 'Opponent'}</div>
                            </div>
                            <button class="btn btn-secondary" style="margin-top: 12px;" onclick="castVote('${challengeId}', '${challenge.opponent_id}')">
                                Vote ${opponent?.name || 'Opponent'}
                            </button>
                        </div>
                    </div>
                    
                    <button style="background: none; border: none; color: #8E8E93; font-size: 13px; cursor: pointer;" onclick="closeVotingOverlay()">
                        Cancel
                    </button>
                </div>
            `;
            
            document.body.appendChild(overlay);
        }
        
        async function castVote(challengeId, voteForId) {
            const overlay = document.getElementById('votingOverlay');
            
            // Show voting animation
            overlay.innerHTML = `
                <div class="reveal-container">
                    <div style="font-size: 64px; margin-bottom: 24px; animation: pulse 1s ease-in-out infinite;">üó≥Ô∏è</div>
                    <div style="font-size: 24px; font-weight: 700; color: #8E8E93;">
                        Recording vote...
                    </div>
                </div>
            `;
            
            try {
                const challenge = challenges.find(c => c.id === challengeId);
                
                // Record vote
                await db
                    .from('votes')
                    .insert({
                        challenge_id: challengeId,
                        voter_id: currentMemberId,
                        vote_for: voteForId
                    });
                
                // Update vote counts
                const isVoteForChallenger = voteForId === challenge.challenger_id;
                await db
                    .from('challenges')
                    .update({
                        votes_for_challenger: (challenge.votes_for_challenger || 0) + (isVoteForChallenger ? 1 : 0),
                        votes_for_opponent: (challenge.votes_for_opponent || 0) + (isVoteForChallenger ? 0 : 1)
                    })
                    .eq('id', challengeId);
                
                // Check if all eligible voters have voted
                await checkVotingComplete(challengeId);
                
                // Show confirmation
                await sleep(500);
                
                overlay.innerHTML = `
                    <div class="reveal-container">
                        <div style="font-size: 64px; margin-bottom: 24px;">‚úÖ</div>
                        <div style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">Vote Cast!</div>
                        <div style="font-size: 14px; color: #8E8E93; margin-bottom: 24px;">Your vote for ${members[voteForId]?.name} has been recorded.</div>
                        <button class="btn btn-primary" onclick="closeVotingOverlay()">Done</button>
                    </div>
                `;
                
                sounds.click();
            } catch (err) {
                console.error('Vote error:', err);
                alert('Failed to cast vote: ' + (err.message || 'Unknown error'));
                closeVotingOverlay();
            }
        }
        
        async function checkVotingComplete(challengeId) {
            await loadSquadData();
            
            const challenge = challenges.find(c => c.id === challengeId);
            if (!challenge || challenge.status !== 'voting') return;
            
            // Count eligible voters (everyone except participants)
            const eligibleVoters = Object.keys(members).filter(id => 
                id !== challenge.challenger_id && id !== challenge.opponent_id
            );
            
            const totalVotes = (challenge.votes_for_challenger || 0) + (challenge.votes_for_opponent || 0);
            
            // If all eligible voters have voted, determine winner
            if (totalVotes >= eligibleVoters.length) {
                await determineWinner(challengeId);
            }
        }
        
        async function determineWinner(challengeId) {
            const challenge = challenges.find(c => c.id === challengeId);
            if (!challenge) return;
            
            const votesChallenger = challenge.votes_for_challenger || 0;
            const votesOpponent = challenge.votes_for_opponent || 0;
            
            let winnerId;
            if (votesChallenger > votesOpponent) {
                winnerId = challenge.challenger_id;
            } else if (votesOpponent > votesChallenger) {
                winnerId = challenge.opponent_id;
            } else {
                // Tie - pick random (or could do AI tiebreaker)
                winnerId = Math.random() < 0.5 ? challenge.challenger_id : challenge.opponent_id;
            }
            
            // Complete the challenge
            await completeChallenge(challengeId, winnerId, votesChallenger, votesOpponent);
        }
        
        function closeVotingOverlay() {
            const overlay = document.getElementById('votingOverlay');
            if (overlay) overlay.remove();
            
            // Reset challenge-related state
            selectedMedia = null;
            selectedChallenge = null;
            selectedOpponent = null;
            window.currentChallengeId = null;
            isSubmitting = false;
            
            // Go to home screen
            screen = 'arena';
            
            loadSquadData().then(() => render());
        }
        
        async function showAIJudging(challengeId) {
            const challenge = challenges.find(c => c.id === challengeId);
            if (!challenge) return;
            
            const challenger = members[challenge.challenger_id];
            const opponent = members[challenge.opponent_id];
            
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            overlay.id = 'aiJudgeOverlay';
            
            // Show the matchup
            overlay.innerHTML = `
                <div class="reveal-container" style="max-width: 600px;">
                    <div style="font-size: 20px; font-weight: 700; margin-bottom: 24px;">${challenge.challenge_type}</div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                        <div style="text-align: center;">
                            ${challenge.challenger_media_type === 'video' ?
                                `<video src="${challenge.challenger_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid #3C3C3E;" controls playsinline></video>` :
                                `<img src="${challenge.challenger_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid #3C3C3E;">`
                            }
                            <div style="margin-top: 12px;">
                                <div style="font-size: 32px;">${challenger?.avatar || 'üë§'}</div>
                                <div style="font-size: 15px; font-weight: 600;">${challenger?.name || 'Challenger'}</div>
                            </div>
                        </div>
                        
                        <div style="text-align: center;">
                            ${challenge.opponent_media_type === 'video' ?
                                `<video src="${challenge.opponent_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid #3C3C3E;" controls playsinline></video>` :
                                `<img src="${challenge.opponent_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid #3C3C3E;">`
                            }
                            <div style="margin-top: 12px;">
                                <div style="font-size: 32px;">${opponent?.avatar || 'üë§'}</div>
                                <div style="font-size: 15px; font-weight: 600;">${opponent?.name || 'Opponent'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="runAIJudge('${challengeId}')">
                        ü§ñ Let AI Judge Decide
                    </button>
                    
                    <button style="background: none; border: none; color: #8E8E93; font-size: 13px; cursor: pointer; margin-top: 16px; display: block; width: 100%;" onclick="closeAIJudgeOverlay()">
                        Cancel
                    </button>
                </div>
            `;
            
            document.body.appendChild(overlay);
        }
        
        async function runAIJudge(challengeId) {
            const overlay = document.getElementById('aiJudgeOverlay');
            const challenge = challenges.find(c => c.id === challengeId);
            if (!challenge) return;
            
            const challenger = members[challenge.challenger_id];
            const opponent = members[challenge.opponent_id];
            
            // Dramatic judging animation
            overlay.innerHTML = `
                <div class="reveal-container">
                    <div style="font-size: 64px; margin-bottom: 24px; animation: pulse 1.5s ease-in-out infinite;">ü§ñ</div>
                    <div style="font-size: 24px; font-weight: 700; color: #8E8E93;">
                        AI Judge analyzing...
                    </div>
                </div>
            `;
            
            await sleep(2000);
            
            // AI commentary based on challenge type
            const commentaries = [
                "Based on creativity and execution...",
                "After careful analysis...",
                "Considering effort and style...",
                "Looking at technique and flair...",
                "The verdict is in..."
            ];
            
            overlay.innerHTML = `
                <div class="reveal-container">
                    <div style="font-size: 64px; margin-bottom: 24px;">ü§ñ</div>
                    <div style="font-size: 18px; color: #FFD700; font-style: italic;">
                        "${commentaries[Math.floor(Math.random() * commentaries.length)]}"
                    </div>
                </div>
            `;
            
            await sleep(1500);
            
            // Pick winner (weighted random for drama)
            const winnerId = Math.random() < 0.5 ? challenge.challenger_id : challenge.opponent_id;
            const winner = members[winnerId];
            const loser = winnerId === challenge.challenger_id ? opponent : challenger;
            const youWon = winnerId === currentMemberId;
            
            // Record result
            await completeChallenge(challengeId, winnerId, 0, 0);
            
            // Dramatic reveal
            overlay.innerHTML = `
                <div class="reveal-container">
                    <div style="font-size: 80px; margin-bottom: 16px;">${winner?.avatar || 'üë§'}</div>
                    <div style="font-size: 32px; font-weight: 900; margin-bottom: 8px; color: #FFD700;">
                        ${winner?.name?.toUpperCase()} WINS!
                    </div>
                    <div style="font-size: 16px; color: #8E8E93; margin-bottom: 24px;">
                        ${youWon ? '+10 points for you!' : `${winner?.name} earns 10 points`}
                    </div>
                    
                    <button class="btn btn-primary" onclick="closeAIJudgeOverlay()">
                        ${youWon ? 'üéâ Celebrate!' : 'Continue'}
                    </button>
                </div>
            `;
            
            if (youWon) {
                sounds.victory();
                createConfetti();
            } else {
                sounds.defeat();
            }
        }
        
        function closeAIJudgeOverlay() {
            const overlay = document.getElementById('aiJudgeOverlay');
            if (overlay) overlay.remove();
            loadSquadData().then(() => render());
        }
        
        async function showShowdown(challengeId) {
            // Reload data first to get latest status
            await loadSquadData();
            
            var challenge = challenges.find(function(c) { return c.id === challengeId; });
            if (!challenge) return;
            
            var isParticipant = challenge.challenger_id === currentMemberId || challenge.opponent_id === currentMemberId;
            
            // Route to appropriate screen based on status
            if (challenge.status === 'completed') {
                showCompletedChallenge(challengeId);
            } else if (challenge.status === 'voting') {
                if (isParticipant) {
                    showTwoPersonVoting(challengeId);
                } else {
                    // Non-participants can't vote in this model
                    showModal(
                        '‚öîÔ∏è Duel in Progress',
                        '<div style="text-align: center;">' +
                            '<p>The two challengers are voting on this duel.</p>' +
                            '<p style="font-size: 13px; color: #8E8E93; margin-top: 12px;">Results will appear in the Arena when complete!</p>' +
                        '</div>',
                        null,
                        'OK',
                        function() { closeModal(); }
                    );
                }
            } else if (challenge.status === 'ready') {
                initiateJudging(challengeId);
            }
        }
        
        function showCompletedChallenge(challengeId) {
            const challenge = challenges.find(c => c.id === challengeId);
            if (!challenge) return;
            
            const challenger = members[challenge.challenger_id];
            const opponent = members[challenge.opponent_id];
            const winner = members[challenge.winner_id];
            const youWon = challenge.winner_id === currentMemberId;
            
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            overlay.id = 'resultsOverlay';
            
            overlay.innerHTML = `
                <div class="reveal-container" style="max-width: 600px;">
                    <div style="font-size: 20px; font-weight: 700; margin-bottom: 24px;">${challenge.challenge_type}</div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                        <div style="text-align: center;">
                            ${challenge.challenger_media_type === 'video' ?
                                `<video src="${challenge.challenger_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid ${challenge.winner_id === challenge.challenger_id ? '#FFD700' : '#3C3C3E'};" controls playsinline></video>` :
                                `<img src="${challenge.challenger_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid ${challenge.winner_id === challenge.challenger_id ? '#FFD700' : '#3C3C3E'};">`
                            }
                            <div style="margin-top: 12px;">
                                <div style="font-size: 32px;">${challenger?.avatar || 'üë§'}${challenge.winner_id === challenge.challenger_id ? ' üëë' : ''}</div>
                                <div style="font-size: 15px; font-weight: 600;">${challenger?.name || 'Challenger'}</div>
                                ${challenge.votes_for_challenger > 0 ? `<div style="font-size: 14px; color: #8E8E93;">${challenge.votes_for_challenger} votes</div>` : ''}
                            </div>
                        </div>
                        
                        <div style="text-align: center;">
                            ${challenge.opponent_media_type === 'video' ?
                                `<video src="${challenge.opponent_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid ${challenge.winner_id === challenge.opponent_id ? '#FFD700' : '#3C3C3E'};" controls playsinline></video>` :
                                `<img src="${challenge.opponent_media_url}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 3px solid ${challenge.winner_id === challenge.opponent_id ? '#FFD700' : '#3C3C3E'};">`
                            }
                            <div style="margin-top: 12px;">
                                <div style="font-size: 32px;">${opponent?.avatar || 'üë§'}${challenge.winner_id === challenge.opponent_id ? ' üëë' : ''}</div>
                                <div style="font-size: 15px; font-weight: 600;">${opponent?.name || 'Opponent'}</div>
                                ${challenge.votes_for_opponent > 0 ? `<div style="font-size: 14px; color: #8E8E93;">${challenge.votes_for_opponent} votes</div>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div style="padding: 20px; background: ${youWon ? 'rgba(255, 215, 0, 0.1)' : 'rgba(142, 142, 147, 0.1)'}; border-radius: 12px; margin-bottom: 24px;">
                        <div style="font-size: 24px; font-weight: 900; color: ${youWon ? '#FFD700' : '#8E8E93'};">
                            ${youWon ? 'üèÜ YOU WON!' : `${winner?.name || 'Winner'} won!`}
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="closeResultsOverlay()">
                        Continue
                    </button>
                </div>
            `;
            
            document.body.appendChild(overlay);
        }
        
        function closeResultsOverlay() {
            const overlay = document.getElementById('resultsOverlay');
            if (overlay) overlay.remove();
            loadSquadData().then(() => render());
        }
        
        function renderLadder() {
            const currentMember = getCurrentMember();
            if (!currentMember) return '';
            
            const rankings = Object.values(members).sort((a, b) => b.points - a.points);
            const champion = rankings[0];
            const yourRank = rankings.findIndex(m => m.id === currentMemberId) + 1;
            
            // Calculate weekly stats
            const now = new Date();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay());
            startOfWeek.setHours(0, 0, 0, 0);
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 7);
            const daysLeft = Math.ceil((endOfWeek - now) / (1000 * 60 * 60 * 24));
            
            // Get this week's squad challenge
            const weekNumber = Math.floor((now - new Date(now.getFullYear(), 0, 1)) / (7 * 24 * 60 * 60 * 1000));
            const thisWeeksChallenge = weeklyChallenges[weekNumber % weeklyChallenges.length];
            
            // Filter challenges completed this week
            const weekChallenges = challenges.filter(c => {
                if (c.status !== 'completed' || !c.completed_at) return false;
                const completedDate = new Date(c.completed_at);
                return completedDate >= startOfWeek && completedDate < endOfWeek;
            });
            
            // Calculate weekly wins per member
            const weeklyWins = {};
            Object.values(members).forEach(m => { weeklyWins[m.id] = 0; });
            weekChallenges.forEach(c => {
                if (c.winner_id) weeklyWins[c.winner_id] = (weeklyWins[c.winner_id] || 0) + 1;
            });
            
            // Get recent battles (battle log) ‚Äî include forfeits
            const recentBattles = challenges
                .filter(c => (c.status === 'completed' || c.status === 'forfeited') && c.winner_id)
                .sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at))
                .slice(0, 10);
            
            // Find dramatic moments
            const streakBreaks = recentBattles.filter(c => {
                const loser = c.winner_id === c.challenger_id ? members[c.opponent_id] : members[c.challenger_id];
                return loser && c.loser_streak_broken > 0;
            });
            
            const closeCalls = recentBattles.filter(c => 
                c.votes_for_challenger === c.votes_for_opponent
            );
            
            // Calculate season info ‚Äî use v25 season_config if available
            var seasonNumber, daysLeftInSeason;
            if (seasonConfig && seasonConfig.ends_at) {
                seasonNumber = seasonConfig.season_number || 1;
                daysLeftInSeason = Math.max(0, Math.ceil((new Date(seasonConfig.ends_at) - now) / (24 * 60 * 60 * 1000)));
            } else {
                const yearStart = new Date(now.getFullYear(), 0, 1);
                const weekOfYear = Math.floor((now - yearStart) / (7 * 24 * 60 * 60 * 1000));
                seasonNumber = Math.floor(weekOfYear / 4) + 1;
                const seasonEndDate = new Date(yearStart.getTime() + (seasonNumber * 4 * 7 * 24 * 60 * 60 * 1000));
                daysLeftInSeason = Math.max(0, Math.ceil((seasonEndDate - now) / (24 * 60 * 60 * 1000)));
            }
            
            return `
                <div class="fade-in">
                    <!-- Season Header -->
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 0 20px; margin-bottom: 8px;">
                        <div class="section-title" style="margin: 0; padding: 0;">üëë SEASON ${seasonNumber} RANKINGS</div>
                        <div style="background: rgba(175, 82, 222, 0.15); border: 1px solid rgba(175, 82, 222, 0.3); border-radius: 12px; padding: 6px 10px;">
                            <span style="font-size: 12px; color: #AF52DE; font-weight: 700;">${daysLeftInSeason}d left</span>
                        </div>
                    </div>
                    <div style="background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 12px; overflow: hidden; margin-bottom: 24px;">
                        ${rankings.map((m, i) => {
                            const isYou = m.id === currentMemberId;
                            const isChamp = i === 0;
                            const weekWins = weeklyWins[m.id] || 0;
                            const allTimeWins = m.all_time_wins || 0;
                            const canChallenge = !isYou && !m.suspended;
                            const h2h = canChallenge ? getHeadToHead(currentMemberId, m.id) : null;
                            return `
                                <div style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; ${i > 0 ? 'border-top: 1px solid #2C2C2E;' : ''} ${isYou ? 'background: rgba(255, 215, 0, 0.1);' : ''} ${isChamp ? 'background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 165, 0, 0.05));' : ''}">
                                    <div style="font-size: 20px; font-weight: 900; color: ${isChamp ? '#FFD700' : '#8E8E93'}; width: 28px;">
                                        ${i === 0 ? 'üëë' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : i + 1}
                                    </div>
                                    <div style="font-size: 32px;">${m.avatar}</div>
                                    <div style="flex: 1;">
                                        <div style="font-size: 15px; font-weight: 600;">${m.name}${isYou ? ' (you)' : ''}${isChamp ? ' üèÜ' : ''}</div>
                                        <div style="font-size: 12px; color: #8E8E93;">
                                            ${m.streak > 0 ? 'üî• ' + m.streak + ' streak ‚Ä¢ ' : ''}
                                            ${h2h && h2h.total > 0 ? 'You ' + h2h.yourWins + '‚Äì' + h2h.theirWins + ' ‚Ä¢ ' : ''}
                                            ${allTimeWins > 0 ? allTimeWins + ' win' + (allTimeWins !== 1 ? 's' : '') : 'No wins yet'}
                                        </div>
                                    </div>
                                    <div style="text-align: right; margin-right: ${canChallenge ? '8px' : '0'};">
                                        <div style="font-size: 18px; font-weight: 700; color: #FFD700;">${m.points}</div>
                                        <div style="font-size: 11px; color: #8E8E93;">pts</div>
                                    </div>
                                    ${canChallenge ? `
                                        <button onclick="quickChallengeRival('${m.id}')" style="padding: 8px 12px; background: rgba(10, 132, 255, 0.15); border: 1px solid rgba(10, 132, 255, 0.3); border-radius: 8px; color: #0A84FF; font-size: 11px; font-weight: 700; cursor: pointer; white-space: nowrap;">‚öîÔ∏è DUEL</button>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- Weekly Squad Challenge with LIVE COUNTDOWN -->
                    <div style="background: linear-gradient(135deg, rgba(175, 82, 222, 0.2), rgba(255, 45, 85, 0.1)); border: 2px solid rgba(175, 82, 222, 0.4); border-radius: 16px; padding: 20px; margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 20px;">üéØ</span>
                                <span style="font-size: 12px; color: #AF52DE; font-weight: 700; letter-spacing: 1px;">WEEKLY SQUAD CHALLENGE</span>
                            </div>
                            <div style="text-align: right;">
                                <div id="weeklyCountdown" data-end="${endOfWeek.toISOString()}" style="font-size: 14px; font-weight: 700; color: ${daysLeft <= 1 ? '#FF9500' : '#AF52DE'}; ${daysLeft <= 1 ? 'animation: pulse 2s infinite;' : ''}">
                                    ${formatWeeklyCountdown(endOfWeek)}
                                </div>
                                <div style="font-size: 10px; color: #8E8E93;">remaining</div>
                            </div>
                        </div>
                        <div style="font-size: 18px; font-weight: 900; margin-bottom: 6px;">${thisWeeksChallenge.name}</div>
                        <div style="font-size: 13px; color: #8E8E93; margin-bottom: 8px;">${thisWeeksChallenge.desc}</div>
                        <div style="font-size: 11px; color: #AF52DE; margin-bottom: 12px;">All squad members compete ‚Ä¢ Participants vote ‚Ä¢ AI breaks ties</div>
                        <button class="btn btn-secondary" style="border-color: #AF52DE; color: #AF52DE;" onclick="startWeeklyChallenge()">
                            Submit Entry
                        </button>
                    </div>
                    
                    <!-- Battle Log (with volatile scoring) -->
                    <div class="section-title">‚öîÔ∏è BATTLE LOG</div>
                    ${recentBattles.length > 0 ? `
                        <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 24px;">
                            ${recentBattles.map(c => {
                                const winner = members[c.winner_id];
                                const loserId = c.winner_id === c.challenger_id ? c.opponent_id : c.challenger_id;
                                const loser = members[loserId];
                                const wasClose = c.votes_for_challenger === c.votes_for_opponent;
                                const wasDethrone = c.was_dethrone;
                                const wasForfeit = c.status === 'forfeited';
                                
                                // Determine the narrative
                                let badge = '';
                                
                                if (wasForfeit) {
                                    badge = '<span style="color: #FF9500; font-size: 11px; font-weight: 700;">‚ö†Ô∏è FORFEIT</span>';
                                } else if (wasDethrone) {
                                    badge = '<span style="color: #FF3B30; font-size: 11px; font-weight: 700;">üëë DETHRONED</span>';
                                } else if (wasClose) {
                                    badge = '<span style="color: #FF9500; font-size: 11px; font-weight: 700;">üéØ CLOSE CALL</span>';
                                }
                                
                                return `
                                    <div style="background: #1C1C1E; border-radius: 10px; padding: 12px 16px; display: flex; align-items: center; gap: 12px;">
                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <span style="font-size: 24px;">${winner?.avatar || 'üë§'}</span>
                                            <span style="font-size: 14px; color: #8E8E93;">${wasForfeit ? 'won vs' : 'beat'}</span>
                                            <span style="font-size: 24px;">${loser?.avatar || 'üë§'}</span>
                                        </div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 13px; font-weight: 600;">${c.challenge_type}</div>
                                            ${badge ? '<div style="margin-top: 2px;">' + badge + '</div>' : ''}
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 12px; color: #34C759; font-weight: 600;">+${WIN_POINTS}</div>
                                            <div style="font-size: 11px; color: #FF3B30;">${wasForfeit && c.forfeit_grace ? '' : '-' + LOSS_POINTS}</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : `
                        <div style="background: #1C1C1E; border-radius: 12px; padding: 24px; text-align: center; margin-bottom: 24px;">
                            <div style="font-size: 32px; margin-bottom: 12px;">üìú</div>
                            <div style="font-size: 14px; color: #8E8E93;">No battles yet. Start some chaos!</div>
                        </div>
                    `}
                </div>
            `;
        }
        
        // Keep old function names for backward compatibility
        function renderRankings() {
            return renderLadder();
        }
        
        function renderWeekly() {
            return renderLadder();
        }
        
        function challengeWeeklyLeader() {
            const rankings = Object.values(members).sort((a, b) => b.points - a.points);
            const leader = rankings[0];
            if (leader && leader.id !== currentMemberId) {
                selectedOpponent = leader.id;
                selectedChallenge = challengeLibrary[Math.floor(Math.random() * challengeLibrary.length)];
                screen = 'challenge-reveal';
                render();
            } else {
                showToast("You're already the leader!", 'info');
            }
        }
        
        function getStartOfWeek() {
            const now = new Date();
            const start = new Date(now);
            start.setDate(now.getDate() - now.getDay());
            start.setHours(0, 0, 0, 0);
            return start;
        }
        
        function renderProfile() {
            var me = getCurrentMember();
            if (!me) {
                return '<div style="padding: 40px; text-align: center; color: #8E8E93;">Profile not available</div>';
            }
            
            // Calculate stats
            var myWins = challenges.filter(c => c.status === 'completed' && c.winner_id === currentMemberId).length;
            var myLosses = challenges.filter(c => c.status === 'completed' && (c.challenger_id === currentMemberId || c.opponent_id === currentMemberId) && c.winner_id !== currentMemberId).length;
            var myForfeits = challenges.filter(c => c.status === 'forfeited' && (c.challenger_id === currentMemberId || c.opponent_id === currentMemberId)).length;
            var totalDuels = myWins + myLosses;
            var winRate = totalDuels > 0 ? Math.round((myWins / totalDuels) * 100) : 0;
            
            // Get ranking
            var sortedMembers = Object.values(members).sort((a, b) => b.points - a.points);
            var myRank = sortedMembers.findIndex(m => m.id === currentMemberId) + 1;
            
            // Get recent matches
            var recentMatches = challenges
                .filter(c => c.status === 'completed' && (c.challenger_id === currentMemberId || c.opponent_id === currentMemberId))
                .sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at))
                .slice(0, 10);
            
            // Get rivals (most frequent opponents)
            var opponentCounts = {};
            challenges.filter(c => c.status === 'completed' && (c.challenger_id === currentMemberId || c.opponent_id === currentMemberId))
                .forEach(c => {
                    var oppId = c.challenger_id === currentMemberId ? c.opponent_id : c.challenger_id;
                    if (!opponentCounts[oppId]) opponentCounts[oppId] = { wins: 0, losses: 0, total: 0 };
                    opponentCounts[oppId].total++;
                    if (c.winner_id === currentMemberId) {
                        opponentCounts[oppId].wins++;
                    } else {
                        opponentCounts[oppId].losses++;
                    }
                });
            
            var topRivals = Object.entries(opponentCounts)
                .sort((a, b) => b[1].total - a[1].total)
                .slice(0, 3);
            
            var html = '<div class="fade-in" style="padding-bottom: 32px;">';
            html += '<button class="back-btn" onclick="screen=\'arena\'; render();">‚Üê Back</button>';
            
            // Profile Header
            html += '<div style="text-align: center; padding: 20px 0 30px;">';
            html += '<div onclick="showEditAvatarModal()" style="font-size: 80px; margin-bottom: 12px; cursor: pointer; position: relative; display: inline-block;">';
            html += me.avatar;
            html += '<div style="position: absolute; bottom: 0; right: -10px; font-size: 20px; background: #1C1C1E; border-radius: 50%; padding: 4px;">‚úèÔ∏è</div>';
            html += '</div>';
            html += '<div onclick="showEditNameModal()" style="font-size: 28px; font-weight: 900; margin-bottom: 4px; cursor: pointer;">' + me.name + ' <span style="font-size: 16px; color: #8E8E93;">‚úèÔ∏è</span></div>';
            html += '<div style="font-size: 14px; color: #8E8E93;">';
            if (myRank === 1) {
                html += 'üëë Current Champion';
            } else {
                html += 'Rank #' + myRank + ' of ' + sortedMembers.length;
            }
            html += '</div>';
            html += '</div>';
            
            // Stats Grid
            html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 24px;">';
            html += '<div style="background: #1C1C1E; border-radius: 12px; padding: 16px; text-align: center;">';
            html += '<div style="font-size: 24px; font-weight: 900; color: #FFD700;">' + me.points + '</div>';
            html += '<div style="font-size: 10px; color: #8E8E93; text-transform: uppercase;">Points</div>';
            html += '</div>';
            html += '<div style="background: #1C1C1E; border-radius: 12px; padding: 16px; text-align: center;">';
            html += '<div style="font-size: 24px; font-weight: 900; color: #34C759;">' + myWins + '</div>';
            html += '<div style="font-size: 10px; color: #8E8E93; text-transform: uppercase;">Wins</div>';
            html += '</div>';
            html += '<div style="background: #1C1C1E; border-radius: 12px; padding: 16px; text-align: center;">';
            html += '<div style="font-size: 24px; font-weight: 900; color: #FF3B30;">' + myLosses + '</div>';
            html += '<div style="font-size: 10px; color: #8E8E93; text-transform: uppercase;">Losses</div>';
            html += '</div>';
            html += '<div style="background: #1C1C1E; border-radius: 12px; padding: 16px; text-align: center;">';
            html += '<div style="font-size: 24px; font-weight: 900; color: #FFFFFF;">' + winRate + '%</div>';
            html += '<div style="font-size: 10px; color: #8E8E93; text-transform: uppercase;">Win Rate</div>';
            html += '</div>';
            html += '</div>';
            
            // Streak & All-Time
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px;">';
            html += '<div style="background: linear-gradient(135deg, rgba(255, 149, 0, 0.15), rgba(255, 100, 0, 0.05)); border: 1px solid rgba(255, 149, 0, 0.3); border-radius: 12px; padding: 16px; text-align: center;">';
            html += '<div style="font-size: 28px; font-weight: 900; color: #FF9500;">' + (me.streak || 0) + '</div>';
            html += '<div style="font-size: 11px; color: #FF9500;">üî• Current Streak</div>';
            html += '</div>';
            html += '<div style="background: linear-gradient(135deg, rgba(175, 82, 222, 0.15), rgba(150, 50, 200, 0.05)); border: 1px solid rgba(175, 82, 222, 0.3); border-radius: 12px; padding: 16px; text-align: center;">';
            html += '<div style="font-size: 28px; font-weight: 900; color: #AF52DE;">' + (me.all_time_wins || myWins) + '</div>';
            html += '<div style="font-size: 11px; color: #AF52DE;">üèÜ All-Time Wins</div>';
            html += '</div>';
            html += '</div>';
            
            // Top Rivals
            if (topRivals.length > 0) {
                html += '<div class="section-title">‚öîÔ∏è Your Rivals</div>';
                html += '<div style="background: #1C1C1E; border-radius: 12px; overflow: hidden; margin-bottom: 24px;">';
                topRivals.forEach(function([oppId, stats], i) {
                    var opp = members[oppId];
                    if (!opp) return;
                    var winning = stats.wins > stats.losses;
                    var tied = stats.wins === stats.losses;
                    html += '<div style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; ' + (i > 0 ? 'border-top: 1px solid #2C2C2E;' : '') + '">';
                    html += '<div style="font-size: 32px;">' + opp.avatar + '</div>';
                    html += '<div style="flex: 1;">';
                    html += '<div style="font-size: 15px; font-weight: 600;">' + opp.name + '</div>';
                    html += '<div style="font-size: 12px; color: #8E8E93;">' + stats.total + ' duels</div>';
                    html += '</div>';
                    html += '<div style="text-align: right;">';
                    html += '<div style="font-size: 18px; font-weight: 900; color: ' + (winning ? '#34C759' : tied ? '#FFFFFF' : '#FF3B30') + ';">' + stats.wins + ' - ' + stats.losses + '</div>';
                    html += '<div style="font-size: 10px; color: #8E8E93;">' + (winning ? 'You lead' : tied ? 'Tied' : 'They lead') + '</div>';
                    html += '</div>';
                    html += '</div>';
                });
                html += '</div>';
            }
            
            // Recent Matches
            if (recentMatches.length > 0) {
                html += '<div class="section-title">üìú Recent Duels</div>';
                html += '<div style="background: #1C1C1E; border-radius: 12px; overflow: hidden; margin-bottom: 24px;">';
                recentMatches.forEach(function(c, i) {
                    var iWon = c.winner_id === currentMemberId;
                    var oppId = c.challenger_id === currentMemberId ? c.opponent_id : c.challenger_id;
                    var opp = members[oppId];
                    var timeAgo = getTimeAgo(new Date(c.completed_at));
                    html += '<div style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; ' + (i > 0 ? 'border-top: 1px solid #2C2C2E;' : '') + '">';
                    html += '<div style="width: 32px; text-align: center;">';
                    html += '<span style="font-size: 18px;">' + (iWon ? '‚úÖ' : '‚ùå') + '</span>';
                    html += '</div>';
                    html += '<div style="font-size: 24px;">' + (opp?.avatar || 'üë§') + '</div>';
                    html += '<div style="flex: 1;">';
                    html += '<div style="font-size: 14px; font-weight: 600;">' + (iWon ? 'Beat ' : 'Lost to ') + (opp?.name || '?') + '</div>';
                    html += '<div style="font-size: 11px; color: #8E8E93;">' + c.challenge_type + '</div>';
                    html += '</div>';
                    html += '<div style="font-size: 11px; color: #8E8E93;">' + timeAgo + '</div>';
                    html += '</div>';
                });
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }
        
        function showEditNameModal() {
            var me = getCurrentMember();
            showModal(
                '‚úèÔ∏è Edit Name',
                '<div style="text-align: center;">' +
                    '<input type="text" id="editNameInput" value="' + (me?.name || '').replace(/"/g, '&quot;') + '" maxlength="20" style="width: 100%; padding: 14px; background: #0A0A0C; border: 2px solid #2C2C2E; border-radius: 8px; color: #FFFFFF; font-size: 18px; font-weight: 700; text-align: center; margin-bottom: 16px;" />' +
                '</div>',
                'Cancel',
                'Save',
                async function() {
                    var newName = document.getElementById('editNameInput').value.trim();
                    if (!newName) {
                        showToast('Name cannot be empty', 'error');
                        return;
                    }
                    try {
                        await db.from('members').update({ name: newName }).eq('id', currentMemberId);
                        members[currentMemberId].name = newName;
                        closeModal();
                        render();
                        showToast('Name updated!', 'info');
                    } catch (err) {
                        showToast('Failed to update name', 'error');
                    }
                },
                function() { closeModal(); }
            );
        }
        
        function showEditAvatarModal() {
            var me = getCurrentMember();
            var avatarOptions = ['üë®', 'üë©', 'üë¶', 'üëß', 'üë¥', 'üëµ', 'üßë', 'üë∂', 'üßî', 'üë±', 'üßë‚Äçü¶∞', 'üßë‚Äçü¶±', 'üßë‚Äçü¶≥', 'üßë‚Äçü¶≤', 'ü•∑', 'ü¶∏', 'ü¶π', 'üßô', 'üßõ', 'üßú', 'üßù', 'üßû', 'üßü', 'üëª', 'ü§ñ', 'üëΩ', 'üéÖ', 'ü§¥', 'üë∏', 'ü§†', 'ü•∏', 'ü§°', 'üòé', 'ü•≥', 'ü§ì', 'üßê'];
            var skinTones = ['', 'üèª', 'üèº', 'üèΩ', 'üèæ', 'üèø'];
            
            var html = '<div style="text-align: center;">';
            html += '<div id="avatarPreviewEdit" style="font-size: 64px; margin-bottom: 16px;">' + (me?.avatar || 'üë§') + '</div>';
            html += '<div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; max-height: 200px; overflow-y: auto; padding: 8px; background: #0A0A0C; border-radius: 8px;">';
            avatarOptions.forEach(function(emoji) {
                html += '<div onclick="selectAvatarOption(\'' + emoji + '\')" style="font-size: 28px; padding: 8px; cursor: pointer; border-radius: 8px; background: rgba(255,255,255,0.05);">' + emoji + '</div>';
            });
            html += '</div>';
            html += '<div style="margin-top: 12px; font-size: 11px; color: #8E8E93;">Skin tone:</div>';
            html += '<div style="display: flex; gap: 8px; justify-content: center; margin-top: 8px;">';
            skinTones.forEach(function(tone, i) {
                html += '<div onclick="applySkinTone(\'' + tone + '\')" style="width: 32px; height: 32px; background: ' + (i === 0 ? '#FFD700' : '#8D5524') + '; border-radius: 50%; cursor: pointer; border: 2px solid #2C2C2E; opacity: ' + (0.4 + i * 0.12) + ';"></div>';
            });
            html += '</div>';
            html += '</div>';
            
            window._selectedAvatar = me?.avatar || 'üë§';
            
            showModal(
                '‚úèÔ∏è Change Avatar',
                html,
                'Cancel',
                'Save',
                async function() {
                    try {
                        await db.from('members').update({ avatar: window._selectedAvatar }).eq('id', currentMemberId);
                        members[currentMemberId].avatar = window._selectedAvatar;
                        closeModal();
                        render();
                        showToast('Avatar updated!', 'info');
                    } catch (err) {
                        showToast('Failed to update avatar', 'error');
                    }
                },
                function() { closeModal(); }
            );
        }
        
        function selectAvatarOption(emoji) {
            window._selectedAvatar = emoji;
            var preview = document.getElementById('avatarPreviewEdit');
            if (preview) preview.textContent = emoji;
        }
        
        function applySkinTone(tone) {
            // Get base emoji (first character or two)
            var base = window._selectedAvatar;
            if (base) {
                // Remove existing skin tone modifier if present
                base = base.replace(/[\u{1F3FB}-\u{1F3FF}]/gu, '');
                window._selectedAvatar = base + tone;
                var preview = document.getElementById('avatarPreviewEdit');
                if (preview) preview.textContent = window._selectedAvatar;
            }
        }
        
        function renderSettings() {
            var currentMember = getCurrentMember();
            var admin = null;
            var memberList = Object.values(members);
            memberList.forEach(function(m) { if (m.is_admin) admin = m; });
            var isAdmin = currentMember && currentMember.is_admin;
            var minorMembers = memberList.filter(function(m) { return m.is_minor; });
            
            // Activity log from challenges
            var recentActivity = challenges
                .filter(function(c) { return c.status === 'completed' && c.completed_at; })
                .sort(function(a, b) { return new Date(b.completed_at) - new Date(a.completed_at); })
                .slice(0, 15);
            
            var html = '<div class="fade-in">';
            html += '<button class="back-btn" onclick="screen=\'arena\'; render();">‚Üê Back</button>';
            html += '<div class="section-title">‚öôÔ∏è Squad Settings</div>';
            
            // Squad Info Card
            html += '<div style="background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 12px; padding: 20px; margin-bottom: 24px;">';
            html += '<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">';
            html += '<div style="font-size: 17px; font-weight: 600;">' + (squad ? squad.name : 'Squad') + '</div>';
            if (isAdmin) {
                html += '<button onclick="renameSquad()" style="background: none; border: 1px solid #3C3C3E; color: #8E8E93; font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 6px; cursor: pointer;">Rename</button>';
            }
            html += '</div>';
            html += '<div style="font-size: 13px; color: #8E8E93; margin-bottom: 4px;">Admin: ' + (admin ? admin.name : 'Unknown') + '</div>';
            html += '<div style="font-size: 13px; color: #8E8E93;">Members: ' + Object.keys(members).length + '</div>';
            html += '</div>';
            
            // Squad Code & Invite (moved here from Ladder)
            html += '<div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 165, 0, 0.05)); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 24px;">';
            html += '<div style="font-size: 15px; font-weight: 600; margin-bottom: 12px; color: #FFD700;">üì≤ Invite Members</div>';
            html += '<div style="font-size: 28px; font-weight: 900; letter-spacing: 6px; color: #FFD700; margin-bottom: 12px; text-align: center;">' + squadCode + '</div>';
            html += '<button class="btn btn-primary" style="margin-bottom: 8px;" onclick="shareInvite()">üì± Send Invite via Text</button>';
            html += '<button class="btn btn-secondary" onclick="copyCode(\'' + squadCode + '\')">üìã Copy Squad Code</button>';
            html += '</div>';
            
            // v25: Season Config (Admin only)
            if (isAdmin) {
                var sc = seasonConfig || {};
                var scLen = sc.season_length || '3wk';
                var scCad = sc.challenge_cadence || 'mwf';
                var scResp = sc.response_window || '24h';
                var scVote = sc.voting_window || '8h';
                
                html += '<div style="background: rgba(175,82,222,.06); border: 2px solid rgba(175,82,222,.2); border-radius: 12px; padding: 20px; margin-bottom: 24px;">';
                html += '<div style="font-size: 15px; font-weight: 700; color: #AF52DE; margin-bottom: 4px;">üèÜ Season Config</div>';
                html += '<div style="font-size: 11px; color: #6E6E73; margin-bottom: 16px;">Configure how the current season runs.</div>';
                
                // Season Length
                html += '<div style="margin-bottom: 14px;">';
                html += '<div style="font-size: 12px; font-weight: 700; color: #8E8E93; margin-bottom: 6px;">Season Length</div>';
                html += '<div style="display: flex; gap: 4px; flex-wrap: wrap;">';
                [['4d','4 days'],['1wk','1 week'],['2wk','2 weeks'],['3wk','3 weeks'],['4wk','4 weeks'],['6wk','6 weeks']].forEach(function(opt) {
                    var active = scLen === opt[0];
                    html += '<button onclick="updateSeasonField(\'season_length\',\'' + opt[0] + '\')" style="padding: 6px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; background: ' + (active ? '#AF52DE' : '#2C2C2E') + '; color: ' + (active ? '#FFF' : '#8E8E93') + '; border: none; cursor: pointer;">' + opt[1] + '</button>';
                });
                html += '</div></div>';
                
                // Challenge Cadence
                html += '<div style="margin-bottom: 14px;">';
                html += '<div style="font-size: 12px; font-weight: 700; color: #8E8E93; margin-bottom: 6px;">Squad Challenge Drops</div>';
                html += '<div style="display: flex; gap: 4px; flex-wrap: wrap;">';
                [['2xday','2√ó / day'],['1xday','1√ó / day'],['mwf','Mon Wed Fri'],['eod','Every other day']].forEach(function(opt) {
                    var active = scCad === opt[0];
                    html += '<button onclick="updateSeasonField(\'challenge_cadence\',\'' + opt[0] + '\')" style="padding: 6px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; background: ' + (active ? '#AF52DE' : '#2C2C2E') + '; color: ' + (active ? '#FFF' : '#8E8E93') + '; border: none; cursor: pointer;">' + opt[1] + '</button>';
                });
                html += '</div></div>';
                
                // Response Window
                html += '<div style="margin-bottom: 14px;">';
                html += '<div style="font-size: 12px; font-weight: 700; color: #8E8E93; margin-bottom: 6px;">Response Window</div>';
                html += '<div style="display: flex; gap: 4px;">';
                [['4h','4 hrs'],['6h','6 hrs'],['8h','8 hrs'],['12h','12 hrs'],['24h','24 hrs']].forEach(function(opt) {
                    var active = scResp === opt[0];
                    html += '<button onclick="updateSeasonField(\'response_window\',\'' + opt[0] + '\')" style="padding: 6px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; background: ' + (active ? '#AF52DE' : '#2C2C2E') + '; color: ' + (active ? '#FFF' : '#8E8E93') + '; border: none; cursor: pointer;">' + opt[1] + '</button>';
                });
                html += '</div></div>';
                
                // Voting Window
                html += '<div style="margin-bottom: 14px;">';
                html += '<div style="font-size: 12px; font-weight: 700; color: #8E8E93; margin-bottom: 6px;">Voting Window</div>';
                html += '<div style="display: flex; gap: 4px;">';
                [['2h','2 hrs'],['4h','4 hrs'],['8h','8 hrs']].forEach(function(opt) {
                    var active = scVote === opt[0];
                    html += '<button onclick="updateSeasonField(\'voting_window\',\'' + opt[0] + '\')" style="padding: 6px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; background: ' + (active ? '#AF52DE' : '#2C2C2E') + '; color: ' + (active ? '#FFF' : '#8E8E93') + '; border: none; cursor: pointer;">' + opt[1] + '</button>';
                });
                html += '</div></div>';
                
                // Callouts note
                html += '<div style="background: rgba(255,255,255,.03); border-radius: 8px; padding: 10px; border: 1px solid rgba(255,255,255,.05); margin-bottom: 10px;">';
                html += '<div style="font-size: 11px; color: #8E8E93;">‚öîÔ∏è <strong style="color: #E5E5EA;">1v1 Callouts</strong> ‚Äî always available, anytime. Not affected by cadence.</div>';
                html += '</div>';
                
                // Trip Mode preset
                html += '<button onclick="applyTripMode()" style="width: 100%; padding: 12px; border-radius: 8px; background: linear-gradient(135deg,rgba(255,149,0,.1),rgba(255,69,0,.08)); border: 1px solid rgba(255,149,0,.3); color: #FF9500; font-size: 12px; font-weight: 700; cursor: pointer;">üéø Trip Mode ‚Äî 4 days, 2√ó/day, fast windows</button>';
                
                html += '</div>';
            }
            
            // Members List
            html += '<div class="section-title">üë• Members</div>';
            memberList.forEach(function(m) {
                var isYou = m.id === currentMemberId;
                var statusBadge = '';
                if (m.is_minor) statusBadge = '<span style="font-size: 11px; background: rgba(0, 122, 255, 0.2); color: #007AFF; padding: 2px 6px; border-radius: 4px; margin-left: 8px;">Minor</span>';
                if (m.suspended) statusBadge = '<span style="font-size: 11px; background: rgba(255, 59, 48, 0.2); color: #FF3B30; padding: 2px 6px; border-radius: 4px; margin-left: 8px;">Suspended</span>';
                
                html += '<div style="background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 12px; padding: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 12px;">';
                html += '<div style="font-size: 32px;">' + m.avatar + '</div>';
                html += '<div style="flex: 1;">';
                html += '<div style="font-size: 17px; font-weight: 600;">' + m.name + (isYou ? ' (You)' : '') + (m.is_admin ? ' üëë' : '') + statusBadge + '</div>';
                html += '<div style="font-size: 13px; color: #8E8E93;">' + m.points + ' pts' + (m.age ? ' ‚Ä¢ Age: ' + m.age : '') + '</div>';
                html += '</div>';
                
                // Admin controls for non-admin members
                if (isAdmin && !m.is_admin && !isYou) {
                    html += '<div style="display: flex; gap: 6px; flex-wrap: wrap;">';
                    if (m.suspended) {
                        html += '<button onclick="toggleSuspend(\'' + m.id + '\', false)" style="background: rgba(52, 199, 89, 0.2); border: 1px solid #34C759; color: #34C759; font-size: 11px; font-weight: 700; padding: 6px 10px; border-radius: 6px; cursor: pointer;">Unsuspend</button>';
                    } else {
                        html += '<button onclick="toggleSuspend(\'' + m.id + '\', true)" style="background: rgba(255, 59, 48, 0.1); border: 1px solid rgba(255, 59, 48, 0.3); color: #FF3B30; font-size: 11px; font-weight: 700; padding: 6px 10px; border-radius: 6px; cursor: pointer;">Suspend</button>';
                    }
                    html += '<button onclick="resetMemberPin(\'' + m.id + '\')" style="background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); color: #FFD700; font-size: 11px; font-weight: 700; padding: 6px 10px; border-radius: 6px; cursor: pointer;">Reset PIN</button>';
                    html += '<button onclick="removeMember(\'' + m.id + '\', \'' + (m.name || '').replace(/'/g, "\\'") + '\')" style="background: rgba(255, 59, 48, 0.05); border: 1px solid rgba(255, 59, 48, 0.2); color: #FF3B30; font-size: 11px; font-weight: 700; padding: 6px 10px; border-radius: 6px; cursor: pointer;">Remove</button>';
                    html += '</div>';
                }
                
                html += '</div>';
            });
            
            // Admin Panel (only visible to admin)
            if (isAdmin) {
                html += '<div class="section-title" style="margin-top: 24px;">üõ°Ô∏è Admin Panel</div>';
                
                // Season Management
                html += '<div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 165, 0, 0.05)); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 16px;">';
                html += '<div style="font-size: 13px; color: #FFD700; font-weight: 700; margin-bottom: 8px;">üèÜ Season Management</div>';
                html += '<p style="font-size: 12px; color: #8E8E93; margin-bottom: 12px;">Start fresh: resets all points, streaks, and the crown. All-time wins are preserved.</p>';
                html += '<button onclick="resetSeason()" style="width: 100%; padding: 12px; background: rgba(255, 59, 48, 0.1); border: 1px solid rgba(255, 59, 48, 0.3); border-radius: 8px; color: #FF3B30; font-size: 13px; font-weight: 700; cursor: pointer;">üîÑ Start New Season</button>';
                html += '</div>';
                
                // Minor Accounts Summary
                if (minorMembers.length > 0) {
                    html += '<div style="background: rgba(0, 122, 255, 0.1); border: 2px solid rgba(0, 122, 255, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 16px;">';
                    html += '<div style="font-size: 13px; color: #007AFF; font-weight: 700; margin-bottom: 8px;">üë∂ Minor Accounts (' + minorMembers.length + ')</div>';
                    minorMembers.forEach(function(m) {
                        html += '<div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-top: 1px solid rgba(0, 122, 255, 0.15);">';
                        html += '<div style="display: flex; align-items: center; gap: 8px;">';
                        html += '<span style="font-size: 20px;">' + m.avatar + '</span>';
                        html += '<span style="font-size: 14px; font-weight: 600;">' + m.name + '</span>';
                        html += '<span style="font-size: 12px; color: #8E8E93;">(Age: ' + (m.age || '?') + ')</span>';
                        html += '</div>';
                        html += '<span style="font-size: 12px; color: ' + (m.suspended ? '#FF3B30' : '#34C759') + '; font-weight: 600;">' + (m.suspended ? 'Suspended' : 'Active') + '</span>';
                        html += '</div>';
                    });
                    html += '</div>';
                }
                
                // Activity Log
                html += '<div style="background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 12px; padding: 16px; margin-bottom: 16px;">';
                html += '<div style="font-size: 13px; color: #8E8E93; font-weight: 700; letter-spacing: 1px; margin-bottom: 12px;">üìã ACTIVITY LOG</div>';
                if (recentActivity.length > 0) {
                    recentActivity.forEach(function(c, i) {
                        var challenger = members[c.challenger_id];
                        var opponent = members[c.opponent_id];
                        var winner = members[c.winner_id];
                        var loserId = c.winner_id === c.challenger_id ? c.opponent_id : c.challenger_id;
                        var loser = members[loserId];
                        var timeAgo = getTimeAgo(new Date(c.completed_at));
                        html += '<div style="padding: 8px 0; ' + (i > 0 ? 'border-top: 1px solid #2C2C2E;' : '') + ' font-size: 13px;">';
                        html += '<div style="display: flex; justify-content: space-between; align-items: center;">';
                        html += '<span>' + (winner ? winner.avatar : '?') + ' ' + (winner ? winner.name : '?') + ' beat ' + (loser ? loser.avatar : '?') + ' ' + (loser ? loser.name : '?') + '</span>';
                        html += '<span style="font-size: 11px; color: #8E8E93;">' + timeAgo + '</span>';
                        html += '</div>';
                        html += '<div style="font-size: 11px; color: #8E8E93; margin-top: 2px;">' + c.challenge_type + '</div>';
                        html += '</div>';
                    });
                } else {
                    html += '<div style="text-align: center; padding: 16px; color: #8E8E93; font-size: 13px;">No activity yet</div>';
                }
                html += '</div>';
            }
            
            // Notifications
            html += '<div class="section-title" style="margin-top: 24px;">üîî Notifications</div>';
            html += '<div style="background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 12px; padding: 16px; margin-bottom: 16px;">';
            if (!pushSupported) {
                html += '<p style="font-size: 13px; color: #8E8E93;">Push notifications require HTTPS. Host the app on a live URL to enable.</p>';
            } else if (Notification.permission === 'granted') {
                var isMuted = localStorage.getItem('notifMuted') === 'true';
                html += '<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">';
                html += '<div>';
                html += '<div style="font-size: 14px; font-weight: 600;">Push Notifications</div>';
                html += '<div style="font-size: 12px; color: #8E8E93;">Challenges, results, streaks</div>';
                html += '</div>';
                html += '<button onclick="toggleNotifMute()" style="padding: 8px 16px; background: ' + (isMuted ? 'rgba(255, 59, 48, 0.1)' : 'rgba(52, 199, 89, 0.1)') + '; border: 1px solid ' + (isMuted ? 'rgba(255, 59, 48, 0.3)' : 'rgba(52, 199, 89, 0.3)') + '; border-radius: 8px; color: ' + (isMuted ? '#FF3B30' : '#34C759') + '; font-size: 13px; font-weight: 700; cursor: pointer;">' + (isMuted ? 'Muted' : 'Active') + '</button>';
                html += '</div>';
                if (isMuted) {
                    html += '<p style="font-size: 11px; color: #FF9500;">Notifications are muted. You won\'t get push alerts.</p>';
                }
            } else if (Notification.permission === 'denied') {
                html += '<p style="font-size: 13px; color: #FF3B30;">Notifications blocked. Enable in your browser settings.</p>';
            } else {
                html += '<button onclick="handleEnableNotifications()" style="width: 100%; padding: 12px; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px; color: #FFD700; font-size: 13px; font-weight: 700; cursor: pointer;">Enable Notifications</button>';
            }
            html += '</div>';
            
            // Push Diagnostics (collapsible)
            html += '<div style="background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 12px; padding: 16px; margin-bottom: 16px;">';
            html += '<div onclick="togglePushDiagnostics()" style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">';
            html += '<div style="font-size: 13px; font-weight: 600; color: #8E8E93;">üîß Push Diagnostics</div>';
            html += '<span id="diagChevron" style="color: #8E8E93; font-size: 12px;">‚ñº</span>';
            html += '</div>';
            html += '<div id="pushDiagnostics" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid #2C2C2E;">';
            html += '<div style="font-size: 11px; font-family: monospace; color: #8E8E93; line-height: 1.8;">';
            html += '<div>Browser Support: <span style="color: ' + (pushSupported ? '#34C759' : '#FF3B30') + ';">' + (pushSupported ? '‚úì Yes' : '‚úó No') + '</span></div>';
            html += '<div>Permission: <span style="color: ' + (Notification.permission === 'granted' ? '#34C759' : '#FF9500') + ';">' + Notification.permission + '</span></div>';
            html += '<div>Subscription: <span id="diagSubStatus" style="color: #FF9500;">checking...</span></div>';
            html += '<div>Member ID: <span style="color: #0A84FF;">' + (currentMemberId || 'none').substring(0, 8) + '...</span></div>';
            html += '<div>Squad ID: <span style="color: #0A84FF;">' + (squadId || 'none').substring(0, 8) + '...</span></div>';
            html += '</div>';
            html += '<div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">';
            html += '<button onclick="testPushNotification()" style="padding: 8px 12px; background: rgba(0, 122, 255, 0.1); border: 1px solid rgba(0, 122, 255, 0.3); border-radius: 6px; color: #0A84FF; font-size: 11px; font-weight: 600; cursor: pointer;">Send Test Push</button>';
            html += '<button onclick="checkPushSubscription()" style="padding: 8px 12px; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 6px; color: #FFD700; font-size: 11px; font-weight: 600; cursor: pointer;">Check DB Status</button>';
            html += '<button onclick="resubscribePush()" style="padding: 8px 12px; background: rgba(52, 199, 89, 0.1); border: 1px solid rgba(52, 199, 89, 0.3); border-radius: 6px; color: #34C759; font-size: 11px; font-weight: 600; cursor: pointer;">Re-subscribe</button>';
            html += '</div>';
            html += '<div id="diagOutput" style="margin-top: 12px; padding: 8px; background: #0A0A0C; border-radius: 6px; font-size: 10px; font-family: monospace; color: #8E8E93; display: none; max-height: 150px; overflow-y: auto;"></div>';
            html += '</div>';
            html += '</div>';
            
            // Change PIN (for current user)
            html += '<div class="section-title" style="margin-top: 24px;">üîë Your PIN</div>';
            html += '<div style="background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 12px; padding: 16px; margin-bottom: 16px;">';
            html += '<p style="font-size: 13px; color: #8E8E93; margin-bottom: 12px;">Your PIN is used to sign back in on new devices.</p>';
            html += '<div style="display: flex; gap: 12px;">';
            html += '<input type="tel" id="newPinInput" placeholder="New 4-digit PIN" maxlength="4" inputmode="numeric" pattern="[0-9]*" style="flex: 1; padding: 12px; background: #0A0A0C; border: 1px solid #2C2C2E; border-radius: 8px; color: #FFFFFF; font-size: 16px; font-weight: 700; text-align: center; letter-spacing: 8px;" />';
            html += '<button onclick="changeMyPin()" style="background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); color: #FFD700; font-size: 13px; font-weight: 700; padding: 12px 16px; border-radius: 8px; cursor: pointer; white-space: nowrap;">Update</button>';
            html += '</div>';
            html += '</div>';
            
            // Terms & Legal
            html += '<div class="section-title" style="margin-top: 24px;">üìú Terms & Legal</div>';
            html += '<div style="background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 12px; padding: 16px; margin-bottom: 16px;">';
            html += '<button onclick="showTermsModal()" style="width: 100%; background: none; border: none; color: #FFFFFF; font-size: 14px; font-weight: 600; padding: 10px 0; cursor: pointer; text-align: left; display: flex; justify-content: space-between; align-items: center;">';
            html += '<span>üìÑ Terms of Service</span><span style="color: #8E8E93;">‚Üí</span></button>';
            html += '<div style="border-top: 1px solid #2C2C2E;"></div>';
            html += '<button onclick="showPrivacyModal()" style="width: 100%; background: none; border: none; color: #FFFFFF; font-size: 14px; font-weight: 600; padding: 10px 0; cursor: pointer; text-align: left; display: flex; justify-content: space-between; align-items: center;">';
            html += '<span>üîí Privacy Policy</span><span style="color: #8E8E93;">‚Üí</span></button>';
            html += '<div style="border-top: 1px solid #2C2C2E;"></div>';
            html += '<button onclick="showCOPPAModal()" style="width: 100%; background: none; border: none; color: #FFFFFF; font-size: 14px; font-weight: 600; padding: 10px 0; cursor: pointer; text-align: left; display: flex; justify-content: space-between; align-items: center;">';
            html += '<span>üë∂ COPPA & Child Safety</span><span style="color: #8E8E93;">‚Üí</span></button>';
            html += '</div>';
            
            html += '<div style="padding: 12px; text-align: center; font-size: 11px; color: #8E8E93; margin-bottom: 16px;">';
            html += 'By using VERSUS you agree to the Terms of Service and Privacy Policy.<br>All user-generated content is the sole responsibility of the user who posted it.';
            html += '</div>';
            
            // Leave Squad
            html += '<div style="margin-top: 16px; margin-bottom: 32px;">';
            html += '<button class="btn btn-secondary" style="border-color: #FF3B30; color: #FF3B30;" onclick="handleLogout()">Leave Squad</button>';
            html += '</div>';
            
            html += '</div>';
            return html;
        }
        
        async function toggleSuspend(memberId, suspend) {
            var member = members[memberId];
            if (!member) return;
            var action = suspend ? 'suspend' : 'unsuspend';
            if (!confirm('Are you sure you want to ' + action + ' ' + member.name + '?')) return;
            
            try {
                await db
                    .from('members')
                    .update({ suspended: suspend })
                    .eq('id', memberId);
                
                await loadSquadData();
                render();
                showToast((suspend ? 'üö´' : '‚úÖ') + ' ' + member.name + ' has been ' + action + 'ed', 'info');
            } catch (err) {
                console.error('Failed to ' + action + ':', err);
                alert('Failed to ' + action + ' member');
            }
        }
        
        async function removeMember(memberId, memberName) {
            if (!confirm('Remove ' + memberName + ' from the squad?\n\nThis will delete their profile, stats, and challenge history. This cannot be undone.')) return;
            if (!confirm('Are you really sure? All of ' + memberName + '\'s data will be permanently deleted.')) return;
            
            try {
                // Delete their push subscription first
                await db
                    .from('push_subscriptions')
                    .delete()
                    .eq('member_id', memberId);
                
                // Delete their push logs
                await db
                    .from('push_log')
                    .delete()
                    .eq('member_id', memberId);
                
                // Delete challenges they were part of
                await db
                    .from('challenges')
                    .delete()
                    .or('challenger_id.eq.' + memberId + ',opponent_id.eq.' + memberId);
                
                // Delete the member
                await db
                    .from('members')
                    .delete()
                    .eq('id', memberId);
                
                await loadSquadData();
                render();
                showToast('üóëÔ∏è ' + memberName + ' has been removed', 'info');
            } catch (err) {
                console.error('Failed to remove member:', err);
                alert('Failed to remove member. Error: ' + err.message);
            }
        }
        
        async function resetSeason() {
            if (!confirm('Start a new season?\n\nThis will reset:\n‚Ä¢ All points to 0\n‚Ä¢ All streaks to 0\n‚Ä¢ All pending challenges\n‚Ä¢ The crown\n\nAll-time wins and completed challenges are preserved.')) return;
            if (!confirm('Are you sure? This affects everyone in the squad and cannot be undone.')) return;
            
            try {
                // Use v25 season system
                var config = seasonConfig || {};
                await startNewSeason({
                    season_length: config.season_length || '3wk',
                    challenge_cadence: config.challenge_cadence || 'mwf',
                    response_window: config.response_window || '24h',
                    voting_window: config.voting_window || '8h',
                });
                
                // Notify all other members
                triggerPushNotification('season_reset', null, squadId, { admin_id: currentMemberId });
                
                showModal(
                    'üèÜ New Season Started!',
                    '<div style="text-align: center;">' +
                        '<div style="font-size: 64px; margin-bottom: 16px;">üéâ</div>' +
                        '<p style="margin-bottom: 16px;">All points, streaks, and pending challenges have been reset.</p>' +
                        '<p style="font-size: 13px; color: #8E8E93;">Season ' + (seasonConfig?.season_number || '?') + ' is live. The crown is up for grabs.</p>' +
                    '</div>',
                    null,
                    'Let\'s Go!',
                    function() { closeModal(); }
                );
            } catch (err) {
                console.error('Failed to reset season:', err);
                alert('Failed to reset season. Error: ' + err.message);
            }
        }
        
        async function resetMemberPin(memberId) {
            var member = members[memberId];
            if (!member) return;
            
            // Generate a random 4-digit temp PIN
            var tempPin = String(Math.floor(1000 + Math.random() * 9000));
            
            try {
                await db
                    .from('members')
                    .update({ pin: tempPin })
                    .eq('id', memberId);
                
                await loadSquadData();
                
                showModal(
                    'üîë PIN Reset',
                    '<div style="text-align: center;">' +
                        '<p style="margin-bottom: 16px;">' + member.name + '\'s temporary PIN:</p>' +
                        '<div style="font-size: 36px; font-weight: 900; letter-spacing: 12px; color: #FFD700; margin-bottom: 16px; padding: 16px; background: #1C1C1E; border-radius: 12px;">' + tempPin + '</div>' +
                        '<p style="font-size: 13px; color: #8E8E93;">Share this with ' + member.name + ' so they can sign back in. They can change it in Settings afterwards.</p>' +
                    '</div>',
                    null,
                    'Done',
                    function() { closeModal(); }
                );
            } catch (err) {
                console.error('Failed to reset PIN:', err);
                alert('Failed to reset PIN');
            }
        }
        
        async function changeMyPin() {
            var newPin = document.getElementById('newPinInput').value.trim();
            
            if (!newPin || newPin.length !== 4 || !/^\d{4}$/.test(newPin)) {
                alert('Please enter a valid 4-digit PIN');
                return;
            }
            
            try {
                await db
                    .from('members')
                    .update({ pin: newPin })
                    .eq('id', currentMemberId);
                
                await loadSquadData();
                showToast('üîë PIN updated', 'info');
                document.getElementById('newPinInput').value = '';
            } catch (err) {
                console.error('Failed to change PIN:', err);
                alert('Failed to update PIN');
            }
        }
        
        async function toggleNotifMute() {
            var isMuted = localStorage.getItem('notifMuted') === 'true';
            localStorage.setItem('notifMuted', isMuted ? 'false' : 'true');
            
            if (currentMemberId) {
                if (isMuted) {
                    // Turning ON ‚Äî re-subscribe to ensure we have a valid subscription
                    await subscribeToPush();
                    db.from('push_subscriptions')
                        .update({ muted: false })
                        .eq('member_id', currentMemberId)
                        .then(function() { console.log('Unmuted'); });
                } else {
                    // Turning OFF ‚Äî just update muted flag
                    db.from('push_subscriptions')
                        .update({ muted: true })
                        .eq('member_id', currentMemberId)
                        .then(function() { console.log('Muted'); });
                }
            }
            
            render();
            showToast(isMuted ? 'üîî Notifications enabled' : 'üîá Notifications muted', 'info');
        }
        
        // Push Diagnostics Functions
        function togglePushDiagnostics() {
            var diag = document.getElementById('pushDiagnostics');
            var chevron = document.getElementById('diagChevron');
            if (diag) {
                var isHidden = diag.style.display === 'none';
                diag.style.display = isHidden ? 'block' : 'none';
                if (chevron) chevron.textContent = isHidden ? '‚ñ≤' : '‚ñº';
                if (isHidden) checkPushSubscriptionStatus();
            }
        }
        
        async function checkPushSubscriptionStatus() {
            var statusEl = document.getElementById('diagSubStatus');
            if (!statusEl) return;
            
            try {
                // Check local subscription
                if ('serviceWorker' in navigator) {
                    var reg = await navigator.serviceWorker.ready;
                    var sub = await reg.pushManager.getSubscription();
                    if (sub) {
                        statusEl.textContent = '‚úì Active locally';
                        statusEl.style.color = '#34C759';
                    } else {
                        statusEl.textContent = '‚úó No local subscription';
                        statusEl.style.color = '#FF3B30';
                    }
                }
            } catch (err) {
                statusEl.textContent = '‚úó Error: ' + err.message;
                statusEl.style.color = '#FF3B30';
            }
        }
        
        async function checkPushSubscription() {
            var output = document.getElementById('diagOutput');
            if (output) {
                output.style.display = 'block';
                output.innerHTML = 'Checking database...\n';
            }
            
            try {
                var { data, error } = await db
                    .from('push_subscriptions')
                    .select('*')
                    .eq('member_id', currentMemberId);
                
                if (error) {
                    output.innerHTML += '‚ùå DB Error: ' + error.message + '\n';
                    return;
                }
                
                if (!data || data.length === 0) {
                    output.innerHTML += '‚ùå No subscription found in DB for this member\n';
                    output.innerHTML += '‚Üí Try clicking "Re-subscribe"\n';
                } else {
                    output.innerHTML += '‚úÖ Found ' + data.length + ' subscription(s) in DB\n';
                    data.forEach(function(sub, i) {
                        output.innerHTML += '\n--- Subscription ' + (i+1) + ' ---\n';
                        output.innerHTML += 'ID: ' + sub.id.substring(0, 8) + '...\n';
                        output.innerHTML += 'Muted: ' + (sub.muted ? 'Yes' : 'No') + '\n';
                        output.innerHTML += 'Created: ' + new Date(sub.created_at).toLocaleString() + '\n';
                        output.innerHTML += 'Endpoint: ' + (sub.endpoint ? sub.endpoint.substring(0, 50) + '...' : 'none') + '\n';
                    });
                }
            } catch (err) {
                output.innerHTML += '‚ùå Error: ' + err.message + '\n';
            }
        }
        
        async function testPushNotification() {
            var output = document.getElementById('diagOutput');
            if (output) {
                output.style.display = 'block';
                output.innerHTML = 'Sending test push...\n';
            }
            
            try {
                var edgeUrl = SUPABASE_URL + '/functions/v1/send-push';
                var response = await fetch(edgeUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + SUPABASE_ANON_KEY
                    },
                    body: JSON.stringify({
                        type: 'test',
                        squad_id: squadId,
                        target_member_id: currentMemberId,
                        test_message: 'Test notification from VERSUS'
                    })
                });
                
                var result = await response.json();
                output.innerHTML += 'Response status: ' + response.status + '\n';
                output.innerHTML += 'Response: ' + JSON.stringify(result, null, 2) + '\n';
                
                if (response.ok) {
                    output.innerHTML += '\n‚úÖ Push sent! Check your device.\n';
                    output.innerHTML += '(May take a few seconds to arrive)\n';
                } else {
                    output.innerHTML += '\n‚ùå Push failed. Check edge function logs.\n';
                }
            } catch (err) {
                output.innerHTML += '‚ùå Error: ' + err.message + '\n';
            }
        }
        
        async function resubscribePush() {
            var output = document.getElementById('diagOutput');
            if (output) {
                output.style.display = 'block';
                output.innerHTML = 'Re-subscribing...\n';
            }
            
            try {
                // First unsubscribe
                if ('serviceWorker' in navigator) {
                    var reg = await navigator.serviceWorker.ready;
                    var existingSub = await reg.pushManager.getSubscription();
                    if (existingSub) {
                        await existingSub.unsubscribe();
                        output.innerHTML += 'Unsubscribed from old subscription\n';
                    }
                }
                
                // Delete from DB
                await db
                    .from('push_subscriptions')
                    .delete()
                    .eq('member_id', currentMemberId);
                output.innerHTML += 'Deleted old DB entries\n';
                
                // Re-subscribe
                await subscribeToPush();
                output.innerHTML += '‚úÖ Re-subscribed successfully!\n';
                
                // Verify
                await checkPushSubscription();
                
            } catch (err) {
                output.innerHTML += '‚ùå Error: ' + err.message + '\n';
            }
        }
        
        // Direct Edge Function call (bypasses pg_net which doesn't work on free tier)
        function triggerPushNotification(type, challengeId, squadId, extraData) {
            var edgeUrl = SUPABASE_URL + '/functions/v1/send-push';
            
            var payload = {
                type: type,
                challenge_id: challengeId,
                squad_id: squadId
            };
            
            // Merge extra data if provided
            if (extraData) {
                Object.keys(extraData).forEach(function(key) {
                    payload[key] = extraData[key];
                });
            }
            
            fetch(edgeUrl, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + SUPABASE_ANON_KEY
                },
                body: JSON.stringify(payload)
            })
            .then(function(res) { return res.json(); })
            .then(function(data) { 
                console.log('üì§ Push notification triggered:', type, data); 
            })
            .catch(function(err) { 
                console.error('Push trigger failed:', err); 
            });
        }
        
        function renameSquad() {
            var newName = prompt('Enter new squad name:', squad ? squad.name : '');
            if (!newName || !newName.trim()) return;
            newName = newName.trim();
            
            db.from('squads')
                .update({ name: newName })
                .eq('id', squadId)
                .then(function(result) {
                    if (result.error) {
                        alert('Failed to rename squad');
                        return;
                    }
                    squad.name = newName;
                    render();
                    showToast('‚úÖ Squad renamed to ' + newName, 'info');
                });
        }
        
        function showTermsModal() {
            showModal(
                'üìÑ Terms of Service',
                '<div style="max-height: 60vh; overflow-y: auto; font-size: 12px; color: #A1A1A6; line-height: 1.6; text-align: left;">' +
                '<p style="font-weight: 700; color: #FFFFFF; margin-bottom: 8px;">VERSUS Terms of Service</p>' +
                '<p style="margin-bottom: 8px;">Last updated: ' + new Date().toLocaleDateString() + '</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">1. ACCEPTANCE.</strong> By creating an account or using VERSUS ("the App"), you agree to these Terms. If you are under 18, your parent or legal guardian must agree on your behalf and supervise your use.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">2. USER-GENERATED CONTENT (UGC).</strong> You retain ownership of content you submit. By posting, you grant VERSUS a non-exclusive, royalty-free, worldwide license to display, distribute, and moderate your content within the App. You are solely responsible for all content you upload. You represent that you have the right to share such content and that it does not violate any law or third-party right.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">3. PROHIBITED CONTENT.</strong> You may not post content that is: obscene, sexually explicit, or pornographic; depicting or exploiting minors; harassing, threatening, or promoting violence; infringing on intellectual property rights; illegal or promoting illegal activity; containing personal information of others without consent.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">4. SQUAD ADMIN RESPONSIBILITY.</strong> The Squad Admin is responsible for managing their squad, including monitoring member activity, enforcing community standards, and supervending minor accounts. VERSUS provides tools (suspend, activity log) but the Admin bears primary responsibility for squad conduct.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">5. DISCLAIMER OF WARRANTIES.</strong> THE APP IS PROVIDED "AS IS" WITHOUT WARRANTIES OF ANY KIND, EXPRESS OR IMPLIED. VERSUS DOES NOT WARRANT UNINTERRUPTED OR ERROR-FREE SERVICE.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">6. LIMITATION OF LIABILITY.</strong> TO THE MAXIMUM EXTENT PERMITTED BY LAW, VERSUS AND ITS OPERATORS SHALL NOT BE LIABLE FOR ANY INDIRECT, INCIDENTAL, SPECIAL, CONSEQUENTIAL, OR PUNITIVE DAMAGES, OR ANY LOSS OF DATA, USE, OR PROFITS, ARISING OUT OF OR RELATED TO YOUR USE OF THE APP. TOTAL LIABILITY SHALL NOT EXCEED $100 USD.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">7. INDEMNIFICATION.</strong> You agree to indemnify and hold harmless VERSUS, its operators, and affiliates from any claims, losses, or damages arising from your use of the App, your content, or your violation of these Terms.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">8. CONTENT MODERATION.</strong> We reserve the right to remove any content and suspend or terminate any account at our sole discretion, without notice. We are not obligated to monitor content but may do so.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">9. TERMINATION.</strong> We may terminate or suspend access to the App at any time, for any reason, without prior notice.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">10. GOVERNING LAW.</strong> These Terms are governed by the laws of the State of California. Any disputes shall be resolved in the courts of Los Angeles County, California.</p>' +
                '<p><strong style="color: #FFD700;">11. CHANGES.</strong> We may modify these Terms at any time. Continued use constitutes acceptance of modified Terms.</p>' +
                '</div>',
                null,
                'Close',
                function() { closeModal(); }
            );
        }
        
        function showPrivacyModal() {
            showModal(
                'üîí Privacy Policy',
                '<div style="max-height: 60vh; overflow-y: auto; font-size: 12px; color: #A1A1A6; line-height: 1.6; text-align: left;">' +
                '<p style="font-weight: 700; color: #FFFFFF; margin-bottom: 8px;">VERSUS Privacy Policy</p>' +
                '<p style="margin-bottom: 8px;">Last updated: ' + new Date().toLocaleDateString() + '</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">DATA COLLECTED.</strong> We collect: display name, age, avatar selection, photos/videos submitted to challenges, vote data, and device identifiers stored locally. We do NOT collect email addresses, real names beyond display names, location data, or contact lists.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">HOW DATA IS USED.</strong> Data is used solely to operate the App: display challenges, calculate scores, and show rankings within your squad. We do not sell, rent, or share personal data with third parties. Media is stored in encrypted cloud storage accessible only within your squad.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">DATA RETENTION.</strong> Squad data is retained while the squad is active. Users may leave a squad at any time, which removes their local session. Squad admins may request deletion of squad data by contacting us.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">CHILDREN\'S PRIVACY.</strong> See our COPPA compliance section for details on how we protect children under 13.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">THIRD-PARTY SERVICES.</strong> We use Supabase for data storage and real-time functionality. Supabase\'s privacy policy applies to data stored on their infrastructure.</p>' +
                '<p><strong style="color: #FFD700;">CONTACT.</strong> For privacy concerns or data deletion requests, contact the squad administrator or reach out through our support channels.</p>' +
                '</div>',
                null,
                'Close',
                function() { closeModal(); }
            );
        }
        
        function showCOPPAModal() {
            showModal(
                'üë∂ COPPA & Child Safety',
                '<div style="max-height: 60vh; overflow-y: auto; font-size: 12px; color: #A1A1A6; line-height: 1.6; text-align: left;">' +
                '<p style="font-weight: 700; color: #FFFFFF; margin-bottom: 8px;">Children\'s Online Privacy Protection</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">PARENTAL CONSENT.</strong> VERSUS is designed for family use. Accounts for users under 18 ("Minors") must be created with the knowledge and consent of a parent or legal guardian. The Squad Admin (typically a parent) serves as the supervising adult. By allowing a minor to join a squad, the parent/guardian affirms verifiable parental consent for that minor\'s participation.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">MINOR PROTECTIONS.</strong> Minor accounts are flagged and visible to the squad admin. Admins can suspend minor accounts at any time. All activity involving minors is logged and visible to the admin. Squads are private, invite-only groups ‚Äî no public discovery or stranger interaction.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">DATA MINIMIZATION FOR CHILDREN.</strong> We collect the minimum data necessary: display name, age, avatar, and challenge submissions. No real names, email, phone numbers, or precise location data are collected from minors. We do not engage in behavioral advertising or profiling of minors.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">PARENTAL RIGHTS.</strong> Parents/guardians may at any time: review their child\'s activity via the admin activity log; suspend their child\'s account; request deletion of their child\'s data; revoke consent by removing the minor from the squad.</p>' +
                '<p style="margin-bottom: 12px;"><strong style="color: #FFD700;">NO THIRD-PARTY SHARING.</strong> We do not share any minor\'s personal information with third parties. No data from minor accounts is used for advertising, analytics, or any purpose beyond operating the App within the squad.</p>' +
                '<p><strong style="color: #FFD700;">REPORTING.</strong> If you believe a minor\'s safety is at risk or content guidelines have been violated, the Squad Admin should immediately suspend the relevant account and remove offending content.</p>' +
                '</div>',
                null,
                'Close',
                function() { closeModal(); }
            );
        }
        
        function handleLogout() {
            if (confirm('Leave this squad? You can rejoin with the squad code.')) {
                localStorage.clear();
                location.reload();
            }
        }

        // ============================================
        // MODAL SYSTEM
        // ============================================
        
        function showModal(title, content, cancelText, confirmText, confirmAction, cancelAction) {
            const modal = document.createElement('div');
            modal.id = 'modalOverlay';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10, 10, 12, 0.95); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;';
            
            modal.innerHTML = `
                <div style="background: #1C1C1E; border: 2px solid #2C2C2E; border-radius: 16px; padding: 24px; max-width: 400px; width: 100%;">
                    <div style="font-size: 20px; font-weight: 700; margin-bottom: 16px;">${title}</div>
                    <div style="margin-bottom: 24px;">${content}</div>
                    <div style="display: grid; grid-template-columns: ${cancelText && confirmText ? '1fr 1fr' : '1fr'}; gap: 12px;">
                        ${cancelText ? `<button class="btn btn-secondary" onclick="modalCancelAction()">${cancelText}</button>` : ''}
                        ${confirmText ? `<button class="btn btn-primary" onclick="modalConfirmAction()">${confirmText}</button>` : ''}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentModalAction = confirmAction;
            window.currentModalCancelAction = cancelAction;
        }

        function closeModal() {
            const modal = document.getElementById('modalOverlay');
            if (modal) modal.remove();
            window.currentModalAction = null;
            window.currentModalCancelAction = null;
        }

        function modalConfirmAction() {
            if (window.currentModalAction) {
                window.currentModalAction();
            } else {
                closeModal();
            }
        }

        function modalCancelAction() {
            if (window.currentModalCancelAction) {
                window.currentModalCancelAction();
            } else {
                closeModal();
            }
        }
        
        function copyCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                alert('‚úÖ Code copied!');
            });
        }
        
        function createConfetti() {
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const c = document.createElement('div');
                    c.className = 'confetti';
                    c.style.left = Math.random() * 100 + '%';
                    c.style.background = ['#D4AF37', '#FFD700', '#FFA500'][Math.floor(Math.random() * 3)];
                    document.body.appendChild(c);
                    setTimeout(() => c.remove(), 3000);
                }, i * 30);
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        
        // v25: Season Config helpers
        async function updateSeasonField(field, value) {
            var config = seasonConfig || { season_number: 1 };
            config[field] = value;
            config.season_length = config.season_length || '3wk';
            config.challenge_cadence = config.challenge_cadence || 'mwf';
            config.response_window = config.response_window || '24h';
            config.voting_window = config.voting_window || '8h';
            await saveSeasonConfig(config);
            render();
        }
        
        async function applyTripMode() {
            if (!confirm('Start Trip Mode?\n\n‚Ä¢ Resets all points to 0\n‚Ä¢ Starts a new 4-day season\n‚Ä¢ 2√ó challenges per day\n‚Ä¢ Fast voting windows\n\nAll-time wins are preserved.')) return;
            
            await startNewSeason({
                season_length: '4d',
                challenge_cadence: '2xday',
                response_window: '6h',
                voting_window: '2h',
            });
            
            showToast('üéø Trip Mode ‚Äî Season started!', 'victory');
            sounds.victory();
            render();
        }
        
        async function startNewSeason(config) {
            try {
                // Determine next season number
                var prevSeason = seasonConfig?.season_number || 0;
                var newSeasonNum = prevSeason + 1;
                
                // Deactivate previous season config
                if (seasonConfig) {
                    await db.from('season_config')
                        .update({ is_active: false })
                        .eq('squad_id', squadId)
                        .eq('is_active', true);
                }
                
                // Calculate end date
                var lens = { '4d': 4, '1wk': 7, '2wk': 14, '3wk': 21, '4wk': 28, '6wk': 42 };
                var days = lens[config.season_length] || 21;
                var endsAt = new Date(Date.now() + days * 24 * 3600000);
                
                // Create new season config
                var { data, error } = await db.from('season_config')
                    .insert({
                        squad_id: squadId,
                        season_number: newSeasonNum,
                        season_length: config.season_length,
                        challenge_cadence: config.challenge_cadence,
                        response_window: config.response_window,
                        voting_window: config.voting_window,
                        started_at: new Date().toISOString(),
                        ends_at: endsAt.toISOString(),
                        is_active: true,
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                seasonConfig = data;
                
                // Reset all member points and streaks
                var memberIds = Object.keys(members);
                for (var i = 0; i < memberIds.length; i++) {
                    await db.from('members')
                        .update({ points: 0, streak: 0 })
                        .eq('id', memberIds[i]);
                }
                
                // Delete pending 1v1 challenges
                await db.from('challenges')
                    .delete()
                    .eq('squad_id', squadId)
                    .in('status', ['waiting', 'ready', 'voting']);
                
                // Delete active squad challenges
                await db.from('squad_challenges')
                    .delete()
                    .eq('squad_id', squadId)
                    .in('status', ['active', 'voting']);
                
                // Clear captain queue for old season
                await db.from('captain_queue')
                    .delete()
                    .eq('squad_id', squadId)
                    .in('status', ['pending', 'upcoming']);
                
                // Reload everything
                await loadSquadData();
                await loadSquadChallenges();
                
                // Initialize first captain for new season
                captainQueue = [];
                await initializeFirstCaptain();
                
                console.log('‚úÖ Season ' + newSeasonNum + ' started!');
                return data;
            } catch (err) {
                console.error('Failed to start new season:', err);
                showToast('Failed to start season: ' + err.message, 'error');
            }
        }
        
        async function init() {
            console.log('üöÄ Initializing VERSUS v25 ‚Äî Squad Challenges + Captain System');
            
            // Check install state and show banner if needed
            updateInstallBanner();
            
            if (squadId && currentMemberId) {
                // Returning user
                try {
                    await loadSquadData();
                    await loadSquadChallenges();
                    
                    if (squad && members[currentMemberId]) {
                        subscribeToSquad();
                        
                        // Initialize captain queue if needed
                        await initializeFirstCaptain();
                        
                        // Save/update in squad switcher
                        saveCurrentSquad();
                        updateSquadSwitcherUI();
                        
                        // v21: Check for expired challenges (forfeits)
                        await checkForForfeits();
                        
                        // v21: Build "While You Were Away" report
                        var returnEvents = buildReturnReport();
                        if (returnEvents && returnEvents.length > 0 && !hasSeenReturnScreen) {
                            window._returnEvents = returnEvents;
                            screen = 'return-screen';
                        } else {
                            screen = 'arena';
                        }
                        
                        // Handle deep links (from push notifications)
                        handleDeepLink();
                        
                        // Update last seen
                        lastSeenAt = new Date().toISOString();
                        localStorage.setItem('lastSeenAt', lastSeenAt);
                        
                        // v21: Set up push notifications (non-blocking)
                        if (pushSupported && Notification.permission === 'granted') {
                            subscribeToPush();
                        }
                        
                        console.log('‚úÖ Logged in as:', members[currentMemberId].name);
                    } else {
                        // Session invalid
                        console.log('‚ö†Ô∏è Invalid session, resetting...');
                        localStorage.clear();
                        screen = 'welcome';
                    }
                } catch (err) {
                    console.error('Init error:', err);
                    screen = 'welcome';
                }
            } else {
                screen = 'welcome';
                
                // Check for invite link with squad code: ?squad=ABCDEF
                var urlParams = new URLSearchParams(window.location.search);
                var inviteCode = urlParams.get('squad') || urlParams.get('code');
                if (inviteCode) {
                    window.prefillSquadCode = inviteCode.toUpperCase();
                    screen = 'join-squad';
                    // Clean up URL
                    history.replaceState(null, null, window.location.pathname);
                }
            }
            
            render();
            
            // v21: Start live countdown timers
            startCountdownTimers();
            
            // v21: Periodic forfeit check (every 2 minutes)
            setInterval(function() {
                if (squadId && currentMemberId) {
                    checkForForfeits();
                }
            }, 120000);
        }
        
        // Start the app
        init();
    </script>
</body>
</html>
