<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Versus - Cloud Edition</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .screen {
            background: white;
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
        }

        .logo {
            font-size: 36px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .connection-status {
            font-size: 12px;
            color: #48bb78;
            margin-top: 4px;
        }

        .connection-status.offline {
            color: #ef4444;
        }

        .screen-title {
            font-size: 28px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .screen-desc {
            color: #718096;
            font-size: 15px;
            margin-bottom: 24px;
        }

        .btn {
            width: 100%;
            padding: 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 12px;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #2d3748;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        input, textarea, select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 12px;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .challenge-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 24px;
        }

        .challenge-card h3 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .challenge-card p {
            opacity: 0.9;
            margin-bottom: 16px;
        }

        .timer-badge {
            background: rgba(255,255,255,0.2);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            display: inline-block;
        }

        .submission-preview {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 12px;
            margin: 12px 0;
        }

        .vote-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            margin: 20px 0;
        }

        .vote-card {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .vote-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .vote-card.selected {
            border-color: #667eea;
            background: #f7fafc;
        }

        .vote-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .results-podium {
            text-align: center;
            margin: 32px 0;
        }

        .winner {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .winner-name {
            font-size: 32px;
            font-weight: 700;
            color: #2d3748;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 20px 0;
        }

        .stat-card {
            background: #f7fafc;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            color: #667eea;
        }

        .stat-label {
            font-size: 13px;
            color: #718096;
            margin-top: 4px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin: 12px 0;
        }

        .progress-fill {
            height: 100%;
            background: #48bb78;
            transition: width 1s linear;
        }

        .hidden {
            display: none;
        }

        .player-switcher {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .player-btn {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .player-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .player-indicator {
            background: #f7fafc;
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 13px;
            color: #718096;
            margin-bottom: 16px;
        }

        .player-indicator strong {
            color: #667eea;
        }

        .coin-flip-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .coin {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #ffd700 100%);
            box-shadow: 0 10px 40px rgba(255, 215, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 64px;
            animation: coinFlip 2s ease-in-out;
            transform-style: preserve-3d;
        }

        @keyframes coinFlip {
            0% {
                transform: rotateY(0deg) scale(1);
            }
            25% {
                transform: rotateY(180deg) scale(1.2);
            }
            50% {
                transform: rotateY(360deg) scale(1);
            }
            75% {
                transform: rotateY(540deg) scale(1.2);
            }
            100% {
                transform: rotateY(720deg) scale(1);
            }
        }

        .tie-message {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 32px;
            font-weight: 700;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }

        .winner-reveal {
            position: absolute;
            bottom: 30%;
            left: 50%;
            transform: translateX(-50%);
            color: #ffd700;
            font-size: 48px;
            font-weight: 800;
            text-align: center;
            opacity: 0;
            animation: revealWinner 1s ease 2s forwards;
        }

        @keyframes revealWinner {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="screen">
            <div class="header">
                <div class="logo">VERSUS</div>
                <div id="connectionStatus" class="connection-status">‚òÅÔ∏è Connected</div>
                <div id="playerSwitcher" style="display: none; margin-top: 12px;"></div>
            </div>
            <div id="screenContent"></div>
        </div>
    </div>

    <script>
        // ==========================================
        // FIREBASE CONFIGURATION
        // ==========================================
        const firebaseConfig = {
          apiKey: "AIzaSyBbHiG6wEBvMRwhH_f8cotQc2HQoZ0V8ZU",
          authDomain: "versus-b202b.firebaseapp.com",
          databaseURL: "https://versus-b202b-default-rtdb.firebaseio.com",
          projectId: "versus-b202b",
          storageBucket: "versus-b202b.firebasestorage.app",
          messagingSenderId: "878415783187",
          appId: "1:878415783187:web:b917374dd39132bafda6e6"
        };

        // Initialize Firebase
        let db = null;
        let pairId = null; // Unique ID for this pair session
        
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            console.log('Firebase initialized successfully!');
            
            // Monitor connection status
            var connectedRef = firebase.database().ref('.info/connected');
            connectedRef.on('value', function(snap) {
                console.log('Firebase connection status:', snap.val());
                var status = document.getElementById('connectionStatus');
                if (status) {
                    if (snap.val() === true) {
                        status.textContent = '‚òÅÔ∏è Connected';
                        status.className = 'connection-status';
                    } else {
                        status.textContent = 'üì¥ Offline';
                        status.className = 'connection-status offline';
                    }
                } else {
                    console.warn('Connection status element not found');
                }
            });
            
            // Get or create pair ID from URL
            var urlParams = new URLSearchParams(window.location.search);
            pairId = urlParams.get('pair');
            if (!pairId) {
                pairId = 'pair_' + Date.now();
                // Update URL without reload
                window.history.replaceState({}, '', '?pair=' + pairId);
            }
            console.log('Pair ID:', pairId);
        } catch (error) {
            console.error('Firebase initialization error:', error);
            alert('Firebase setup required! Please check FIREBASE_SETUP.md');
        }

        // ==========================================
        // DATA & STATE
        // ==========================================
        // Data
        var pair = null;
        var challenges = [];
        var submissions = [];
        var votes = {};
        var currentPlayer = 'parent'; // 'parent' or 'teen'

        // Workflow state
        var currentScreen = 'welcome';
        var activeChallenge = null;

        // Initialize
        loadData();

        function loadData() {
            if (!db || !pairId) {
                console.error('Firebase not initialized');
                return;
            }
            
            // Listen for realtime updates
            db.ref('pairs/' + pairId).on('value', function(snapshot) {
                var data = snapshot.val();
                if (data) {
                    pair = data;
                    updateScreen();
                }
            });
            
            db.ref('challenges/' + pairId).on('value', function(snapshot) {
                challenges = [];
                snapshot.forEach(function(child) {
                    challenges.push(child.val());
                });
                updateScreen();
            });
            
            db.ref('submissions/' + pairId).on('value', function(snapshot) {
                submissions = [];
                snapshot.forEach(function(child) {
                    submissions.push(child.val());
                });
                updateScreen();
            });
            
            db.ref('votes/' + pairId).on('value', function(snapshot) {
                votes = snapshot.val() || {};
                updateScreen();
            });
            
            // Initial render
            updateScreen();
        }

        function saveData() {
            console.log('saveData called - db:', db ? 'initialized' : 'null', 'pairId:', pairId);
            
            if (!db || !pairId) {
                console.error('Firebase not initialized - db:', db, 'pairId:', pairId);
                return;
            }
            
            console.log('Saving pair:', pair);
            
            // Save to Firebase (replaces localStorage)
            if (pair) {
                db.ref('pairs/' + pairId).set(pair)
                    .then(function() {
                        console.log('Pair saved successfully to Firebase');
                    })
                    .catch(function(error) {
                        console.error('Error saving pair:', error);
                    });
            }
            
            // Save challenges
            if (challenges.length > 0) {
                db.ref('challenges/' + pairId).set(null); // Clear first
                challenges.forEach(function(challenge) {
                    db.ref('challenges/' + pairId + '/' + challenge.id).set(challenge)
                        .catch(function(error) {
                            console.error('Error saving challenge:', error);
                        });
                });
            }
            
            // Save submissions
            if (submissions.length > 0) {
                db.ref('submissions/' + pairId).set(null);
                submissions.forEach(function(submission) {
                    db.ref('submissions/' + pairId + '/' + submission.id).set(submission)
                        .catch(function(error) {
                            console.error('Error saving submission:', error);
                        });
                });
            }
            
            // Save votes
            db.ref('votes/' + pairId).set(votes);
        }

        function updateScreen() {
            // Show player switcher if pair exists
            if (pair) {
                showPlayerSwitcher();
            }
            
            // Determine what screen to show
            if (!pair) {
                currentScreen = 'welcome';
            } else {
                var activeEnrollment = null;
                var activeVoting = null;
                
                for (var i = 0; i < challenges.length; i++) {
                    if (challenges[i].phase === 'enrollment') activeEnrollment = challenges[i];
                    if (challenges[i].phase === 'voting') activeVoting = challenges[i];
                }

                if (activeVoting) {
                    activeChallenge = activeVoting;
                    // Check if THIS player has voted
                    var playerVoteKey = activeVoting.id + '_' + currentPlayer;
                    if (votes[playerVoteKey]) {
                        currentScreen = 'results';
                    } else {
                        currentScreen = 'vote';
                    }
                } else if (activeEnrollment) {
                    activeChallenge = activeEnrollment;
                    // Check if THIS player has submitted
                    var hasSubmitted = submissions.some(function(s) {
                        return s.challengeId === activeEnrollment.id && s.player === currentPlayer;
                    });
                    
                    if (hasSubmitted) {
                        currentScreen = 'waiting';
                    } else {
                        currentScreen = 'submit';
                    }
                } else {
                    currentScreen = 'create';
                }
            }

            renderScreen();
        }

        function renderScreen() {
            var html = '';

            // Add player indicator at top of screen
            if (pair && currentScreen !== 'welcome') {
                var playerName = currentPlayer === 'parent' ? pair.parentName : pair.teenName;
                html += '<div class="player-indicator">Playing as: <strong>' + playerName + '</strong></div>';
            }

            if (currentScreen === 'welcome') {
                html += renderWelcome();
            } else if (currentScreen === 'create') {
                html += renderCreate();
            } else if (currentScreen === 'submit') {
                html += renderSubmit();
            } else if (currentScreen === 'waiting') {
                html += renderWaiting();
            } else if (currentScreen === 'vote') {
                html += renderVote();
            } else if (currentScreen === 'results') {
                html += renderResults();
            }

            document.getElementById('screenContent').innerHTML = html;
        }

        function renderWelcome() {
            return '<h1 class="screen-title">Welcome!</h1>' +
                   '<p class="screen-desc">Create your parent-teen pair to start competing</p>' +
                   '<input type="text" id="parentName" placeholder="Parent name (e.g., Sarah)">' +
                   '<input type="text" id="teenName" placeholder="Teen name (e.g., Alex)">' +
                   '<button class="btn" onclick="createPair()">Create Pair</button>';
        }

        function createPair() {
            var parentName = document.getElementById('parentName').value.trim();
            var teenName = document.getElementById('teenName').value.trim();
            
            console.log('createPair called - Parent:', parentName, 'Teen:', teenName);
            
            if (!parentName || !teenName) {
                alert('Please enter both names');
                return;
            }

            pair = {
                id: pairId,
                parentName: parentName,
                teenName: teenName,
                parentScore: 0,
                teenScore: 0,
                parentWins: 0,
                teenWins: 0
            };

            console.log('Pair object created:', pair);
            console.log('About to call saveData()');
            saveData();
            console.log('saveData() called');
            
            showPlayerSwitcher();
            
            // Show share link
            var shareUrl = window.location.href;
            alert('Pair created! Share this link with your partner:\n\n' + shareUrl + '\n\nBoth devices must use the SAME link!');
            
            updateScreen();
        }

        function showPlayerSwitcher() {
            if (!pair) return;
            
            document.getElementById('playerSwitcher').innerHTML = 
                '<div class="player-switcher">' +
                '<button class="player-btn ' + (currentPlayer === 'parent' ? 'active' : '') + '" onclick="switchPlayer(\'parent\')">üë® ' + pair.parentName + '</button>' +
                '<button class="player-btn ' + (currentPlayer === 'teen' ? 'active' : '') + '" onclick="switchPlayer(\'teen\')">üë¶ ' + pair.teenName + '</button>' +
                '</div>';
            document.getElementById('playerSwitcher').style.display = 'block';
        }

        function switchPlayer(player) {
            currentPlayer = player;
            showPlayerSwitcher();
            updateScreen();
        }

        function renderCreate() {
            return '<h1 class="screen-title">Create Challenge</h1>' +
                   '<p class="screen-desc">What will you compete in?</p>' +
                   '<input type="text" id="title" placeholder="Challenge name">' +
                   '<textarea id="desc" placeholder="Description" rows="3"></textarea>' +
                   '<select id="duration">' +
                   '<option value="300">5 minutes (demo)</option>' +
                   '<option value="3600">1 hour</option>' +
                   '<option value="86400">24 hours</option>' +
                   '</select>' +
                   '<button class="btn" onclick="createChallengeWorkflow()">Start Challenge</button>';
        }

        function createChallengeWorkflow() {
            var title = document.getElementById('title').value.trim();
            var desc = document.getElementById('desc').value.trim();
            var duration = parseInt(document.getElementById('duration').value);

            if (!title) {
                alert('Enter a title');
                return;
            }

            var now = Date.now();
            challenges.push({
                id: 'chal_' + Date.now(),
                title: title,
                description: desc,
                phase: 'enrollment',
                createdAt: now,
                enrollmentEndsAt: now + (duration * 1000),
                votingEndsAt: now + (duration * 2 * 1000)
            });

            saveData();
            updateScreen();
        }

        function renderSubmit() {
            return '<div class="challenge-card">' +
                   '<h3>' + activeChallenge.title + '</h3>' +
                   '<p>' + activeChallenge.description + '</p>' +
                   '<div class="timer-badge">‚è±Ô∏è <span data-timer-end="' + activeChallenge.enrollmentEndsAt + '">' + formatTime(activeChallenge.enrollmentEndsAt) + '</span></div>' +
                   '</div>' +
                   '<h1 class="screen-title">Submit Your Entry</h1>' +
                   '<p class="screen-desc">Take a photo or choose from library</p>' +
                   '<label for="photo" class="btn" style="display: block; text-align: center; cursor: pointer;">üì∑ Take Photo</label>' +
                   '<input type="file" id="photo" accept="image/*" capture="environment" style="display:none;" onchange="previewPhoto()">' +
                   '<div id="preview"></div>' +
                   '<div id="submitBtnContainer" style="display:none;">' +
                   '<button class="btn" onclick="submitPhoto()">‚úì Submit Entry</button>' +
                   '<label for="photo" class="btn btn-secondary" style="display: block; text-align: center; cursor: pointer; margin-top: 8px;">Change Photo</label>' +
                   '</div>';
        }

        function previewPhoto() {
            var file = document.getElementById('photo').files[0];
            if (!file) return;

            // Check file size
            if (file.size > 5 * 1024 * 1024) {
                alert('File too large. Please choose a smaller photo (under 5MB).');
                document.getElementById('photo').value = '';
                return;
            }

            try {
                var reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        document.getElementById('preview').innerHTML = 
                            '<img src="' + e.target.result + '" class="submission-preview">' +
                            '<p style="color: #48bb78; font-size: 14px; text-align: center;">‚úì Photo ready!</p>';
                        document.getElementById('submitBtnContainer').style.display = 'block';
                    } catch (err) {
                        console.error('Error displaying preview:', err);
                        alert('Error displaying photo. Please try again.');
                    }
                };
                reader.onerror = function(err) {
                    console.error('FileReader error:', err);
                    alert('Error reading photo. Please try again.');
                };
                reader.readAsDataURL(file);
            } catch (err) {
                console.error('Error in previewPhoto:', err);
                alert('Error loading photo. Please try again.');
            }
        }

        function submitPhoto() {
            var file = document.getElementById('photo').files[0];
            if (!file) {
                alert('Please select a photo first');
                return;
            }

            try {
                var reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        // Compress the image before storing
                        var img = new Image();
                        img.onload = function() {
                            try {
                                // Create canvas and compress
                                var canvas = document.createElement('canvas');
                                var maxWidth = 800;
                                var scale = maxWidth / img.width;
                                
                                if (scale < 1) {
                                    canvas.width = maxWidth;
                                    canvas.height = img.height * scale;
                                } else {
                                    canvas.width = img.width;
                                    canvas.height = img.height;
                                }
                                
                                var ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                
                                // Convert to JPEG with quality 0.7
                                var compressedData = canvas.toDataURL('image/jpeg', 0.7);
                                
                                console.log('Original size:', e.target.result.length, 'Compressed:', compressedData.length);
                                
                                var playerName = currentPlayer === 'parent' ? pair.parentName : pair.teenName;
                                
                                submissions.push({
                                    id: 'sub_' + Date.now(),
                                    challengeId: activeChallenge.id,
                                    player: currentPlayer,
                                    playerName: playerName,
                                    imageData: compressedData
                                });
                                saveData();
                                updateScreen();
                            } catch (err) {
                                console.error('Error compressing image:', err);
                                alert('Error compressing image. Please try a smaller photo.');
                            }
                        };
                        img.onerror = function() {
                            alert('Error loading image. Please try again.');
                        };
                        img.src = e.target.result;
                    } catch (err) {
                        console.error('Error saving submission:', err);
                        if (err.name === 'QuotaExceededError') {
                            alert('Storage full! Please reset or use smaller photos.');
                        } else {
                            alert('Error submitting photo. Please try again.');
                        }
                    }
                };
                reader.onerror = function(err) {
                    console.error('FileReader error:', err);
                    alert('Error reading photo. Please try again.');
                };
                reader.readAsDataURL(file);
            } catch (err) {
                console.error('Error in submitPhoto:', err);
                alert('Error submitting photo. Please try again.');
            }
        }

        function renderWaiting() {
            var parentSub = submissions.find(function(s) {
                return s.challengeId === activeChallenge.id && s.player === 'parent';
            });
            var teenSub = submissions.find(function(s) {
                return s.challengeId === activeChallenge.id && s.player === 'teen';
            });
            
            var bothSubmitted = parentSub && teenSub;
            
            return '<div class="challenge-card">' +
                   '<h3>' + activeChallenge.title + '</h3>' +
                   '<p>' + activeChallenge.description + '</p>' +
                   '<div class="timer-badge">‚è±Ô∏è <span data-timer-end="' + activeChallenge.enrollmentEndsAt + '">' + formatTime(activeChallenge.enrollmentEndsAt) + '</span></div>' +
                   '</div>' +
                   '<h1 class="screen-title">Entry Submitted! ‚úÖ</h1>' +
                   '<p class="screen-desc">' + (bothSubmitted ? 'Both entries in! Waiting for voting...' : 'Waiting for other player to submit...') + '</p>' +
                   '<div class="stats-grid">' +
                   '<div class="stat-card"><div class="stat-value">' + (parentSub ? '‚úì' : '‚è≥') + '</div><div class="stat-label">' + pair.parentName + '</div></div>' +
                   '<div class="stat-card"><div class="stat-value">' + (teenSub ? '‚úì' : '‚è≥') + '</div><div class="stat-label">' + pair.teenName + '</div></div>' +
                   '</div>' +
                   (bothSubmitted ? '<p style="color: #48bb78; text-align: center; margin: 20px 0;">üéâ Ready to vote! Timer will move to voting when it expires.</p>' : '') +
                   '<button class="btn btn-secondary" onclick="skipToVoting()">‚öôÔ∏è Skip to Voting (Demo)</button>';
        }

        function skipToVoting() {
            // Check if both players have submitted
            var parentSubmitted = submissions.some(function(s) {
                return s.challengeId === activeChallenge.id && s.player === 'parent';
            });
            var teenSubmitted = submissions.some(function(s) {
                return s.challengeId === activeChallenge.id && s.player === 'teen';
            });
            
            if (!parentSubmitted || !teenSubmitted) {
                var missing = [];
                if (!parentSubmitted) missing.push(pair.parentName);
                if (!teenSubmitted) missing.push(pair.teenName);
                
                if (confirm('Warning: ' + missing.join(' and ') + ' has not submitted yet.\n\nSkip to voting anyway?')) {
                    activeChallenge.phase = 'voting';
                    saveData();
                    updateScreen();
                }
            } else {
                activeChallenge.phase = 'voting';
                saveData();
                updateScreen();
            }
        }

        function renderVote() {
            var html = '<div class="challenge-card">' +
                       '<h3>' + activeChallenge.title + '</h3>' +
                       '<p>Vote for the best entry!</p>' +
                       '<div class="timer-badge">‚è±Ô∏è <span data-timer-end="' + activeChallenge.votingEndsAt + '">' + formatTime(activeChallenge.votingEndsAt) + '</span></div>' +
                       '</div>' +
                       '<h1 class="screen-title">Vote Now!</h1>' +
                       '<p class="screen-desc">Tap to select the winner (you can vote for any entry!)</p>' +
                       '<div class="vote-grid">';

            var challengeSubs = submissions.filter(function(s) {
                return s.challengeId === activeChallenge.id;
            });

            for (var i = 0; i < challengeSubs.length; i++) {
                var sub = challengeSubs[i];
                
                html += '<div class="vote-card" onclick="selectWinner(\'' + sub.id + '\')">' +
                        '<img src="' + sub.imageData + '">' +
                        '<strong>' + sub.playerName + '</strong>' +
                        (sub.player === currentPlayer ? '<div style="color: #667eea; font-size: 12px; margin-top: 4px;">Your entry</div>' : '') +
                        '</div>';
            }

            html += '</div>';
            return html;
        }

        function selectWinner(subId) {
            var playerVoteKey = activeChallenge.id + '_' + currentPlayer;
            votes[playerVoteKey] = subId;
            saveData();
            updateScreen();
        }

        function renderResults() {
            var parentVoteKey = activeChallenge.id + '_parent';
            var teenVoteKey = activeChallenge.id + '_teen';
            
            var parentVote = votes[parentVoteKey];
            var teenVote = votes[teenVoteKey];
            
            var bothVoted = parentVote && teenVote;
            
            if (!bothVoted) {
                return '<h1 class="screen-title">Voted! ‚úì</h1>' +
                       '<p class="screen-desc">Waiting for other player to vote...</p>' +
                       '<div class="stats-grid">' +
                       '<div class="stat-card"><div class="stat-value">' + (parentVote ? '‚úì' : '‚è≥') + '</div><div class="stat-label">' + pair.parentName + '</div></div>' +
                       '<div class="stat-card"><div class="stat-value">' + (teenVote ? '‚úì' : '‚è≥') + '</div><div class="stat-label">' + pair.teenName + '</div></div>' +
                       '</div>';
            }
            
            // Check if we need to show coin flip animation
            var coinFlipKey = activeChallenge.id + '_coinflip_shown';
            var coinFlipShown = votes[coinFlipKey] || false;
            
            // Calculate winner
            var parentSubmission = submissions.find(function(s) {
                return s.challengeId === activeChallenge.id && s.player === 'parent';
            });
            var teenSubmission = submissions.find(function(s) {
                return s.challengeId === activeChallenge.id && s.player === 'teen';
            });
            
            var parentVotes = 0;
            var teenVotes = 0;
            
            if (parentVote === parentSubmission.id) parentVotes++;
            if (parentVote === teenSubmission.id) teenVotes++;
            if (teenVote === parentSubmission.id) parentVotes++;
            if (teenVote === teenSubmission.id) teenVotes++;
            
            var isTie = parentVotes === teenVotes;
            var winner = null;
            var winnerName = '';
            var tieBreaker = false;
            
            if (isTie && !coinFlipShown) {
                // Show coin flip animation
                votes[coinFlipKey] = true;
                saveData();
                
                setTimeout(function() {
                    showCoinFlip();
                }, 500);
                
                // Return placeholder while coin flips
                return '<h1 class="screen-title">Calculating Results...</h1>' +
                       '<p class="screen-desc">Both votes are in!</p>';
            }
            
            if (parentVotes > teenVotes) {
                winner = 'parent';
                winnerName = pair.parentName;
                pair.parentScore += 3;
                pair.parentWins += 1;
            } else if (teenVotes > parentVotes) {
                winner = 'teen';
                winnerName = pair.teenName;
                pair.teenScore += 3;
                pair.teenWins += 1;
            } else {
                // Tie - coin flip decides
                tieBreaker = true;
                var coinFlip = Math.random() < 0.5 ? 'parent' : 'teen';
                winner = coinFlip;
                winnerName = coinFlip === 'parent' ? pair.parentName : pair.teenName;
                
                if (winner === 'parent') {
                    pair.parentScore += 3;
                    pair.parentWins += 1;
                } else {
                    pair.teenScore += 3;
                    pair.teenWins += 1;
                }
            }
            
            saveData();
            
            var winnerSubmission = winner === 'parent' ? parentSubmission : teenSubmission;

            var html = '<div class="results-podium">' +
                       '<div class="winner">üèÜ</div>' +
                       '<div class="winner-name">' + winnerName + ' Wins!</div>' +
                       (tieBreaker ? '<p style="color: #999; font-size: 14px; margin-top: 8px;">Won by coin flip!</p>' : '') +
                       '</div>';

            if (winnerSubmission) {
                html += '<img src="' + winnerSubmission.imageData + '" class="submission-preview">';
            }
            
            html += '<p style="text-align: center; color: #718096; margin: 16px 0;">Votes: ' + pair.parentName + ' got ' + parentVotes + ', ' + pair.teenName + ' got ' + teenVotes + '</p>';
            
            if (tieBreaker) {
                html += '<p style="text-align: center; color: #ffd700; font-weight: 600; margin: 16px 0;">ü™ô Tie broken by coin flip!</p>';
            }

            html += '<div class="stats-grid">' +
                    '<div class="stat-card">' +
                    '<div style="font-weight: 700; margin-bottom: 8px;">' + pair.parentName + '</div>' +
                    '<div class="stat-value">' + pair.parentScore + '</div><div class="stat-label">Score</div>' +
                    '<div style="margin-top: 8px; font-size: 12px;">Wins: ' + pair.parentWins + '</div>' +
                    '</div>' +
                    '<div class="stat-card">' +
                    '<div style="font-weight: 700; margin-bottom: 8px;">' + pair.teenName + '</div>' +
                    '<div class="stat-value">' + pair.teenScore + '</div><div class="stat-label">Score</div>' +
                    '<div style="margin-top: 8px; font-size: 12px;">Wins: ' + pair.teenWins + '</div>' +
                    '</div>' +
                    '</div>' +
                    '<button class="btn" onclick="startNew()">üéÆ Start New Challenge</button>' +
                    '<button class="btn btn-secondary" onclick="showStorageInfo()">üíæ Storage Info</button>' +
                    '<button class="btn btn-secondary" onclick="resetAll()">Reset Everything</button>';

            return html;
        }

        function showCoinFlip() {
            // Calculate who wins the coin flip
            var winner = Math.random() < 0.5 ? pair.parentName : pair.teenName;
            
            // Create overlay
            var overlay = document.createElement('div');
            overlay.className = 'coin-flip-container';
            overlay.innerHTML = 
                '<div class="tie-message">It\'s a Tie!<br>Coin Flip Time! ü™ô</div>' +
                '<div class="coin">ü™ô</div>' +
                '<div class="winner-reveal">' + winner + ' Wins!</div>';
            
            document.body.appendChild(overlay);
            
            // Remove overlay after 3.5 seconds and refresh
            setTimeout(function() {
                document.body.removeChild(overlay);
                updateScreen();
            }, 3500);
        }

        function startNew() {
            // Archive current challenge
            activeChallenge.phase = 'completed';
            saveData();
            updateScreen();
        }

        function resetAll() {
            if (confirm('Reset all data for this pair?')) {
                if (db && pairId) {
                    db.ref('pairs/' + pairId).remove();
                    db.ref('challenges/' + pairId).remove();
                    db.ref('submissions/' + pairId).remove();
                    db.ref('votes/' + pairId).remove();
                }
                location.reload();
            }
        }

        function showStorageInfo() {
            var total = 0;
            for (var key in localStorage) {
                if (localStorage.hasOwnProperty(key) && key.startsWith('versus_')) {
                    total += localStorage[key].length;
                }
            }
            
            var totalMB = (total / 1024 / 1024).toFixed(2);
            var submissionsCount = submissions.length;
            
            alert('Storage Usage:\n\nTotal: ' + totalMB + ' MB\nSubmissions: ' + submissionsCount + '\n\nLimit: ~5-10 MB\n\nTip: Reset to clear storage');
        }

        function formatTime(endTime) {
            var now = Date.now();
            var remaining = endTime - now;
            
            if (remaining <= 0) return 'Ended';
            
            var minutes = Math.floor(remaining / 60000);
            var seconds = Math.floor((remaining % 60000) / 1000);
            
            if (minutes > 60) {
                var hours = Math.floor(minutes / 60);
                return hours + 'h ' + (minutes % 60) + 'm';
            }
            
            return minutes + 'm ' + seconds + 's';
        }

        // Global error handler
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Global error:', msg, error);
            return false; // Let default handler run
        };

        // Update timers every second
        setInterval(function() {
            try {
                var timers = document.querySelectorAll('[data-timer-end]');
                for (var i = 0; i < timers.length; i++) {
                    var end = parseInt(timers[i].getAttribute('data-timer-end'));
                    timers[i].textContent = formatTime(end);
                }

                // Check for auto-transitions
                if (activeChallenge) {
                    var now = Date.now();
                    if (activeChallenge.phase === 'enrollment' && now >= activeChallenge.enrollmentEndsAt) {
                        // Only move to voting if BOTH players have submitted
                        var parentSubmitted = submissions.some(function(s) {
                            return s.challengeId === activeChallenge.id && s.player === 'parent';
                        });
                        var teenSubmitted = submissions.some(function(s) {
                            return s.challengeId === activeChallenge.id && s.player === 'teen';
                        });
                        
                        if (parentSubmitted && teenSubmitted) {
                            console.log('Both submitted - moving to voting');
                            activeChallenge.phase = 'voting';
                            saveData();
                            updateScreen();
                        } else {
                            console.log('Timer expired but waiting for submissions. Parent:', parentSubmitted, 'Teen:', teenSubmitted);
                        }
                    } else if (activeChallenge.phase === 'voting' && now >= activeChallenge.votingEndsAt) {
                        // Only complete if BOTH players have voted
                        var parentVoteKey = activeChallenge.id + '_parent';
                        var teenVoteKey = activeChallenge.id + '_teen';
                        var parentVoted = votes[parentVoteKey] ? true : false;
                        var teenVoted = votes[teenVoteKey] ? true : false;
                        
                        if (parentVoted && teenVoted) {
                            console.log('Both voted - completing challenge');
                            activeChallenge.phase = 'completed';
                            saveData();
                            updateScreen();
                        } else {
                            console.log('Timer expired but waiting for votes. Parent:', parentVoted, 'Teen:', teenVoted);
                        }
                    }
                }
            } catch (err) {
                console.error('Timer update error:', err);
            }
        }, 1000);
    </script>
</body>
</html>